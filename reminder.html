<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cerebro de Proyectos IA">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Cerebro de Proyectos IA&quot;,&quot;short_name&quot;:&quot;Proyectos IA&quot;,&quot;description&quot;:&quot;Sistema inteligente de gestión de proyectos y recordatorios&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#3b82f6&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik05NiA0OEM3MS4yIDQ4IDUyIDY3LjIgNTIgOTJWMTQ0QzUyIDE2OC44IDcxLjIgMTg4IDk2IDE4OEMxMjAuOCAxODggMTQwIDE2OC44IDE0MCAxNDRWOTJDMTQwIDY3LjIgMTIwLjggNDggOTYgNDhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNODggODhIMTA0VjEyMEg4OFY4OFoiIGZpbGw9IiMzYjgyZjYiLz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwX2xpbmVhcl8xXzEiIHgxPSIwIiB5MT0iMCIgeDI9IjE5MiIgeTI9IjE5MiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},{&quot;src&quot;:&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iNjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik0yNTYgMTI4QzE4OS4yIDEyOCAxMzggMTc5LjIgMTM4IDI0NlYzODRDMzggNDUwLjggMTg5LjIgNTAyIDI1NiA1MDJDMzIyLjggNTAyIDM3NCA0NTAuOCAzNzQgMzg0VjI0NkMzNzQgMTc5LjIgMzIyLjggMTI4IDI1NiAxMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMjI0IDIzMkgzMjhWMzIwSDIyNFYyMzJaIiBmaWxsPSIjM2I4MmY2Ii8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MF9saW5lYXJfMV8xIiB4MT0iMCIgeTE9IjAiIHgyPSI1MTIiIHkyPSI1MTIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzY2N2VlYSIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4K&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik05NiA0OEM3MS4yIDQ4IDUyIDY3LjIgNTIgOTJWMTQ0QzUyIDE2OC44IDcxLjIgMTg4IDk2IDE4OEMxMjAuOCAxODggMTQwIDE2OC44IDE0MCAxNDRWOTJDMTQwIDY3LjIgMTIwLjggNDggOTYgNDhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNODggODhIMTA0VjEyMEg4OFY4OFoiIGZpbGw9IiMzYjgyZjYiLz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwX2xpbmVhcl8xXzEiIHgxPSIwIiB5MT0iMCIgeDI9IjE5MiIgeTI9IjE5MiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=">
    <title>Cerebro de Proyectos IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="firebase-config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #334155;
            line-height: 1.6;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .due-soon {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        .due-today {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }
        
        .overdue {
            border-left: 4px solid #dc2626;
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        #loading-spinner {
            display: none;
        }
        
        #loading-spinner.show {
            display: flex;
        }
        
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .parsed-field {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .parsed-field:focus {
            border-color: #3b82f6;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .modern-input {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 20px;
            font-size: 15px;
            font-weight: 400;
            color: #334155;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .modern-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        /* Login Modal Styles */
        #login-modal {
            display: none;
        }

        #login-modal.show {
            display: flex;
        }

        .hidden {
            display: none !important;
        }
        
        .modern-input::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }
        
        .modern-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
        }
        
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .modern-button:active {
            transform: translateY(0);
        }
        
        .project-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .delete-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            color: #64748b;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #fee2e2;
            border-color: #fecaca;
            color: #dc2626;
            transform: scale(1.05);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .status-due-soon {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-due-today {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .status-overdue {
            background: #fef2f2;
            color: #b91c1c;
        }
        
        .status-normal {
            background: #f0f9ff;
            color: #0369a1;
        }
        
        /* Date picker styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.4);
            cursor: pointer;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* AI Assistant Styles */
        .ai-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .ai-chat.open {
            transform: translateY(0);
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .ai-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .ai-message.user {
            justify-content: flex-end;
        }

        .ai-message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .ai-message.bot .ai-message-content {
            background: white;
            border: 1px solid #e2e8f0;
            margin-right: 10px;
        }

        .ai-message.user .ai-message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 10px;
        }

        .ai-input-container {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
            border-radius: 0 0 20px 20px;
        }

        .ai-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .ai-input:focus {
            border-color: #667eea;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .metric-change {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .metric-change.positive {
            color: #059669;
        }

        .metric-change.negative {
            color: #dc2626;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 32px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #64748b;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #334155;
        }

        /* Team Management */
        .team-member {
            display: flex;
            align-items: center;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .team-member:hover {
            transform: translateY(-2px);
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 16px;
        }

        /* AI Learning Indicators */
        .ai-learning {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .ai-insight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .ai-prediction {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #22c55e;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .ai-chat {
                width: calc(100vw - 20px);
                height: calc(100vh - 20px);
                bottom: 10px;
                right: 10px;
                left: 10px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .nav-tabs {
                flex-direction: column;
                padding: 8px;
            }

            .nav-tab {
                margin-bottom: 4px;
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Mobile Navigation */
            .nav-tabs {
                position: sticky;
                top: 0;
                z-index: 100;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            }

            /* Mobile Cards */
            .glass-card {
                margin: 8px;
                padding: 16px;
                border-radius: 16px;
            }

            /* Mobile Forms */
            .modern-input {
                padding: 12px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 12px;
            }

            .modern-button {
                padding: 12px 20px;
                font-size: 16px;
                border-radius: 12px;
            }

            /* Mobile Tables */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
            }

            /* Mobile Notifications */
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Mobile Grid Adjustments */
            .grid {
                gap: 12px;
            }

            .grid-cols-1 {
                grid-template-columns: 1fr;
            }

            .grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .grid-cols-3 {
                grid-template-columns: 1fr;
            }

            .grid-cols-4 {
                grid-template-columns: 1fr;
            }

            /* Mobile Text Sizes */
            .text-2xl {
                font-size: 1.5rem;
            }

            .text-xl {
                font-size: 1.25rem;
            }

            .text-lg {
                font-size: 1.125rem;
            }

            /* Mobile Spacing */
            .space-y-8 > * + * {
                margin-top: 1.5rem;
            }

            .space-y-6 > * + * {
                margin-top: 1rem;
            }

            .space-y-4 > * + * {
                margin-top: 0.75rem;
            }

            /* Mobile Modal */
            .modal {
                padding: 16px;
            }

            .modal-content {
                margin: 16px;
                max-height: calc(100vh - 32px);
                overflow-y: auto;
            }

            /* Mobile Charts */
            .chart-container {
                height: 250px;
            }

            /* Mobile Team Members */
            .team-member-card {
                padding: 12px;
                margin-bottom: 8px;
            }

            /* Mobile WhatsApp Cards */
            .notification-method-card {
                padding: 16px;
                margin-bottom: 12px;
            }

            /* Mobile Project Cards */
            .project-card {
                padding: 16px;
                margin-bottom: 12px;
            }

            /* Mobile Search */
            .search-input {
                padding: 12px 16px;
                font-size: 16px;
            }

            /* Mobile Filters */
            .filter-container {
                flex-direction: column;
                gap: 8px;
            }

            /* Mobile Action Buttons */
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .action-buttons button {
                width: 100%;
            }
        }

        /* Extra Small Mobile Devices */
        @media (max-width: 480px) {
            .glass-card {
                margin: 4px;
                padding: 12px;
            }

            .nav-tab {
                padding: 10px 12px;
                font-size: 13px;
            }

            .modern-input {
                padding: 10px 12px;
                font-size: 16px;
            }

            .modern-button {
                padding: 10px 16px;
                font-size: 14px;
            }

            .text-2xl {
                font-size: 1.25rem;
            }

            .text-xl {
                font-size: 1.125rem;
            }

            .text-lg {
                font-size: 1rem;
            }
        }

        /* Landscape Mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .nav-tabs {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .nav-tab {
                margin-right: 4px;
                margin-bottom: 4px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #22c55e;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification-method-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .notification-method-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .notification-method-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .notification-method-card input[type="radio"]:checked + span {
            color: #3b82f6;
            font-weight: 600;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        /* Team Management Styles */
        .team-member-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .team-member-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .team-member-card.online {
            border-left: 4px solid #22c55e;
        }

        .team-member-card.offline {
            border-left: 4px solid #ef4444;
        }

        .team-member-card.busy {
            border-left: 4px solid #f59e0b;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .role-admin {
            background: #fef2f2;
            color: #dc2626;
        }

        .role-manager {
            background: #eff6ff;
            color: #2563eb;
        }

        .role-operator {
            background: #f0fdf4;
            color: #16a34a;
        }

        .role-technician {
            background: #faf5ff;
            color: #9333ea;
        }

        /* Knowledge Base Styles */
        .template-btn {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: #64748b;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .template-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .knowledge-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .knowledge-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .knowledge-category {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .category-equipment {
            background: #dbeafe;
            color: #1e40af;
        }

        .category-materials {
            background: #dcfce7;
            color: #166534;
        }

        .category-processes {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .category-standards {
            background: #fed7aa;
            color: #ea580c;
        }

        .category-projects {
            background: #fce7f3;
            color: #be185d;
        }

        /* Progress Bars */
        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Mobile Optimizations for Team */
        @media (max-width: 768px) {
            .team-member-card {
                padding: 12px;
            }

            .role-badge {
                font-size: 11px;
                padding: 3px 6px;
            }

            .template-btn {
                padding: 6px 8px;
                font-size: 12px;
            }

            .knowledge-item {
                padding: 12px;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-16 relative">
            <div class="absolute top-0 right-0">
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-300 flex items-center hidden">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Cerrar Sesión
                </button>
            </div>
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-purple-500 via-blue-500 to-cyan-500 rounded-3xl mb-6 shadow-xl">
                <i class="fas fa-brain text-white text-3xl"></i>
            </div>
            <h1 class="text-5xl md:text-6xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-cyan-600 bg-clip-text text-transparent mb-4 tracking-tight">Cerebro de Proyectos IA</h1>
            <p class="text-xl text-slate-600 max-w-3xl mx-auto leading-relaxed">Tu asistente inteligente de gestión de proyectos que aprende, predice y optimiza tu flujo de trabajo automáticamente.</p>
        </header>

        <!-- Login Modal -->
        <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="glass-card p-8 rounded-2xl max-w-md w-full mx-4">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-lock text-white text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Iniciar Sesión</h2>
                    <p class="text-slate-600">Ingresa tus credenciales para acceder</p>
                </div>
                
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                        <input type="email" id="login-email" required 
                               class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                               placeholder="tu@empresa.com">
                    </div>
                    
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-slate-700 mb-2">Contraseña</label>
                        <input type="password" id="login-password" required 
                               class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                               placeholder="••••••••">
                    </div>
                    
                    <button type="submit" id="login-submit" 
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Iniciar Sesión
                    </button>
                </form>
                
                <div id="login-error" class="mt-4 p-3 bg-red-100 border border-red-300 rounded-lg text-red-700 text-sm hidden">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="login-error-text"></span>
                </div>
                
                <div class="mt-6 text-center">
                    <p class="text-sm text-slate-500">Solo usuarios autorizados pueden acceder<br>Contacta al administrador si necesitas acceso</p>
                </div>
            </div>
        </div>

        <!-- Add Supplier Modal -->
        <div id="add-supplier-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="glass-card p-8 rounded-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-teal-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-plus text-white text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Agregar Nuevo Proveedor</h2>
                            <p class="text-slate-600">Completa la información del proveedor</p>
                        </div>
                    </div>
                    <button id="close-supplier-modal" class="text-slate-400 hover:text-slate-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="supplier-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Nombre del Proveedor</label>
                            <input type="text" id="supplier-name" class="modern-input w-full" placeholder="Ej: Proveedor XYZ" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Categoría</label>
                            <select id="supplier-category" class="modern-input w-full" required>
                                <option value="">Seleccionar categoría</option>
                                <option value="Materiales Industriales">Materiales Industriales</option>
                                <option value="Herramientas y Equipos">Herramientas y Equipos</option>
                                <option value="Componentes Electrónicos">Componentes Electrónicos</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Contacto</label>
                            <input type="text" id="supplier-contact" class="modern-input w-full" placeholder="Nombre del contacto" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                            <input type="tel" id="supplier-phone" class="modern-input w-full" placeholder="+1 234-567-8900" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                            <input type="email" id="supplier-email" class="modern-input w-full" placeholder="contacto@proveedor.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Tiempo de Entrega</label>
                            <select id="supplier-delivery" class="modern-input w-full" required>
                                <option value="">Seleccionar tiempo</option>
                                <option value="1-2 días">1-2 días</option>
                                <option value="2-4 días">2-4 días</option>
                                <option value="3-5 días">3-5 días</option>
                                <option value="5-7 días">5-7 días</option>
                                <option value="1-2 semanas">1-2 semanas</option>
                                <option value="Más de 2 semanas">Más de 2 semanas</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Dirección</label>
                        <textarea id="supplier-address" class="modern-input w-full h-20" placeholder="Dirección completa del proveedor"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Calificación (1-5)</label>
                            <select id="supplier-rating" class="modern-input w-full" required>
                                <option value="">Seleccionar calificación</option>
                                <option value="1">1 - Muy malo</option>
                                <option value="2">2 - Malo</option>
                                <option value="3">3 - Regular</option>
                                <option value="4">4 - Bueno</option>
                                <option value="5">5 - Excelente</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Notas Adicionales</label>
                            <input type="text" id="supplier-notes" class="modern-input w-full" placeholder="Información adicional">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-6 border-t border-slate-200">
                        <button type="button" id="cancel-supplier" class="px-6 py-3 border border-slate-300 text-slate-700 rounded-xl font-semibold hover:bg-slate-50 transition-colors duration-300">
                            Cancelar
                        </button>
                        <button type="submit" class="px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-teal-700 transition-all duration-300">
                            <i class="fas fa-save mr-2"></i>
                            Guardar Proveedor
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-chart-line mr-2"></i>Panel
            </div>
            <div class="nav-tab" data-tab="projects">
                <i class="fas fa-tasks mr-2"></i>Proyectos
            </div>
            <div class="nav-tab" data-tab="analytics">
                <i class="fas fa-analytics mr-2"></i>Análisis
            </div>
            <div class="nav-tab" data-tab="team">
                <i class="fas fa-users mr-2"></i>Equipo
            </div>
            <div class="nav-tab" data-tab="ai-insights">
                <i class="fas fa-robot mr-2"></i>Insights IA
            </div>
            <div class="nav-tab" data-tab="knowledge">
                <i class="fas fa-database mr-2"></i>Base de Conocimiento
            </div>
            <div class="nav-tab" data-tab="whatsapp">
                <i class="fab fa-whatsapp mr-2"></i>WhatsApp
            </div>
            <div class="nav-tab" data-tab="buyers">
                <i class="fas fa-shopping-cart mr-2"></i>Compradores
            </div>
            <div class="nav-tab" data-tab="settings">
                <i class="fas fa-cog mr-2"></i>Configuraciones
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <!-- AI Learning Status -->
            <div class="ai-learning">
                <div class="flex items-center mb-3">
                    <i class="fas fa-brain text-blue-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-blue-800">Estado de Aprendizaje IA</h3>
                </div>
                <p class="text-blue-700 mb-2">La IA está analizando tus patrones de proyectos y aprendiendo tu flujo de trabajo empresarial...</p>
                <div class="w-full bg-blue-200 rounded-full h-2">
                    <div id="ai-learning-progress" class="bg-blue-500 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p class="text-sm text-blue-600 mt-2">Progreso de Aprendizaje: <span id="learning-percentage">0%</span></p>
            </div>

            <!-- Key Metrics Dashboard -->
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-tasks text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">+12%</span>
                    </div>
                    <div class="metric-value" id="total-projects">0</div>
                    <div class="metric-label">Total Proyectos</div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">+8%</span>
                    </div>
                    <div class="metric-value" id="completed-projects">0</div>
                    <div class="metric-label">Completados Este Mes</div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <span class="text-sm text-red-600 font-semibold">-5%</span>
                    </div>
                    <div class="metric-value" id="overdue-projects">0</div>
                    <div class="metric-label">Proyectos Atrasados</div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">+15%</span>
                    </div>
                    <div class="metric-value" id="efficiency-score">0%</div>
                    <div class="metric-label">Puntuación Eficiencia IA</div>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="ai-insight">
                <div class="flex items-center mb-3">
                    <i class="fas fa-lightbulb text-yellow-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-yellow-800">Insight IA</h3>
                </div>
                <p id="ai-insight-text" class="text-yellow-700">Basándome en tus patrones de proyectos, he notado que los proyectos con "brida" en la descripción tienden a tomar 15% más tiempo del estimado. Considera agregar tiempo de buffer para proyectos similares.</p>
            </div>

            <!-- AI Predictions -->
            <div class="ai-prediction">
                <div class="flex items-center mb-3">
                    <i class="fas fa-crystal-ball text-green-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-green-800">Predicción IA</h3>
                </div>
                <p id="ai-prediction-text" class="text-green-700">Basándome en la carga de trabajo actual y datos históricos, es probable que completes 85% de los proyectos a tiempo este mes. Considera priorizar los 3 proyectos que vencen la próxima semana.</p>
            </div>

            <!-- Project Timeline Chart -->
            <div class="glass-card p-8 rounded-2xl">
                <h3 class="text-xl font-semibold text-slate-800 mb-6">Cronograma de Proyectos</h3>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects-tab" class="tab-content hidden">
        <!-- Form to Add New Project -->
            <div class="glass-card p-8 rounded-2xl mb-12">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-plus text-white text-sm"></i>
                </div>
                <div>
                        <h2 class="text-2xl font-semibold text-slate-800">Agregar Nuevo Proyecto</h2>
                        <p class="text-slate-600">Copia los detalles del proyecto de tu otro sistema y pégalos abajo.</p>
                    </div>
                </div>
                
                <div class="mb-8">
                    <label for="smart-entry" class="block text-sm font-semibold text-slate-700 mb-3">Entrada Inteligente</label>
                    <textarea id="smart-entry" rows="4" class="modern-input w-full resize-none" placeholder="ej.,&#10;Número PO: 11-2345&#10;Trabajo: Bridas para Cliente XYZ&#10;Fecha Vencimiento: 2025-12-25"></textarea>
                    <p class="text-xs text-slate-500 mt-2">Pega la información del proyecto y extraeremos automáticamente los detalles abajo.</p>
            </div>

                <form id="add-project-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                            <label for="po-number" class="block text-sm font-semibold text-slate-700 mb-3">PO / Número de Orden</label>
                            <input type="text" id="po-number" name="po-number" required class="modern-input w-full parsed-field" placeholder="Auto-completado desde pegar">
                </div>
                <div>
                            <label for="due-date" class="block text-sm font-semibold text-slate-700 mb-3">Fecha de Vencimiento</label>
                            <input type="date" id="due-date" name="due-date" required class="modern-input w-full parsed-field">
                </div>
                </div>
                    
                    <div>
                        <label for="project-description" class="block text-sm font-semibold text-slate-700 mb-3">Descripción del Proyecto</label>
                        <input type="text" id="project-description" name="project-description" required class="modern-input w-full parsed-field" placeholder="Auto-completado desde pegar">
                </div>
                    
                    <div class="flex justify-end pt-4">
                        <button type="submit" class="modern-button flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Agregar Proyecto
                </button>
                    </div>
            </form>
        </div>

        <!-- Loading Spinner -->
            <div id="loading-spinner" class="flex justify-center items-center py-16 show">
                <div class="flex flex-col items-center">
                    <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-slate-600 font-medium">Cargando proyectos...</p>
                </div>
        </div>

        <!-- Project List -->
        <div id="project-list-container">
                <div class="flex items-center mb-8">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-list-check text-white text-sm"></i>
            </div>
                    <div>
                        <h2 class="text-2xl font-semibold text-slate-800">Proyectos Activos</h2>
                        <p class="text-slate-600">Gestiona y rastrea las fechas límite de tus proyectos</p>
        </div>
    </div>
                
                <div id="project-list" class="space-y-4">
                    <div id="no-projects-message" class="text-center py-16 hidden">
                        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-inbox text-slate-400 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-700 mb-2">No hay proyectos activos</h3>
                        <p class="text-slate-500">¡Agrega tu primer proyecto arriba para comenzar!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Tendencias de Finalización de Proyectos</h3>
                    <div class="chart-container">
                        <canvas id="completionChart"></canvas>
                    </div>
                </div>
                
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Distribución de Tipos de Proyectos</h3>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Tab -->
        <div id="team-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Team Overview -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Gestión del Equipo</h3>
                            <p class="text-slate-600">Administra miembros, roles y configuraciones del equipo</p>
                        </div>
                        <button id="add-team-member-btn" class="modern-button">
                            <i class="fas fa-user-plus mr-2"></i>
                            Agregar Miembro
                        </button>
                    </div>
                    
                    <!-- Team Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-blue-700" id="total-members">0</div>
                                    <div class="text-sm text-blue-600">Miembros Activos</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-clock text-white"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-700" id="online-members">0</div>
                                    <div class="text-sm text-green-600">En Línea</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-tasks text-white"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-purple-700" id="active-projects">0</div>
                                    <div class="text-sm text-purple-600">Proyectos Activos</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-chart-line text-white"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-orange-700" id="team-efficiency">0%</div>
                                    <div class="text-sm text-orange-600">Eficiencia</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Members Management -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="text-xl font-semibold text-slate-800">Miembros del Equipo</h4>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <input type="text" id="team-search" placeholder="Buscar miembro..." class="modern-input pr-10">
                                <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                            </div>
                            <select id="role-filter" class="modern-input">
                                <option value="all">Todos los roles</option>
                                <option value="admin">Administrador</option>
                                <option value="manager">Gerente</option>
                                <option value="operator">Operador</option>
                                <option value="technician">Técnico</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="team-members-list" class="space-y-4">
                        <!-- Team members will be dynamically loaded here -->
                    </div>
                </div>

                <!-- Team Configuration -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Notification Settings -->
                    <div class="glass-card p-8 rounded-2xl">
                        <h4 class="text-xl font-semibold text-slate-800 mb-6">Configuración de Notificaciones</h4>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Horarios de Notificación</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs text-slate-500 mb-1">Inicio</label>
                                        <input type="time" id="notification-start" class="modern-input w-full" value="08:00">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-500 mb-1">Fin</label>
                                        <input type="time" id="notification-end" class="modern-input w-full" value="18:00">
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Días de Trabajo</label>
                                <div class="grid grid-cols-7 gap-2">
                                    <label class="flex items-center justify-center p-2 border rounded cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" class="workday-checkbox" value="monday" checked>
                                        <span class="text-xs ml-1">L</span>
                                    </label>
                                    <label class="flex items-center justify-center p-2 border rounded cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" class="workday-checkbox" value="tuesday" checked>
                                        <span class="text-xs ml-1">M</span>
                                    </label>
                                    <label class="flex items-center justify-center p-2 border rounded cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" class="workday-checkbox" value="wednesday" checked>
                                        <span class="text-xs ml-1">X</span>
                                    </label>
                                    <label class="flex items-center justify-center p-2 border rounded cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" class="workday-checkbox" value="thursday" checked>
                                        <span class="text-xs ml-1">J</span>
                                    </label>
                                    <label class="flex items-center justify-center p-2 border rounded cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" class="workday-checkbox" value="friday" checked>
                                        <span class="text-xs ml-1">V</span>
                                    </label>
                                    <label class="flex items-center justify-center p-2 border rounded cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" class="workday-checkbox" value="saturday">
                                        <span class="text-xs ml-1">S</span>
                                    </label>
                                    <label class="flex items-center justify-center p-2 border rounded cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" class="workday-checkbox" value="sunday">
                                        <span class="text-xs ml-1">D</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Tipos de Notificación</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="urgent-notifications" checked class="mr-3">
                                        <span class="text-sm text-slate-700">Proyectos urgentes (inmediato)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="daily-summary" checked class="mr-3">
                                        <span class="text-sm text-slate-700">Resumen diario (8:00 AM)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="weekly-report" class="mr-3">
                                        <span class="text-sm text-slate-700">Reporte semanal (Lunes 9:00 AM)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Team Roles & Permissions -->
                    <div class="glass-card p-8 rounded-2xl">
                        <div class="flex items-center justify-between mb-6">
                            <h4 class="text-xl font-semibold text-slate-800">Roles y Permisos</h4>
                            <button onclick="window.teamManager.testRolesFunction()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                                Probar Funciones
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Roles Disponibles</label>
                                <div id="roles-list" class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-crown text-red-600 text-sm"></i>
                                            </div>
                                            <div>
                                                <div class="font-medium text-slate-800">Administrador</div>
                                                <div class="text-xs text-slate-500">Acceso completo al sistema</div>
                                            </div>
                                        </div>
                                        <button class="text-slate-400 hover:text-slate-600">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user-tie text-blue-600 text-sm"></i>
                                            </div>
                                            <div>
                                                <div class="font-medium text-slate-800">Gerente</div>
                                                <div class="text-xs text-slate-500">Gestión de proyectos y equipo</div>
                                            </div>
                                        </div>
                                        <button class="text-slate-400 hover:text-slate-600">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-cogs text-green-600 text-sm"></i>
                                            </div>
                                            <div>
                                                <div class="font-medium text-slate-800">Operador</div>
                                                <div class="text-xs text-slate-500">Operación de equipos CNC</div>
                                            </div>
                                        </div>
                                        <button class="text-slate-400 hover:text-slate-600">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-tools text-purple-600 text-sm"></i>
                                            </div>
                                            <div>
                                                <div class="font-medium text-slate-800">Técnico</div>
                                                <div class="text-xs text-slate-500">Mantenimiento y calibración</div>
                                            </div>
                                        </div>
                                        <button class="text-slate-400 hover:text-slate-600">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="modern-button w-full">
                                <i class="fas fa-plus mr-2"></i>
                                Crear Nuevo Rol
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Team Performance -->
                <div class="glass-card p-8 rounded-2xl">
                    <h4 class="text-xl font-semibold text-slate-800 mb-6">Rendimiento del Equipo</h4>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h5 class="text-lg font-medium text-slate-700 mb-4">Proyectos por Miembro</h5>
                            <div class="chart-container">
                                <canvas id="teamProjectsChart"></canvas>
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="text-lg font-medium text-slate-700 mb-4">Eficiencia por Rol</h5>
                            <div class="chart-container">
                                <canvas id="roleEfficiencyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights Tab -->
        <div id="ai-insights-tab" class="tab-content hidden">
            <div class="space-y-6">
                <div class="ai-learning">
                    <h3 class="text-xl font-semibold text-blue-800 mb-4">Progreso de Aprendizaje IA</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Reconocimiento de Patrones de Proyectos</span>
                                <span>92%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 92%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Precisión de Predicción de Fechas Límite</span>
                                <span>87%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 87%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Optimización de Recursos</span>
                                <span>78%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 78%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Recomendaciones IA</h3>
                    <div class="space-y-4">
                        <div class="flex items-start p-4 bg-slate-50 rounded-lg">
                            <i class="fas fa-lightbulb text-yellow-500 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-slate-800">Optimizar Programación de Proyectos</h4>
                                <p class="text-sm text-slate-600">Considera programar proyectos complejos los martes y miércoles cuando la eficiencia del equipo es más alta.</p>
                            </div>
                        </div>
                        <div class="flex items-start p-4 bg-slate-50 rounded-lg">
                            <i class="fas fa-chart-line text-green-500 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-slate-800">Asignación de Recursos</h4>
                                <p class="text-sm text-slate-600">Reasigna 2 miembros del equipo de proyectos de baja prioridad para cumplir con los plazos de la próxima semana.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Base Tab -->
        <div id="knowledge-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Knowledge Upload Section -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-upload text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Cargar Conocimiento al IA</h3>
                            <p class="text-slate-600">Sube información sobre tu taller para que la IA aprenda sobre tus capacidades</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Text Upload -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Información de Texto</h4>
                            <textarea id="knowledge-text" rows="8" class="modern-input w-full resize-none" placeholder="Ejemplo:&#10;Nuestro taller cuenta con:&#10;- Torno CNC de 3 ejes con capacidad de 500mm de diámetro&#10;- Fresadora vertical con mesa de 1000x500mm&#10;- Sistema de automatización con robots KUKA&#10;- Software CAD/CAM Mastercam&#10;- Materiales: acero inoxidable, aluminio, titanio&#10;- Tolerancias: ±0.01mm para piezas de precisión"></textarea>
                            <button id="upload-text-knowledge" class="modern-button mt-4 w-full">
                                <i class="fas fa-upload mr-2"></i>
                                Cargar Texto
                            </button>
                        </div>
                        
                        <!-- File Upload -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Archivos (PDF, DOC, TXT)</h4>
                            <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-indigo-400 transition-colors">
                                <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-4"></i>
                                <p class="text-slate-600 mb-4">Arrastra archivos aquí o haz clic para seleccionar</p>
                                <input type="file" id="knowledge-files" multiple accept=".pdf,.doc,.docx,.txt" class="hidden">
                                <button onclick="document.getElementById('knowledge-files').click()" class="modern-button">
                                    <i class="fas fa-folder-open mr-2"></i>
                                    Seleccionar Archivos
                                </button>
                            </div>
                            <div id="file-list" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                </div>


        <!-- Knowledge Base Tab -->
        <div id="knowledge-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Knowledge Overview -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Base de Conocimiento Inteligente</h3>
                            <p class="text-slate-600">Sistema avanzado de gestión y aprendizaje automático</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="sync-knowledge" class="modern-button">
                                <i class="fas fa-sync mr-2"></i>
                                Sincronizar
                            </button>
                            <button id="export-knowledge" class="modern-button">
                                <i class="fas fa-download mr-2"></i>
                                Exportar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Knowledge Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-database text-white"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-blue-700" id="knowledge-items">0</div>
                                    <div class="text-sm text-blue-600">Elementos de Conocimiento</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-file-alt text-white"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-700" id="documents-count">0</div>
                                    <div class="text-sm text-green-600">Documentos Procesados</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-brain text-white"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-purple-700" id="ai-insights">0</div>
                                    <div class="text-sm text-purple-600">Insights Generados</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-chart-line text-white"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-orange-700" id="learning-progress">0%</div>
                                    <div class="text-sm text-orange-600">Progreso de Aprendizaje</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Management -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Knowledge Upload -->
                    <div class="glass-card p-8 rounded-2xl">
                        <h4 class="text-xl font-semibold text-slate-800 mb-6">Cargar Conocimiento</h4>
                        
                        <div class="space-y-6">
                            <!-- Text Input -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Información de Texto</label>
                                <textarea id="knowledge-text" rows="6" class="modern-input w-full resize-none" placeholder="Describe capacidades, procesos, materiales, tolerancias, etc..."></textarea>
                                <button id="upload-text-knowledge" class="modern-button mt-3 w-full">
                                    <i class="fas fa-upload mr-2"></i>
                                    Procesar Texto
                                </button>
                            </div>
                            
                            <!-- File Upload -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Archivos</label>
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-3"></i>
                                    <p class="text-slate-600 mb-3">Arrastra archivos aquí</p>
                                    <input type="file" id="knowledge-files" multiple accept=".pdf,.doc,.docx,.txt,.xlsx,.csv" class="hidden">
                                    <button onclick="document.getElementById('knowledge-files').click()" class="modern-button">
                                        <i class="fas fa-folder-open mr-2"></i>
                                        Seleccionar Archivos
                                    </button>
                                </div>
                                <div id="file-list" class="mt-3 space-y-2"></div>
                            </div>
                            
                            <!-- Quick Templates -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Plantillas Rápidas</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button class="template-btn" data-template="equipment">
                                        <i class="fas fa-cog mr-2"></i>Equipos
                                    </button>
                                    <button class="template-btn" data-template="materials">
                                        <i class="fas fa-cube mr-2"></i>Materiales
                                    </button>
                                    <button class="template-btn" data-template="processes">
                                        <i class="fas fa-cogs mr-2"></i>Procesos
                                    </button>
                                    <button class="template-btn" data-template="standards">
                                        <i class="fas fa-ruler mr-2"></i>Estándares
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Knowledge Search & Categories -->
                    <div class="glass-card p-8 rounded-2xl">
                        <h4 class="text-xl font-semibold text-slate-800 mb-6">Buscar Conocimiento</h4>
                        
                        <div class="space-y-6">
                            <!-- Search -->
                            <div>
                                <div class="relative">
                                    <input type="text" id="knowledge-search" placeholder="Buscar en la base de conocimiento..." class="modern-input w-full pr-10">
                                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                </div>
                            </div>
                            
                            <!-- Categories -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Categorías</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="category-filter" value="equipment" checked class="mr-3">
                                        <span class="text-sm text-slate-700">Equipos y Máquinas</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="category-filter" value="materials" checked class="mr-3">
                                        <span class="text-sm text-slate-700">Materiales y Aleaciones</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="category-filter" value="processes" checked class="mr-3">
                                        <span class="text-sm text-slate-700">Procesos de Fabricación</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="category-filter" value="standards" checked class="mr-3">
                                        <span class="text-sm text-slate-700">Estándares y Tolerancias</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="category-filter" value="projects" checked class="mr-3">
                                        <span class="text-sm text-slate-700">Proyectos y Casos</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Recent Knowledge -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Conocimiento Reciente</label>
                                <div id="recent-knowledge" class="space-y-2">
                                    <!-- Recent items will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Display -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="text-xl font-semibold text-slate-800">Conocimiento Disponible</h4>
                        <div class="flex items-center space-x-4">
                            <select id="knowledge-sort" class="modern-input">
                                <option value="recent">Más Reciente</option>
                                <option value="relevant">Más Relevante</option>
                                <option value="category">Por Categoría</option>
                                <option value="type">Por Tipo</option>
                            </select>
                            <button id="clear-knowledge" class="modern-button">
                                <i class="fas fa-trash mr-2"></i>
                                Limpiar Todo
                            </button>
                        </div>
                    </div>
                    
                    <div id="knowledge-results" class="space-y-4">
                        <!-- Knowledge items will be displayed here -->
                    </div>
                </div>

                <!-- AI Learning Progress -->
                <div class="glass-card p-8 rounded-2xl">
                    <h4 class="text-xl font-semibold text-slate-800 mb-6">Progreso de Aprendizaje IA</h4>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h5 class="text-lg font-medium text-slate-700 mb-4">Áreas de Conocimiento</h5>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-sm text-slate-600 mb-1">
                                        <span>Equipos CNC</span>
                                        <span>85%</span>
                                    </div>
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: 85%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between text-sm text-slate-600 mb-1">
                                        <span>Materiales</span>
                                        <span>72%</span>
                                    </div>
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 72%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between text-sm text-slate-600 mb-1">
                                        <span>Procesos</span>
                                        <span>68%</span>
                                    </div>
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div class="bg-purple-500 h-2 rounded-full" style="width: 68%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between text-sm text-slate-600 mb-1">
                                        <span>Estándares</span>
                                        <span>45%</span>
                                    </div>
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div class="bg-orange-500 h-2 rounded-full" style="width: 45%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="text-lg font-medium text-slate-700 mb-4">Insights Generados</h5>
                            <div class="space-y-3">
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <div class="flex items-start">
                                        <i class="fas fa-lightbulb text-blue-600 mr-2 mt-1"></i>
                                        <div>
                                            <div class="text-sm font-medium text-blue-800">Optimización de Tiempos</div>
                                            <div class="text-xs text-blue-600">Los proyectos con titanio requieren 3 días adicionales</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <div class="flex items-start">
                                        <i class="fas fa-chart-line text-green-600 mr-2 mt-1"></i>
                                        <div>
                                            <div class="text-sm font-medium text-green-800">Patrón de Eficiencia</div>
                                            <div class="text-xs text-green-600">Los operadores con más experiencia tienen 15% mejor rendimiento</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-purple-50 p-3 rounded-lg">
                                    <div class="flex items-start">
                                        <i class="fas fa-cogs text-purple-600 mr-2 mt-1"></i>
                                        <div>
                                            <div class="text-sm font-medium text-purple-800">Capacidad de Equipos</div>
                                            <div class="text-xs text-purple-600">El torno CNC puede manejar proyectos hasta 500mm de diámetro</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Sistemas Mecánicos Completos</h4>
                            <div class="space-y-3">
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Ejes torneados + bases fresadas + automatización</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Sistemas de transmisión completos</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Mecanismos de precisión integrados</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Sistemas de control automatizado</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Piezas de Precisión</h4>
                            <div class="space-y-3">
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Componentes con tolerancias ±0.001mm</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Piezas críticas para automatización</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Elementos de calibración y medición</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Componentes para prototipos</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Status -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Estado del Conocimiento IA</h3>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-700">Conocimiento del Taller</h4>
                                <p class="text-sm text-slate-500">Información sobre capacidades y equipos</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-green-600" id="workshop-knowledge">85%</div>
                                <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-700">Tipos de Proyectos</h4>
                                <p class="text-sm text-slate-500">Patrones y categorías de trabajo</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-600" id="project-types-knowledge">72%</div>
                                <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 72%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-700">Tiempos de Producción</h4>
                                <p class="text-sm text-slate-500">Estimaciones basadas en experiencia</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-purple-600" id="timing-knowledge">68%</div>
                                <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-purple-500 h-2 rounded-full" style="width: 68%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Web Search Integration -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Búsqueda Web Inteligente</h3>
                    <div class="space-y-4">
                        <p class="text-slate-600">La IA puede buscar información adicional en internet para complementar su conocimiento sobre:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Nuevas tecnologías CNC</span>
                            </div>
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Tendencias de automatización</span>
                            </div>
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Materiales y aleaciones</span>
                            </div>
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Mejores prácticas industriales</span>
                            </div>
                        </div>
                        <button id="enable-web-search" class="modern-button">
                            <i class="fas fa-globe mr-2"></i>
                            Activar Búsqueda Web
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Tab -->
        <div id="whatsapp-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Notification Methods Selection -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-bell text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Métodos de Notificación</h3>
                            <p class="text-slate-600">Elige cómo quieres recibir los recordatorios</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="notification-method-card" data-method="whatsapp-business">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mb-3">
                                <i class="fab fa-whatsapp text-green-600 text-xl"></i>
                            </div>
                            <h4 class="font-semibold text-slate-800 mb-2">WhatsApp Business</h4>
                            <p class="text-sm text-slate-600 mb-3">API oficial para empresas</p>
                            <div class="flex items-center">
                                <input type="radio" name="notification-method" value="whatsapp-business" class="mr-2">
                                <span class="text-sm text-slate-700">Seleccionar</span>
                            </div>
                        </div>
                        
                        <div class="notification-method-card" data-method="whatsapp-web">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mb-3">
                                <i class="fab fa-whatsapp text-green-600 text-xl"></i>
                            </div>
                            <h4 class="font-semibold text-slate-800 mb-2">WhatsApp Web (GRATIS)</h4>
                            <p class="text-sm text-slate-600 mb-3">Envío directo sin API</p>
                            <div class="flex items-center">
                                <input type="radio" name="notification-method" value="whatsapp-web" class="mr-2">
                                <span class="text-sm text-slate-700">Seleccionar</span>
                            </div>
                        </div>
                        
                        <div class="notification-method-card" data-method="email">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mb-3">
                                <i class="fas fa-envelope text-blue-600 text-xl"></i>
                            </div>
                            <h4 class="font-semibold text-slate-800 mb-2">Email</h4>
                            <p class="text-sm text-slate-600 mb-3">Notificaciones por correo</p>
                            <div class="flex items-center">
                                <input type="radio" name="notification-method" value="email" class="mr-2">
                                <span class="text-sm text-slate-700">Seleccionar</span>
                            </div>
                        </div>
                        
                        <div class="notification-method-card" data-method="browser">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-3">
                                <i class="fas fa-bell text-purple-600 text-xl"></i>
                            </div>
                            <h4 class="font-semibold text-slate-800 mb-2">Navegador</h4>
                            <p class="text-sm text-slate-600 mb-3">Notificaciones push</p>
                            <div class="flex items-center">
                                <input type="radio" name="notification-method" value="browser" class="mr-2">
                                <span class="text-sm text-slate-700">Seleccionar</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Business Configuration -->
                <div id="whatsapp-business-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fab fa-whatsapp text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">WhatsApp Business API</h3>
                            <p class="text-slate-600">Configuración para empresas con API oficial</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- WhatsApp Business API Setup -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración de API</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Token de Acceso</label>
                                    <input type="password" id="whatsapp-token" class="modern-input w-full" placeholder="Ingresa tu token de WhatsApp Business API">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Número de Teléfono ID</label>
                                    <input type="text" id="whatsapp-phone-id" class="modern-input w-full" placeholder="ID del número de teléfono">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Número de Verificación</label>
                                    <input type="text" id="whatsapp-verify-token" class="modern-input w-full" placeholder="Token de verificación">
                                </div>
                                <button id="test-whatsapp-connection" class="modern-button w-full">
                                    <i class="fab fa-whatsapp mr-2"></i>
                                    Probar Conexión
                                </button>
                            </div>
                        </div>
                        
                        <!-- Team Members Configuration -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Miembros del Equipo</h4>
                            <div class="space-y-4">
                                <div id="team-members-whatsapp" class="space-y-3">
                                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-green-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-slate-800">Juan Pérez</h5>
                                                <p class="text-sm text-slate-600">+52 555 123 4567</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" class="whatsapp-notifications" checked>
                                                <span class="ml-2 text-sm text-slate-600">Notificaciones</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-green-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-slate-800">María García</h5>
                                                <p class="text-sm text-slate-600">+52 555 987 6543</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" class="whatsapp-notifications" checked>
                                                <span class="ml-2 text-sm text-slate-600">Notificaciones</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <button id="add-team-member" class="modern-button w-full">
                                    <i class="fas fa-plus mr-2"></i>
                                    Agregar Miembro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Web Configuration -->
                <div id="whatsapp-web-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fab fa-whatsapp text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">WhatsApp Web (GRATIS)</h3>
                            <p class="text-slate-600">Envío directo sin necesidad de API - 100% Gratuito</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-green-800 mb-2">¡Completamente Gratuito!</h4>
                                    <p class="text-sm text-green-700">No necesitas API ni tokens. El sistema genera enlaces directos de WhatsApp que se abren automáticamente con el mensaje pre-escrito.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración Simple</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Tu Número de WhatsApp</label>
                                        <input type="text" id="whatsapp-web-number" class="modern-input w-full" placeholder="+52 555 123 4567" value="+52">
                                        <p class="text-xs text-slate-500 mt-1">Incluye código de país (ej: +52 para México)</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Mensaje Personalizado</label>
                                        <textarea id="whatsapp-web-intro" rows="3" class="modern-input w-full" placeholder="Hola! Te envío un recordatorio importante del taller...">Hola! Te envío un recordatorio importante del taller:</textarea>
                                    </div>
                                    <button id="test-whatsapp-web" class="modern-button w-full">
                                        <i class="fab fa-whatsapp mr-2"></i>
                                        Probar WhatsApp Web
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Vista Previa</h4>
                                <div class="bg-slate-50 p-4 rounded-lg">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                            <i class="fab fa-whatsapp text-white text-sm"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                                <p class="text-sm text-slate-800">
                                                    <strong>Enlace generado:</strong><br>
                                                    <code class="text-xs bg-slate-100 p-1 rounded">https://wa.me/525551234567?text=...</code>
                                                </p>
                                                <p class="text-xs text-slate-600 mt-2">
                                                    Al hacer clic, se abrirá WhatsApp Web/App con el mensaje listo para enviar.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h5 class="font-semibold text-slate-700 mb-2">Ventajas:</h5>
                                    <ul class="text-sm text-slate-600 space-y-1">
                                        <li>• ✅ 100% Gratuito</li>
                                        <li>• ✅ No requiere API</li>
                                        <li>• ✅ Funciona en móviles</li>
                                        <li>• ✅ Compatible con todos los dispositivos</li>
                                        <li>• ✅ Envío instantáneo</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Configuration -->
                <div id="email-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-envelope text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Notificaciones por Email</h3>
                            <p class="text-slate-600">Configura el envío de recordatorios por correo electrónico</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración SMTP</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Servidor SMTP</label>
                                        <input type="text" id="smtp-server" class="modern-input w-full" placeholder="smtp.gmail.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Puerto</label>
                                        <input type="number" id="smtp-port" class="modern-input w-full" placeholder="587" value="587">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Email de Envío</label>
                                        <input type="email" id="smtp-email" class="modern-input w-full" placeholder="taller@empresa.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Contraseña</label>
                                        <input type="password" id="smtp-password" class="modern-input w-full" placeholder="Contraseña de aplicación">
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Plantilla de Email</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Asunto</label>
                                        <input type="text" id="email-subject" class="modern-input w-full" placeholder="Recordatorio de Proyecto - PO #{{PO_NUMBER}}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Mensaje</label>
                                        <textarea id="email-template" rows="6" class="modern-input w-full" placeholder="Estimado equipo,&#10;&#10;El proyecto PO #{{PO_NUMBER}} vence el {{DUE_DATE}}.&#10;Descripción: {{PROJECT_DESCRIPTION}}&#10;&#10;Saludos,&#10;Sistema de Recordatorios"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button id="test-email" class="modern-button">
                                <i class="fas fa-envelope mr-2"></i>
                                Probar Email
                            </button>
                            <button id="save-email-config" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-save mr-2"></i>
                                Guardar Configuración
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Browser Notifications Configuration -->
                <div id="browser-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-bell text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Notificaciones del Navegador</h3>
                            <p class="text-slate-600">Notificaciones push nativas del navegador</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Ventajas de las Notificaciones del Navegador</h4>
                                    <ul class="text-sm text-blue-700 space-y-1">
                                        <li>• No requiere configuración adicional</li>
                                        <li>• Funciona en todos los dispositivos</li>
                                        <li>• Notificaciones nativas del sistema</li>
                                        <li>• Gratuito y fácil de usar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Estado de Permisos</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <i class="fas fa-bell text-purple-600 mr-3"></i>
                                            <span class="text-sm font-medium text-slate-800">Notificaciones</span>
                                        </div>
                                        <span id="notification-permission-status" class="text-xs px-2 py-1 rounded">Verificando...</span>
                                    </div>
                                    
                                    <button id="request-notification-permission" class="modern-button w-full">
                                        <i class="fas fa-key mr-2"></i>
                                        Solicitar Permisos
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-700">Sonido de notificación</span>
                                        <input type="checkbox" id="notification-sound" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-700">Vibrar en móvil</span>
                                        <input type="checkbox" id="notification-vibrate" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-700">Mostrar siempre</span>
                                        <input type="checkbox" id="notification-persistent" class="rounded">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-2">Vista Previa</h4>
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-bell text-white text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-800">Recordatorio de Proyecto</p>
                                    <p class="text-xs text-slate-600">PO #12345 vence mañana - Taller de Torno CNC</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reminder Templates -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Plantillas de Recordatorios</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Recordatorio de Vencimiento</h4>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fab fa-whatsapp text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <p class="text-sm text-slate-800">
                                                🚨 <strong>Recordatorio de Proyecto</strong><br>
                                                PO #{{PO_NUMBER}} vence {{DUE_DATE}}<br>
                                                {{PROJECT_DESCRIPTION}}<br>
                                                <em>Taller de Torno CNC</em>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="modern-button w-full" onclick="editTemplate('due')">
                                <i class="fas fa-edit mr-2"></i>
                                Editar Plantilla
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Proyecto Atrasado</h4>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fab fa-whatsapp text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <p class="text-sm text-slate-800">
                                                ⚠️ <strong>PROYECTO ATRASADO</strong><br>
                                                PO #{{PO_NUMBER}} - {{DAYS_OVERDUE}} días atrasado<br>
                                                {{PROJECT_DESCRIPTION}}<br>
                                                <em>Acción requerida inmediatamente</em>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="modern-button w-full" onclick="editTemplate('overdue')">
                                <i class="fas fa-edit mr-2"></i>
                                Editar Plantilla
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reminder Schedule -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Programación de Recordatorios</h3>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-clock text-blue-600 text-xl mr-3"></i>
                                    <h4 class="font-semibold text-blue-800">Recordatorio Temprano</h4>
                                </div>
                                <p class="text-sm text-blue-700 mb-4">7 días antes del vencimiento</p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="early-reminder" checked class="mr-2">
                                    <label for="early-reminder" class="text-sm text-blue-700">Activar</label>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-200">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3"></i>
                                    <h4 class="font-semibold text-yellow-800">Recordatorio Urgente</h4>
                                </div>
                                <p class="text-sm text-yellow-700 mb-4">1 día antes del vencimiento</p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="urgent-reminder" checked class="mr-2">
                                    <label for="urgent-reminder" class="text-sm text-yellow-700">Activar</label>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-times-circle text-red-600 text-xl mr-3"></i>
                                    <h4 class="font-semibold text-red-800">Proyecto Atrasado</h4>
                                </div>
                                <p class="text-sm text-red-700 mb-4">Inmediatamente al vencerse</p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="overdue-reminder" checked class="mr-2">
                                    <label for="overdue-reminder" class="text-sm text-red-700">Activar</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-6 rounded-xl">
                            <h4 class="font-semibold text-slate-800 mb-4">Horarios de Envío</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Hora de Inicio</label>
                                    <input type="time" id="start-time" value="08:00" class="modern-input w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Hora de Fin</label>
                                    <input type="time" id="end-time" value="18:00" class="modern-input w-full">
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Los recordatorios solo se enviarán durante estas horas</p>
                        </div>
                    </div>
                </div>

                <!-- Test Notifications -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Probar Notificaciones</h3>
                    <div class="space-y-4">
                        <p class="text-slate-600">Envía un mensaje de prueba a todos los miembros del equipo</p>
                        <div class="flex space-x-4">
                            <button id="test-all-notifications" class="modern-button">
                                <i class="fab fa-whatsapp mr-2"></i>
                                Probar a Todos
                            </button>
                            <button id="test-specific-member" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-user mr-2"></i>
                                Probar Miembro Específico
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notification History -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Historial de Notificaciones</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-800">Recordatorio enviado</p>
                                    <p class="text-sm text-slate-600">PO #12345 - Juan Pérez - Hace 2 horas</p>
                                </div>
                            </div>
                            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded">Enviado</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-clock text-yellow-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-800">Recordatorio programado</p>
                                    <p class="text-sm text-slate-600">PO #12346 - María García - Mañana 8:00 AM</p>
                                </div>
                            </div>
                            <span class="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded">Programado</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-times-circle text-red-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-800">Error de envío</p>
                                    <p class="text-sm text-slate-600">PO #12347 - Carlos López - Hace 1 hora</p>
                                </div>
                            </div>
                            <span class="text-xs text-red-600 bg-red-100 px-2 py-1 rounded">Error</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buyers Tab -->
        <div id="buyers-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Header Section -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-teal-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-shopping-cart text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Portal de Compradores</h3>
                            <p class="text-slate-600">Información de proveedores y gestión de compras</p>
                        </div>
                    </div>
                </div>

                <!-- Suppliers Information -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-slate-800">Información de Proveedores</h3>
                        <button id="add-supplier-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-300 flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Agregar Proveedor
                        </button>
                    </div>
                    
                    <div id="suppliers-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Supplier Card 1 -->
                        <div id="supplier-1" class="bg-white rounded-xl p-6 border border-slate-200 hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-industry text-blue-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-slate-800">Proveedor A</h4>
                                    <p class="text-sm text-slate-600">Materiales Industriales</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Contacto:</span>
                                    <span class="font-medium">Juan Pérez</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Teléfono:</span>
                                    <span class="font-medium">+1 234-567-8900</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Email:</span>
                                    <span class="font-medium">juan@proveedora.com</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Tiempo de entrega:</span>
                                    <span class="font-medium text-green-600">3-5 días</span>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-200">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">Calificación:</span>
                                    <div class="flex items-center">
                                        <div class="flex text-yellow-400">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                        </div>
                                        <span class="ml-2 text-sm font-medium">4.8</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Supplier Card 2 -->
                        <div id="supplier-2" class="bg-white rounded-xl p-6 border border-slate-200 hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-tools text-green-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-slate-800">Proveedor B</h4>
                                    <p class="text-sm text-slate-600">Herramientas y Equipos</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Contacto:</span>
                                    <span class="font-medium">María García</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Teléfono:</span>
                                    <span class="font-medium">+1 234-567-8901</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Email:</span>
                                    <span class="font-medium">maria@proveedorb.com</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Tiempo de entrega:</span>
                                    <span class="font-medium text-green-600">2-4 días</span>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-200">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">Calificación:</span>
                                    <div class="flex items-center">
                                        <div class="flex text-yellow-400">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="far fa-star"></i>
                                        </div>
                                        <span class="ml-2 text-sm font-medium">4.2</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Supplier Card 3 -->
                        <div id="supplier-3" class="bg-white rounded-xl p-6 border border-slate-200 hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-cogs text-purple-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-slate-800">Proveedor C</h4>
                                    <p class="text-sm text-slate-600">Componentes Electrónicos</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Contacto:</span>
                                    <span class="font-medium">Carlos López</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Teléfono:</span>
                                    <span class="font-medium">+1 234-567-8902</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Email:</span>
                                    <span class="font-medium">carlos@proveedorc.com</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Tiempo de entrega:</span>
                                    <span class="font-medium text-orange-600">5-7 días</span>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-200">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">Calificación:</span>
                                    <div class="flex items-center">
                                        <div class="flex text-yellow-400">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                        </div>
                                        <span class="ml-2 text-sm font-medium">4.9</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purchase Orders -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Órdenes de Compra Recientes</h3>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-slate-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">PO #</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Proveedor</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Fecha</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Estado</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-slate-100 hover:bg-slate-50">
                                    <td class="py-3 px-4 font-medium text-blue-600">PO-2024-001</td>
                                    <td class="py-3 px-4">Proveedor A</td>
                                    <td class="py-3 px-4">15/01/2024</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Entregado</span>
                                    </td>
                                    <td class="py-3 px-4 font-semibold">$2,500.00</td>
                                </tr>
                                <tr class="border-b border-slate-100 hover:bg-slate-50">
                                    <td class="py-3 px-4 font-medium text-blue-600">PO-2024-002</td>
                                    <td class="py-3 px-4">Proveedor B</td>
                                    <td class="py-3 px-4">18/01/2024</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">En Tránsito</span>
                                    </td>
                                    <td class="py-3 px-4 font-semibold">$1,800.00</td>
                                </tr>
                                <tr class="border-b border-slate-100 hover:bg-slate-50">
                                    <td class="py-3 px-4 font-medium text-blue-600">PO-2024-003</td>
                                    <td class="py-3 px-4">Proveedor C</td>
                                    <td class="py-3 px-4">20/01/2024</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">Procesando</span>
                                    </td>
                                    <td class="py-3 px-4 font-semibold">$3,200.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Acciones Rápidas</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button id="new-order-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors duration-300 flex items-center justify-center">
                            <i class="fas fa-plus mr-2"></i>
                            Nueva Orden
                        </button>
                        <button id="search-supplier-btn" class="bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors duration-300 flex items-center justify-center">
                            <i class="fas fa-search mr-2"></i>
                            Buscar Proveedor
                        </button>
                        <button id="view-invoices-btn" class="bg-purple-500 hover:bg-purple-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors duration-300 flex items-center justify-center">
                            <i class="fas fa-file-invoice mr-2"></i>
                            Ver Facturas
                        </button>
                        <button id="reports-btn" class="bg-orange-500 hover:bg-orange-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors duration-300 flex items-center justify-center">
                            <i class="fas fa-chart-bar mr-2"></i>
                            Reportes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- General Settings Header -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-cog text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Configuraciones Generales</h3>
                            <p class="text-slate-600">Personaliza tu Cerebro de Proyectos IA para tu taller</p>
                        </div>
                    </div>
                </div>

                <!-- Workshop Information -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Información del Taller</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Nombre del Taller</label>
                                <input type="text" id="workshop-name" class="modern-input w-full" placeholder="Taller de Torno CNC Emilio" value="Taller de Torno CNC Emilio">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Dirección</label>
                                <textarea id="workshop-address" rows="3" class="modern-input w-full" placeholder="Calle, Colonia, Ciudad, Estado, CP"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                                <input type="tel" id="workshop-phone" class="modern-input w-full" placeholder="+52 555 123 4567">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                <input type="email" id="workshop-email" class="modern-input w-full" placeholder="taller@empresa.com">
                            </div>
                        </div>
                        
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Capacidades del Taller</label>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Flujo de Trabajo Integrado</h4>
                                    <p class="text-sm text-blue-700">Los proyectos utilizan <strong>torno CNC, fresadora y automatización</strong> en conjunto para crear piezas completas y sistemas integrados.</p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-integrated" checked class="mr-2 rounded" disabled>
                                <span class="text-sm text-slate-700 font-medium">Proyectos Integrados (Torno + Fresado + Automatización)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-prototyping" class="mr-2 rounded">
                                <span class="text-sm text-slate-700">Prototipado Rápido</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-maintenance" class="mr-2 rounded">
                                <span class="text-sm text-slate-700">Mantenimiento Especializado</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-custom" class="mr-2 rounded">
                                <span class="text-sm text-slate-700">Desarrollo a Medida</span>
                            </label>
                        </div>
                    </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Capacidad de Producción</label>
                                <select id="production-capacity" class="modern-input w-full">
                                    <option value="small">Pequeña (1-10 proyectos/mes)</option>
                                    <option value="medium" selected>Mediana (10-50 proyectos/mes)</option>
                                    <option value="large">Grande (50+ proyectos/mes)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Zona Horaria</label>
                                <select id="timezone" class="modern-input w-full">
                                    <option value="America/Mexico_City" selected>México Central (GMT-6)</option>
                                    <option value="America/Mexico_City">México Pacífico (GMT-7)</option>
                                    <option value="America/New_York">Este (GMT-5)</option>
                                    <option value="America/Los_Angeles">Oeste (GMT-8)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Project Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Configuraciones de Proyectos</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Prefijo de PO</label>
                                <input type="text" id="po-prefix" class="modern-input w-full" placeholder="PO" value="PO">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Formato de Numeración</label>
                                <select id="po-format" class="modern-input w-full">
                                    <option value="sequential" selected>Secuencial (PO-001, PO-002...)</option>
                                    <option value="year-month">Año-Mes (PO-2024-01-001)</option>
                                    <option value="year-only">Solo Año (PO-2024-001)</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            <div id="custom-format-container" class="hidden">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Formato Personalizado</label>
                                <input type="text" id="custom-po-format" class="modern-input w-full" placeholder="PO-{YYYY}-{MM}-{###}">
                                <p class="text-xs text-slate-500 mt-1">Usa {YYYY} para año, {MM} para mes, {###} para número secuencial</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Días de Aviso por Defecto</label>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Temprano</label>
                                        <input type="number" id="early-warning-days" class="modern-input w-full" value="7" min="1" max="30">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Urgente</label>
                                        <input type="number" id="urgent-warning-days" class="modern-input w-full" value="1" min="0" max="7">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Crítico</label>
                                        <input type="number" id="critical-warning-days" class="modern-input w-full" value="0" min="0" max="3">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Tipos de Proyectos Integrados</label>
                                <div class="space-y-2" id="project-categories">
                                    <div class="flex items-center space-x-2">
                                        <input type="text" class="modern-input flex-1" placeholder="Nuevo tipo de proyecto" id="new-category">
                                        <button id="add-category" class="modern-button px-4 py-2">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="space-y-1" id="categories-list">
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Sistema Mecánico Completo</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Piezas de Precisión</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Automatización Industrial</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Prototipo Integrado</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Etapas del Proyecto Integrado</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-planning" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Planificación</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-turning" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Torneado CNC</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-milling" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Fresado</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-automation" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Integración Automatización</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-testing" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Pruebas y Calibración</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-completed" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Completado</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-cancelled" class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Cancelado</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Configuraciones de Notificaciones</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Horario de Trabajo</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Inicio</label>
                                        <input type="time" id="work-start-time" class="modern-input w-full" value="08:00">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Fin</label>
                                        <input type="time" id="work-end-time" class="modern-input w-full" value="18:00">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Días de Trabajo</label>
                                <div class="grid grid-cols-7 gap-2">
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-monday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">L</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-tuesday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">M</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-wednesday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">X</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-thursday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">J</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-friday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">V</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-saturday" class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">S</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-sunday" class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">D</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Frecuencia de Verificación</label>
                                <select id="check-frequency" class="modern-input w-full">
                                    <option value="15">Cada 15 minutos</option>
                                    <option value="30" selected>Cada 30 minutos</option>
                                    <option value="60">Cada hora</option>
                                    <option value="120">Cada 2 horas</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Tipos de Recordatorios</label>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <h4 class="font-medium text-slate-800">Email</h4>
                                            <p class="text-sm text-slate-600">Notificaciones por correo</p>
                                        </div>
                                        <input type="checkbox" id="reminder-email" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <h4 class="font-medium text-slate-800">WhatsApp</h4>
                                            <p class="text-sm text-slate-600">Mensajes de WhatsApp</p>
                                        </div>
                                        <input type="checkbox" id="reminder-whatsapp" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <h4 class="font-medium text-slate-800">Navegador</h4>
                                            <p class="text-sm text-slate-600">Notificaciones push</p>
                                        </div>
                                        <input type="checkbox" id="reminder-browser" checked class="rounded">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Configuración de Sonido</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="sound-enabled" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Activar sonidos</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="sound-vibrate" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Vibrar en móvil</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Configuraciones de IA</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Nivel de Aprendizaje</label>
                                <select id="ai-learning-level" class="modern-input w-full">
                                    <option value="basic">Básico</option>
                                    <option value="intermediate" selected>Intermedio</option>
                                    <option value="advanced">Avanzado</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Frecuencia de Análisis</label>
                                <select id="ai-analysis-frequency" class="modern-input w-full">
                                    <option value="immediate" selected>Inmediato</option>
                                    <option value="hourly">Cada hora</option>
                                    <option value="daily">Diario</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Precisión de Predicciones</label>
                                <div class="space-y-2">
                                    <input type="range" id="ai-precision" min="50" max="95" value="80" class="w-full">
                                    <div class="flex justify-between text-xs text-slate-600">
                                        <span>50% (Rápido)</span>
                                        <span id="precision-value">80%</span>
                                        <span>95% (Preciso)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Características de IA</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-pattern-recognition" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Reconocimiento de patrones</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-duration-prediction" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Predicción de duración</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-risk-analysis" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Análisis de riesgos</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-optimization" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Optimización de recursos</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Idioma de Respuestas</label>
                                <select id="ai-language" class="modern-input w-full">
                                    <option value="es" selected>Español</option>
                                    <option value="en">English</option>
                                    <option value="auto">Automático</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup and Export -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Respaldo y Exportación</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-4">Exportar Datos</h4>
                                <div class="space-y-3">
                                    <button id="export-projects" class="modern-button w-full">
                                        <i class="fas fa-download mr-2"></i>
                                        Exportar Proyectos (CSV)
                                    </button>
                                    <button id="export-settings" class="modern-button w-full">
                                        <i class="fas fa-cog mr-2"></i>
                                        Exportar Configuraciones (JSON)
                                    </button>
                                    <button id="export-knowledge" class="modern-button w-full">
                                        <i class="fas fa-database mr-2"></i>
                                        Exportar Base de Conocimiento
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-4">Importar Datos</h4>
                                <div class="space-y-3">
                                    <input type="file" id="import-file" accept=".json,.csv" class="hidden">
                                    <button id="import-data" class="modern-button w-full">
                                        <i class="fas fa-upload mr-2"></i>
                                        Importar Datos
                                    </button>
                                    <button id="reset-settings" class="modern-button w-full bg-red-600 hover:bg-red-700">
                                        <i class="fas fa-undo mr-2"></i>
                                        Restablecer Configuraciones
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Guardar Configuraciones</h3>
                            <p class="text-slate-600">Tus configuraciones se guardan automáticamente</p>
                        </div>
                        <div class="flex space-x-4">
                            <button id="save-all-settings" class="modern-button">
                                <i class="fas fa-save mr-2"></i>
                                Guardar Todo
                            </button>
                            <button id="reset-to-defaults" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-undo mr-2"></i>
                                Restablecer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Interface -->
    <div id="ai-chat" class="ai-chat">
        <div class="ai-chat-header">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h3 class="font-semibold">Asistente IA</h3>
                    <p class="text-sm opacity-90">Tu cerebro de gestión de proyectos</p>
                </div>
            </div>
            <button id="close-ai-chat" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ai-messages" id="ai-messages">
            <div class="ai-message bot">
                <div class="ai-message-content">
                    <p>¡Hola! Soy tu asistente de proyectos IA. Puedo ayudarte con:</p>
                    <ul class="mt-2 text-sm">
                        <li>• Análisis de proyectos e insights</li>
                        <li>• Predicciones de fechas límite</li>
                        <li>• Optimización de recursos</li>
                        <li>• Evaluación de riesgos</li>
                    </ul>
                    <p class="mt-2">¿Qué te gustaría saber sobre tus proyectos?</p>
                </div>
            </div>
        </div>
        <div class="ai-input-container">
            <input type="text" id="ai-input" class="ai-input" placeholder="Pregúntame cualquier cosa sobre tus proyectos...">
        </div>
    </div>

    <!-- AI Chat Toggle Button -->
    <button id="ai-chat-toggle" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-purple-500 to-blue-500 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center z-50">
        <i class="fas fa-robot text-xl"></i>
    </button>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-workshop-bot';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let projectsCollection;
        let allProjects = [];
        let aiLearningData = {
            projectPatterns: {},
            completionTimes: {},
            efficiencyScore: 0,
            insights: [],
            predictions: []
        };

        // --- DOM Elements ---
        const addProjectForm = document.getElementById('add-project-form');
        const smartEntryTextarea = document.getElementById('smart-entry');
        const poNumberInput = document.getElementById('po-number');
        const projectDescriptionInput = document.getElementById('project-description');
        const dueDateInput = document.getElementById('due-date');
        const projectList = document.getElementById('project-list');
        const noProjectsMessage = document.getElementById('no-projects-message');
        const loadingSpinner = document.getElementById('loading-spinner');

        // New DOM elements
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const aiChat = document.getElementById('ai-chat');
        const aiChatToggle = document.getElementById('ai-chat-toggle');
        const closeAiChat = document.getElementById('close-ai-chat');
        
        // Login system elements
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginSubmit = document.getElementById('login-submit');
        const loginError = document.getElementById('login-error');
        const loginErrorText = document.getElementById('login-error-text');
        const logoutBtn = document.getElementById('logout-btn');
        
        // Supplier system elements
        const addSupplierModal = document.getElementById('add-supplier-modal');
        const addSupplierBtn = document.getElementById('add-supplier-btn');
        const closeSupplierModal = document.getElementById('close-supplier-modal');
        const cancelSupplierBtn = document.getElementById('cancel-supplier');
        const supplierForm = document.getElementById('supplier-form');
        const suppliersContainer = document.getElementById('suppliers-container');
        
        // Quick actions buttons
        const newOrderBtn = document.getElementById('new-order-btn');
        const searchSupplierBtn = document.getElementById('search-supplier-btn');
        const viewInvoicesBtn = document.getElementById('view-invoices-btn');
        const reportsBtn = document.getElementById('reports-btn');
        
        // User state
        let currentUser = null;
        let userRole = null;
        let suppliers = [
            {
                id: 1,
                name: 'Proveedor A',
                category: 'Materiales Industriales',
                contact: 'Juan Pérez',
                phone: '+1 234-567-8900',
                email: 'juan@proveedora.com',
                delivery: '3-5 días',
                rating: 4.8,
                address: 'Calle Industrial 123, Ciudad',
                notes: 'Proveedor confiable'
            },
            {
                id: 2,
                name: 'Proveedor B',
                category: 'Herramientas y Equipos',
                contact: 'María García',
                phone: '+1 234-567-8901',
                email: 'maria@proveedorb.com',
                delivery: '2-4 días',
                rating: 4.2,
                address: 'Avenida Herramientas 456, Ciudad',
                notes: 'Buen servicio técnico'
            },
            {
                id: 3,
                name: 'Proveedor C',
                category: 'Componentes Electrónicos',
                contact: 'Carlos López',
                phone: '+1 234-567-8902',
                email: 'carlos@proveedorc.com',
                delivery: '5-7 días',
                rating: 4.9,
                address: 'Plaza Electrónica 789, Ciudad',
                notes: 'Componentes de alta calidad'
            }
        ];
        const aiInput = document.getElementById('ai-input');
        const aiMessages = document.getElementById('ai-messages');

        // --- AI Learning System ---
        class AILearningSystem {
            constructor() {
                this.patterns = new Map();
                this.insights = [];
                this.predictions = [];
                this.learningProgress = 0;
                this.workshopKnowledge = {
                    capabilities: {
                        cnc_lathe: {
                            axes: 3,
                            max_diameter: 500,
                            precision: 0.01,
                            materials: ['acero', 'aluminio', 'titanio']
                        },
                        milling_machine: {
                            table_size: '1000x500',
                            axes: 4,
                            precision: 0.005,
                            capabilities: ['fresado_3d', 'geometrias_complejas']
                        },
                        automation: {
                            robots: 'KUKA',
                            features: ['carga_automatica', 'vision_inspection', '24_7_operation']
                        }
                    },
                    projectTypes: {
                        lathe: ['ejes_husillos', 'bridas_conexiones', 'tornillos_tuercas', 'piezas_cilindricas'],
                        milling: ['bases_soportes', 'moldes_matrices', 'geometrias_complejas', 'prototipos']
                    },
                    materials: ['acero_inoxidable', 'aluminio', 'titanio', 'aceros_especiales'],
                    tolerances: {
                        standard: 0.01,
                        precision: 0.005,
                        high_precision: 0.001
                    }
                };
                this.webSearchEnabled = false;
            }

            analyzeProject(project) {
                // Analyze project description for patterns
                const description = project.description.toLowerCase();
                const keywords = this.extractKeywords(description);
                
                // Enhanced analysis with workshop knowledge
                const projectType = this.classifyProjectType(description);
                const material = this.identifyMaterial(description);
                const complexity = this.assessComplexity(description, projectType);
                
                keywords.forEach(keyword => {
                    if (!this.patterns.has(keyword)) {
                        this.patterns.set(keyword, {
                            count: 0,
                            avgDuration: 0,
                            completionRate: 0,
                            difficulty: 'medium',
                            projectType: projectType,
                            material: material,
                            complexity: complexity
                        });
                    }
                    
                    const pattern = this.patterns.get(keyword);
                    pattern.count++;
                    
                    // Calculate average duration based on project type and workshop capabilities
                    const estimatedDuration = this.estimateDurationWithWorkshopKnowledge(description, projectType, material, complexity);
                    pattern.avgDuration = (pattern.avgDuration * (pattern.count - 1) + estimatedDuration) / pattern.count;
                });

                this.updateLearningProgress();
                this.generateInsights();
                this.generatePredictions();
            }

            classifyProjectType(description) {
                // Classify based on integrated workflow
                const lowerDesc = description.toLowerCase();
                
                // Integrated projects (most common)
                if (lowerDesc.includes('sistema') || lowerDesc.includes('completo') || lowerDesc.includes('integrado')) {
                    return 'integrated';
                }
                
                // Precision parts that use all tools
                if (lowerDesc.includes('precision') || lowerDesc.includes('tolerancia') || lowerDesc.includes('calibracion')) {
                    return 'precision';
                }
                
                // Automation projects
                if (lowerDesc.includes('automatizacion') || lowerDesc.includes('robot') || lowerDesc.includes('cnc') || 
                    lowerDesc.includes('programacion') || lowerDesc.includes('control')) {
                    return 'automation';
                }
                
                // Prototype development
                if (lowerDesc.includes('prototipo') || lowerDesc.includes('desarrollo') || lowerDesc.includes('prueba')) {
                    return 'prototype';
                }
                
                // Maintenance and repair
                if (lowerDesc.includes('mantenimiento') || lowerDesc.includes('reparacion') || lowerDesc.includes('revision')) {
                    return 'maintenance';
                }
                
                // Default to integrated workflow
                return 'integrated';
            }

            identifyMaterial(description) {
                const materials = this.workshopKnowledge.materials;
                for (const material of materials) {
                    if (description.includes(material.replace('_', ' '))) {
                        return material;
                    }
                }
                return 'unknown';
            }

            assessComplexity(description, projectType) {
                let complexity = 'medium';
                
                // Check for complexity indicators
                if (description.includes('precision') || description.includes('tolerancia') || description.includes('±0.001')) {
                    complexity = 'high';
                } else if (description.includes('simple') || description.includes('basico')) {
                    complexity = 'low';
                }
                
                // Adjust based on project type
                if (projectType === 'automation') complexity = 'high';
                if (projectType === 'lathe' && description.includes('cnc')) complexity = 'high';
                
                return complexity;
            }

            estimateDurationWithWorkshopKnowledge(description, projectType, material, complexity) {
                let baseDays = 5; // Base duration for integrated projects
                
                // Adjust based on integrated project type
                switch (projectType) {
                    case 'integrated':
                        baseDays = 5; // Standard integrated project (torno + fresado + automatización)
                        break;
                    case 'precision':
                        baseDays = 7; // Precision work requires more time
                        break;
                    case 'automation':
                        baseDays = 8; // Complex automation integration
                        break;
                    case 'prototype':
                        baseDays = 6; // Prototype development
                        break;
                    case 'maintenance':
                        baseDays = 3; // Maintenance is usually faster
                        break;
                }
                
                // Adjust based on material (affects all processes)
                if (material === 'titanio') baseDays += 3; // Titanium is harder to work with
                if (material === 'acero_inoxidable') baseDays += 2;
                if (material === 'aluminio') baseDays += 0; // Aluminum is easier
                
                // Adjust based on complexity
                if (complexity === 'high') baseDays += 4; // High complexity affects all stages
                if (complexity === 'low') baseDays = Math.max(2, baseDays - 2);
                
                // Check for specific keywords that affect integrated workflow
                if (description.includes('urgente')) baseDays = Math.max(2, baseDays - 1);
                if (description.includes('prototipo')) baseDays += 2; // Prototypes need more testing
                if (description.includes('serie') || description.includes('lote')) baseDays += 3; // Series require setup time
                if (description.includes('calibracion') || description.includes('pruebas')) baseDays += 2; // Testing phase
                if (description.includes('programacion')) baseDays += 1; // CNC programming time
                
                return baseDays;
            }

            extractKeywords(description) {
                const commonWords = ['for', 'and', 'the', 'with', 'from', 'to', 'of', 'in', 'on', 'at', 'by'];
                return description
                    .split(/\s+/)
                    .filter(word => word.length > 3 && !commonWords.includes(word))
                    .slice(0, 5); // Top 5 keywords
            }

            estimateDuration(description) {
                // Simple duration estimation based on keywords
                let baseDays = 7;
                if (description.includes('flange')) baseDays += 3;
                if (description.includes('complex')) baseDays += 5;
                if (description.includes('urgent')) baseDays -= 2;
                if (description.includes('simple')) baseDays -= 2;
                return baseDays;
            }

            updateLearningProgress() {
                this.learningProgress = Math.min(100, this.patterns.size * 10);
                document.getElementById('ai-learning-progress').style.width = `${this.learningProgress}%`;
                document.getElementById('learning-percentage').textContent = `${this.learningProgress}%`;
            }

            generateInsights() {
                this.insights = [];
                
                // Generate insights based on patterns
                for (const [keyword, data] of this.patterns) {
                    if (data.count > 2) {
                        if (data.avgDuration > 10) {
                            this.insights.push({
                                type: 'warning',
                                message: `Los proyectos con "${keyword}" tienden a tomar ${Math.round(data.avgDuration)} días en promedio. Considera agregar tiempo de buffer.`
                            });
                        }
                        
                        if (data.completionRate > 0.9) {
                            this.insights.push({
                                type: 'success',
                                message: `¡Excelente! Los proyectos con "${keyword}" tienen una tasa de finalización del ${Math.round(data.completionRate * 100)}%.`
                            });
                        }
                    }
                }

                // Update UI with insights
                this.updateInsightsUI();
            }

            generatePredictions() {
                this.predictions = [];
                
                // Predict project success based on patterns
                const upcomingProjects = allProjects.filter(p => {
                    const dueDate = p.dueDate.toDate();
                    const today = new Date();
                    return dueDate > today;
                });

                if (upcomingProjects.length > 0) {
                    const riskProjects = upcomingProjects.filter(p => {
                        const keywords = this.extractKeywords(p.description.toLowerCase());
                        return keywords.some(k => {
                            const pattern = this.patterns.get(k);
                            return pattern && pattern.avgDuration > 10;
                        });
                    });

                    if (riskProjects.length > 0) {
                        this.predictions.push({
                            type: 'warning',
                            message: `${riskProjects.length} proyectos pueden estar en riesgo de retraso basándose en patrones históricos.`
                        });
                    }
                }

                this.updatePredictionsUI();
            }

            updateInsightsUI() {
                const insightElement = document.getElementById('ai-insight-text');
                if (this.insights.length > 0) {
                    insightElement.textContent = this.insights[0].message;
                }
            }

            updatePredictionsUI() {
                const predictionElement = document.getElementById('ai-prediction-text');
                if (this.predictions.length > 0) {
                    predictionElement.textContent = this.predictions[0].message;
                }
            }

            getAIResponse(userMessage) {
                const message = userMessage.toLowerCase();
                
                if (message.includes('proyecto') && (message.includes('estado') || message.includes('status'))) {
                    return `Actualmente tienes ${allProjects.length} proyectos activos. ${allProjects.filter(p => {
                        const dueDate = p.dueDate.toDate();
                        const today = new Date();
                        return dueDate < today;
                    }).length} están atrasados.`;
                }
                
                if (message.includes('taller') || message.includes('capacidades') || message.includes('equipos')) {
                    return `Tu taller cuenta con un flujo de trabajo integrado que combina: Torno CNC de 3 ejes (500mm diámetro), Fresadora vertical (1000x500mm), y Sistema de automatización KUKA. Los proyectos utilizan todas estas herramientas en conjunto para crear sistemas mecánicos completos con precisiones de ±0.01mm.`;
                }
                
                if (message.includes('proyecto') || message.includes('trabajo') || message.includes('orden')) {
                    return `Los proyectos en tu taller siguen un flujo integrado: 1) Planificación, 2) Torneado CNC, 3) Fresado, 4) Integración de automatización, 5) Pruebas y calibración. Cada proyecto utiliza todas las herramientas disponibles para crear sistemas completos y funcionales.`;
                }
                
                if (message.includes('tiempo') || message.includes('duracion') || message.includes('estimacion')) {
                    return `Para proyectos integrados (torno + fresado + automatización): proyectos estándar toman 5-7 días, de precisión 7-9 días, automatización compleja 8-10 días. Los materiales como titanio añaden 3 días, y la complejidad alta +4 días. El tiempo incluye todas las etapas del flujo integrado.`;
                }
                
                if (message.includes('material') || message.includes('aleacion')) {
                    return `Trabajamos con: acero inoxidable, aluminio, titanio, y aceros especiales. El titanio requiere más tiempo de mecanizado (+2 días), mientras que el aluminio es más rápido de procesar.`;
                }
                
                if (message.includes('tiempo') || message.includes('duracion') || message.includes('estimacion')) {
                    return `Basándome en las capacidades de tu taller: proyectos de torno toman 2-3 días, fresado 4-6 días, automatización 7+ días. Los materiales como titanio añaden 2 días, y la complejidad alta +3 días.`;
                }
                
                if (message.includes('insight') || message.includes('análisis') || message.includes('analisis')) {
                    return `Basándome en tus patrones de proyectos y conocimiento del taller, he identificado ${this.patterns.size} patrones clave. Los tipos de proyectos más comunes son: ${Array.from(this.patterns.keys()).slice(0, 3).join(', ')}.`;
                }
                
                if (message.includes('predicción') || message.includes('prediccion') || message.includes('forecast')) {
                    return `Predigo que completarás aproximadamente ${Math.round(allProjects.length * 0.85)} proyectos a tiempo este mes basándome en la carga de trabajo actual, capacidades del taller y datos históricos.`;
                }
                
                if (message.includes('whatsapp') || message.includes('recordatorio') || message.includes('notificacion')) {
                    return `El sistema de WhatsApp está configurado para enviar recordatorios automáticos a tu equipo. Puedes configurar: recordatorios tempranos (7 días antes), urgentes (1 día antes), y para proyectos atrasados. Los mensajes se envían solo en horario laboral (8:00-18:00).`;
                }
                
                if (message.includes('ayuda') || message.includes('help') || message.includes('qué puedes hacer') || message.includes('que puedes hacer')) {
                    return `Puedo ayudarte con: análisis de proyectos específicos de tu taller (torno, fresado, automatización), predicciones de tiempos basadas en equipos CNC, identificación de materiales y complejidad, optimización de recursos, insights sobre patrones de trabajo industrial, y gestión de recordatorios por WhatsApp para tu equipo. ¿Qué te gustaría saber?`;
                }
                
                return `Entiendo que estás preguntando sobre "${userMessage}". Basándome en el conocimiento de tu taller de torno con fresadora y automatización, puedo proporcionar insights específicos sobre proyectos CNC, tiempos de producción, materiales, y capacidades. ¿Podrías ser más específico?`;
            }
        }

        const aiSystem = new AILearningSystem();

        // --- WhatsApp Manager System ---
        class WhatsAppManager {
            constructor() {
                this.apiToken = '';
                this.phoneId = '';
                this.verifyToken = '';
                this.teamMembers = [
                    { name: 'Juan Pérez', phone: '+525551234567', notifications: true },
                    { name: 'María García', phone: '+525559876543', notifications: true }
                ];
                this.templates = {
                    due: {
                        title: 'Recordatorio de Vencimiento',
                        message: '🚨 *Recordatorio de Proyecto*\nPO #{{PO_NUMBER}} vence {{DUE_DATE}}\n{{PROJECT_DESCRIPTION}}\n_Taller de Torno CNC_'
                    },
                    overdue: {
                        title: 'Proyecto Atrasado',
                        message: '⚠️ *PROYECTO ATRASADO*\nPO #{{PO_NUMBER}} - {{DAYS_OVERDUE}} días atrasado\n{{PROJECT_DESCRIPTION}}\n_Acción requerida inmediatamente_'
                    },
                    completed: {
                        title: 'Proyecto Completado',
                        message: '✅ *Proyecto Completado*\nPO #{{PO_NUMBER}} finalizado exitosamente\n{{PROJECT_DESCRIPTION}}\n_¡Excelente trabajo!_'
                    }
                };
                this.reminderSettings = {
                    early: { enabled: true, days: 7 },
                    urgent: { enabled: true, days: 1 },
                    overdue: { enabled: true, days: 0 },
                    startTime: '08:00',
                    endTime: '18:00'
                };
                this.notificationHistory = [];
            }

            setCredentials(token, phoneId, verifyToken) {
                this.apiToken = token;
                this.phoneId = phoneId;
                this.verifyToken = verifyToken;
            }

            async sendMessage(phoneNumber, message) {
                if (!this.apiToken || !this.phoneId) {
                    throw new Error('WhatsApp API no configurada');
                }

                const url = `https://graph.facebook.com/v18.0/${this.phoneId}/messages`;
                const payload = {
                    messaging_product: 'whatsapp',
                    to: phoneNumber,
                    type: 'text',
                    text: { body: message }
                };

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error.message);
                    }

                    return result;
                } catch (error) {
                    console.error('Error enviando mensaje WhatsApp:', error);
                    throw error;
                }
            }

            formatMessage(template, project) {
                let message = template.message;
                const dueDate = project.dueDate.toDate();
                const today = new Date();
                const diffDays = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                
                message = message.replace('{{PO_NUMBER}}', project.poNumber);
                message = message.replace('{{PROJECT_DESCRIPTION}}', project.description);
                message = message.replace('{{DUE_DATE}}', dueDate.toLocaleDateString('es-ES'));
                message = message.replace('{{DAYS_OVERDUE}}', Math.abs(diffDays));
                
                return message;
            }

            async sendProjectReminder(project, reminderType) {
                const template = this.templates[reminderType];
                if (!template) return;

                const message = this.formatMessage(template, project);
                const results = [];

                for (const member of this.teamMembers) {
                    if (member.notifications) {
                        try {
                            const result = await this.sendMessage(member.phone, message);
                            results.push({
                                member: member.name,
                                phone: member.phone,
                                status: 'sent',
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        } catch (error) {
                            results.push({
                                member: member.name,
                                phone: member.phone,
                                status: 'error',
                                error: error.message,
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        }
                    }
                }

                this.notificationHistory.unshift(...results);
                return results;
            }

            checkReminders(projects) {
                const now = new Date();
                const currentHour = now.getHours();
                const startHour = parseInt(this.reminderSettings.startTime.split(':')[0]);
                const endHour = parseInt(this.reminderSettings.endTime.split(':')[0]);

                // Solo enviar recordatorios en horario laboral
                if (currentHour < startHour || currentHour > endHour) {
                    return;
                }

                projects.forEach(project => {
                    const dueDate = project.dueDate.toDate();
                    const diffDays = Math.ceil((dueDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

                    // Recordatorio temprano (7 días antes)
                    if (this.reminderSettings.early.enabled && diffDays === 7) {
                        this.sendProjectReminder(project, 'due');
                    }

                    // Recordatorio urgente (1 día antes)
                    if (this.reminderSettings.urgent.enabled && diffDays === 1) {
                        this.sendProjectReminder(project, 'due');
                    }

                    // Proyecto atrasado
                    if (this.reminderSettings.overdue.enabled && diffDays < 0) {
                        this.sendProjectReminder(project, 'overdue');
                    }
                });
            }

            async testConnection() {
                if (!this.apiToken || !this.phoneId) {
                    throw new Error('Configuración de API incompleta');
                }

                // Test con el primer miembro del equipo
                const testMember = this.teamMembers[0];
                const testMessage = '🧪 *Prueba de Conexión*\nSistema de recordatorios WhatsApp funcionando correctamente.\n_Taller de Torno CNC_';

                return await this.sendMessage(testMember.phone, testMessage);
            }

            addTeamMember(name, phone) {
                this.teamMembers.push({
                    name: name,
                    phone: phone,
                    notifications: true
                });
            }

            updateReminderSettings(settings) {
                this.reminderSettings = { ...this.reminderSettings, ...settings };
            }

            getNotificationHistory() {
                return this.notificationHistory;
            }
        }

        const whatsappManager = new WhatsAppManager();

        // --- Multi-Channel Notification System ---
        class MultiChannelNotificationManager {
            constructor() {
                this.selectedMethod = 'browser'; // Default to browser notifications
                this.emailConfig = {
                    smtpServer: '',
                    smtpPort: 587,
                    email: '',
                    password: '',
                    subject: 'Recordatorio de Proyecto - PO #{{PO_NUMBER}}',
                    template: 'Estimado equipo,\n\nEl proyecto PO #{{PO_NUMBER}} vence el {{DUE_DATE}}.\nDescripción: {{PROJECT_DESCRIPTION}}\n\nSaludos,\nSistema de Recordatorios'
                };
                this.whatsappWebConfig = {
                    mainNumber: '',
                    introMessage: 'Hola! Soy el sistema de recordatorios del taller...'
                };
                this.browserConfig = {
                    sound: true,
                    vibrate: true,
                    persistent: false
                };
            }

            setNotificationMethod(method) {
                this.selectedMethod = method;
            }

            async sendNotification(project, reminderType, teamMembers) {
                const message = this.formatMessage(reminderType, project);
                
                switch (this.selectedMethod) {
                    case 'whatsapp-business':
                        return await whatsappManager.sendProjectReminder(project, reminderType);
                    
                    case 'whatsapp-web':
                        return await this.sendWhatsAppWebNotification(project, message, teamMembers);
                    
                    case 'email':
                        return await this.sendEmailNotification(project, message, teamMembers);
                    
                    case 'browser':
                        return await this.sendBrowserNotification(project, message);
                    
                    default:
                        throw new Error('Método de notificación no válido');
                }
            }

            formatMessage(reminderType, project) {
                const templates = {
                    due: '🚨 *Recordatorio de Proyecto*\nPO #{{PO_NUMBER}} vence {{DUE_DATE}}\n{{PROJECT_DESCRIPTION}}\n_Taller de Torno CNC_',
                    overdue: '⚠️ *PROYECTO ATRASADO*\nPO #{{PO_NUMBER}} - {{DAYS_OVERDUE}} días atrasado\n{{PROJECT_DESCRIPTION}}\n_Acción requerida inmediatamente_',
                    completed: '✅ *Proyecto Completado*\nPO #{{PO_NUMBER}} finalizado exitosamente\n{{PROJECT_DESCRIPTION}}\n_¡Excelente trabajo!_'
                };

                let message = templates[reminderType] || templates.due;
                const dueDate = project.dueDate.toDate();
                const today = new Date();
                const diffDays = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                
                message = message.replace('{{PO_NUMBER}}', project.poNumber);
                message = message.replace('{{PROJECT_DESCRIPTION}}', project.description);
                message = message.replace('{{DUE_DATE}}', dueDate.toLocaleDateString('es-ES'));
                message = message.replace('{{DAYS_OVERDUE}}', Math.abs(diffDays));
                
                return message;
            }

            async sendWhatsAppWebNotification(project, message, teamMembers) {
                const results = [];
                const config = this.getWhatsAppWebConfig();
                const introMessage = config.introMessage || 'Hola! Te envío un recordatorio importante del taller:';
                const fullMessage = `${introMessage}\n\n${message}`;
                const encodedMessage = encodeURIComponent(fullMessage);
                
                for (const member of teamMembers) {
                    if (member.notifications && member.phone) {
                        const cleanPhone = member.phone.replace(/\D/g, '');
                        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
                        
                        // Open WhatsApp Web in new tab
                        window.open(whatsappUrl, '_blank');
                        
                        results.push({
                            member: member.name,
                            phone: member.phone,
                            status: 'opened',
                            timestamp: new Date(),
                            project: project.poNumber,
                            url: whatsappUrl,
                            message: fullMessage
                        });
                        
                        // Small delay between openings to avoid browser blocking
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                return results;
            }

            getWhatsAppWebConfig() {
                return {
                    mainNumber: document.getElementById('whatsapp-web-number')?.value || '+52',
                    introMessage: document.getElementById('whatsapp-web-intro')?.value || 'Hola! Te envío un recordatorio importante del taller:'
                };
            }

            updateWhatsAppWebConfig(config) {
                localStorage.setItem('whatsapp-web-config', JSON.stringify(config));
            }

            loadWhatsAppWebConfig() {
                const saved = localStorage.getItem('whatsapp-web-config');
                if (saved) {
                    const config = JSON.parse(saved);
                    if (document.getElementById('whatsapp-web-number')) {
                        document.getElementById('whatsapp-web-number').value = config.mainNumber || '+52';
                    }
                    if (document.getElementById('whatsapp-web-intro')) {
                        document.getElementById('whatsapp-web-intro').value = config.introMessage || 'Hola! Te envío un recordatorio importante del taller:';
                    }
                }
            }

            async sendEmailNotification(project, message, teamMembers) {
                const results = [];
                
                // This would typically use a backend service to send emails
                // For now, we'll simulate the email sending
                for (const member of teamMembers) {
                    if (member.notifications && member.email) {
                        try {
                            // Simulate email sending
                            console.log(`Sending email to ${member.email}: ${message}`);
                            
                            results.push({
                                member: member.name,
                                email: member.email,
                                status: 'sent',
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        } catch (error) {
                            results.push({
                                member: member.name,
                                email: member.email,
                                status: 'error',
                                error: error.message,
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        }
                    }
                }
                
                return results;
            }

            async sendBrowserNotification(project, message) {
                if (!('Notification' in window)) {
                    throw new Error('Este navegador no soporta notificaciones');
                }

                if (Notification.permission === 'denied') {
                    throw new Error('Permisos de notificación denegados');
                }

                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('Permisos de notificación denegados');
                    }
                }

                const notification = new Notification(`Recordatorio: ${project.poNumber}`, {
                    body: message,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iOCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfMSkiLz4KPHBhdGggZD0iTTMyIDE2QzI0LjI0IDE2IDE4IDIyLjI0IDE4IDMwVjQ2QzE4IDUzLjc2IDI0LjI0IDYwIDMyIDYwQzM5Ljc2IDYwIDQ2IDUzLjc2IDQ2IDQ2VjMwQzQ2IDIyLjI0IDM5Ljc2IDE2IDMyIDE2WiIgZmlsbD0id2hpdGUiLz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwX2xpbmVhcl8xXzEiIHgxPSIwIiB5MT0iMCIgeDI9IjY0IiB5Mj0iNjQiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzY2N2VlYSIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4K',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzNiODJmNiIvPgo8cGF0aCBkPSJNMTYgOEMxMi42ODYgOCAxMCAxMC42ODYgMTAgMTRWMThDMTAgMjEuMzE0IDEyLjY4NiAyNCAxNiAyNEMxOS4zMTQgMjQgMjIgMjEuMzE0IDIyIDE4VjE0QzIyIDEwLjY4NiAxOS4zMTQgOCAxNiA4WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==',
                    tag: `project-${project.poNumber}`,
                    requireInteraction: true,
                    silent: false,
                    vibrate: [200, 100, 200],
                    actions: [
                        {
                            action: 'view',
                            title: 'Ver Proyecto',
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjMzM0MTU1Ii8+Cjwvc3ZnPgo='
                        },
                        {
                            action: 'dismiss',
                            title: 'Descartar',
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE5IDYuNDFMMTcuNTkgNUwxMiAxMC41OUw2LjQxIDVMNSA2LjQxTDEwLjU5IDEyTDUgMTcuNTlMNi40MSAxOUwxMiAxMy40MUwxNy41OSAxOUwxOSAxNy41OUwxMy40MSAxMkwxOSA2LjQxWiIgZmlsbD0iIzMzNDE1NSIvPgo8L3N2Zz4K'
                        }
                    ]
                });

                // Handle notification click
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                    // Switch to projects tab
                    document.querySelector('[data-tab="projects"]').click();
                };

                // Handle notification actions
                notification.addEventListener('notificationclick', (event) => {
                    event.notification.close();
                    
                    if (event.action === 'view') {
                        window.focus();
                        document.querySelector('[data-tab="projects"]').click();
                    }
                });

                // Auto-close after 10 seconds
                setTimeout(() => {
                    notification.close();
                }, 10000);

                return [{
                    member: 'Usuario actual',
                    status: 'sent',
                    timestamp: new Date(),
                    project: project.poNumber
                }];
            }

            updateEmailConfig(config) {
                this.emailConfig = { ...this.emailConfig, ...config };
            }

            updateWhatsAppWebConfig(config) {
                this.whatsappWebConfig = { ...this.whatsappWebConfig, ...config };
            }

            updateBrowserConfig(config) {
                this.browserConfig = { ...this.browserConfig, ...config };
            }
        }

        const multiChannelManager = new MultiChannelNotificationManager();

        // --- Settings Management System ---
        class SettingsManager {
            constructor() {
                this.settings = {
                    workshop: {
                        name: 'Taller de Torno CNC Emilio',
                        address: '',
                        phone: '',
                        email: '',
                        specialties: ['integrated', 'prototyping', 'maintenance', 'custom'],
                        productionCapacity: 'medium',
                        timezone: 'America/Mexico_City'
                    },
                    projects: {
                        poPrefix: 'PO',
                        poFormat: 'sequential',
                        customFormat: 'PO-{YYYY}-{MM}-{###}',
                        warningDays: {
                            early: 7,
                            urgent: 1,
                            critical: 0
                        },
                        categories: ['Sistema Mecánico Completo', 'Piezas de Precisión', 'Automatización Industrial', 'Prototipo Integrado'],
                        statuses: ['planning', 'turning', 'milling', 'automation', 'testing', 'completed']
                    },
                    notifications: {
                        workHours: {
                            start: '08:00',
                            end: '18:00',
                            workdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
                        },
                        checkFrequency: 30, // minutes
                        types: {
                            email: true,
                            whatsapp: true,
                            browser: true
                        },
                        sound: {
                            enabled: true,
                            vibrate: true
                        }
                    },
                    ai: {
                        learningLevel: 'intermediate',
                        analysisFrequency: 'immediate',
                        precision: 80,
                        features: {
                            patternRecognition: true,
                            durationPrediction: true,
                            riskAnalysis: true,
                            optimization: true
                        },
                        language: 'es'
                    }
                };
                this.loadSettings();
            }

            loadSettings() {
                const saved = localStorage.getItem('workshop-settings');
                if (saved) {
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                }
                this.applySettings();
            }

            saveSettings() {
                localStorage.setItem('workshop-settings', JSON.stringify(this.settings));
                this.applySettings();
                showNotification('Configuraciones guardadas exitosamente', 'success');
            }

            applySettings() {
                // Apply workshop settings
                document.getElementById('workshop-name').value = this.settings.workshop.name;
                document.getElementById('workshop-address').value = this.settings.workshop.address;
                document.getElementById('workshop-phone').value = this.settings.workshop.phone;
                document.getElementById('workshop-email').value = this.settings.workshop.email;
                
                // Apply specialties
                this.settings.workshop.specialties.forEach(specialty => {
                    const checkbox = document.getElementById(`specialty-${specialty}`);
                    if (checkbox) checkbox.checked = true;
                });
                
                document.getElementById('production-capacity').value = this.settings.workshop.productionCapacity;
                document.getElementById('timezone').value = this.settings.workshop.timezone;
                
                // Apply project settings
                document.getElementById('po-prefix').value = this.settings.projects.poPrefix;
                document.getElementById('po-format').value = this.settings.projects.poFormat;
                document.getElementById('custom-po-format').value = this.settings.projects.customFormat;
                
                if (this.settings.projects.poFormat === 'custom') {
                    document.getElementById('custom-format-container').classList.remove('hidden');
                }
                
                document.getElementById('early-warning-days').value = this.settings.projects.warningDays.early;
                document.getElementById('urgent-warning-days').value = this.settings.projects.warningDays.urgent;
                document.getElementById('critical-warning-days').value = this.settings.projects.warningDays.critical;
                
                // Apply notification settings
                document.getElementById('work-start-time').value = this.settings.notifications.workHours.start;
                document.getElementById('work-end-time').value = this.settings.notifications.workHours.end;
                
                this.settings.notifications.workHours.workdays.forEach(day => {
                    const checkbox = document.getElementById(`workday-${day}`);
                    if (checkbox) checkbox.checked = true;
                });
                
                document.getElementById('check-frequency').value = this.settings.notifications.checkFrequency;
                
                // Apply AI settings
                document.getElementById('ai-learning-level').value = this.settings.ai.learningLevel;
                document.getElementById('ai-analysis-frequency').value = this.settings.ai.analysisFrequency;
                document.getElementById('ai-precision').value = this.settings.ai.precision;
                document.getElementById('precision-value').textContent = this.settings.ai.precision + '%';
                
                Object.keys(this.settings.ai.features).forEach(feature => {
                    const checkbox = document.getElementById(`ai-${feature.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
                    if (checkbox) checkbox.checked = this.settings.ai.features[feature];
                });
                
                document.getElementById('ai-language').value = this.settings.ai.language;
            }

            updateSetting(path, value) {
                const keys = path.split('.');
                let current = this.settings;
                
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) current[keys[i]] = {};
                    current = current[keys[i]];
                }
                
                current[keys[keys.length - 1]] = value;
                this.saveSettings();
            }

            getSetting(path) {
                const keys = path.split('.');
                let current = this.settings;
                
                for (const key of keys) {
                    if (current[key] === undefined) return null;
                    current = current[key];
                }
                
                return current;
            }

            exportSettings() {
                const dataStr = JSON.stringify(this.settings, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `workshop-settings-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            importSettings(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        this.settings = { ...this.settings, ...imported };
                        this.saveSettings();
                        this.applySettings();
                        showNotification('Configuraciones importadas exitosamente', 'success');
                    } catch (error) {
                        showNotification('Error importando configuraciones: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            }

            resetToDefaults() {
                if (confirm('¿Estás seguro de que quieres restablecer todas las configuraciones a los valores por defecto?')) {
                    localStorage.removeItem('workshop-settings');
                    this.settings = new SettingsManager().settings;
                    this.applySettings();
                    showNotification('Configuraciones restablecidas', 'success');
                }
            }
        }

        const settingsManager = new SettingsManager();

        // --- Knowledge Upload System ---
        function setupKnowledgeUpload() {
            const uploadTextBtn = document.getElementById('upload-text-knowledge');
            const knowledgeText = document.getElementById('knowledge-text');
            const fileInput = document.getElementById('knowledge-files');
            const fileList = document.getElementById('file-list');
            const enableWebSearchBtn = document.getElementById('enable-web-search');

            // Check if elements exist before adding event listeners
            if (!uploadTextBtn || !knowledgeText || !fileInput) {
                console.warn('Knowledge upload elements not found, skipping setup');
                return;
            }

            // Text upload
            uploadTextBtn.addEventListener('click', () => {
                const text = knowledgeText.value.trim();
                if (text) {
                    aiSystem.addKnowledgeFromText(text);
                    knowledgeText.value = '';
                    showNotification('Conocimiento agregado exitosamente! La IA ha aprendido nueva información.', 'success');
                    updateKnowledgeStatus();
                }
            });

            // File upload
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type === 'text/plain' || file.type === 'application/pdf' || 
                        file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        displayFile(file);
                        processFile(file);
                    } else {
                        showNotification('Tipo de archivo no soportado: ' + file.name, 'warning');
                    }
                });
            });

            // Web search toggle (if element exists)
            if (enableWebSearchBtn) {
                enableWebSearchBtn.addEventListener('click', () => {
                    aiSystem.toggleWebSearch();
                    enableWebSearchBtn.textContent = aiSystem.webSearchEnabled ? 
                        'Desactivar Búsqueda Web' : 'Activar Búsqueda Web';
                    showNotification(aiSystem.webSearchEnabled ? 
                        'Búsqueda web activada' : 'Búsqueda web desactivada', 'success');
                });
            }

            function displayFile(file) {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-file text-slate-500 mr-3"></i>
                        <span class="text-sm font-medium">${file.name}</span>
                        <span class="text-xs text-slate-500 ml-2">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin mr-2"></div>
                        <span class="text-xs text-green-600">Procesando...</span>
                    </div>
                `;
                fileList.appendChild(fileItem);
            }

            function processFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    aiSystem.addKnowledgeFromText(content);
                    updateKnowledgeStatus();
                    
                    // Update file display
                    const fileItems = fileList.querySelectorAll('.flex.items-center.justify-between');
                    const lastItem = fileItems[fileItems.length - 1];
                    if (lastItem) {
                        lastItem.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-file text-slate-500 mr-3"></i>
                                <span class="text-sm font-medium">${file.name}</span>
                                <span class="text-xs text-slate-500 ml-2">(${(file.size / 1024).toFixed(1)} KB)</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="text-xs text-green-600">Completado</span>
                            </div>
                        `;
                    }
                };
                reader.readAsText(file);
            }
        }

        // Add methods to AI system
        AILearningSystem.prototype.addKnowledgeFromText = function(text) {
            // Extract key information from text
            const lines = text.split('\n').filter(line => line.trim());
            
            lines.forEach(line => {
                const lowerLine = line.toLowerCase();
                
                // Extract equipment specifications
                if (lowerLine.includes('torno') && lowerLine.includes('cnc')) {
                    this.updateEquipmentKnowledge('cnc_lathe', line);
                }
                if (lowerLine.includes('fresadora') || lowerLine.includes('fresado')) {
                    this.updateEquipmentKnowledge('milling_machine', line);
                }
                if (lowerLine.includes('robot') || lowerLine.includes('automatizacion')) {
                    this.updateEquipmentKnowledge('automation', line);
                }
                
                // Extract material information
                if (lowerLine.includes('material') || lowerLine.includes('aleacion')) {
                    this.updateMaterialKnowledge(line);
                }
                
                // Extract project types
                if (lowerLine.includes('proyecto') || lowerLine.includes('pieza')) {
                    this.updateProjectTypeKnowledge(line);
                }
            });
            
            this.updateLearningProgress();
        };

        AILearningSystem.prototype.updateEquipmentKnowledge = function(equipment, line) {
            // Update equipment knowledge based on new information
            if (!this.workshopKnowledge.capabilities[equipment]) {
                this.workshopKnowledge.capabilities[equipment] = {};
            }
            
            // Extract specifications from line
            const specs = this.extractSpecifications(line);
            Object.assign(this.workshopKnowledge.capabilities[equipment], specs);
        };

        AILearningSystem.prototype.updateMaterialKnowledge = function(line) {
            // Extract materials from line
            const materials = line.match(/\b(acero|aluminio|titanio|inoxidable|bronce|cobre)\b/g);
            if (materials) {
                materials.forEach(material => {
                    if (!this.workshopKnowledge.materials.includes(material)) {
                        this.workshopKnowledge.materials.push(material);
                    }
                });
            }
        };

        AILearningSystem.prototype.updateProjectTypeKnowledge = function(line) {
            // Extract project types from line
            if (line.includes('torno') || line.includes('cilindrico')) {
                this.addProjectType('lathe', line);
            }
            if (line.includes('fresado') || line.includes('mecanizado')) {
                this.addProjectType('milling', line);
            }
        };

        AILearningSystem.prototype.addProjectType = function(type, line) {
            if (!this.workshopKnowledge.projectTypes[type]) {
                this.workshopKnowledge.projectTypes[type] = [];
            }
            
            // Extract project description
            const description = line.replace(/[^\w\s]/g, '').trim();
            if (description && !this.workshopKnowledge.projectTypes[type].includes(description)) {
                this.workshopKnowledge.projectTypes[type].push(description);
            }
        };

        AILearningSystem.prototype.extractSpecifications = function(line) {
            const specs = {};
            
            // Extract dimensions
            const dimensions = line.match(/(\d+)\s*mm/g);
            if (dimensions) {
                specs.dimensions = dimensions;
            }
            
            // Extract precision
            const precision = line.match(/±?(\d+\.?\d*)\s*mm/g);
            if (precision) {
                specs.precision = precision;
            }
            
            // Extract axes
            const axes = line.match(/(\d+)\s*eje/g);
            if (axes) {
                specs.axes = parseInt(axes[0]);
            }
            
            return specs;
        };

        AILearningSystem.prototype.toggleWebSearch = function() {
            this.webSearchEnabled = !this.webSearchEnabled;
        };

        function updateKnowledgeStatus() {
            // Update knowledge status indicators
            const workshopKnowledge = document.getElementById('workshop-knowledge');
            const projectTypesKnowledge = document.getElementById('project-types-knowledge');
            const timingKnowledge = document.getElementById('timing-knowledge');
            
            if (workshopKnowledge) {
                const workshopScore = Math.min(100, Object.keys(aiSystem.workshopKnowledge.capabilities).length * 25);
                workshopKnowledge.textContent = workshopScore + '%';
                workshopKnowledge.parentElement.querySelector('.bg-green-500').style.width = workshopScore + '%';
            }
            
            if (projectTypesKnowledge) {
                const projectTypesScore = Math.min(100, Object.values(aiSystem.workshopKnowledge.projectTypes).flat().length * 10);
                projectTypesKnowledge.textContent = projectTypesScore + '%';
                projectTypesKnowledge.parentElement.querySelector('.bg-blue-500').style.width = projectTypesScore + '%';
            }
            
            if (timingKnowledge) {
                const timingScore = Math.min(100, aiSystem.patterns.size * 15);
                timingKnowledge.textContent = timingScore + '%';
                timingKnowledge.parentElement.querySelector('.bg-purple-500').style.width = timingScore + '%';
            }
        }

        // --- Authentication System ---
        function showLoginModal() {
            loginModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideLoginModal() {
            loginModal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function showLoginError(message) {
            loginErrorText.textContent = message;
            loginError.classList.remove('hidden');
        }

        function hideLoginError() {
            loginError.classList.add('hidden');
        }

        async function loginUser(email, password) {
            try {
                hideLoginError();
                loginSubmit.disabled = true;
                loginSubmit.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Iniciando sesión...';
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Hide login modal
                hideLoginModal();
                
                // Show logout button
                logoutBtn.classList.remove('hidden');
                
                // Store user info
                currentUser = {
                    email: user.email,
                    uid: user.uid,
                    loginTime: new Date()
                };
                
                // Show success message
                showNotification(`Bienvenido, ${user.email}`, 'success');
                
                // Initialize app data
                initializeApp();
                
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Error al iniciar sesión';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No existe una cuenta con este email';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Contraseña incorrecta';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inválido';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Esta cuenta ha sido deshabilitada';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Demasiados intentos fallidos. Intenta más tarde';
                        break;
                    default:
                        errorMessage = 'Error de autenticación. Verifica tus credenciales';
                }
                
                showLoginError(errorMessage);
            } finally {
                loginSubmit.disabled = false;
                loginSubmit.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión';
            }
        }

        async function logoutUser() {
            try {
                await signOut(auth);
                
                // Clear user info
                currentUser = null;
                
                // Hide logout button
                logoutBtn.classList.add('hidden');
                
                // Reset UI
                resetUI();
                
                // Show login modal
                showLoginModal();
                
                showNotification('Sesión cerrada correctamente', 'info');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error al cerrar sesión', 'error');
            }
        }

        function updateUIForRole(role) {
            // Hide all tabs first
            navTabs.forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Show tabs based on role
            if (role === 'admin') {
                // Admin sees all tabs
                navTabs.forEach(tab => {
                    tab.style.display = 'flex';
                });
            } else if (role === 'buyer') {
                // Buyer only sees buyers tab
                navTabs.forEach(tab => {
                    if (tab.dataset.tab === 'buyers') {
                        tab.style.display = 'flex';
                        tab.classList.add('active');
                    } else {
                        tab.style.display = 'none';
                        tab.classList.remove('active');
                    }
                });
                
                // Show only buyers tab content
                tabContents.forEach(content => {
                    if (content.id === 'buyers-tab') {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            }
        }

        function resetUI() {
            // Show all tabs
            navTabs.forEach(tab => {
                tab.style.display = 'flex';
            });
            
            // Reset to dashboard
            navTabs.forEach(t => t.classList.remove('active'));
            const dashboardTab = document.querySelector('[data-tab="dashboard"]');
            if (dashboardTab) {
                dashboardTab.classList.add('active');
            }
            
            // Show dashboard content
            tabContents.forEach(content => {
                if (content.id === 'dashboard-tab') {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        }

        // Event listeners for authentication
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmail.value.trim();
            const password = loginPassword.value;
            
            if (email && password) {
                await loginUser(email, password);
            }
        });
        
        logoutBtn.addEventListener('click', logoutUser);

        // --- Supplier Management System ---
        function showAddSupplierModal() {
            addSupplierModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideAddSupplierModal() {
            addSupplierModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            supplierForm.reset();
        }

        function getCategoryIcon(category) {
            const icons = {
                'Materiales Industriales': 'fas fa-industry',
                'Herramientas y Equipos': 'fas fa-tools',
                'Componentes Electrónicos': 'fas fa-cogs',
                'Servicios': 'fas fa-concierge-bell',
                'Otros': 'fas fa-box'
            };
            return icons[category] || 'fas fa-box';
        }

        function getCategoryColor(category) {
            const colors = {
                'Materiales Industriales': 'blue',
                'Herramientas y Equipos': 'green',
                'Componentes Electrónicos': 'purple',
                'Servicios': 'orange',
                'Otros': 'gray'
            };
            return colors[category] || 'gray';
        }

        function getCategoryColorClasses(category) {
            const colorClasses = {
                'Materiales Industriales': {
                    bg: 'bg-blue-100',
                    text: 'text-blue-600'
                },
                'Herramientas y Equipos': {
                    bg: 'bg-green-100',
                    text: 'text-green-600'
                },
                'Componentes Electrónicos': {
                    bg: 'bg-purple-100',
                    text: 'text-purple-600'
                },
                'Servicios': {
                    bg: 'bg-orange-100',
                    text: 'text-orange-600'
                },
                'Otros': {
                    bg: 'bg-gray-100',
                    text: 'text-gray-600'
                }
            };
            return colorClasses[category] || { bg: 'bg-gray-100', text: 'text-gray-600' };
        }

        function getDeliveryColorClasses(delivery) {
            if (delivery.includes('1-2') || delivery.includes('2-4')) return 'text-green-600';
            if (delivery.includes('3-5')) return 'text-green-600';
            if (delivery.includes('5-7')) return 'text-orange-600';
            return 'text-red-600';
        }

        function renderStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            return stars;
        }

        function createSupplierCard(supplier) {
            const colorClasses = getCategoryColorClasses(supplier.category);
            const deliveryColorClass = getDeliveryColorClasses(supplier.delivery);
            const iconClass = getCategoryIcon(supplier.category);
            
            return `
                <div id="supplier-${supplier.id}" class="bg-white rounded-xl p-6 border border-slate-200 hover:shadow-lg transition-all duration-300">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 ${colorClasses.bg} rounded-lg flex items-center justify-center mr-3">
                                <i class="${iconClass} ${colorClasses.text}"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800">${supplier.name}</h4>
                                <p class="text-sm text-slate-600">${supplier.category}</p>
                            </div>
                        </div>
                        <button class="delete-supplier-btn text-red-400 hover:text-red-600 text-sm" data-supplier-id="${supplier.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-600">Contacto:</span>
                            <span class="font-medium">${supplier.contact}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Teléfono:</span>
                            <span class="font-medium">${supplier.phone}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Email:</span>
                            <span class="font-medium">${supplier.email}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Tiempo de entrega:</span>
                            <span class="font-medium ${deliveryColorClass}">${supplier.delivery}</span>
                        </div>
                        ${supplier.address ? `
                        <div class="flex justify-between">
                            <span class="text-slate-600">Dirección:</span>
                            <span class="font-medium text-xs">${supplier.address}</span>
                        </div>
                        ` : ''}
                        ${supplier.notes ? `
                        <div class="flex justify-between">
                            <span class="text-slate-600">Notas:</span>
                            <span class="font-medium text-xs">${supplier.notes}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-600">Calificación:</span>
                            <div class="flex items-center">
                                <div class="flex text-yellow-400">
                                    ${renderStars(supplier.rating)}
                                </div>
                                <span class="ml-2 text-sm font-medium">${supplier.rating}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSuppliers() {
            suppliersContainer.innerHTML = suppliers.map(supplier => createSupplierCard(supplier)).join('');
        }

        function addSupplier(supplierData) {
            const newSupplier = {
                id: Math.max(...suppliers.map(s => s.id)) + 1,
                ...supplierData,
                rating: parseFloat(supplierData.rating)
            };
            suppliers.push(newSupplier);
            renderSuppliers();
            showNotification('Proveedor agregado exitosamente', 'success');
        }

        function deleteSupplier(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este proveedor?')) {
                suppliers = suppliers.filter(supplier => supplier.id !== id);
                renderSuppliers();
                showNotification('Proveedor eliminado exitosamente', 'success');
            }
        }

        // Event listeners for supplier management
        addSupplierBtn.addEventListener('click', showAddSupplierModal);
        closeSupplierModal.addEventListener('click', hideAddSupplierModal);
        cancelSupplierBtn.addEventListener('click', hideAddSupplierModal);

        supplierForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(supplierForm);
            const supplierData = {
                name: document.getElementById('supplier-name').value,
                category: document.getElementById('supplier-category').value,
                contact: document.getElementById('supplier-contact').value,
                phone: document.getElementById('supplier-phone').value,
                email: document.getElementById('supplier-email').value,
                delivery: document.getElementById('supplier-delivery').value,
                rating: document.getElementById('supplier-rating').value,
                address: document.getElementById('supplier-address').value,
                notes: document.getElementById('supplier-notes').value
            };
            
            addSupplier(supplierData);
            hideAddSupplierModal();
        });

        // --- Quick Actions System ---
        function showNewOrderModal() {
            const modal = createModal('Nueva Orden de Compra', `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Número de PO</label>
                            <input type="text" id="po-number" class="modern-input w-full" placeholder="PO-2024-XXX" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Proveedor</label>
                            <select id="po-supplier" class="modern-input w-full" required>
                                <option value="">Seleccionar proveedor</option>
                                ${suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Fecha de Orden</label>
                            <input type="date" id="po-date" class="modern-input w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Fecha de Entrega Esperada</label>
                            <input type="date" id="po-delivery-date" class="modern-input w-full" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Descripción de la Orden</label>
                        <textarea id="po-description" class="modern-input w-full h-20" placeholder="Describe los productos o servicios solicitados" required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Cantidad</label>
                            <input type="number" id="po-quantity" class="modern-input w-full" placeholder="1" min="1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Precio Unitario</label>
                            <input type="number" id="po-unit-price" class="modern-input w-full" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Notas Adicionales</label>
                        <input type="text" id="po-notes" class="modern-input w-full" placeholder="Información adicional">
                    </div>
                </div>
            `, 'Crear Orden', 'blue');
            showModal(modal);
        }

        function showSearchSupplierModal() {
            const modal = createModal('Buscar Proveedor', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Término de Búsqueda</label>
                        <input type="text" id="search-term" class="modern-input w-full" placeholder="Nombre, categoría, contacto...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Categoría</label>
                        <select id="search-category" class="modern-input w-full">
                            <option value="">Todas las categorías</option>
                            <option value="Materiales Industriales">Materiales Industriales</option>
                            <option value="Herramientas y Equipos">Herramientas y Equipos</option>
                            <option value="Componentes Electrónicos">Componentes Electrónicos</option>
                            <option value="Servicios">Servicios</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div id="search-results" class="max-h-60 overflow-y-auto">
                        ${suppliers.map(supplier => createSupplierCard(supplier)).join('')}
                    </div>
                </div>
            `, 'Buscar', 'green');
            showModal(modal);
            
            // Add event listeners after modal is shown
            setTimeout(() => {
                const searchTerm = document.getElementById('search-term');
                const searchCategory = document.getElementById('search-category');
                
                if (searchTerm) {
                    searchTerm.addEventListener('keyup', filterSuppliers);
                }
                if (searchCategory) {
                    searchCategory.addEventListener('change', filterSuppliers);
                }
            }, 100);
        }

        function showInvoicesModal() {
            const invoices = [
                { id: 'INV-001', supplier: 'Proveedor A', date: '2024-01-15', amount: 2500.00, status: 'Pagada' },
                { id: 'INV-002', supplier: 'Proveedor B', date: '2024-01-18', amount: 1800.00, status: 'Pendiente' },
                { id: 'INV-003', supplier: 'Proveedor C', date: '2024-01-20', amount: 3200.00, status: 'Vencida' }
            ];
            
            const modal = createModal('Facturas', `
                <div class="space-y-4">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-slate-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Factura #</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Proveedor</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Fecha</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Monto</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoices.map(invoice => `
                                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                                        <td class="py-3 px-4 font-medium text-blue-600">${invoice.id}</td>
                                        <td class="py-3 px-4">${invoice.supplier}</td>
                                        <td class="py-3 px-4">${invoice.date}</td>
                                        <td class="py-3 px-4 font-semibold">$${invoice.amount.toFixed(2)}</td>
                                        <td class="py-3 px-4">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                                invoice.status === 'Pagada' ? 'bg-green-100 text-green-800' :
                                                invoice.status === 'Pendiente' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-red-100 text-red-800'
                                            }">${invoice.status}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `, 'Cerrar', 'purple');
            showModal(modal);
        }

        function showReportsModal() {
            const modal = createModal('Reportes de Compras', `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">Total de Órdenes</h4>
                            <p class="text-2xl font-bold text-blue-600">12</p>
                            <p class="text-sm text-blue-600">Este mes</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-2">Monto Total</h4>
                            <p class="text-2xl font-bold text-green-600">$45,200</p>
                            <p class="text-sm text-green-600">Este mes</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-purple-800 mb-2">Proveedores Activos</h4>
                            <p class="text-2xl font-bold text-purple-600">${suppliers.length}</p>
                            <p class="text-sm text-purple-600">Total registrados</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-orange-800 mb-2">Promedio por Orden</h4>
                            <p class="text-2xl font-bold text-orange-600">$3,767</p>
                            <p class="text-sm text-orange-600">Este mes</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-3">Top Proveedores por Volumen</h4>
                        <div class="space-y-2">
                            ${suppliers.map((supplier, index) => `
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">${index + 1}. ${supplier.name}</span>
                                    <span class="text-sm font-medium">${supplier.rating}⭐</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, 'Cerrar', 'orange');
            showModal(modal);
        }

        function createModal(title, content, buttonText, color) {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="glass-card p-8 rounded-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${title}</h2>
                            <button class="close-modal-btn text-slate-400 hover:text-slate-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        ${content}
                        <div class="flex justify-end pt-6 border-t border-slate-200 mt-6">
                            <button class="close-modal-btn px-6 py-3 bg-${color}-500 hover:bg-${color}-600 text-white rounded-xl font-semibold transition-colors duration-300">
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showModal(modalHTML) {
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            modalContainer.id = 'dynamic-modal';
            document.body.appendChild(modalContainer);
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('dynamic-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        function filterSuppliers() {
            const searchTerm = document.getElementById('search-term').value.toLowerCase();
            const category = document.getElementById('search-category').value;
            const resultsContainer = document.getElementById('search-results');
            
            let filteredSuppliers = suppliers.filter(supplier => {
                const matchesSearch = !searchTerm || 
                    supplier.name.toLowerCase().includes(searchTerm) ||
                    supplier.category.toLowerCase().includes(searchTerm) ||
                    supplier.contact.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !category || supplier.category === category;
                
                return matchesSearch && matchesCategory;
            });
            
            resultsContainer.innerHTML = filteredSuppliers.map(supplier => createSupplierCard(supplier)).join('');
        }

        // Event listeners for quick actions
        newOrderBtn.addEventListener('click', showNewOrderModal);
        searchSupplierBtn.addEventListener('click', showSearchSupplierModal);
        viewInvoicesBtn.addEventListener('click', showInvoicesModal);
        reportsBtn.addEventListener('click', showReportsModal);

        // Event delegation for dynamic elements
        document.addEventListener('click', (e) => {
            // Handle delete supplier buttons
            if (e.target.closest('.delete-supplier-btn')) {
                const supplierId = parseInt(e.target.closest('.delete-supplier-btn').dataset.supplierId);
                deleteSupplier(supplierId);
            }
            
            // Handle close modal buttons
            if (e.target.closest('.close-modal-btn')) {
                closeModal();
            }
        });

        // --- Tab Navigation ---
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                // Update active tab
                navTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show target content
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${targetTab}-tab`).classList.remove('hidden');
                
                // Initialize charts if analytics tab is selected
                if (targetTab === 'analytics') {
                    initializeCharts();
                }
            });
        });

        // --- AI Chat System ---
        aiChatToggle.addEventListener('click', () => {
            aiChat.classList.toggle('open');
        });

        closeAiChat.addEventListener('click', () => {
            aiChat.classList.remove('open');
        });

        aiInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && aiInput.value.trim()) {
                const userMessage = aiInput.value.trim();
                addMessageToChat('user', userMessage);
                aiInput.value = '';
                
                // Simulate AI thinking
                setTimeout(() => {
                    const aiResponse = aiSystem.getAIResponse(userMessage);
                    addMessageToChat('bot', aiResponse);
                }, 1000);
            }
        });

        function addMessageToChat(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            messageDiv.innerHTML = `
                <div class="ai-message-content">
                    <p>${message}</p>
                </div>
            `;
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // --- Smart Entry Parser (Enhanced) ---
        smartEntryTextarea.addEventListener('input', () => {
            const text = smartEntryTextarea.value;
            const poRegex = /(?:PO|Order|Job)\s*(?:#|:)?\s*([\w-]+)/i;
            const poMatch = text.match(poRegex);
            if (poMatch && poMatch[1]) {
                poNumberInput.value = poMatch[1];
            }
            const dateRegex = /(\d{4}-\d{2}-\d{2})|(\d{1,2}\/\d{1,2}\/\d{4})/;
            const dateMatch = text.match(dateRegex);
            if (dateMatch) {
                const dateStr = dateMatch[2] ? new Date(dateMatch[2]).toISOString().split('T')[0] : dateMatch[1];
                dueDateInput.value = dateStr;
            }
             const descRegex = /(?:Job|Description|Title|Desc)\s*:\s*(.*)/i;
             const descMatch = text.match(descRegex);
             if (descMatch && descMatch[1]) {
                 projectDescriptionInput.value = descMatch[1].trim();
             } else {
                const lines = text.split('\n');
                const nonPoDateLine = lines.find(line => !poRegex.test(line) && !dateRegex.test(line) && line.trim() !== '');
                if(nonPoDateLine) {
                    projectDescriptionInput.value = nonPoDateLine.trim().replace(/^:\s*/, '');
                }
             }
        });

        // --- Helper Functions ---
        const getRelativeDateInfo = (date) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(date);
            dueDate.setHours(0, 0, 0, 0);
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { text: `Atrasado por ${Math.abs(diffDays)} día(s)`, class: 'overdue' };
            if (diffDays === 0) return { text: 'Vence hoy', class: 'due-today' };
            if (diffDays === 1) return { text: 'Vence mañana', class: 'due-soon' };
            if (diffDays <= 3) return { text: `Vence en ${diffDays} días`, class: 'due-soon' };
            return { text: `Vence en ${diffDays} días`, class: '' };
        };
        
        const renderProject = (project) => {
            const dueDate = project.dueDate.toDate();
            const formattedDate = dueDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const relativeDateInfo = getRelativeDateInfo(dueDate);
            
            // Determine status badge class
            let statusClass = 'status-normal';
            if (relativeDateInfo.class === 'due-soon') statusClass = 'status-due-soon';
            else if (relativeDateInfo.class === 'due-today') statusClass = 'status-due-today';
            else if (relativeDateInfo.class === 'overdue') statusClass = 'status-overdue';
            
            return `
                <div class="project-card fade-in ${relativeDateInfo.class}">
                    <div class="flex justify-between items-start">
                    <div class="flex-grow">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-file-alt text-white text-sm"></i>
                    </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-slate-800">PO #${project.poNumber}</h3>
                                    <p class="text-slate-600 text-sm">${formattedDate}</p>
                                </div>
                            </div>
                            <p class="text-slate-700 mb-3 leading-relaxed">${project.description}</p>
                            <span class="status-badge ${statusClass}">
                                <i class="fas fa-clock mr-1"></i>
                                ${relativeDateInfo.text}
                            </span>
                    </div>
                        <button data-id="${project.id}" class="delete-btn ml-4">
                            <i class="fas fa-trash-alt"></i>
                    </button>
                    </div>
                </div>
            `;
        };

        const updateProjectList = (projects) => {
            loadingSpinner.classList.remove('show');
            noProjectsMessage.classList.toggle('hidden', projects.length > 0);
            projectList.innerHTML = projects.map(renderProject).join('');
            allProjects = projects;
            updateDashboardMetrics(projects);
            
            // Check for multi-channel reminders
            checkMultiChannelReminders(projects);
        };

        async function checkMultiChannelReminders(projects) {
            const now = new Date();
            const currentHour = now.getHours();
            const startHour = 8; // 8:00 AM
            const endHour = 18; // 6:00 PM

            // Only send reminders during business hours
            if (currentHour < startHour || currentHour > endHour) {
                return;
            }

            for (const project of projects) {
                const dueDate = project.dueDate.toDate();
                const diffDays = Math.ceil((dueDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

                let reminderType = null;
                
                // Early reminder (7 days before)
                if (diffDays === 7) {
                    reminderType = 'due';
                }
                // Urgent reminder (1 day before)
                else if (diffDays === 1) {
                    reminderType = 'due';
                }
                // Overdue project
                else if (diffDays < 0) {
                    reminderType = 'overdue';
                }

                if (reminderType) {
                    try {
                        await multiChannelManager.sendNotification(project, reminderType, whatsappManager.teamMembers);
                    } catch (error) {
                        console.error('Error sending notification:', error);
                    }
                }
            }
        }

        const updateDashboardMetrics = (projects) => {
            document.getElementById('total-projects').textContent = projects.length;
            
            const completedThisMonth = projects.filter(p => {
                const created = p.createdAt.toDate();
                const now = new Date();
                return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
            }).length;
            document.getElementById('completed-projects').textContent = completedThisMonth;
            
            const overdue = projects.filter(p => {
                const dueDate = p.dueDate.toDate();
                const today = new Date();
                return dueDate < today;
            }).length;
            document.getElementById('overdue-projects').textContent = overdue;
            
            const efficiencyScore = Math.max(0, Math.min(100, 100 - (overdue * 10) + (completedThisMonth * 5)));
            document.getElementById('efficiency-score').textContent = `${efficiencyScore}%`;
        };

        // --- Chart Initialization ---
        function initializeCharts() {
            // Timeline Chart
            const timelineCtx = document.getElementById('timelineChart');
            if (timelineCtx) {
                new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
                        datasets: [{
                            label: 'Proyectos Completados',
                            data: [2, 4, 3, 5],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Completion Chart
            const completionCtx = document.getElementById('completionChart');
            if (completionCtx) {
                new Chart(completionCtx, {
                    type: 'bar',
                    data: {
                        labels: ['A Tiempo', 'Tardío', 'Temprano'],
                        datasets: [{
                            data: [12, 3, 2],
                            backgroundColor: ['#22c55e', '#ef4444', '#3b82f6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Distribution Chart
            const distributionCtx = document.getElementById('distributionChart');
            if (distributionCtx) {
                new Chart(distributionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Bridas', 'Tuberías', 'Válvulas', 'Otros'],
                        datasets: [{
                            data: [35, 25, 20, 20],
                            backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // --- Notification System ---
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('notification-container').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // --- Event Handlers ---
        addProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!poNumberInput.value || !dueDateInput.value || !projectDescriptionInput.value) return;
            
            const [year, month, day] = dueDateInput.value.split('-');
            const dueDate = new Date(year, month - 1, day, 12, 0, 0);
            
            try {
                const projectData = {
                    poNumber: poNumberInput.value,
                    description: projectDescriptionInput.value,
                    dueDate: Timestamp.fromDate(dueDate),
                    createdAt: Timestamp.now()
                };
                
                await addDoc(projectsCollection, projectData);
                
                // AI Learning
                aiSystem.analyzeProject(projectData);
                
                addProjectForm.reset();
                smartEntryTextarea.value = '';
                showNotification('¡Proyecto agregado exitosamente! La IA está aprendiendo de estos datos.', 'success');
            } catch (error) {
                console.error("Error adding document: ", error);
                showNotification('Error al agregar proyecto. Por favor intenta de nuevo.', 'error');
            }
        });

        projectList.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-btn')) {
                const id = e.target.closest('.delete-btn').dataset.id;
                try {
                    await deleteDoc(doc(db, projectsCollection.path, id));
                    showNotification('¡Proyecto eliminado exitosamente!', 'success');
                } catch (error) {
                    console.error("Error removing document: ", error);
                    showNotification('Error al eliminar proyecto.', 'error');
                }
            }
        });

        // --- Multi-Channel Setup System ---
        function setupMultiChannelNotifications() {
            // Method selection
            const methodCards = document.querySelectorAll('.notification-method-card');
            const methodRadios = document.querySelectorAll('input[name="notification-method"]');
            
            methodCards.forEach(card => {
                card.addEventListener('click', () => {
                    const method = card.dataset.method;
                    const radio = card.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Update visual selection
                    methodCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    
                    // Show/hide configuration sections
                    showConfigurationSection(method);
                    
                    // Update notification manager
                    multiChannelManager.setNotificationMethod(method);
                });
            });

            // Initialize with browser notifications
            showConfigurationSection('browser');
            multiChannelManager.setNotificationMethod('browser');
        }

        function showConfigurationSection(method) {
            // Hide all configuration sections
            document.getElementById('whatsapp-business-config').classList.add('hidden');
            document.getElementById('whatsapp-web-config').classList.add('hidden');
            document.getElementById('email-config').classList.add('hidden');
            document.getElementById('browser-config').classList.add('hidden');
            
            // Show selected section
            switch (method) {
                case 'whatsapp-business':
                    document.getElementById('whatsapp-business-config').classList.remove('hidden');
                    break;
                case 'whatsapp-web':
                    document.getElementById('whatsapp-web-config').classList.remove('hidden');
                    break;
                case 'email':
                    document.getElementById('email-config').classList.remove('hidden');
                    break;
                case 'browser':
                    document.getElementById('browser-config').classList.remove('hidden');
                    checkNotificationPermission();
                    break;
            }
        }

        function checkNotificationPermission() {
            const statusElement = document.getElementById('notification-permission-status');
            
            if (!('Notification' in window)) {
                statusElement.textContent = 'No soportado';
                statusElement.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-600';
                return;
            }
            
            switch (Notification.permission) {
                case 'granted':
                    statusElement.textContent = 'Permitido';
                    statusElement.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-600';
                    break;
                case 'denied':
                    statusElement.textContent = 'Denegado';
                    statusElement.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-600';
                    break;
                default:
                    statusElement.textContent = 'Pendiente';
                    statusElement.className = 'text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-600';
            }
        }

        // --- WhatsApp Setup System ---
        function setupWhatsApp() {
            const testConnectionBtn = document.getElementById('test-whatsapp-connection');
            const addMemberBtn = document.getElementById('add-team-member');
            const testAllBtn = document.getElementById('test-all-notifications');
            const testSpecificBtn = document.getElementById('test-specific-member');

            // Test WhatsApp connection
            testConnectionBtn.addEventListener('click', async () => {
                const token = document.getElementById('whatsapp-token').value;
                const phoneId = document.getElementById('whatsapp-phone-id').value;
                const verifyToken = document.getElementById('whatsapp-verify-token').value;

                if (!token || !phoneId) {
                    showNotification('Por favor completa el token y Phone ID', 'warning');
                    return;
                }

                whatsappManager.setCredentials(token, phoneId, verifyToken);

                try {
                    await whatsappManager.testConnection();
                    showNotification('¡Conexión WhatsApp exitosa!', 'success');
                } catch (error) {
                    showNotification('Error de conexión: ' + error.message, 'error');
                }
            });

            // Add team member
            addMemberBtn.addEventListener('click', () => {
                const name = prompt('Nombre del miembro:');
                const phone = prompt('Número de teléfono (con código país):');
                
                if (name && phone) {
                    whatsappManager.addTeamMember(name, phone);
                    updateTeamMembersDisplay();
                    showNotification('Miembro agregado exitosamente', 'success');
                }
            });

            // Test all notifications
            testAllBtn.addEventListener('click', async () => {
                if (!whatsappManager.apiToken) {
                    showNotification('Configura primero la API de WhatsApp', 'warning');
                    return;
                }

                try {
                    const testMessage = '🧪 *Prueba de Sistema*\nRecordatorios automáticos de proyectos activados.\n_Taller de Torno CNC_';
                    
                    for (const member of whatsappManager.teamMembers) {
                        if (member.notifications) {
                            await whatsappManager.sendMessage(member.phone, testMessage);
                        }
                    }
                    
                    showNotification('Mensajes de prueba enviados a todos los miembros', 'success');
                } catch (error) {
                    showNotification('Error enviando mensajes: ' + error.message, 'error');
                }
            });

            // Update reminder settings
            document.getElementById('early-reminder').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ early: { enabled: e.target.checked, days: 7 } });
            });

            document.getElementById('urgent-reminder').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ urgent: { enabled: e.target.checked, days: 1 } });
            });

            document.getElementById('overdue-reminder').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ overdue: { enabled: e.target.checked, days: 0 } });
            });

            document.getElementById('start-time').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ startTime: e.target.value });
            });

            document.getElementById('end-time').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ endTime: e.target.value });
            });

            // Browser notification permission request
            document.getElementById('request-notification-permission').addEventListener('click', async () => {
                try {
                    const permission = await Notification.requestPermission();
                    checkNotificationPermission();
                    
                    if (permission === 'granted') {
                        showNotification('Permisos de notificación concedidos', 'success');
                    } else {
                        showNotification('Permisos de notificación denegados', 'warning');
                    }
                } catch (error) {
                    showNotification('Error solicitando permisos: ' + error.message, 'error');
                }
            });

            // Browser notification settings
            document.getElementById('notification-sound').addEventListener('change', (e) => {
                multiChannelManager.updateBrowserConfig({ sound: e.target.checked });
            });

            document.getElementById('notification-vibrate').addEventListener('change', (e) => {
                multiChannelManager.updateBrowserConfig({ vibrate: e.target.checked });
            });

            document.getElementById('notification-persistent').addEventListener('change', (e) => {
                multiChannelManager.updateBrowserConfig({ persistent: e.target.checked });
            });

            // Email configuration
            document.getElementById('test-email').addEventListener('click', async () => {
                const smtpServer = document.getElementById('smtp-server').value;
                const smtpPort = document.getElementById('smtp-port').value;
                const email = document.getElementById('smtp-email').value;
                const password = document.getElementById('smtp-password').value;
                
                if (!smtpServer || !email) {
                    showNotification('Completa la configuración SMTP', 'warning');
                    return;
                }

                multiChannelManager.updateEmailConfig({
                    smtpServer,
                    smtpPort: parseInt(smtpPort),
                    email,
                    password
                });

                try {
                    // Simulate email test
                    showNotification('Email de prueba enviado (simulado)', 'success');
                } catch (error) {
                    showNotification('Error enviando email: ' + error.message, 'error');
                }
            });

            document.getElementById('save-email-config').addEventListener('click', () => {
                const subject = document.getElementById('email-subject').value;
                const template = document.getElementById('email-template').value;
                
                multiChannelManager.updateEmailConfig({
                    subject,
                    template
                });
                
                showNotification('Configuración de email guardada', 'success');
            });

            // WhatsApp Web configuration
            const whatsappNumberInput = document.getElementById('whatsapp-web-number');
            const whatsappIntroInput = document.getElementById('whatsapp-web-intro');
            
            if (whatsappNumberInput) {
                whatsappNumberInput.addEventListener('change', (e) => {
                    multiChannelManager.updateWhatsAppWebConfig({ mainNumber: e.target.value });
                });
            }
            
            if (whatsappIntroInput) {
                whatsappIntroInput.addEventListener('change', (e) => {
                    multiChannelManager.updateWhatsAppWebConfig({ introMessage: e.target.value });
                });
            }

            // Test WhatsApp Web button
            const testWhatsAppBtn = document.getElementById('test-whatsapp-web');
            if (testWhatsAppBtn) {
                testWhatsAppBtn.addEventListener('click', async () => {
                    const config = multiChannelManager.getWhatsAppWebConfig();
                    const testMessage = `${config.introMessage}\n\n🧪 MENSAJE DE PRUEBA\n\nEste es un mensaje de prueba del sistema de recordatorios del taller. Si recibes este mensaje, la configuración está funcionando correctamente.\n\n¡Todo listo para recibir recordatorios importantes!`;
                    const encodedMessage = encodeURIComponent(testMessage);
                    
                    // Get a test phone number (use the main number or ask for one)
                    const testPhone = prompt('Ingresa un número de teléfono para la prueba (ej: +52 555 123 4567):', config.mainNumber);
                    
                    if (testPhone) {
                        const cleanPhone = testPhone.replace(/\D/g, '');
                        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
                        
                        // Open WhatsApp Web
                        window.open(whatsappUrl, '_blank');
                        
                        showNotification('¡Prueba enviada! Se abrió WhatsApp Web con el mensaje de prueba.', 'success');
                    }
                });
            }
        }

        function updateTeamMembersDisplay() {
            const container = document.getElementById('team-members-whatsapp');
            container.innerHTML = '';

            whatsappManager.teamMembers.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'flex items-center justify-between p-4 bg-slate-50 rounded-lg';
                memberDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-green-600"></i>
                        </div>
                        <div>
                            <h5 class="font-medium text-slate-800">${member.name}</h5>
                            <p class="text-sm text-slate-600">${member.phone}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="whatsapp-notifications" ${member.notifications ? 'checked' : ''}>
                            <span class="ml-2 text-sm text-slate-600">Notificaciones</span>
                        </label>
                    </div>
                `;
                container.appendChild(memberDiv);
            });
        }

        // --- Template Editor Functions ---
        function editTemplate(templateType) {
            const template = whatsappManager.templates[templateType];
            const newMessage = prompt(`Editar plantilla "${template.title}":`, template.message);
            
            if (newMessage && newMessage !== template.message) {
                whatsappManager.templates[templateType].message = newMessage;
                showNotification('Plantilla actualizada exitosamente', 'success');
                updateTemplateDisplay(templateType);
            }
        }

        function updateTemplateDisplay(templateType) {
            // Update the template display in the UI
            const template = whatsappManager.templates[templateType];
            const templateElements = document.querySelectorAll(`[onclick="editTemplate('${templateType}')"]`);
            
            templateElements.forEach(element => {
                const messageContainer = element.parentElement.querySelector('.bg-white p');
                if (messageContainer) {
                    messageContainer.innerHTML = template.message.replace(/\n/g, '<br>');
                }
            });
        }

        // --- Periodic Reminder Check ---
        function startReminderScheduler() {
            // Check for reminders every hour
            setInterval(() => {
                if (allProjects.length > 0) {
                    whatsappManager.checkReminders(allProjects);
                }
            }, 60 * 60 * 1000); // Every hour

            // Also check immediately on load
            if (allProjects.length > 0) {
                whatsappManager.checkReminders(allProjects);
            }
        }

        // --- Settings Setup System ---
        function setupSettings() {
            // Workshop information
            document.getElementById('workshop-name').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.name', e.target.value);
            });
            
            document.getElementById('workshop-address').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.address', e.target.value);
            });
            
            document.getElementById('workshop-phone').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.phone', e.target.value);
            });
            
            document.getElementById('workshop-email').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.email', e.target.value);
            });
            
            // Specialties
            document.querySelectorAll('input[id^="specialty-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const specialty = e.target.id.replace('specialty-', '');
                    let specialties = settingsManager.getSetting('workshop.specialties') || [];
                    
                    if (e.target.checked) {
                        if (!specialties.includes(specialty)) {
                            specialties.push(specialty);
                        }
                    } else {
                        specialties = specialties.filter(s => s !== specialty);
                    }
                    
                    settingsManager.updateSetting('workshop.specialties', specialties);
                });
            });
            
            document.getElementById('production-capacity').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.productionCapacity', e.target.value);
            });
            
            document.getElementById('timezone').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.timezone', e.target.value);
            });
            
            // Project settings
            document.getElementById('po-prefix').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.poPrefix', e.target.value);
            });
            
            document.getElementById('po-format').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.poFormat', e.target.value);
                
                if (e.target.value === 'custom') {
                    document.getElementById('custom-format-container').classList.remove('hidden');
                } else {
                    document.getElementById('custom-format-container').classList.add('hidden');
                }
            });
            
            document.getElementById('custom-po-format').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.customFormat', e.target.value);
            });
            
            // Warning days
            document.getElementById('early-warning-days').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.warningDays.early', parseInt(e.target.value));
            });
            
            document.getElementById('urgent-warning-days').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.warningDays.urgent', parseInt(e.target.value));
            });
            
            document.getElementById('critical-warning-days').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.warningDays.critical', parseInt(e.target.value));
            });
            
            // Categories management
            document.getElementById('add-category').addEventListener('click', () => {
                const input = document.getElementById('new-category');
                const category = input.value.trim();
                
                if (category) {
                    let categories = settingsManager.getSetting('projects.categories') || [];
                    if (!categories.includes(category)) {
                        categories.push(category);
                        settingsManager.updateSetting('projects.categories', categories);
                        updateCategoriesList();
                        input.value = '';
                    }
                }
            });
            
            // Notification settings
            document.getElementById('work-start-time').addEventListener('change', (e) => {
                settingsManager.updateSetting('notifications.workHours.start', e.target.value);
            });
            
            document.getElementById('work-end-time').addEventListener('change', (e) => {
                settingsManager.updateSetting('notifications.workHours.end', e.target.value);
            });
            
            // Workdays
            document.querySelectorAll('input[id^="workday-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const day = e.target.id.replace('workday-', '');
                    let workdays = settingsManager.getSetting('notifications.workHours.workdays') || [];
                    
                    if (e.target.checked) {
                        if (!workdays.includes(day)) {
                            workdays.push(day);
                        }
                    } else {
                        workdays = workdays.filter(d => d !== day);
                    }
                    
                    settingsManager.updateSetting('notifications.workHours.workdays', workdays);
                });
            });
            
            document.getElementById('check-frequency').addEventListener('change', (e) => {
                settingsManager.updateSetting('notifications.checkFrequency', parseInt(e.target.value));
            });
            
            // AI settings
            document.getElementById('ai-learning-level').addEventListener('change', (e) => {
                settingsManager.updateSetting('ai.learningLevel', e.target.value);
            });
            
            document.getElementById('ai-analysis-frequency').addEventListener('change', (e) => {
                settingsManager.updateSetting('ai.analysisFrequency', e.target.value);
            });
            
            document.getElementById('ai-precision').addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                settingsManager.updateSetting('ai.precision', value);
                document.getElementById('precision-value').textContent = value + '%';
            });
            
            // AI features
            document.querySelectorAll('input[id^="ai-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const feature = e.target.id.replace('ai-', '').replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                    settingsManager.updateSetting(`ai.features.${feature}`, e.target.checked);
                });
            });
            
            document.getElementById('ai-language').addEventListener('change', (e) => {
                settingsManager.updateSetting('ai.language', e.target.value);
            });
            
            // Export/Import
            document.getElementById('export-settings').addEventListener('click', () => {
                settingsManager.exportSettings();
            });
            
            document.getElementById('import-data').addEventListener('click', () => {
                document.getElementById('import-file').click();
            });
            
            document.getElementById('import-file').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    settingsManager.importSettings(e.target.files[0]);
                }
            });
            
            document.getElementById('reset-settings').addEventListener('click', () => {
                settingsManager.resetToDefaults();
            });
            
            document.getElementById('save-all-settings').addEventListener('click', () => {
                settingsManager.saveSettings();
            });
            
            document.getElementById('reset-to-defaults').addEventListener('click', () => {
                settingsManager.resetToDefaults();
            });
        }

        function updateCategoriesList() {
            const container = document.getElementById('categories-list');
            const categories = settingsManager.getSetting('projects.categories') || [];
            
            container.innerHTML = categories.map(category => `
                <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                    <span class="text-sm text-slate-700">${category}</span>
                    <button class="text-red-500 hover:text-red-700" onclick="removeCategory('${category}')">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCategory(category) {
            let categories = settingsManager.getSetting('projects.categories') || [];
            categories = categories.filter(c => c !== category);
            settingsManager.updateSetting('projects.categories', categories);
            updateCategoriesList();
        }

        // --- Main Initialization ---
        async function main() {
            try {
                // Initialize knowledge upload system
                setupKnowledgeUpload();
                
                // Initialize multi-channel notification system
                setupMultiChannelNotifications();
                
                // Initialize WhatsApp system
                setupWhatsApp();
                
                // Initialize settings system
                setupSettings();
                
                // Start reminder scheduler
                startReminderScheduler();
                
                // Initialize team and knowledge managers
                if (typeof window.teamManager !== 'undefined') {
                    window.teamManager.updateTeamStats();
                    window.teamManager.renderTeamMembers();
                    window.teamManager.renderRolesAndPermissions();
                }
                
                if (typeof window.knowledgeManager !== 'undefined') {
                    window.knowledgeManager.updateKnowledgeStats();
                    window.knowledgeManager.renderKnowledgeItems();
                }
                
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Error during initialization:', error);
                showNotification('Error durante la inicialización de la aplicación', 'error');
            }
            
             if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing!");
                loadingSpinner.classList.remove('show');
                projectList.innerHTML = `<p class="text-red-500 text-center">No se pudo conectar a la base de datos. Por favor verifica la configuración.</p>`;
                return;
            }
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    projectsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
                    const q = query(projectsCollection, orderBy("dueDate", "asc"));
                    onSnapshot(q, (snapshot) => {
                        const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        updateProjectList(projects);
                        
                        // AI Learning from existing projects
                        projects.forEach(project => {
                            aiSystem.analyzeProject(project);
                        });
                    });
                }
            });

            // Check if user is already authenticated
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, hide login modal and show app
                    hideLoginModal();
                    initializeApp();
                } else {
                    // User is signed out, show login modal
                    showLoginModal();
                }
            });
        }

        // Initialize app data after authentication
        function initializeApp() {
            if (auth && projectsCollection) {
                const q = query(projectsCollection, orderBy("dueDate", "asc"));
                onSnapshot(q, (snapshot) => {
                    const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateProjectList(projects);
                    
                    // AI Learning from existing projects
                    projects.forEach(project => {
                        aiSystem.analyzeProject(project);
                    });
                });
            }
        }

        // Initialize login system
        function initializeLoginSystem() {
            // Firebase auth state will handle showing/hiding login modal
            // No need to show login modal immediately
        }

        // Initialize supplier system
        function initializeSupplierSystem() {
            // Render initial suppliers
            renderSuppliers();
        }

        main();
        initializeLoginSystem();
        initializeSupplierSystem();

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript,' + encodeURIComponent(`
                    const CACHE_NAME = 'proyectos-ia-v1';
                    const urlsToCache = [
                        '/',
                        '/reminder.html',
                        'https://cdn.tailwindcss.com',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                        'https://cdn.jsdelivr.net/npm/chart.js',
                        'https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js'
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `))
                .then((registration) => {
                    console.log('SW registered: ', registration);
                })
                .catch((registrationError) => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }

        // --- PWA Install Prompt ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            const installButton = document.createElement('button');
            installButton.innerHTML = '<i class="fas fa-download mr-2"></i>Instalar App';
            installButton.className = 'modern-button fixed bottom-4 right-4 z-50 shadow-lg';
            installButton.style.display = 'none';
            document.body.appendChild(installButton);

            installButton.addEventListener('click', () => {
                installButton.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showNotification('¡App instalada exitosamente!', 'success');
                    }
                    deferredPrompt = null;
                });
            });

            // Show install button after 3 seconds
            setTimeout(() => {
                installButton.style.display = 'block';
            }, 3000);
        });

        // --- PWA Install Detection ---
        window.addEventListener('appinstalled', () => {
            showNotification('¡App instalada exitosamente!', 'success');
        });

        // --- Mobile Touch Optimizations ---
        if ('ontouchstart' in window) {
            document.body.classList.add('touch-device');
            
            // Add touch-friendly styles
            const touchStyles = document.createElement('style');
            touchStyles.textContent = `
                .touch-device .modern-button {
                    min-height: 44px;
                    min-width: 44px;
                }
                .touch-device .nav-tab {
                    min-height: 44px;
                }
                .touch-device .modern-input {
                    min-height: 44px;
                }
                .touch-device .notification-method-card {
                    min-height: 120px;
                }
            `;
            document.head.appendChild(touchStyles);
        }

        // --- Mobile Orientation Handling ---
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                // Refresh charts on orientation change
                if (window.chartInstances) {
                    window.chartInstances.forEach(chart => {
                        if (chart && typeof chart.resize === 'function') {
                            chart.resize();
                        }
                    });
                }
            }, 500);
        });

        // --- Mobile Performance Optimizations ---
        if (window.DeviceMotionEvent) {
            // Disable scroll bounce on iOS
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('.scrollable')) {
                    return;
                }
                e.preventDefault();
            }, { passive: false });
        }

        // --- Load WhatsApp Web Configuration ---
        multiChannelManager.loadWhatsAppWebConfig();

        // --- Advanced Team Management System ---
        class AdvancedTeamManager {
            constructor() {
                this.teamMembers = [
                    {
                        id: 1,
                        name: 'Juan Pérez',
                        role: 'manager',
                        email: 'juan@taller.com',
                        phone: '+52 555 123 4567',
                        status: 'online',
                        projects: 3,
                        efficiency: 85,
                        lastActive: new Date(),
                        notifications: true,
                        avatar: 'JP'
                    },
                    {
                        id: 2,
                        name: 'María García',
                        role: 'operator',
                        email: 'maria@taller.com',
                        phone: '+52 555 987 6543',
                        status: 'busy',
                        projects: 2,
                        efficiency: 92,
                        lastActive: new Date(),
                        notifications: true,
                        avatar: 'MG'
                    },
                    {
                        id: 3,
                        name: 'Carlos López',
                        role: 'technician',
                        email: 'carlos@taller.com',
                        phone: '+52 555 456 7890',
                        status: 'offline',
                        projects: 1,
                        efficiency: 78,
                        lastActive: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
                        notifications: false,
                        avatar: 'CL'
                    }
                ];
                this.notificationSettings = {
                    startTime: '08:00',
                    endTime: '18:00',
                    workDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
                    urgentNotifications: true,
                    dailySummary: true,
                    weeklyReport: false
                };

                // Sistema de Roles y Permisos
                this.roles = {
                    admin: {
                        name: 'Administrador',
                        description: 'Acceso completo al sistema',
                        icon: 'fas fa-crown',
                        color: 'red',
                        permissions: {
                            manageUsers: true,
                            manageProjects: true,
                            manageEquipment: true,
                            viewAnalytics: true,
                            manageSettings: true,
                            manageRoles: true,
                            sendNotifications: true,
                            viewReports: true
                        }
                    },
                    manager: {
                        name: 'Gerente',
                        description: 'Gestión de proyectos y equipo',
                        icon: 'fas fa-user-tie',
                        color: 'blue',
                        permissions: {
                            manageUsers: false,
                            manageProjects: true,
                            manageEquipment: true,
                            viewAnalytics: true,
                            manageSettings: false,
                            manageRoles: false,
                            sendNotifications: true,
                            viewReports: true
                        }
                    },
                    operator: {
                        name: 'Operador',
                        description: 'Operación de equipos CNC',
                        icon: 'fas fa-cogs',
                        color: 'green',
                        permissions: {
                            manageUsers: false,
                            manageProjects: false,
                            manageEquipment: false,
                            viewAnalytics: false,
                            manageSettings: false,
                            manageRoles: false,
                            sendNotifications: false,
                            viewReports: false
                        }
                    },
                    technician: {
                        name: 'Técnico',
                        description: 'Mantenimiento y soporte técnico',
                        icon: 'fas fa-tools',
                        color: 'orange',
                        permissions: {
                            manageUsers: false,
                            manageProjects: false,
                            manageEquipment: true,
                            viewAnalytics: false,
                            manageSettings: false,
                            manageRoles: false,
                            sendNotifications: false,
                            viewReports: false
                        }
                    }
                };

                // Cargar configuración guardada
                this.loadRolesConfig();
            }

            getTeamStats() {
                const totalMembers = this.teamMembers.length;
                const onlineMembers = this.teamMembers.filter(m => m.status === 'online').length;
                const activeProjects = this.teamMembers.reduce((sum, m) => sum + m.projects, 0);
                const avgEfficiency = Math.round(this.teamMembers.reduce((sum, m) => sum + m.efficiency, 0) / totalMembers);

                return { totalMembers, onlineMembers, activeProjects, avgEfficiency };
            }

            updateTeamStats() {
                const stats = this.getTeamStats();
                document.getElementById('total-members').textContent = stats.totalMembers;
                document.getElementById('online-members').textContent = stats.onlineMembers;
                document.getElementById('active-projects').textContent = stats.activeProjects;
                document.getElementById('team-efficiency').textContent = stats.avgEfficiency + '%';
            }

            renderTeamMembers(membersToRender = null) {
                const members = membersToRender || this.teamMembers;
                const container = document.getElementById('team-members-list');
                container.innerHTML = members.map(member => `
                    <div class="team-member-card ${member.status}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-4">
                                    <span class="text-white font-semibold text-sm">${member.avatar}</span>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-slate-800">${member.name}</h5>
                                    <div class="flex items-center space-x-2">
                                        <span class="role-badge role-${member.role}">${this.getRoleName(member.role)}</span>
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 bg-${this.getStatusColor(member.status)} rounded-full mr-1"></div>
                                            <span class="text-xs text-slate-500">${this.getStatusText(member.status)}</span>
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">
                                        ${member.projects} proyectos • ${member.efficiency}% eficiencia
                                    </div>
                                    <div class="text-xs text-slate-400 mt-1">
                                        ${member.email} • ${member.phone}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="text-slate-400 hover:text-slate-600" onclick="teamManager.editMember(${member.id})" title="Editar miembro">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-slate-400 hover:text-red-600" onclick="teamManager.removeMember(${member.id})" title="Eliminar miembro">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            getRoleName(role) {
                return this.roles[role] ? this.roles[role].name : role;
            }

            getStatusColor(status) {
                const colors = {
                    online: 'green-500',
                    busy: 'yellow-500',
                    offline: 'red-500'
                };
                return colors[status] || 'gray-500';
            }

            getStatusText(status) {
                const texts = {
                    online: 'En línea',
                    busy: 'Ocupado',
                    offline: 'Desconectado'
                };
                return texts[status] || status;
            }

            addMember(name, email, phone, role) {
                const newMember = {
                    id: Date.now(),
                    name,
                    role,
                    email,
                    phone,
                    status: 'offline',
                    projects: 0,
                    efficiency: 75,
                    lastActive: new Date(),
                    notifications: true,
                    avatar: name.split(' ').map(n => n[0]).join('').toUpperCase()
                };
                this.teamMembers.push(newMember);
                this.renderTeamMembers();
                this.updateTeamStats();
                showNotification('Miembro agregado exitosamente', 'success');
            }

            showAddMemberModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-8 w-full max-w-md mx-4">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6">Agregar Nuevo Miembro</h3>
                        <form id="add-member-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Nombre Completo</label>
                                    <input type="text" id="add-name" class="modern-input w-full" placeholder="Ej: Juan Pérez" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                    <input type="email" id="add-email" class="modern-input w-full" placeholder="juan@taller.com" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                                    <input type="tel" id="add-phone" class="modern-input w-full" placeholder="+52 555 123 4567" required>
                                </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Rol</label>
                                        <select id="add-role" class="modern-input w-full" required>
                                            <option value="">Seleccionar rol</option>
                                            ${Object.entries(this.roles).map(([key, role]) => 
                                                `<option value="${key}">${role.name}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Estado Inicial</label>
                                    <select id="add-status" class="modern-input w-full" required>
                                        <option value="offline">Desconectado</option>
                                        <option value="online">En línea</option>
                                        <option value="busy">Ocupado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" id="cancel-add" class="px-4 py-2 text-slate-600 hover:text-slate-800">Cancelar</button>
                                <button type="submit" class="modern-button">Agregar Miembro</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                document.getElementById('add-member-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('add-name').value;
                    const email = document.getElementById('add-email').value;
                    const phone = document.getElementById('add-phone').value;
                    const role = document.getElementById('add-role').value;
                    const status = document.getElementById('add-status').value;
                    
                    if (name && email && phone && role) {
                        this.addMember(name, email, phone, role);
                        document.body.removeChild(modal);
                    } else {
                        showNotification('Por favor completa todos los campos', 'error');
                    }
                });
                
                // Handle cancel
                document.getElementById('cancel-add').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            }

            editMember(id) {
                const member = this.teamMembers.find(m => m.id === id);
                if (member) {
                    // Create a modal for editing
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl p-8 w-full max-w-md mx-4">
                            <h3 class="text-xl font-semibold text-slate-800 mb-6">Editar Miembro del Equipo</h3>
                            <form id="edit-member-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Nombre</label>
                                        <input type="text" id="edit-name" value="${member.name}" class="modern-input w-full" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                        <input type="email" id="edit-email" value="${member.email}" class="modern-input w-full" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                                        <input type="tel" id="edit-phone" value="${member.phone}" class="modern-input w-full" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Rol</label>
                                        <select id="edit-role" class="modern-input w-full" required>
                                            ${Object.entries(this.roles).map(([key, role]) => 
                                                `<option value="${key}" ${member.role === key ? 'selected' : ''}>${role.name}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Estado</label>
                                        <select id="edit-status" class="modern-input w-full" required>
                                            <option value="online" ${member.status === 'online' ? 'selected' : ''}>En línea</option>
                                            <option value="busy" ${member.status === 'busy' ? 'selected' : ''}>Ocupado</option>
                                            <option value="offline" ${member.status === 'offline' ? 'selected' : ''}>Desconectado</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" id="cancel-edit" class="px-4 py-2 text-slate-600 hover:text-slate-800">Cancelar</button>
                                    <button type="submit" class="modern-button">Guardar Cambios</button>
                                </div>
                            </form>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Handle form submission
                    document.getElementById('edit-member-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const newName = document.getElementById('edit-name').value;
                        const newEmail = document.getElementById('edit-email').value;
                        const newPhone = document.getElementById('edit-phone').value;
                        const newRole = document.getElementById('edit-role').value;
                        const newStatus = document.getElementById('edit-status').value;
                        
                        if (newName && newEmail && newPhone && newRole) {
                            member.name = newName;
                            member.email = newEmail;
                            member.phone = newPhone;
                            member.role = newRole;
                            member.status = newStatus;
                            member.avatar = newName.split(' ').map(n => n[0]).join('').toUpperCase();
                            this.renderTeamMembers();
                            this.updateTeamStats();
                            showNotification('Miembro actualizado exitosamente', 'success');
                            document.body.removeChild(modal);
                        }
                    });
                    
                    // Handle cancel
                    document.getElementById('cancel-edit').addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                }
            }

            removeMember(id) {
                const member = this.teamMembers.find(m => m.id === id);
                if (member) {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl p-8 w-full max-w-md mx-4">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-slate-800 mb-2">Confirmar Eliminación</h3>
                                <p class="text-slate-600 mb-6">
                                    ¿Estás seguro de que deseas eliminar a <strong>${member.name}</strong> del equipo?<br>
                                    Esta acción no se puede deshacer.
                                </p>
                                <div class="flex justify-center space-x-3">
                                    <button id="cancel-delete" class="px-6 py-2 text-slate-600 hover:text-slate-800 border border-slate-300 rounded-lg hover:bg-slate-50">
                                        Cancelar
                                    </button>
                                    <button id="confirm-delete" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                        Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Handle confirmation
                    document.getElementById('confirm-delete').addEventListener('click', () => {
                        this.teamMembers = this.teamMembers.filter(m => m.id !== id);
                        this.renderTeamMembers();
                        this.updateTeamStats();
                        showNotification('Miembro eliminado exitosamente', 'success');
                        document.body.removeChild(modal);
                    });
                    
                    // Handle cancel
                    document.getElementById('cancel-delete').addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                }
            }

            updateNotificationSettings() {
                this.notificationSettings.startTime = document.getElementById('notification-start').value;
                this.notificationSettings.endTime = document.getElementById('notification-end').value;
                this.notificationSettings.workDays = Array.from(document.querySelectorAll('.workday-checkbox:checked')).map(cb => cb.value);
                this.notificationSettings.urgentNotifications = document.getElementById('urgent-notifications').checked;
                this.notificationSettings.dailySummary = document.getElementById('daily-summary').checked;
                this.notificationSettings.weeklyReport = document.getElementById('weekly-report').checked;
                
                localStorage.setItem('team-notification-settings', JSON.stringify(this.notificationSettings));
                showNotification('Configuración de notificaciones guardada', 'success');
            }

            searchMembers(query) {
                const filteredMembers = this.teamMembers.filter(member => 
                    member.name.toLowerCase().includes(query.toLowerCase()) ||
                    member.email.toLowerCase().includes(query.toLowerCase()) ||
                    member.role.toLowerCase().includes(query.toLowerCase())
                );
                this.renderTeamMembers(filteredMembers);
            }

            filterByRole(role) {
                if (role === 'all' || role === '') {
                    this.renderTeamMembers();
                } else {
                    const filteredMembers = this.teamMembers.filter(member => member.role === role);
                    this.renderTeamMembers(filteredMembers);
                }
            }

            // Métodos para gestión de roles y permisos
            loadRolesConfig() {
                const savedRoles = localStorage.getItem('team-roles-config');
                if (savedRoles) {
                    const parsedRoles = JSON.parse(savedRoles);
                    this.roles = { ...this.roles, ...parsedRoles };
                }
            }

            saveRolesConfig() {
                localStorage.setItem('team-roles-config', JSON.stringify(this.roles));
            }

            editRole(roleKey) {
                console.log('editRole called with:', roleKey);
                const role = this.roles[roleKey];
                if (!role) {
                    console.log('Role not found:', roleKey);
                    return;
                }
                console.log('Opening edit modal for role:', role);

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-8 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6">Editar Rol: ${role.name}</h3>
                        <form id="edit-role-form">
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Nombre del Rol</label>
                                        <input type="text" id="role-name" value="${role.name}" class="modern-input w-full" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Descripción</label>
                                        <input type="text" id="role-description" value="${role.description}" class="modern-input w-full" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Icono</label>
                                    <select id="role-icon" class="modern-input w-full" required>
                                        <option value="fas fa-crown" ${role.icon === 'fas fa-crown' ? 'selected' : ''}>👑 Corona</option>
                                        <option value="fas fa-user-tie" ${role.icon === 'fas fa-user-tie' ? 'selected' : ''}>👔 Ejecutivo</option>
                                        <option value="fas fa-cogs" ${role.icon === 'fas fa-cogs' ? 'selected' : ''}>⚙️ Engranajes</option>
                                        <option value="fas fa-tools" ${role.icon === 'fas fa-tools' ? 'selected' : ''}>🔧 Herramientas</option>
                                        <option value="fas fa-user-shield" ${role.icon === 'fas fa-user-shield' ? 'selected' : ''}>🛡️ Seguridad</option>
                                        <option value="fas fa-chart-line" ${role.icon === 'fas fa-chart-line' ? 'selected' : ''}>📈 Análisis</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Color</label>
                                    <select id="role-color" class="modern-input w-full" required>
                                        <option value="red" ${role.color === 'red' ? 'selected' : ''}>🔴 Rojo</option>
                                        <option value="blue" ${role.color === 'blue' ? 'selected' : ''}>🔵 Azul</option>
                                        <option value="green" ${role.color === 'green' ? 'selected' : ''}>🟢 Verde</option>
                                        <option value="orange" ${role.color === 'orange' ? 'selected' : ''}>🟠 Naranja</option>
                                        <option value="purple" ${role.color === 'purple' ? 'selected' : ''}>🟣 Morado</option>
                                        <option value="yellow" ${role.color === 'yellow' ? 'selected' : ''}>🟡 Amarillo</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-3">Permisos</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="perm-manageUsers" ${role.permissions.manageUsers ? 'checked' : ''} class="rounded">
                                            <span class="text-sm text-slate-700">Gestionar Usuarios</span>
                                        </label>
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="perm-manageProjects" ${role.permissions.manageProjects ? 'checked' : ''} class="rounded">
                                            <span class="text-sm text-slate-700">Gestionar Proyectos</span>
                                        </label>
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="perm-manageEquipment" ${role.permissions.manageEquipment ? 'checked' : ''} class="rounded">
                                            <span class="text-sm text-slate-700">Gestionar Equipos</span>
                                        </label>
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="perm-viewAnalytics" ${role.permissions.viewAnalytics ? 'checked' : ''} class="rounded">
                                            <span class="text-sm text-slate-700">Ver Análisis</span>
                                        </label>
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="perm-manageSettings" ${role.permissions.manageSettings ? 'checked' : ''} class="rounded">
                                            <span class="text-sm text-slate-700">Gestionar Configuración</span>
                                        </label>
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="perm-manageRoles" ${role.permissions.manageRoles ? 'checked' : ''} class="rounded">
                                            <span class="text-sm text-slate-700">Gestionar Roles</span>
                                        </label>
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="perm-sendNotifications" ${role.permissions.sendNotifications ? 'checked' : ''} class="rounded">
                                            <span class="text-sm text-slate-700">Enviar Notificaciones</span>
                                        </label>
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="perm-viewReports" ${role.permissions.viewReports ? 'checked' : ''} class="rounded">
                                            <span class="text-sm text-slate-700">Ver Reportes</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" id="cancel-role-edit" class="px-4 py-2 text-slate-600 hover:text-slate-800">Cancelar</button>
                                <button type="submit" class="modern-button">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                document.getElementById('edit-role-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const updatedRole = {
                        name: document.getElementById('role-name').value,
                        description: document.getElementById('role-description').value,
                        icon: document.getElementById('role-icon').value,
                        color: document.getElementById('role-color').value,
                        permissions: {
                            manageUsers: document.getElementById('perm-manageUsers').checked,
                            manageProjects: document.getElementById('perm-manageProjects').checked,
                            manageEquipment: document.getElementById('perm-manageEquipment').checked,
                            viewAnalytics: document.getElementById('perm-viewAnalytics').checked,
                            manageSettings: document.getElementById('perm-manageSettings').checked,
                            manageRoles: document.getElementById('perm-manageRoles').checked,
                            sendNotifications: document.getElementById('perm-sendNotifications').checked,
                            viewReports: document.getElementById('perm-viewReports').checked
                        }
                    };
                    
                    this.roles[roleKey] = updatedRole;
                    this.saveRolesConfig();
                    this.renderRolesAndPermissions();
                    showNotification('Rol actualizado exitosamente', 'success');
                    document.body.removeChild(modal);
                });
                
                // Handle cancel
                document.getElementById('cancel-role-edit').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            }

            renderRolesAndPermissions() {
                console.log('renderRolesAndPermissions called');
                const container = document.getElementById('roles-list');
                if (!container) {
                    console.log('Roles container not found');
                    return;
                }
                console.log('Container found, rendering roles:', Object.keys(this.roles));

                container.innerHTML = Object.entries(this.roles).map(([key, role]) => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-${role.color}-100 rounded-full flex items-center justify-center mr-3">
                                <i class="${role.icon} text-${role.color}-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-medium text-slate-800">${role.name}</div>
                                <div class="text-xs text-slate-500">${role.description}</div>
                            </div>
                        </div>
                        <button class="text-slate-400 hover:text-slate-600" onclick="window.teamManager.editRole('${key}')" title="Editar rol">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `).join('');
            }

            testRolesFunction() {
                console.log('Testing roles function...');
                console.log('teamManager exists:', typeof window.teamManager);
                console.log('roles object:', this.roles);
                console.log('roles-list element:', document.getElementById('roles-list'));
                
                // Probar renderizado
                this.renderRolesAndPermissions();
                
                // Probar edición de un rol
                setTimeout(() => {
                    console.log('Testing editRole function...');
                    this.editRole('admin');
                }, 1000);
            }
        }

        // --- Advanced Knowledge Base System ---
        class AdvancedKnowledgeManager {
            constructor() {
                this.knowledgeItems = [];
                this.categories = ['equipment', 'materials', 'processes', 'standards', 'projects'];
                this.templates = {
                    equipment: 'Equipos disponibles:\n- Torno CNC: 3 ejes, 500mm diámetro, precisión ±0.01mm\n- Fresadora: mesa 1000x500mm, 4 ejes, precisión ±0.005mm\n- Robots KUKA: automatización completa',
                    materials: 'Materiales trabajados:\n- Acero inoxidable: 304, 316L\n- Aluminio: 6061-T6, 7075\n- Titanio: Grade 2, Grade 5\n- Aceros especiales: herramientas, templados',
                    processes: 'Procesos de fabricación:\n- Torneado CNC: cilíndrico, cónico, roscado\n- Fresado: 2D, 3D, geometrías complejas\n- Automatización: carga/descarga, inspección\n- Acabados: pulido, anodizado, recubrimientos',
                    standards: 'Estándares y tolerancias:\n- ISO 9001:2015\n- Tolerancias estándar: ±0.01mm\n- Tolerancias precisión: ±0.005mm\n- Tolerancias alta precisión: ±0.001mm\n- Rugosidad superficial: Ra 0.8-3.2'
                };
                this.loadKnowledge();
            }

            loadKnowledge() {
                const saved = localStorage.getItem('advanced-knowledge');
                if (saved) {
                    this.knowledgeItems = JSON.parse(saved);
                }
                this.updateKnowledgeStats();
                this.renderKnowledgeItems();
            }

            saveKnowledge() {
                localStorage.setItem('advanced-knowledge', JSON.stringify(this.knowledgeItems));
            }

            updateKnowledgeStats() {
                document.getElementById('knowledge-items').textContent = this.knowledgeItems.length;
                document.getElementById('documents-count').textContent = this.knowledgeItems.filter(item => item.type === 'document').length;
                document.getElementById('ai-insights').textContent = this.knowledgeItems.filter(item => item.type === 'insight').length;
                
                const totalProgress = this.categories.reduce((sum, category) => {
                    const categoryItems = this.knowledgeItems.filter(item => item.category === category).length;
                    return sum + Math.min(categoryItems * 10, 100);
                }, 0);
                const avgProgress = Math.round(totalProgress / this.categories.length);
                document.getElementById('learning-progress').textContent = avgProgress + '%';
            }

            addKnowledgeItem(content, category, type = 'text') {
                const item = {
                    id: Date.now(),
                    content,
                    category,
                    type,
                    timestamp: new Date(),
                    tags: this.extractTags(content)
                };
                this.knowledgeItems.unshift(item);
                this.saveKnowledge();
                this.updateKnowledgeStats();
                this.renderKnowledgeItems();
                showNotification('Conocimiento agregado exitosamente', 'success');
            }

            extractTags(content) {
                const tags = [];
                const lowerContent = content.toLowerCase();
                
                if (lowerContent.includes('torno') || lowerContent.includes('cnc')) tags.push('torno');
                if (lowerContent.includes('fresadora') || lowerContent.includes('fresado')) tags.push('fresado');
                if (lowerContent.includes('robot') || lowerContent.includes('automatización')) tags.push('automatización');
                if (lowerContent.includes('acero') || lowerContent.includes('aluminio') || lowerContent.includes('titanio')) tags.push('materiales');
                if (lowerContent.includes('tolerancia') || lowerContent.includes('precisión')) tags.push('tolerancias');
                
                return tags;
            }

            renderKnowledgeItems() {
                const container = document.getElementById('knowledge-results');
                if (this.knowledgeItems.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-database text-4xl text-slate-300 mb-4"></i>
                            <p class="text-slate-500">No hay elementos de conocimiento aún</p>
                            <p class="text-sm text-slate-400">Agrega información sobre tu taller para comenzar</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.knowledgeItems.map(item => `
                    <div class="knowledge-item">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="knowledge-category category-${item.category}">${this.getCategoryName(item.category)}</span>
                                    <span class="text-xs text-slate-500">${item.type}</span>
                                    <span class="text-xs text-slate-400">${this.formatDate(item.timestamp)}</span>
                                </div>
                                <p class="text-slate-700 text-sm mb-2">${item.content.substring(0, 200)}${item.content.length > 200 ? '...' : ''}</p>
                                ${item.tags.length > 0 ? `
                                    <div class="flex flex-wrap gap-1">
                                        ${item.tags.map(tag => `<span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">${tag}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <button class="text-slate-400 hover:text-slate-600" onclick="knowledgeManager.editItem(${item.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-slate-400 hover:text-red-600" onclick="knowledgeManager.removeItem(${item.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            getCategoryName(category) {
                const names = {
                    equipment: 'Equipos',
                    materials: 'Materiales',
                    processes: 'Procesos',
                    standards: 'Estándares',
                    projects: 'Proyectos'
                };
                return names[category] || category;
            }

            formatDate(date) {
                return new Date(date).toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            searchKnowledge(query) {
                const filtered = this.knowledgeItems.filter(item => 
                    item.content.toLowerCase().includes(query.toLowerCase()) ||
                    item.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
                );
                
                const container = document.getElementById('knowledge-results');
                container.innerHTML = filtered.map(item => `
                    <div class="knowledge-item">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="knowledge-category category-${item.category}">${this.getCategoryName(item.category)}</span>
                                    <span class="text-xs text-slate-500">${item.type}</span>
                                    <span class="text-xs text-slate-400">${this.formatDate(item.timestamp)}</span>
                                </div>
                                <p class="text-slate-700 text-sm mb-2">${item.content.substring(0, 200)}${item.content.length > 200 ? '...' : ''}</p>
                                ${item.tags.length > 0 ? `
                                    <div class="flex flex-wrap gap-1">
                                        ${item.tags.map(tag => `<span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">${tag}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            editItem(id) {
                const item = this.knowledgeItems.find(i => i.id === id);
                if (item) {
                    const newContent = prompt('Contenido:', item.content);
                    if (newContent) {
                        item.content = newContent;
                        item.tags = this.extractTags(newContent);
                        this.saveKnowledge();
                        this.renderKnowledgeItems();
                        showNotification('Elemento actualizado', 'success');
                    }
                }
            }

            removeItem(id) {
                if (confirm('¿Estás seguro de eliminar este elemento?')) {
                    this.knowledgeItems = this.knowledgeItems.filter(i => i.id !== id);
                    this.saveKnowledge();
                    this.updateKnowledgeStats();
                    this.renderKnowledgeItems();
                    showNotification('Elemento eliminado', 'success');
                }
            }

            clearAll() {
                if (confirm('¿Estás seguro de eliminar todo el conocimiento? Esta acción no se puede deshacer.')) {
                    this.knowledgeItems = [];
                    this.saveKnowledge();
                    this.updateKnowledgeStats();
                    this.renderKnowledgeItems();
                    showNotification('Base de conocimiento limpiada', 'success');
                }
            }
        }

        // Initialize managers
        window.teamManager = new AdvancedTeamManager();
        window.knowledgeManager = new AdvancedKnowledgeManager();

        // Team management event listeners
        const addTeamMemberBtn = document.getElementById('add-team-member-btn');
        if (addTeamMemberBtn) {
            addTeamMemberBtn.addEventListener('click', () => {
                window.teamManager.showAddMemberModal();
            });
        }

        // Team search functionality
        const teamSearchInput = document.getElementById('team-search');
        if (teamSearchInput) {
            teamSearchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                if (query.trim() === '') {
                    window.teamManager.renderTeamMembers();
                } else {
                    window.teamManager.searchMembers(query);
                }
            });
        }

        // Team role filter functionality
        const roleFilterSelect = document.getElementById('role-filter');
        if (roleFilterSelect) {
            roleFilterSelect.addEventListener('change', (e) => {
                window.teamManager.filterByRole(e.target.value);
            });
        }

        // Knowledge management event listeners
        const uploadTextKnowledgeBtn = document.getElementById('upload-text-knowledge');
        if (uploadTextKnowledgeBtn) {
            uploadTextKnowledgeBtn.addEventListener('click', () => {
                const content = document.getElementById('knowledge-text').value;
                if (content.trim()) {
                    knowledgeManager.addKnowledgeItem(content, 'equipment', 'text');
                    document.getElementById('knowledge-text').value = '';
                }
            });
        }

        const knowledgeSearchInput = document.getElementById('knowledge-search');
        if (knowledgeSearchInput) {
            knowledgeSearchInput.addEventListener('input', (e) => {
                if (e.target.value.trim()) {
                    knowledgeManager.searchKnowledge(e.target.value);
                } else {
                    knowledgeManager.renderKnowledgeItems();
                }
            });
        }

        const clearKnowledgeBtn = document.getElementById('clear-knowledge');
        if (clearKnowledgeBtn) {
            clearKnowledgeBtn.addEventListener('click', () => {
                knowledgeManager.clearAll();
            });
        }

        // Template buttons
        document.querySelectorAll('.template-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const template = btn.dataset.template;
                const content = knowledgeManager.templates[template];
                const knowledgeTextArea = document.getElementById('knowledge-text');
                if (knowledgeTextArea && content) {
                    knowledgeTextArea.value = content;
                }
            });
        });

        // --- Application Health Check ---
        function performHealthCheck() {
            const healthStatus = {
                navigation: false,
                teamManagement: false,
                knowledgeBase: false,
                notifications: false,
                whatsapp: false,
                pwa: false
            };
            
            try {
                // Check navigation
                const navTabs = document.querySelectorAll('.nav-tab');
                const tabContents = document.querySelectorAll('.tab-content');
                healthStatus.navigation = navTabs.length > 0 && tabContents.length > 0;
                
                // Check team management
                const teamElements = [
                    'add-team-member-btn',
                    'team-members-list',
                    'total-members',
                    'online-members'
                ];
                healthStatus.teamManagement = teamElements.every(id => document.getElementById(id));
                
                // Check knowledge base
                const knowledgeElements = [
                    'knowledge-text',
                    'knowledge-search',
                    'knowledge-results'
                ];
                healthStatus.knowledgeBase = knowledgeElements.every(id => document.getElementById(id));
                
                // Check notifications
                healthStatus.notifications = 'Notification' in window;
                
                // Check WhatsApp
                const whatsappElements = [
                    'whatsapp-web-number',
                    'whatsapp-web-intro',
                    'test-whatsapp-web'
                ];
                healthStatus.whatsapp = whatsappElements.every(id => document.getElementById(id));
                
                // Check PWA
                healthStatus.pwa = 'serviceWorker' in navigator;
                
                console.log('Application Health Check:', healthStatus);
                
                // Show overall status
                const allHealthy = Object.values(healthStatus).every(status => status);
                if (allHealthy) {
                    console.log('✅ All systems operational');
                } else {
                    console.warn('⚠️ Some systems may have issues:', healthStatus);
                }
                
                return healthStatus;
                
            } catch (error) {
                console.error('Health check failed:', error);
                return healthStatus;
            }
        }

        // Run health check after initialization
        setTimeout(() => {
            performHealthCheck();
        }, 2000);

        // Initialize team stats and render
        window.teamManager.updateTeamStats();
        window.teamManager.renderTeamMembers();
        window.teamManager.renderRolesAndPermissions();
    </script>
</body>
</html>

