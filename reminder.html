<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cerebro de Proyectos IA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10a985">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CNC Reminders">
    <meta name="description" content="Sistema de recordatorios y notificaciones para proyectos de taller CNC">
    <meta name="keywords" content="taller, cnc, recordatorios, proyectos, notificaciones">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMxMEE5ODUiLz4KPHBhdGggZD0iTTQ4IDY0SDQ0QzQwLjY4NjMgNjQgMzggNjYuNjg2MyAzOCA3MFY4NkMzOCA4OS4zMTM3IDQwLjY4NjMgOTIgNDQgOTJINDRDNDcuMzEzNyA5MiA1MCA4OS4zMTM3IDUwIDg2VjcwQzUwIDY2LjY4NjMgNDcuMzEzNyA2NCA0NCA2NFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik04NCA2NEg4MEM3Ni42ODYzIDY0IDc0IDY2LjY4NjMgNzQgNzBWODZDNzQgODkuMzEzNyA3Ni42ODYzIDkyIDgwIDkySDEwNEMxMDcuMzE0IDkyIDExMCA4OS4zMTM3IDExMCA4NlY3MEMxMTAgNjYuNjg2MyAxMDcuMzE0IDY0IDEwNCA2NEg4NFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xMjAgNjRIMTE2QzExMi42ODYgNjQgMTEwIDY2LjY4NjMgMTEwIDcwVjg2QzExMCA4OS4zMTM3IDExMi42ODYgOTIgMTE2IDkySDE1MkMxNTUuMzE0IDkyIDE1OCA4OS4zMTM3IDE1OCA4NlY3MEMxNTggNjYuNjg2MyAxNTUuMzE0IDY0IDE1MiA2NEgxMjBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNNDggMTEwSDQ0QzQwLjY4NjMgMTEwIDM4IDExMi42ODYgMzggMTE2VjEzMkMzOCAxMzUuMzE0IDQwLjY4NjMgMTM4IDQ0IDEzOEg0NEM0Ny4zMTM3IDEzOCA1MCAxMzUuMzE0IDUwIDEzMlYxMTZDNTAgMTEyLjY4NiA0Ny4zMTM3IDExMCA0NCAxMTBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNODQgMTEwSDgwQzc2LjY4NjMgMTEwIDc0IDExMi42ODYgNzQgMTE2VjEzMkM3NCAxMzUuMzE0IDc2LjY4NjMgMTM4IDgwIDEzOEgxMDRDMTA3LjMxNCAxMzggMTEwIDEzNS4zMTQgMTEwIDEzMlYxMTZDMTEwIDExMi42ODYgMTA3LjMxNCAxMTAgMTA0IDExMEg4NFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xMjAgMTEwSDExNkMxMTIuNjg2IDExMCAxMTAgMTEyLjY4NiAxMTAgMTE2VjEzMkMxMTAgMTM1LjMxNCAxMTIuNjg2IDEzOCAxMTYgMTM4SDE1MkMxNTUuMzE0IDEzOCAxNTggMTM1LjMxNCAxNTggMTMyVjExNkMxNTggMTEyLjY4NiAxNTUuMzE0IDExMCAxNTIgMTEwSDEyMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xNjggNjRIMTY0QzE2MC42ODYgNjQgMTU4IDY2LjY4NjMgMTU4IDcwVjg2QzE1OCA4OS4zMTM3IDE2MC42ODYgOTIgMTY0IDkySDE2NEMxNjcuMzE0IDkyIDE3MCA4OS4zMTM3IDE3MCA4NlY3MEMxNzAgNjYuNjg2MyAxNjcuMzE0IDY0IDE2NCA2NEgxNjhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTY4IDExMEgxNjRDMTYwLjY4NiAxMTAgMTU4IDExMi42ODYgMTU4IDExNlYxMzJDMTU4IDEzNS4zMTQgMTYwLjY4NiAxMzggMTY0IDEzOEgxNjRDMTY3LjMxNCAxMzggMTcwIDEzNS4zMTQgMTcwIDEzMlYxMTZDMTcwIDExMi42ODYgMTY3LjMxNCAxMTAgMTY0IDExMEgxNjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiMxMEE5ODUiLz4KPHBhdGggZD0iTTEyIDEySDIwVjIwSDEyVjEyWiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #1e293b;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .hidden {
            display: none !important;
        }
        
        .glass-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border-radius: 16px;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .glass-card {
                margin: 0.5rem;
                padding: 1rem;
                border-radius: 1rem;
            }
            
            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            .modern-button {
                padding: 0.75rem 1.5rem;
                font-size: 0.875rem;
            }
            
            .notification-card {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            .project-card {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            /* Mobile-specific touch targets */
            button, .nav-tab, .clickable {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Better mobile scrolling */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Mobile-friendly forms */
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.75rem;
            }
            
            /* Mobile navigation improvements */
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .nav-tabs::-webkit-scrollbar {
                display: none;
            }
        }

        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .glass-card {
                margin: 0.5rem;
            }
        }

        /* Force light theme - no dark mode */
        @media (prefers-color-scheme: dark) {
            body {
                background: #ffffff !important;
                color: #1e293b !important;
            }
            
            .glass-card {
                background: #ffffff !important;
                border: 1px solid #e2e8f0 !important;
                color: #1e293b !important;
            }
            
            .modern-input {
                background: #ffffff !important;
                color: #1e293b !important;
                border: 1px solid #d1d5db !important;
            }
            
            h1, h2, h3, h4, h5, h6 {
                color: #1e293b !important;
            }
            
            p, span, div {
                color: #374151 !important;
            }
        }
        
        .due-soon {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        .due-today {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }
        
        .overdue {
            border-left: 4px solid #dc2626;
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        #loading-spinner {
            display: none;
        }
        
        #loading-spinner.show {
            display: flex;
        }
        
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .parsed-field {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .parsed-field:focus {
            border-color: #3b82f6;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .modern-input {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 20px;
            font-size: 15px;
            font-weight: 400;
            color: #1e293b;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .modern-input:focus {
            outline: none;
            border-color: #10a985;
            box-shadow: 0 0 0 3px rgba(16, 169, 133, 0.1);
            transform: translateY(-1px);
            background: #ffffff;
        }
        
        .modern-input::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }
        
        .modern-input:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        /* File upload area styling */
        .border-dashed {
            background: #ffffff !important;
            border-color: #d1d5db !important;
            color: #374151 !important;
        }
        
        .border-dashed:hover {
            border-color: #10a985 !important;
            background: #f8fafc !important;
        }
        
        .border-dashed i {
            color: #6b7280 !important;
        }
        
        .border-dashed p {
            color: #6b7280 !important;
        }
        
        /* Text areas and content areas */
        textarea {
            background: #ffffff !important;
            color: #1e293b !important;
            border: 1px solid #d1d5db !important;
        }
        
        /* Headers and titles */
        h1, h2, h3, h4, h5, h6 {
            color: #1e293b !important;
        }
        
        /* Text content */
        p, span, div {
            color: #374151 !important;
        }
        
        /* Icons - More visible colors */
        .fas, .far, .fab {
            color: #10a985 !important;  /* Green for primary icons */
        }
        
        /* Icon categories with different colors */
        .fas.fa-home, .fas.fa-dashboard, .fas.fa-tachometer-alt {
            color: #10a985 !important;  /* Green for dashboard icons */
        }
        
        .fas.fa-project-diagram, .fas.fa-tasks, .fas.fa-clipboard-list {
            color: #3b82f6 !important;  /* Blue for project icons */
        }
        
        .fas.fa-chart-line, .fas.fa-analytics, .fas.fa-chart-bar {
            color: #8b5cf6 !important;  /* Purple for analytics icons */
        }
        
        .fas.fa-users, .fas.fa-user-friends, .fas.fa-team {
            color: #f59e0b !important;  /* Orange for team icons */
        }
        
        .fas.fa-brain, .fas.fa-robot, .fas.fa-magic {
            color: #ef4444 !important;  /* Red for AI icons */
        }
        
        .fas.fa-book, .fas.fa-graduation-cap, .fas.fa-lightbulb {
            color: #06b6d4 !important;  /* Cyan for knowledge icons */
        }
        
        .fas.fa-whatsapp, .fas.fa-comments, .fas.fa-message {
            color: #25d366 !important;  /* WhatsApp green for notifications */
        }
        
        .fas.fa-cog, .fas.fa-settings, .fas.fa-wrench {
            color: #6b7280 !important;  /* Gray for settings icons */
        }
        
        .fas.fa-shopping-cart, .fas.fa-box, .fas.fa-truck {
            color: #f97316 !important;  /* Orange for purchasing icons */
        }
        
        .fas.fa-upload, .fas.fa-download, .fas.fa-file-upload {
            color: #059669 !important;  /* Dark green for upload icons */
        }
        
        .fas.fa-plus, .fas.fa-add, .fas.fa-create {
            color: #10a985 !important;  /* Green for add/create icons */
        }
        
        .fas.fa-edit, .fas.fa-pencil, .fas.fa-edit-alt {
            color: #3b82f6 !important;  /* Blue for edit icons */
        }
        
        .fas.fa-trash, .fas.fa-delete, .fas.fa-remove {
            color: #ef4444 !important;  /* Red for delete icons */
        }
        
        .fas.fa-save, .fas.fa-check, .fas.fa-check-circle {
            color: #10a985 !important;  /* Green for save/success icons */
        }
        
        .fas.fa-clock, .fas.fa-time, .fas.fa-calendar {
            color: #f59e0b !important;  /* Orange for time icons */
        }
        
        .fas.fa-bell, .fas.fa-notification, .fas.fa-alert {
            color: #ef4444 !important;  /* Red for notification icons */
        }
        
        /* Enhanced icon visibility with effects */
        .fas, .far, .fab {
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .fas:hover, .far:hover, .fab:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* Icon containers for better visibility */
        .icon-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .icon-container:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        
        /* Navigation tab icons */
        .nav-tab .fas, .nav-tab .far, .nav-tab .fab {
            font-size: 1.1em;
            margin-right: 8px;
        }
        
        /* Status icons with specific colors */
        .status-icon.success {
            color: #10a985 !important;
        }
        
        .status-icon.warning {
            color: #f59e0b !important;
        }
        
        .status-icon.error {
            color: #ef4444 !important;
        }
        
        .status-icon.info {
            color: #3b82f6 !important;
        }
        
        /* Action icons with backgrounds */
        .action-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .action-icon.primary {
            background: linear-gradient(135deg, #10a985 0%, #059669 100%);
        }
        
        .action-icon.secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .action-icon.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .action-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Force all dark elements to be white/light */
        .bg-slate-800, .bg-slate-900, .bg-gray-800, .bg-gray-900 {
            background-color: #ffffff !important;
            color: #1e293b !important;
        }
        
        .text-slate-800, .text-slate-900, .text-gray-800, .text-gray-900 {
            color: #1e293b !important;
        }
        
        .border-slate-800, .border-slate-900, .border-gray-800, .border-gray-900 {
            border-color: #d1d5db !important;
        }
        
        /* Specific dark elements that should be light */
        .bg-dark, .dark-bg, .dark-background {
            background-color: #ffffff !important;
            color: #1e293b !important;
        }
        
        /* Knowledge upload section */
        .knowledge-section {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
        }
        
        .knowledge-section textarea {
            background: #ffffff !important;
            color: #1e293b !important;
            border: 1px solid #d1d5db !important;
        }
        
        .modern-button {
            background: linear-gradient(135deg, #10a985 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(16, 169, 133, 0.3);
        }
        
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 169, 133, 0.4);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .modern-button:active {
            transform: translateY(0);
        }
        
        .project-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #e2e8f0;
        }
        
        .delete-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            color: #64748b;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #fee2e2;
            border-color: #fecaca;
            color: #dc2626;
            transform: scale(1.05);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .status-due-soon {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-due-today {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .status-overdue {
            background: #fef2f2;
            color: #b91c1c;
        }
        
        .status-normal {
            background: #f0f9ff;
            color: #0369a1;
        }
        
        /* Date picker styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.4);
            cursor: pointer;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* AI Assistant Styles */
        .ai-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .ai-chat.open {
            transform: translateY(0);
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .ai-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .ai-message.user {
            justify-content: flex-end;
        }

        .ai-message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .ai-message.bot .ai-message-content {
            background: white;
            border: 1px solid #e2e8f0;
            margin-right: 10px;
        }

        .ai-message.user .ai-message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 10px;
        }

        .ai-input-container {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
            border-radius: 0 0 20px 20px;
        }

        .ai-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .ai-input:focus {
            border-color: #667eea;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .metric-change {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .metric-change.positive {
            color: #059669;
        }

        .metric-change.negative {
            color: #dc2626;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 32px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #64748b;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #334155;
        }

        /* Team Management */
        .team-member {
            display: flex;
            align-items: center;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .team-member:hover {
            transform: translateY(-2px);
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 16px;
        }

        /* AI Learning Indicators */
        .ai-learning {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .ai-insight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .ai-prediction {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #22c55e;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .ai-chat {
                width: calc(100vw - 40px);
                height: calc(100vh - 40px);
                bottom: 20px;
                right: 20px;
                left: 20px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                margin-bottom: 4px;
            }
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #22c55e;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification-method-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .notification-method-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .notification-method-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .notification-method-card input[type="radio"]:checked + span {
            color: #3b82f6;
            font-weight: 600;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification.error {
            border-left-color: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-16">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-purple-500 via-blue-500 to-cyan-500 rounded-3xl mb-6 shadow-xl">
                <i class="fas fa-brain text-white text-3xl"></i>
            </div>
            <h1 class="text-5xl md:text-6xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-cyan-600 bg-clip-text text-transparent mb-4 tracking-tight">Cerebro de Proyectos IA</h1>
            <p class="text-xl text-slate-600 max-w-3xl mx-auto leading-relaxed">Tu asistente inteligente de gestión de proyectos que aprende, predice y optimiza tu flujo de trabajo automáticamente.</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-chart-line mr-2"></i>Panel
            </div>
            <div class="nav-tab" data-tab="projects">
                <i class="fas fa-tasks mr-2"></i>Proyectos
            </div>
            <div class="nav-tab" data-tab="analytics">
                <i class="fas fa-analytics mr-2"></i>Análisis
            </div>
            <div class="nav-tab" data-tab="team">
                <i class="fas fa-users mr-2"></i>Equipo
            </div>
            <div class="nav-tab" data-tab="ai-insights">
                <i class="fas fa-robot mr-2"></i>Insights IA
            </div>
            <div class="nav-tab" data-tab="knowledge">
                <i class="fas fa-database mr-2"></i>Base de Conocimiento
            </div>
            <div class="nav-tab" data-tab="whatsapp">
                <i class="fab fa-whatsapp mr-2"></i>WhatsApp
            </div>
            <div class="nav-tab" data-tab="purchasing">
                <i class="fas fa-shopping-cart mr-2"></i>Compras
            </div>
            <div class="nav-tab" data-tab="settings">
                <i class="fas fa-cog mr-2"></i>Configuraciones
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <!-- AI Learning Status -->
            <div class="ai-learning">
                <div class="flex items-center mb-3">
                    <i class="fas fa-brain text-blue-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-blue-800">Estado de Aprendizaje IA</h3>
                </div>
                <p class="text-blue-700 mb-2">La IA está analizando tus patrones de proyectos y aprendiendo tu flujo de trabajo empresarial...</p>
                <div class="w-full bg-blue-200 rounded-full h-2">
                    <div id="ai-learning-progress" class="bg-blue-500 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p class="text-sm text-blue-600 mt-2">Progreso de Aprendizaje: <span id="learning-percentage">0%</span></p>
            </div>

            <!-- Key Metrics Dashboard -->
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-tasks text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">+12%</span>
                    </div>
                    <div class="metric-value" id="total-projects">0</div>
                    <div class="metric-label">Total Proyectos</div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">+8%</span>
                    </div>
                    <div class="metric-value" id="completed-projects">0</div>
                    <div class="metric-label">Completados Este Mes</div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <span class="text-sm text-red-600 font-semibold">-5%</span>
                    </div>
                    <div class="metric-value" id="overdue-projects">0</div>
                    <div class="metric-label">Proyectos Atrasados</div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">+15%</span>
                    </div>
                    <div class="metric-value" id="efficiency-score">0%</div>
                    <div class="metric-label">Puntuación Eficiencia IA</div>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="ai-insight">
                <div class="flex items-center mb-3">
                    <i class="fas fa-lightbulb text-yellow-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-yellow-800">Insight IA</h3>
                </div>
                <p id="ai-insight-text" class="text-yellow-700">Basándome en tus patrones de proyectos, he notado que los proyectos con "brida" en la descripción tienden a tomar 15% más tiempo del estimado. Considera agregar tiempo de buffer para proyectos similares.</p>
            </div>

            <!-- AI Predictions -->
            <div class="ai-prediction">
                <div class="flex items-center mb-3">
                    <i class="fas fa-crystal-ball text-green-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-green-800">Predicción IA</h3>
                </div>
                <p id="ai-prediction-text" class="text-green-700">Basándome en la carga de trabajo actual y datos históricos, es probable que completes 85% de los proyectos a tiempo este mes. Considera priorizar los 3 proyectos que vencen la próxima semana.</p>
            </div>

            <!-- Project Timeline Chart -->
            <div class="glass-card p-8 rounded-2xl">
                <h3 class="text-xl font-semibold text-slate-800 mb-6">Cronograma de Proyectos</h3>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects-tab" class="tab-content hidden">
        <!-- Form to Add New Project -->
            <div class="glass-card p-8 rounded-2xl mb-12">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-plus text-white text-sm"></i>
                </div>
                <div>
                        <h2 class="text-2xl font-semibold text-slate-800">Agregar Nuevo Proyecto</h2>
                        <p class="text-slate-600">Copia los detalles del proyecto de tu otro sistema y pégalos abajo.</p>
                    </div>
                </div>
                
                <div class="mb-8">
                    <label for="smart-entry" class="block text-sm font-semibold text-slate-700 mb-3">Entrada Inteligente</label>
                    <textarea id="smart-entry" rows="4" class="modern-input w-full resize-none" placeholder="ej.,&#10;Número PO: 11-2345&#10;Trabajo: Bridas para Cliente XYZ&#10;Fecha Vencimiento: 2025-12-25"></textarea>
                    <p class="text-xs text-slate-500 mt-2">Pega la información del proyecto y extraeremos automáticamente los detalles abajo.</p>
            </div>

                <form id="add-project-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                            <label for="po-number" class="block text-sm font-semibold text-slate-700 mb-3">PO / Número de Orden</label>
                            <input type="text" id="po-number" name="po-number" required class="modern-input w-full parsed-field" placeholder="Auto-completado desde pegar">
                </div>
                <div>
                            <label for="due-date" class="block text-sm font-semibold text-slate-700 mb-3">Fecha de Vencimiento</label>
                            <input type="date" id="due-date" name="due-date" required class="modern-input w-full parsed-field">
                </div>
                </div>
                    
                    <div>
                        <label for="project-description" class="block text-sm font-semibold text-slate-700 mb-3">Descripción del Proyecto</label>
                        <input type="text" id="project-description" name="project-description" required class="modern-input w-full parsed-field" placeholder="Auto-completado desde pegar">
                </div>
                    
                    <div class="flex justify-end pt-4">
                        <button type="submit" class="modern-button flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Agregar Proyecto
                </button>
                    </div>
            </form>
        </div>

        <!-- Loading Spinner -->
            <div id="loading-spinner" class="flex justify-center items-center py-16 show">
                <div class="flex flex-col items-center">
                    <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-slate-600 font-medium">Cargando proyectos...</p>
                </div>
        </div>

        <!-- Project List -->
        <div id="project-list-container">
                <div class="flex items-center mb-8">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-list-check text-white text-sm"></i>
            </div>
                    <div>
                        <h2 class="text-2xl font-semibold text-slate-800">Proyectos Activos</h2>
                        <p class="text-slate-600">Gestiona y rastrea las fechas límite de tus proyectos</p>
        </div>
    </div>
                
                <div id="project-list" class="space-y-4">
                    <div id="no-projects-message" class="text-center py-16 hidden">
                        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-inbox text-slate-400 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-700 mb-2">No hay proyectos activos</h3>
                        <p class="text-slate-500">¡Agrega tu primer proyecto arriba para comenzar!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Tendencias de Finalización de Proyectos</h3>
                    <div class="chart-container">
                        <canvas id="completionChart"></canvas>
                    </div>
                </div>
                
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Distribución de Tipos de Proyectos</h3>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Tab -->
        <div id="team-tab" class="tab-content hidden">
            <div class="glass-card p-8 rounded-2xl mb-8">
                <h3 class="text-xl font-semibold text-slate-800 mb-6">Miembros del Equipo</h3>
                <div id="team-members">
                    <div class="team-member">
                        <div class="member-avatar">JD</div>
                        <div class="flex-grow">
                            <h4 class="font-semibold text-slate-800">Juan Pérez</h4>
                            <p class="text-sm text-slate-600">Gerente de Proyectos</p>
                            <div class="flex items-center mt-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span class="text-xs text-slate-500">3 proyectos activos</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-semibold text-slate-800">85%</div>
                            <div class="text-xs text-slate-500">Eficiencia</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights Tab -->
        <div id="ai-insights-tab" class="tab-content hidden">
            <div class="space-y-6">
                <div class="ai-learning">
                    <h3 class="text-xl font-semibold text-blue-800 mb-4">Progreso de Aprendizaje IA</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Reconocimiento de Patrones de Proyectos</span>
                                <span>92%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 92%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Precisión de Predicción de Fechas Límite</span>
                                <span>87%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 87%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Optimización de Recursos</span>
                                <span>78%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 78%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Recomendaciones IA</h3>
                    <div class="space-y-4">
                        <div class="flex items-start p-4 bg-slate-50 rounded-lg">
                            <i class="fas fa-lightbulb text-yellow-500 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-slate-800">Optimizar Programación de Proyectos</h4>
                                <p class="text-sm text-slate-600">Considera programar proyectos complejos los martes y miércoles cuando la eficiencia del equipo es más alta.</p>
                            </div>
                        </div>
                        <div class="flex items-start p-4 bg-slate-50 rounded-lg">
                            <i class="fas fa-chart-line text-green-500 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-slate-800">Asignación de Recursos</h4>
                                <p class="text-sm text-slate-600">Reasigna 2 miembros del equipo de proyectos de baja prioridad para cumplir con los plazos de la próxima semana.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Base Tab -->
        <div id="knowledge-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Knowledge Upload Section -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-upload text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Cargar Conocimiento al IA</h3>
                            <p class="text-slate-600">Sube información sobre tu taller para que la IA aprenda sobre tus capacidades</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Text Upload -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Información de Texto</h4>
                            <textarea id="knowledge-text" rows="8" class="modern-input w-full resize-none" placeholder="Ejemplo:&#10;Nuestro taller cuenta con:&#10;- Torno CNC de 3 ejes con capacidad de 500mm de diámetro&#10;- Fresadora vertical con mesa de 1000x500mm&#10;- Sistema de automatización con robots KUKA&#10;- Software CAD/CAM Mastercam&#10;- Materiales: acero inoxidable, aluminio, titanio&#10;- Tolerancias: ±0.01mm para piezas de precisión"></textarea>
                            <button id="upload-text-knowledge" class="modern-button mt-4 w-full">
                                <i class="fas fa-upload mr-2"></i>
                                Cargar Texto
                            </button>
                        </div>
                        
                        <!-- File Upload -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Archivos (PDF, DOC, TXT)</h4>
                            <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-indigo-400 transition-colors">
                                <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-4"></i>
                                <p class="text-slate-600 mb-4">Arrastra archivos aquí o haz clic para seleccionar</p>
                                <input type="file" id="knowledge-files" multiple accept=".pdf,.doc,.docx,.txt" class="hidden">
                                <button onclick="document.getElementById('knowledge-files').click()" class="modern-button">
                                    <i class="fas fa-folder-open mr-2"></i>
                                    Seleccionar Archivos
                                </button>
                            </div>
                            <div id="file-list" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Workshop Capabilities -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Flujo de Trabajo Integrado</h3>
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-indigo-600 text-2xl mr-4 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-indigo-800 mb-2">Proceso Integrado</h4>
                                <p class="text-sm text-indigo-700">Cada proyecto utiliza <strong>torno CNC, fresadora y automatización</strong> en secuencia para crear sistemas mecánicos completos y funcionales.</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-cog text-blue-600 text-2xl mr-3"></i>
                                <h4 class="font-semibold text-blue-800">Torno CNC</h4>
                            </div>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>• 3 ejes de control</li>
                                <li>• Capacidad: 500mm diámetro</li>
                                <li>• Precisión: ±0.01mm</li>
                                <li>• Materiales: Acero, Aluminio, Titanio</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-tools text-green-600 text-2xl mr-3"></i>
                                <h4 class="font-semibold text-green-800">Fresadora</h4>
                            </div>
                            <ul class="text-sm text-green-700 space-y-1">
                                <li>• Mesa: 1000x500mm</li>
                                <li>• 4 ejes de control</li>
                                <li>• Precisión: ±0.005mm</li>
                                <li>• Fresado 3D complejo</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-robot text-purple-600 text-2xl mr-3"></i>
                                <h4 class="font-semibold text-purple-800">Automatización</h4>
                            </div>
                            <ul class="text-sm text-purple-700 space-y-1">
                                <li>• Robots KUKA</li>
                                <li>• Carga automática</li>
                                <li>• Inspección por visión</li>
                                <li>• 24/7 operación</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Project Types Knowledge -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Tipos de Proyectos Integrados</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Sistemas Mecánicos Completos</h4>
                            <div class="space-y-3">
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Ejes torneados + bases fresadas + automatización</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Sistemas de transmisión completos</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Mecanismos de precisión integrados</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Sistemas de control automatizado</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Piezas de Precisión</h4>
                            <div class="space-y-3">
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Componentes con tolerancias ±0.001mm</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Piezas críticas para automatización</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Elementos de calibración y medición</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Componentes para prototipos</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Status -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Estado del Conocimiento IA</h3>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-700">Conocimiento del Taller</h4>
                                <p class="text-sm text-slate-500">Información sobre capacidades y equipos</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-green-600" id="workshop-knowledge">85%</div>
                                <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-700">Tipos de Proyectos</h4>
                                <p class="text-sm text-slate-500">Patrones y categorías de trabajo</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-600" id="project-types-knowledge">72%</div>
                                <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 72%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-700">Tiempos de Producción</h4>
                                <p class="text-sm text-slate-500">Estimaciones basadas en experiencia</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-purple-600" id="timing-knowledge">68%</div>
                                <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-purple-500 h-2 rounded-full" style="width: 68%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Web Search Integration -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Búsqueda Web Inteligente</h3>
                    <div class="space-y-4">
                        <p class="text-slate-600">La IA puede buscar información adicional en internet para complementar su conocimiento sobre:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Nuevas tecnologías CNC</span>
                            </div>
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Tendencias de automatización</span>
                            </div>
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Materiales y aleaciones</span>
                            </div>
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Mejores prácticas industriales</span>
                            </div>
                        </div>
                        <button id="enable-web-search" class="modern-button">
                            <i class="fas fa-globe mr-2"></i>
                            Activar Búsqueda Web
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Tab -->
        <div id="whatsapp-tab" class="tab-content hidden">
            <!-- Configuración Simple de Notificaciones -->
            <div class="glass-card p-8">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-blue-600 mb-4">
                        <i class="fas fa-bell mr-3"></i>
                        Configurar Notificaciones del Equipo
                    </h2>
                    <p class="text-gray-600 text-lg">Configura notificaciones simples para tu equipo de 5-7 personas</p>
                </div>

                <!-- Método 1: WhatsApp Web -->
                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fab fa-whatsapp text-green-500 text-2xl mr-3"></i>
                        <h3 class="text-xl font-semibold text-green-800">WhatsApp Web (Recomendado)</h3>
                    </div>
                    <p class="text-green-700 mb-4">El líder del equipo recibe notificaciones y las comparte con el grupo</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Número del líder del equipo:</label>
                            <input type="tel" id="team-leader-phone" placeholder="+52 555 123 4567" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Horarios de notificación:</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">Desde:</label>
                                    <input type="time" id="notification-start-time" value="08:00" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">Hasta:</label>
                                    <input type="time" id="notification-end-time" value="18:00" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipos de notificación:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="notify-deadlines" checked class="mr-2">
                                    <span class="text-sm text-gray-700">Fechas límite de proyectos</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="notify-completions" checked class="mr-2">
                                    <span class="text-sm text-gray-700">Proyectos completados</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="notify-issues" checked class="mr-2">
                                    <span class="text-sm text-gray-700">Problemas o retrasos</span>
                                </label>
                            </div>
                        </div>
                        
                        <button onclick="saveWhatsAppConfig()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fas fa-save mr-2"></i>
                            Guardar Configuración WhatsApp
                        </button>
                    </div>
                </div>

                <!-- Método 2: Notificaciones del Navegador -->
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-bell text-blue-500 text-2xl mr-3"></i>
                        <h3 class="text-xl font-semibold text-blue-800">Notificaciones del Navegador</h3>
                    </div>
                    <p class="text-blue-700 mb-4">Notificaciones nativas que aparecen en tu dispositivo</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Frecuencia de recordatorios:</label>
                            <select id="notification-frequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="immediate">Inmediato</option>
                                <option value="daily">Diario</option>
                                <option value="weekly">Semanal</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sonido de notificación:</label>
                            <select id="notification-sound" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="default">Sonido por defecto</option>
                                <option value="none">Sin sonido</option>
                            </select>
                        </div>
                        
                        <button onclick="saveBrowserConfig()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fas fa-bell mr-2"></i>
                            Activar Notificaciones del Navegador
                        </button>
                    </div>
                </div>

                <!-- Probar Configuración -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-flask mr-2"></i>
                        Probar Configuración
                    </h3>
                    <p class="text-gray-600 mb-4">Envía un mensaje de prueba para verificar que todo funciona</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <button onclick="testWhatsAppNotification()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Probar WhatsApp
                        </button>
                        <button onclick="testBrowserNotification()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fas fa-bell mr-2"></i>
                            Probar Navegador
                        </button>
                        <button onclick="showConfigStatus()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fas fa-info-circle mr-2"></i>
                            Ver Estado
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-500 text-center">
                        <p><i class="fas fa-lightbulb mr-1"></i> Abre la consola del navegador (F12) para ver logs detallados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Settings Header -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-cog text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Configuraciones Generales</h3>
                            <p class="text-slate-600">Personaliza tu Cerebro de Proyectos IA para tu taller</p>
                        </div>
                    </div>
                </div>

                <!-- Workshop Information -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Información del Taller</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Nombre del Taller</label>
                                <input type="text" id="workshop-name" class="modern-input w-full" placeholder="Taller de Torno CNC Emilio" value="Taller de Torno CNC Emilio">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Descripción del Taller</label>
                                <textarea id="workshop-description" class="modern-input w-full h-24" placeholder="Describe tu taller y especialidades...">Taller especializado en mecanizado CNC con más de 10 años de experiencia</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Dirección</label>
                                <input type="text" id="workshop-address" class="modern-input w-full" placeholder="Calle, Ciudad, Estado">
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono de Contacto</label>
                                <input type="tel" id="workshop-phone" class="modern-input w-full" placeholder="+52 555 123 4567">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Email de Contacto</label>
                                <input type="email" id="workshop-email" class="modern-input w-full" placeholder="contacto@taller.com">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Horarios de Trabajo</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="time" id="work-start" class="modern-input" value="08:00">
                                    <input type="time" id="work-end" class="modern-input" value="17:00">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="saveWorkshopInfo()" class="modern-button bg-indigo-600 hover:bg-indigo-700">
                        <i class="fas fa-save mr-2"></i>
                        Guardar Información del Taller
                    </button>
                </div>

                <!-- Admin: Gestión de Roles -->
                <div id="admin-roles-card" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-users-cog text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Administración de Roles</h3>
                            <p class="text-slate-600">Solo administradores pueden cambiar roles</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">UID del Usuario</label>
                            <input id="role-user-uid" type="text" class="modern-input w-full" placeholder="UID del usuario">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Rol</label>
                            <select id="role-select" class="modern-input w-full">
                                <option value="viewer">viewer</option>
                                <option value="compras">compras</option>
                                <option value="admin">admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex gap-4">
                        <button id="save-role" class="modern-button">
                            <i class="fas fa-save mr-2"></i>Guardar Rol
                        </button>
                        <button id="load-role" class="modern-button bg-slate-600 hover:bg-slate-700">
                            <i class="fas fa-search mr-2"></i>Cargar Rol
                        </button>
                    </div>
                    <p id="role-message" class="text-sm text-slate-600 mt-3"></p>
                </div>

                <!-- Project Categories -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Categorías de Proyectos</h3>
                    <div class="space-y-4">
                        <div id="categories-list" class="space-y-3">
                            <!-- Categories will be populated here -->
                        </div>
                        
                        <div class="flex space-x-4">
                            <input type="text" id="new-category" class="modern-input flex-1" placeholder="Nueva categoría (ej: Piezas Automotrices)">
                            <button onclick="addCategory()" class="modern-button bg-green-600 hover:bg-green-700">
                                <i class="fas fa-plus mr-2"></i>
                                Agregar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Import/Export Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Respaldo y Configuración</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Exportar Configuración</h4>
                            <p class="text-sm text-slate-600">Descarga un archivo con todas tus configuraciones</p>
                            <button onclick="exportSettings()" class="modern-button bg-blue-600 hover:bg-blue-700 w-full">
                                <i class="fas fa-download mr-2"></i>
                                Exportar
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Importar Configuración</h4>
                            <p class="text-sm text-slate-600">Carga un archivo de configuración</p>
                            <input type="file" id="import-file" accept=".json" class="hidden">
                            <button onclick="document.getElementById('import-file').click()" class="modern-button bg-purple-600 hover:bg-purple-700 w-full">
                                <i class="fas fa-upload mr-2"></i>
                                Importar
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <button id="reset-to-defaults" class="modern-button bg-red-600 hover:bg-red-700">
                            <i class="fas fa-undo mr-2"></i>
                            Restablecer a Configuración por Defecto
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchasing Tab (legacy/incomplete duplicate) -->
        <div id="purchasing-tab-legacy" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Purchasing Header -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-shopping-cart text-white text-xl"></i>
                            </div>
                            </div>

                <!-- Step 1: Team Notification Methods -->
                <div id="custom-method-selection" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-1 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 1: Elige cómo tu equipo recibirá notificaciones</h3>
                            <p class="text-slate-600">Opciones simples y efectivas para equipos de 5-7 personas</p>
                    </div>
                </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- WhatsApp Web Simple -->
                        <div class="notification-method-card border-2 border-green-200 bg-green-50" data-method="whatsapp-web-simple">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fab fa-whatsapp text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-slate-800">WhatsApp Web (Recomendado)</h4>
                                    <p class="text-sm text-slate-600">Perfecto para equipos</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center text-sm text-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Líder del equipo recibe notificaciones</span>
                                </div>
                                <div class="flex items-center text-sm text-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Reenvía mensajes al grupo automáticamente</span>
                                </div>
                                <div class="flex items-center text-sm text-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Sin APIs complicadas</span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <input type="radio" name="notification-method" value="whatsapp-web-simple" class="mr-2" checked>
                                <span class="text-sm font-medium text-green-700">Usar WhatsApp Web</span>
                            </div>
                        </div>
                        
                        <!-- Browser Notifications -->
                        <div class="notification-method-card border-2 border-purple-200 bg-purple-50" data-method="browser-notifications">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-bell text-white text-xl"></i>
                        </div>
                        <div>
                                    <h4 class="font-semibold text-slate-800">Notificaciones del Navegador</h4>
                                    <p class="text-sm text-slate-600">Para equipos en oficina</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center text-sm text-purple-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Cada miembro recibe notificaciones directas</span>
                                </div>
                                <div class="flex items-center text-sm text-purple-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Aparecen en la pantalla automáticamente</span>
                                </div>
                                <div class="flex items-center text-sm text-purple-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Sin configuración adicional</span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <input type="radio" name="notification-method" value="browser-notifications" class="mr-2">
                                <span class="text-sm font-medium text-purple-700">Usar Navegador</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-blue-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-blue-800 mb-1">Recomendación para tu equipo</h4>
                                <p class="text-sm text-blue-700">Te recomendamos <strong>WhatsApp Web</strong> porque es la forma más fácil de que todos en tu equipo reciban las notificaciones sin configuración compleja.</p>
                            </div>
                        </div>
                            </div>
                        </div>
                        
                <!-- Step 2: WhatsApp Web Ultra Simple -->
                <div id="whatsapp-web-simple-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-2 text-white text-lg font-bold"></i>
                            </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 2: Configura WhatsApp Web para tu Equipo</h3>
                            <p class="text-slate-600">Solo necesitas el número del líder del equipo</p>
                            </div>
                        </div>
                        
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-green-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-green-800 mb-2">¡Perfecto para Equipos!</h4>
                                <p class="text-sm text-green-700 mb-2">Cómo funciona:</p>
                                <ul class="text-sm text-green-700 space-y-1">
                                    <li>• El líder del equipo recibe las notificaciones</li>
                                    <li>• Se abren automáticamente en WhatsApp Web</li>
                                    <li>• El líder reenvía el mensaje al grupo del equipo</li>
                                    <li>• ¡Todos reciben la notificación!</li>
                                </ul>
                            </div>
                            </div>
                        </div>
                        
                    <div class="space-y-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-semibold text-slate-800 mb-4">Para tu equipo de 5-7 personas:</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Número de WhatsApp del líder del equipo</label>
                                    <input type="tel" id="team-leader-whatsapp" class="modern-input w-full" placeholder="+52 555 123 4567">
                                    <p class="text-xs text-slate-500 mt-1">Esta persona recibirá notificaciones y las reenviará al equipo</p>
                            </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Grupo de WhatsApp del equipo (opcional)</label>
                                    <input type="text" id="team-whatsapp-group" class="modern-input w-full" placeholder="Nombre del grupo o enlace">
                                    <p class="text-xs text-slate-500 mt-1">Si tienes un grupo, las notificaciones irán ahí también</p>
                            </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-1">¿Cómo funciona?</h4>
                                    <p class="text-sm text-blue-700">El sistema creará un enlace de WhatsApp que se abrirá automáticamente cuando haya una notificación. El líder del equipo puede reenviar el mensaje al grupo o a miembros específicos.</p>
                        </div>
                    </div>
                </div>

                        <button id="save-whatsapp-web-config" class="modern-button w-full">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Configurar WhatsApp Web
                        </button>
                    </div>
                </div>

                <!-- Step 2: Email Ultra Simple -->
                <div id="email-ultra-simple-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-2 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 2: Configura Email</h3>
                            <p class="text-slate-600">Solo necesitas tu email</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-blue-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-blue-800 mb-2">¡Súper Fácil!</h4>
                                <p class="text-sm text-blue-700">Solo necesitas tu email. El sistema generará un enlace que puedes copiar y pegar en tu cliente de email favorito.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-semibold text-slate-800 mb-4">Para tu equipo de 5-7 personas:</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Emails del equipo (separados por comas)</label>
                                    <textarea id="team-emails" rows="3" class="modern-input w-full" placeholder="juan@taller.com, maria@taller.com, carlos@taller.com"></textarea>
                                    <p class="text-xs text-slate-500 mt-1">Lista todos los emails de tu equipo</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Tu email principal</label>
                                    <input type="email" id="main-email" class="modern-input w-full" placeholder="taller@empresa.com">
                                    <p class="text-xs text-slate-500 mt-1">Email donde recibirás las notificaciones principales</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-green-800 mb-1">¿Cómo funciona?</h4>
                                    <p class="text-sm text-green-700">El sistema generará un enlace de email pre-rellenado que puedes usar con Gmail, Outlook, o cualquier cliente de email. Solo copia y pega cuando necesites enviar notificaciones.</p>
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-email-ultra-config" class="modern-button w-full">
                            <i class="fas fa-envelope mr-2"></i>
                            Configurar Email Simple
                        </button>
                    </div>
                </div>

                <!-- Step 2: Browser Notifications -->
                <div id="browser-notifications-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-2 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 2: Notificaciones del Navegador</h3>
                            <p class="text-slate-600">Sin configuración, funciona inmediatamente</p>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-magic text-purple-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-purple-800 mb-2">¡Perfecto para Equipos!</h4>
                                <p class="text-sm text-purple-700">Cada miembro del equipo solo necesita tener esta página abierta en su navegador. Recibirán notificaciones automáticamente sin configurar nada más.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-semibold text-slate-800 mb-4">Para tu equipo de 5-7 personas:</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Nombres de los miembros del equipo</label>
                                    <textarea id="team-members" rows="3" class="modern-input w-full" placeholder="Juan, María, Carlos, Ana, Luis, Roberto, Emilio"></textarea>
                                    <p class="text-xs text-slate-500 mt-1">Solo para referencia, no es obligatorio</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-green-800 mb-1">¿Cómo funciona?</h4>
                                    <p class="text-sm text-green-700">Cada miembro del equipo debe tener esta página abierta en su navegador. Cuando haya una notificación, aparecerá como una notificación del sistema en la esquina de la pantalla.</p>
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-browser-config" class="modern-button w-full">
                            <i class="fas fa-bell mr-2"></i>
                            Activar Notificaciones del Navegador
                        </button>
                    </div>
                </div>

                <!-- Step 2: Email Simple Configuration -->
                <div id="email-simple-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-2 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 2: Configura Email</h3>
                            <p class="text-slate-600">Configuración simple con Gmail</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-blue-800 mb-2">Configuración con Gmail</h4>
                                <p class="text-sm text-blue-700">Usa tu cuenta de Gmail para enviar notificaciones automáticas. Solo necesitas activar la "Verificación en 2 pasos" y generar una "Contraseña de aplicación".</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Tu email de Gmail</label>
                                <input type="email" id="simple-email-address" class="modern-input w-full" placeholder="tu@email.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Contraseña de aplicación</label>
                                <input type="password" id="simple-email-password" class="modern-input w-full" placeholder="Contraseña de 16 caracteres">
                                <p class="text-xs text-slate-500 mt-1">Genera una contraseña de aplicación en tu cuenta de Google</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Email de destino</label>
                            <input type="email" id="simple-email-destination" class="modern-input w-full" placeholder="donde@recibir.com">
                            <p class="text-xs text-slate-500 mt-1">Email donde recibirás las notificaciones</p>
                        </div>
                        
                        <button id="save-email-config" class="modern-button w-full">
                            <i class="fas fa-envelope mr-2"></i>
                            Guardar Configuración de Email
                        </button>
                    </div>
                </div>

                <!-- Step 3: Test Configuration -->
                <div id="test-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-3 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 3: Prueba tu configuración</h3>
                            <p class="text-slate-600">Envía un mensaje de prueba para verificar que todo funciona</p>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-purple-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-purple-800 mb-2">¡Casi listo!</h4>
                                <p class="text-sm text-purple-700">Envía un mensaje de prueba para asegurarte de que recibirás las notificaciones correctamente.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="send-test-notification" class="modern-button bg-purple-600 hover:bg-purple-700">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Enviar Mensaje de Prueba
                        </button>
                        <p class="text-sm text-slate-500 mt-3">Verifica que recibas el mensaje en tu dispositivo</p>
                    </div>
                </div>

                <!-- Configuration Complete -->
                <div id="config-complete" class="glass-card p-8 rounded-2xl hidden">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-check text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-semibold text-slate-800 mb-4">¡Configuración Completada!</h3>
                        <p class="text-slate-600 mb-6">Ahora recibirás notificaciones automáticas sobre tus proyectos</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <i class="fas fa-bell text-green-600 text-xl mb-2"></i>
                                <h4 class="font-semibold text-green-800">Recordatorios</h4>
                                <p class="text-sm text-green-700">Recibe alertas antes de que los proyectos venzan</p>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <i class="fas fa-clock text-blue-600 text-xl mb-2"></i>
                                <h4 class="font-semibold text-blue-800">Horario</h4>
                                <p class="text-sm text-blue-700">Solo durante tu horario laboral</p>
                            </div>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <i class="fas fa-robot text-purple-600 text-xl mb-2"></i>
                                <h4 class="font-semibold text-purple-800">Automático</h4>
                                <p class="text-sm text-purple-700">Sin intervención manual necesaria</p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 justify-center">
                            <button id="edit-config" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-edit mr-2"></i>
                                Editar Configuración
                            </button>
                            <button id="view-projects" class="modern-button">
                                <i class="fas fa-tasks mr-2"></i>
                                Ver Proyectos
                            </button>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Business Configuration (Advanced) -->
                <div id="whatsapp-business-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fab fa-whatsapp text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">WhatsApp Business API (Avanzado)</h3>
                            <p class="text-slate-600">Configuración para empresas con API oficial</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- WhatsApp Business API Setup -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración de API</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Token de Acceso</label>
                                    <input type="password" id="whatsapp-token" class="modern-input w-full" placeholder="Ingresa tu token de WhatsApp Business API">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Número de Teléfono ID</label>
                                    <input type="text" id="whatsapp-phone-id" class="modern-input w-full" placeholder="ID del número de teléfono">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Número de Verificación</label>
                                    <input type="text" id="whatsapp-verify-token" class="modern-input w-full" placeholder="Token de verificación">
                                </div>
                                <button id="test-whatsapp-connection" class="modern-button w-full">
                                    <i class="fab fa-whatsapp mr-2"></i>
                                    Probar Conexión
                                </button>
                            </div>
                        </div>
                        
                        <!-- Team Members Configuration -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Miembros del Equipo</h4>
                            <div class="space-y-4">
                                <div id="team-members-whatsapp" class="space-y-3">
                                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-green-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-slate-800">Juan Pérez</h5>
                                                <p class="text-sm text-slate-600">+52 555 123 4567</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" class="whatsapp-notifications" checked>
                                                <span class="ml-2 text-sm text-slate-600">Notificaciones</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-green-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-slate-800">María García</h5>
                                                <p class="text-sm text-slate-600">+52 555 987 6543</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" class="whatsapp-notifications" checked>
                                                <span class="ml-2 text-sm text-slate-600">Notificaciones</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <button id="add-team-member" class="modern-button w-full">
                                    <i class="fas fa-plus mr-2"></i>
                                    Agregar Miembro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Web Configuration -->
                <div id="whatsapp-web-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fab fa-whatsapp text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">WhatsApp Web</h3>
                            <p class="text-slate-600">Para usuarios sin WhatsApp Business - Envía enlaces directos</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-yellow-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-yellow-800 mb-2">¿Cómo funciona?</h4>
                                    <p class="text-sm text-yellow-700">El sistema generará enlaces de WhatsApp Web que se abrirán automáticamente con el mensaje pre-escrito. Los miembros del equipo solo necesitan hacer clic en el enlace.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Número de WhatsApp Principal</label>
                                        <input type="text" id="whatsapp-web-number" class="modern-input w-full" placeholder="+52 555 123 4567">
                                        <p class="text-xs text-slate-500 mt-1">Número que aparecerá como remitente</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Mensaje de Presentación</label>
                                        <textarea id="whatsapp-web-intro" rows="3" class="modern-input w-full" placeholder="Hola! Soy el sistema de recordatorios del taller..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Vista Previa</h4>
                                <div class="bg-slate-50 p-4 rounded-lg">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                            <i class="fab fa-whatsapp text-white text-sm"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                                <p class="text-sm text-slate-800">
                                                    <strong>Enlace generado:</strong><br>
                                                    <a href="#" class="text-green-600 underline">Abrir WhatsApp Web</a><br>
                                                    <em>Mensaje: "PO #12345 vence mañana..."</em>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Configuration -->
                <div id="email-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-envelope text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Notificaciones por Email</h3>
                            <p class="text-slate-600">Configura el envío de recordatorios por correo electrónico</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración SMTP</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Servidor SMTP</label>
                                        <input type="text" id="smtp-server" class="modern-input w-full" placeholder="smtp.gmail.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Puerto</label>
                                        <input type="number" id="smtp-port" class="modern-input w-full" placeholder="587" value="587">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Email de Envío</label>
                                        <input type="email" id="smtp-email" class="modern-input w-full" placeholder="taller@empresa.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Contraseña</label>
                                        <input type="password" id="smtp-password" class="modern-input w-full" placeholder="Contraseña de aplicación">
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Plantilla de Email</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Asunto</label>
                                        <input type="text" id="email-subject" class="modern-input w-full" placeholder="Recordatorio de Proyecto - PO #{{PO_NUMBER}}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Mensaje</label>
                                        <textarea id="email-template" rows="6" class="modern-input w-full" placeholder="Estimado equipo,&#10;&#10;El proyecto PO #{{PO_NUMBER}} vence el {{DUE_DATE}}.&#10;Descripción: {{PROJECT_DESCRIPTION}}&#10;&#10;Saludos,&#10;Sistema de Recordatorios"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button id="test-email" class="modern-button">
                                <i class="fas fa-envelope mr-2"></i>
                                Probar Email
                            </button>
                            <button id="save-email-config" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-save mr-2"></i>
                                Guardar Configuración
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Browser Notifications Configuration -->
                <div id="browser-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-bell text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Notificaciones del Navegador</h3>
                            <p class="text-slate-600">Notificaciones push nativas del navegador</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Ventajas de las Notificaciones del Navegador</h4>
                                    <ul class="text-sm text-blue-700 space-y-1">
                                        <li>• No requiere configuración adicional</li>
                                        <li>• Funciona en todos los dispositivos</li>
                                        <li>• Notificaciones nativas del sistema</li>
                                        <li>• Gratuito y fácil de usar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Estado de Permisos</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <i class="fas fa-bell text-purple-600 mr-3"></i>
                                            <span class="text-sm font-medium text-slate-800">Notificaciones</span>
                                        </div>
                                        <span id="notification-permission-status" class="text-xs px-2 py-1 rounded">Verificando...</span>
                                    </div>
                                    
                                    <button id="request-notification-permission" class="modern-button w-full">
                                        <i class="fas fa-key mr-2"></i>
                                        Solicitar Permisos
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-700">Sonido de notificación</span>
                                        <input type="checkbox" id="notification-sound" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-700">Vibrar en móvil</span>
                                        <input type="checkbox" id="notification-vibrate" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-700">Mostrar siempre</span>
                                        <input type="checkbox" id="notification-persistent" class="rounded">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-2">Vista Previa</h4>
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-bell text-white text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-800">Recordatorio de Proyecto</p>
                                    <p class="text-xs text-slate-600">PO #12345 vence mañana - Taller de Torno CNC</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reminder Templates -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Plantillas de Recordatorios</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Recordatorio de Vencimiento</h4>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fab fa-whatsapp text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <p class="text-sm text-slate-800">
                                                🚨 <strong>Recordatorio de Proyecto</strong><br>
                                                PO #{{PO_NUMBER}} vence {{DUE_DATE}}<br>
                                                {{PROJECT_DESCRIPTION}}<br>
                                                <em>Taller de Torno CNC</em>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="modern-button w-full" onclick="editTemplate('due')">
                                <i class="fas fa-edit mr-2"></i>
                                Editar Plantilla
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Proyecto Atrasado</h4>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fab fa-whatsapp text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <p class="text-sm text-slate-800">
                                                ⚠️ <strong>PROYECTO ATRASADO</strong><br>
                                                PO #{{PO_NUMBER}} - {{DAYS_OVERDUE}} días atrasado<br>
                                                {{PROJECT_DESCRIPTION}}<br>
                                                <em>Acción requerida inmediatamente</em>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="modern-button w-full" onclick="editTemplate('overdue')">
                                <i class="fas fa-edit mr-2"></i>
                                Editar Plantilla
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reminder Schedule -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Programación de Recordatorios</h3>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-clock text-blue-600 text-xl mr-3"></i>
                                    <h4 class="font-semibold text-blue-800">Recordatorio Temprano</h4>
                                </div>
                                <p class="text-sm text-blue-700 mb-4">7 días antes del vencimiento</p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="early-reminder" checked class="mr-2">
                                    <label for="early-reminder" class="text-sm text-blue-700">Activar</label>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-200">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3"></i>
                                    <h4 class="font-semibold text-yellow-800">Recordatorio Urgente</h4>
                                </div>
                                <p class="text-sm text-yellow-700 mb-4">1 día antes del vencimiento</p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="urgent-reminder" checked class="mr-2">
                                    <label for="urgent-reminder" class="text-sm text-yellow-700">Activar</label>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-times-circle text-red-600 text-xl mr-3"></i>
                                    <h4 class="font-semibold text-red-800">Proyecto Atrasado</h4>
                                </div>
                                <p class="text-sm text-red-700 mb-4">Inmediatamente al vencerse</p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="overdue-reminder" checked class="mr-2">
                                    <label for="overdue-reminder" class="text-sm text-red-700">Activar</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-6 rounded-xl">
                            <h4 class="font-semibold text-slate-800 mb-4">Horarios de Envío</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Hora de Inicio</label>
                                    <input type="time" id="start-time" value="08:00" class="modern-input w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Hora de Fin</label>
                                    <input type="time" id="end-time" value="18:00" class="modern-input w-full">
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Los recordatorios solo se enviarán durante estas horas</p>
                        </div>
                    </div>
                </div>

                <!-- Test Notifications -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Probar Notificaciones</h3>
                    <div class="space-y-4">
                        <p class="text-slate-600">Envía un mensaje de prueba a todos los miembros del equipo</p>
                        <div class="flex space-x-4">
                            <button id="test-all-notifications" class="modern-button">
                                <i class="fab fa-whatsapp mr-2"></i>
                                Probar a Todos
                            </button>
                            <button id="test-specific-member" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-user mr-2"></i>
                                Probar Miembro Específico
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notification History -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Historial de Notificaciones</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-800">Recordatorio enviado</p>
                                    <p class="text-sm text-slate-600">PO #12345 - Juan Pérez - Hace 2 horas</p>
                                </div>
                            </div>
                            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded">Enviado</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-clock text-yellow-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-800">Recordatorio programado</p>
                                    <p class="text-sm text-slate-600">PO #12346 - María García - Mañana 8:00 AM</p>
                                </div>
                            </div>
                            <span class="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded">Programado</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-times-circle text-red-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-800">Error de envío</p>
                                    <p class="text-sm text-slate-600">PO #12347 - Carlos López - Hace 1 hora</p>
                                </div>
                            </div>
                            <span class="text-xs text-red-600 bg-red-100 px-2 py-1 rounded">Error</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- General Settings Header -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-cog text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Configuraciones Generales</h3>
                            <p class="text-slate-600">Personaliza tu Cerebro de Proyectos IA para tu taller</p>
                        </div>
                    </div>
                </div>

                <!-- Workshop Information -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Información del Taller</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Nombre del Taller</label>
                                <input type="text" id="workshop-name" class="modern-input w-full" placeholder="Taller de Torno CNC Emilio" value="Taller de Torno CNC Emilio">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Dirección</label>
                                <textarea id="workshop-address" rows="3" class="modern-input w-full" placeholder="Calle, Colonia, Ciudad, Estado, CP"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                                <input type="tel" id="workshop-phone" class="modern-input w-full" placeholder="+52 555 123 4567">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                <input type="email" id="workshop-email" class="modern-input w-full" placeholder="taller@empresa.com">
                            </div>
                        </div>
                        
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Capacidades del Taller</label>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Flujo de Trabajo Integrado</h4>
                                    <p class="text-sm text-blue-700">Los proyectos utilizan <strong>torno CNC, fresadora y automatización</strong> en conjunto para crear piezas completas y sistemas integrados.</p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-integrated" checked class="mr-2 rounded" disabled>
                                <span class="text-sm text-slate-700 font-medium">Proyectos Integrados (Torno + Fresado + Automatización)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-prototyping" class="mr-2 rounded">
                                <span class="text-sm text-slate-700">Prototipado Rápido</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-maintenance" class="mr-2 rounded">
                                <span class="text-sm text-slate-700">Mantenimiento Especializado</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-custom" class="mr-2 rounded">
                                <span class="text-sm text-slate-700">Desarrollo a Medida</span>
                            </label>
                        </div>
                    </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Capacidad de Producción</label>
                                <select id="production-capacity" class="modern-input w-full">
                                    <option value="small">Pequeña (1-10 proyectos/mes)</option>
                                    <option value="medium" selected>Mediana (10-50 proyectos/mes)</option>
                                    <option value="large">Grande (50+ proyectos/mes)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Zona Horaria</label>
                                <select id="timezone" class="modern-input w-full">
                                    <option value="America/Mexico_City" selected>México Central (GMT-6)</option>
                                    <option value="America/Mexico_City">México Pacífico (GMT-7)</option>
                                    <option value="America/New_York">Este (GMT-5)</option>
                                    <option value="America/Los_Angeles">Oeste (GMT-8)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Project Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Configuraciones de Proyectos</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Prefijo de PO</label>
                                <input type="text" id="po-prefix" class="modern-input w-full" placeholder="PO" value="PO">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Formato de Numeración</label>
                                <select id="po-format" class="modern-input w-full">
                                    <option value="sequential" selected>Secuencial (PO-001, PO-002...)</option>
                                    <option value="year-month">Año-Mes (PO-2024-01-001)</option>
                                    <option value="year-only">Solo Año (PO-2024-001)</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            <div id="custom-format-container" class="hidden">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Formato Personalizado</label>
                                <input type="text" id="custom-po-format" class="modern-input w-full" placeholder="PO-{YYYY}-{MM}-{###}">
                                <p class="text-xs text-slate-500 mt-1">Usa {YYYY} para año, {MM} para mes, {###} para número secuencial</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Días de Aviso por Defecto</label>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Temprano</label>
                                        <input type="number" id="early-warning-days" class="modern-input w-full" value="7" min="1" max="30">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Urgente</label>
                                        <input type="number" id="urgent-warning-days" class="modern-input w-full" value="1" min="0" max="7">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Crítico</label>
                                        <input type="number" id="critical-warning-days" class="modern-input w-full" value="0" min="0" max="3">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Tipos de Proyectos Integrados</label>
                                <div class="space-y-2" id="project-categories">
                                    <div class="flex items-center space-x-2">
                                        <input type="text" class="modern-input flex-1" placeholder="Nuevo tipo de proyecto" id="new-category">
                                        <button id="add-category" class="modern-button px-4 py-2">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="space-y-1" id="categories-list">
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Sistema Mecánico Completo</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Piezas de Precisión</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Automatización Industrial</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Prototipo Integrado</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Etapas del Proyecto Integrado</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-planning" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Planificación</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-turning" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Torneado CNC</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-milling" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Fresado</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-automation" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Integración Automatización</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-testing" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Pruebas y Calibración</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-completed" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Completado</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-cancelled" class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Cancelado</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Configuraciones de Notificaciones</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Horario de Trabajo</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Inicio</label>
                                        <input type="time" id="work-start-time" class="modern-input w-full" value="08:00">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Fin</label>
                                        <input type="time" id="work-end-time" class="modern-input w-full" value="18:00">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Días de Trabajo</label>
                                <div class="grid grid-cols-7 gap-2">
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-monday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">L</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-tuesday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">M</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-wednesday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">X</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-thursday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">J</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-friday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">V</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-saturday" class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">S</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-sunday" class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">D</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Frecuencia de Verificación</label>
                                <select id="check-frequency" class="modern-input w-full">
                                    <option value="15">Cada 15 minutos</option>
                                    <option value="30" selected>Cada 30 minutos</option>
                                    <option value="60">Cada hora</option>
                                    <option value="120">Cada 2 horas</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Tipos de Recordatorios</label>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <h4 class="font-medium text-slate-800">Email</h4>
                                            <p class="text-sm text-slate-600">Notificaciones por correo</p>
                                        </div>
                                        <input type="checkbox" id="reminder-email" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <h4 class="font-medium text-slate-800">WhatsApp</h4>
                                            <p class="text-sm text-slate-600">Mensajes de WhatsApp</p>
                                        </div>
                                        <input type="checkbox" id="reminder-whatsapp" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <h4 class="font-medium text-slate-800">Navegador</h4>
                                            <p class="text-sm text-slate-600">Notificaciones push</p>
                                        </div>
                                        <input type="checkbox" id="reminder-browser" checked class="rounded">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Configuración de Sonido</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="sound-enabled" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Activar sonidos</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="sound-vibrate" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Vibrar en móvil</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Configuraciones de IA</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Nivel de Aprendizaje</label>
                                <select id="ai-learning-level" class="modern-input w-full">
                                    <option value="basic">Básico</option>
                                    <option value="intermediate" selected>Intermedio</option>
                                    <option value="advanced">Avanzado</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Frecuencia de Análisis</label>
                                <select id="ai-analysis-frequency" class="modern-input w-full">
                                    <option value="immediate" selected>Inmediato</option>
                                    <option value="hourly">Cada hora</option>
                                    <option value="daily">Diario</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Precisión de Predicciones</label>
                                <div class="space-y-2">
                                    <input type="range" id="ai-precision" min="50" max="95" value="80" class="w-full">
                                    <div class="flex justify-between text-xs text-slate-600">
                                        <span>50% (Rápido)</span>
                                        <span id="precision-value">80%</span>
                                        <span>95% (Preciso)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Características de IA</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-pattern-recognition" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Reconocimiento de patrones</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-duration-prediction" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Predicción de duración</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-risk-analysis" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Análisis de riesgos</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-optimization" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Optimización de recursos</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Idioma de Respuestas</label>
                                <select id="ai-language" class="modern-input w-full">
                                    <option value="es" selected>Español</option>
                                    <option value="en">English</option>
                                    <option value="auto">Automático</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup and Export -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Respaldo y Exportación</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-4">Exportar Datos</h4>
                                <div class="space-y-3">
                                    <button id="export-projects" class="modern-button w-full">
                                        <i class="fas fa-download mr-2"></i>
                                        Exportar Proyectos (CSV)
                                    </button>
                                    <button id="export-settings" class="modern-button w-full">
                                        <i class="fas fa-cog mr-2"></i>
                                        Exportar Configuraciones (JSON)
                                    </button>
                                    <button id="export-knowledge" class="modern-button w-full">
                                        <i class="fas fa-database mr-2"></i>
                                        Exportar Base de Conocimiento
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-4">Importar Datos</h4>
                                <div class="space-y-3">
                                    <input type="file" id="import-file" accept=".json,.csv" class="hidden">
                                    <button id="import-data" class="modern-button w-full">
                                        <i class="fas fa-upload mr-2"></i>
                                        Importar Datos
                                    </button>
                                    <button id="reset-settings" class="modern-button w-full bg-red-600 hover:bg-red-700">
                                        <i class="fas fa-undo mr-2"></i>
                                        Restablecer Configuraciones
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Guardar Configuraciones</h3>
                            <p class="text-slate-600">Tus configuraciones se guardan automáticamente</p>
                        </div>
                        <div class="flex space-x-4">
                            <button id="save-all-settings" class="modern-button">
                                <i class="fas fa-save mr-2"></i>
                                Guardar Todo
                            </button>
                            <button id="reset-to-defaults" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-undo mr-2"></i>
                                Restablecer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchasing Tab -->
        <div id="purchasing-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Purchasing Header -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-shopping-cart text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Gestión de Compras Inteligente</h3>
                            <p class="text-slate-600">Sistema de ayuda para el equipo de compras basado en proyectos activos</p>
                        </div>
                    </div>
                </div>

                <!-- Project-Based Material Recommendations -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-lightbulb text-yellow-500 mr-3"></i>
                        Recomendaciones Basadas en Proyectos
                    </h3>
                    <div id="project-material-recommendations" class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Análisis Automático</h4>
                                    <p class="text-sm text-blue-700">El sistema analiza automáticamente los proyectos activos para identificar materiales y componentes necesarios.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Material Categories -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-cubes text-purple-500 mr-3"></i>
                        Categorías de Materiales
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Metals -->
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 border border-gray-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-hammer text-white"></i>
                                </div>
                                <h4 class="font-semibold text-gray-800">Metales</h4>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Acero Inoxidable</span>
                                    <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Aluminio</span>
                                    <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Titanio</span>
                                    <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <button class="w-full mt-3 bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Agregar Material
                                </button>
                            </div>
                        </div>

                        <!-- Cutting Tools -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-cut text-white"></i>
                                </div>
                                <h4 class="font-semibold text-blue-800">Herramientas de Corte</h4>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-blue-600">Fresas</span>
                                    <span class="text-xs bg-blue-200 text-blue-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-blue-600">Brocas</span>
                                    <span class="text-xs bg-blue-200 text-blue-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-blue-600">Inserts</span>
                                    <span class="text-xs bg-blue-200 text-blue-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <button class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Agregar Herramienta
                                </button>
                            </div>
                        </div>

                        <!-- Consumables -->
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-tint text-white"></i>
                                </div>
                                <h4 class="font-semibold text-green-800">Consumibles</h4>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-600">Aceite de Corte</span>
                                    <span class="text-xs bg-green-200 text-green-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-600">Refrigerante</span>
                                    <span class="text-xs bg-green-200 text-green-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-600">Abrasivos</span>
                                    <span class="text-xs bg-green-200 text-green-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <button class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Agregar Consumible
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Supplier Management -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-handshake text-orange-500 mr-3"></i>
                        Gestión de Proveedores
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Proveedores Frecuentes</h4>
                            <div class="space-y-3" id="suppliers-list">
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="font-medium text-slate-800">Proveedor de Metales ABC</h5>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Activo</span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-2">Especialista en acero inoxidable y aluminio</p>
                                    <div class="flex items-center space-x-4 text-xs text-slate-500">
                                        <span><i class="fas fa-phone mr-1"></i>555-1234</span>
                                        <span><i class="fas fa-envelope mr-1"></i>ventas@abc.com</span>
                                    </div>
                                </div>
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="font-medium text-slate-800">Herramientas CNC Pro</h5>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Activo</span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-2">Fresas, brocas y herramientas especializadas</p>
                                    <div class="flex items-center space-x-4 text-xs text-slate-500">
                                        <span><i class="fas fa-phone mr-1"></i>555-5678</span>
                                        <span><i class="fas fa-envelope mr-1"></i>info@cncpro.com</span>
                                    </div>
                                </div>
                            </div>
                            <button id="add-supplier" class="w-full mt-4 bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Agregar Proveedor
                            </button>
                        </div>

                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Nuevo Proveedor</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Nombre del Proveedor</label>
                                    <input id="supplier-name" type="text" class="modern-input w-full" placeholder="Ej: Metales del Norte SA">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Especialidad</label>
                                    <select id="supplier-specialty" class="modern-input w-full">
                                        <option value="">Seleccionar especialidad</option>
                                        <option value="metales">Metales y Aleaciones</option>
                                        <option value="herramientas">Herramientas de Corte</option>
                                        <option value="consumibles">Consumibles</option>
                                        <option value="equipos">Equipos y Maquinaria</option>
                                        <option value="servicios">Servicios Especializados</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Contacto Principal</label>
                                    <input id="supplier-contact" type="text" class="modern-input w-full" placeholder="Nombre del contacto">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                                        <input id="supplier-phone" type="tel" class="modern-input w-full" placeholder="555-1234">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                        <input id="supplier-email" type="email" class="modern-input w-full" placeholder="contacto@empresa.com">
                                    </div>
                                </div>
                                <button id="save-supplier" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-save mr-2"></i>Guardar Proveedor
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purchase Orders -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-file-invoice text-indigo-500 mr-3"></i>
                        Órdenes de Compra
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Órdenes Recientes</h4>
                            <div class="flex items-center gap-3 mb-3">
                                <select id="po-filter-status" class="modern-input">
                                    <option value="">Estado: Todos</option>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="entregado">Entregado</option>
                                </select>
                                <input id="po-filter-supplier" class="modern-input" placeholder="Filtrar por proveedor" />
                            </div>
                            <div class="space-y-3" id="purchase-orders-list">
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="font-medium text-slate-800">PO-2024-001</h5>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">Pendiente</span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-2">Acero inoxidable 316L - 50kg</p>
                                    <div class="flex items-center justify-between text-xs text-slate-500">
                                        <span>Proveedor: ABC Metales</span>
                                        <span>Fecha: 15/01/2024</span>
                                    </div>
                                </div>
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="font-medium text-slate-800">PO-2024-002</h5>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Entregado</span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-2">Fresas HSS - Set completo</p>
                                    <div class="flex items-center justify-between text-xs text-slate-500">
                                        <span>Proveedor: CNC Pro</span>
                                        <span>Fecha: 10/01/2024</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Nueva Orden de Compra</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Proveedor</label>
                                    <select id="po-supplier" class="modern-input w-full">
                                        <option value="">Seleccionar proveedor</option>
                                        <option value="abc">Proveedor de Metales ABC</option>
                                        <option value="cnc">Herramientas CNC Pro</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Material/Producto</label>
                                    <input id="po-item" type="text" class="modern-input w-full" placeholder="Ej: Acero inoxidable 316L">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Cantidad</label>
                                        <input id="po-quantity" type="number" class="modern-input w-full" placeholder="50">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Unidad</label>
                                        <select id="po-unit" class="modern-input w-full">
                                            <option value="kg">Kilogramos</option>
                                            <option value="piezas">Piezas</option>
                                            <option value="metros">Metros</option>
                                            <option value="litros">Litros</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Proyecto Relacionado</label>
                                    <select id="po-project" class="modern-input w-full">
                                        <option value="">Seleccionar proyecto (opcional)</option>
                                        <option value="proj1">PO-2024-001 - Ejes para motor</option>
                                        <option value="proj2">PO-2024-002 - Bridas de conexión</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Notas</label>
                                    <textarea id="po-notes" rows="3" class="modern-input w-full" placeholder="Especificaciones adicionales..."></textarea>
                                </div>
                                <button id="create-purchase-order" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Crear Orden de Compra
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Purchase Insights -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-chart-line text-cyan-500 mr-3"></i>
                        Insights de Compras IA
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-trending-up text-white"></i>
                                </div>
                                <h4 class="font-semibold text-blue-800">Tendencias de Uso</h4>
                            </div>
                            <p class="text-sm text-blue-700 mb-2">El acero inoxidable ha aumentado un 25% en los últimos 3 meses</p>
                            <div class="text-xs text-blue-600">Recomendación: Considerar compra a granel</div>
                        </div>

                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-dollar-sign text-white"></i>
                                </div>
                                <h4 class="font-semibold text-green-800">Optimización de Costos</h4>
                            </div>
                            <p class="text-sm text-green-700 mb-2">Comprando en lotes de 100kg puedes ahorrar 15%</p>
                            <div class="text-xs text-green-600">Ahorro estimado: $2,400/mes</div>
                        </div>

                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-clock text-white"></i>
                                </div>
                                <h4 class="font-semibold text-purple-800">Predicción de Necesidades</h4>
                            </div>
                            <p class="text-sm text-purple-700 mb-2">Se necesitarán 80kg de aluminio en 2 semanas</p>
                            <div class="text-xs text-purple-600">Basado en proyectos programados</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Interface -->
    <div id="ai-chat" class="ai-chat">
        <div class="ai-chat-header">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h3 class="font-semibold">Asistente IA</h3>
                    <p class="text-sm opacity-90">Tu cerebro de gestión de proyectos</p>
                </div>
            </div>
            <button id="close-ai-chat" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ai-messages" id="ai-messages">
            <div class="ai-message bot">
                <div class="ai-message-content">
                    <p>¡Hola! Soy tu asistente de proyectos IA. Puedo ayudarte con:</p>
                    <ul class="mt-2 text-sm">
                        <li>• Análisis de proyectos e insights</li>
                        <li>• Predicciones de fechas límite</li>
                        <li>• Optimización de recursos</li>
                        <li>• Evaluación de riesgos</li>
                    </ul>
                    <p class="mt-2">¿Qué te gustaría saber sobre tus proyectos?</p>
                </div>
            </div>
        </div>
        <div class="ai-input-container">
            <input type="text" id="ai-input" class="ai-input" placeholder="Pregúntame cualquier cosa sobre tus proyectos...">
        </div>
    </div>

    <!-- AI Chat Toggle Button -->
    <button id="ai-chat-toggle" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-purple-500 to-blue-500 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center z-50">
        <i class="fas fa-robot text-xl"></i>
    </button>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 bg-slate-900 bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-user-lock text-white text-xl"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-semibold text-slate-800">Iniciar sesión</h3>
                    <p class="text-slate-600 text-sm">Accede con tu usuario para continuar</p>
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                    <input id="auth-email" type="email" class="modern-input w-full" placeholder="tu@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Contraseña</label>
                    <input id="auth-password" type="password" class="modern-input w-full" placeholder="********">
                </div>
                <div class="flex items-center justify-between">
                    <button id="auth-login" class="modern-button">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                    <button id="auth-register" class="modern-button bg-slate-600 hover:bg-slate-700">
                        <i class="fas fa-user-plus mr-2"></i>Crear cuenta
                    </button>
                </div>
                <p id="auth-error" class="text-sm text-red-600 hidden"></p>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script type="application/json" data-disabled-duplicate-module="true">
        /* Duplicated module block disabled
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy, Timestamp, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-workshop-bot';
        const firebaseConfig = {
            apiKey: "AIzaSyD6aTV9nIYz4_QdZRs-Bx5pLScI8lmY_ag",
            authDomain: "cerebro-proyecto-smv.firebaseapp.com",
            projectId: "cerebro-proyecto-smv",
            storageBucket: "cerebro-proyecto-smv.firebasestorage.app",
            messagingSenderId: "899383982708",
            appId: "1:899383982708:web:247457d9c08436b6b3ef21",
            measurementId: "G-MD27C2HZ79"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let currentUser = null;
        let currentUserRole = 'viewer';
        let projectsCollection;
        let allProjects = [];
        let aiLearningData = {
            projectPatterns: {},
            completionTimes: {},
            efficiencyScore: 0,
            insights: [],
            predictions: []
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // --- DOM Elements ---
        const addProjectForm = document.getElementById('add-project-form');
        const smartEntryTextarea = document.getElementById('smart-entry');
        const poNumberInput = document.getElementById('po-number');
        const projectDescriptionInput = document.getElementById('project-description');
        const dueDateInput = document.getElementById('due-date');
        const projectList = document.getElementById('project-list');
        const noProjectsMessage = document.getElementById('no-projects-message');
        const loadingSpinner = document.getElementById('loading-spinner');

        // New DOM elements
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const aiChat = document.getElementById('ai-chat');
        const aiChatToggle = document.getElementById('ai-chat-toggle');
        const closeAiChat = document.getElementById('close-ai-chat');
        const aiInput = document.getElementById('ai-input');
        const aiMessages = document.getElementById('ai-messages');
        const authScreen = document.getElementById('auth-screen');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authLoginBtn = document.getElementById('auth-login');
        const authRegisterBtn = document.getElementById('auth-register');
        const authError = document.getElementById('auth-error');
        const openLoginBtn = document.getElementById('open-login');
        const logoutBtn = document.getElementById('logout-btn');
        const currentUserEmailEl = document.getElementById('current-user-email');

        // --- Auth lifecycle ---
        setupAuthHandlers();
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (!user) {
                showApp(false);
                return;
            }
            showApp(true);
            const role = await loadUserRole(user.uid);
            applyRoleUI(role);
        });

        // --- Auth + Roles ---
        async function loadUserRole(userId) {
            try {
                const userDocRef = doc(getFirestore(), 'users', userId);
                const snap = await (await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js')).getDoc(userDocRef);
                if (snap.exists()) {
                    const data = snap.data();
                    return data.role || 'viewer';
                }
            } catch (e) {
                console.warn('No se pudo cargar rol:', e);
            }
            return 'viewer';
        }

        function applyRoleUI(role) {
            currentUserRole = role;
            const purchasingTabBtn = document.querySelector('.nav-tab[data-tab="purchasing"]');
            const purchasingTabContent = document.getElementById('purchasing-tab');
            const isAllowed = role === 'admin' || role === 'compras';
            if (purchasingTabBtn) {
                if (!isAllowed) {
                    purchasingTabBtn.classList.add('hidden');
                } else {
                    purchasingTabBtn.classList.remove('hidden');
                }
            }
            if (purchasingTabContent) {
                if (!isAllowed && !purchasingTabContent.classList.contains('hidden')) {
                    document.querySelector('[data-tab="dashboard"]').click();
                }
            }
        }

        function showApp(show) {
            const appRoot = document.querySelector('.container.mx-auto');
            if (!appRoot) return;
            if (show) {
                authScreen.classList.add('hidden');
                appRoot.classList.remove('opacity-0');
                openLoginBtn?.classList.add('hidden');
                logoutBtn?.classList.remove('hidden');
                if (currentUser && currentUser.email) {
                    currentUserEmailEl.textContent = currentUser.email;
                    currentUserEmailEl.classList.remove('hidden');
                }
            } else {
                authScreen.classList.remove('hidden');
                appRoot.classList.add('opacity-0');
                openLoginBtn?.classList.remove('hidden');
                logoutBtn?.classList.add('hidden');
                currentUserEmailEl.classList.add('hidden');
            }
        }

        function setupAuthHandlers() {
            authLoginBtn?.addEventListener('click', async () => {
                authError.classList.add('hidden');
                try {
                    const cred = await signInWithEmailAndPassword(auth, authEmail.value.trim(), authPassword.value.trim());
                    currentUser = cred.user;
                } catch (e) {
                    authError.textContent = e.message || 'Error al iniciar sesión';
                    authError.classList.remove('hidden');
                }
            });
            authRegisterBtn?.addEventListener('click', async () => {
                authError.classList.add('hidden');
                try {
                    const cred = await createUserWithEmailAndPassword(auth, authEmail.value.trim(), authPassword.value.trim());
                    currentUser = cred.user;
                    // Default role viewer document using uid as doc id
                    const userDoc = doc(db, 'users', currentUser.uid);
                    await setDoc(userDoc, { uid: currentUser.uid, role: 'viewer', email: currentUser.email, createdAt: Timestamp.now() }, { merge: true });
                } catch (e) {
                    authError.textContent = e.message || 'Error al registrar';
                    authError.classList.remove('hidden');
                }
            });
            openLoginBtn?.addEventListener('click', () => {
                showApp(false);
            });
            logoutBtn?.addEventListener('click', async () => {
                try { await signOut(auth); } catch {}
            });
        }
        class AILearningSystem {
            constructor() {
                this.patterns = new Map();
                this.insights = [];
                this.predictions = [];
                this.learningProgress = 0;
                this.workshopKnowledge = {
                    capabilities: {
                        cnc_lathe: {
                            axes: 3,
                            max_diameter: 500,
                            precision: 0.01,
                            materials: ['acero', 'aluminio', 'titanio']
                        },
                        milling_machine: {
                            table_size: '1000x500',
                            axes: 4,
                            precision: 0.005,
                            capabilities: ['fresado_3d', 'geometrias_complejas']
                        },
                        automation: {
                            robots: 'KUKA',
                            features: ['carga_automatica', 'vision_inspection', '24_7_operation']
                        }
                    },
                    projectTypes: {
                        lathe: ['ejes_husillos', 'bridas_conexiones', 'tornillos_tuercas', 'piezas_cilindricas'],
                        milling: ['bases_soportes', 'moldes_matrices', 'geometrias_complejas', 'prototipos']
                    },
                    materials: ['acero_inoxidable', 'aluminio', 'titanio', 'aceros_especiales'],
                    tolerances: {
                        standard: 0.01,
                        precision: 0.005,
                        high_precision: 0.001
                    }
                };
                this.webSearchEnabled = false;
            }

            analyzeProject(project) {
                // Analyze project description for patterns
                const description = project.description.toLowerCase();
                const keywords = this.extractKeywords(description);
                
                // Enhanced analysis with workshop knowledge
                const projectType = this.classifyProjectType(description);
                const material = this.identifyMaterial(description);
                const complexity = this.assessComplexity(description, projectType);
                
                keywords.forEach(keyword => {
                    if (!this.patterns.has(keyword)) {
                        this.patterns.set(keyword, {
                            count: 0,
                            avgDuration: 0,
                            completionRate: 0,
                            difficulty: 'medium',
                            projectType: projectType,
                            material: material,
                            complexity: complexity
                        });
                    }
                    
                    const pattern = this.patterns.get(keyword);
                    pattern.count++;
                    
                    // Calculate average duration based on project type and workshop capabilities
                    const estimatedDuration = this.estimateDurationWithWorkshopKnowledge(description, projectType, material, complexity);
                    pattern.avgDuration = (pattern.avgDuration * (pattern.count - 1) + estimatedDuration) / pattern.count;
                });

                this.updateLearningProgress();
                this.generateInsights();
                this.generatePredictions();
            }

            classifyProjectType(description) {
                // Classify based on integrated workflow
                const lowerDesc = description.toLowerCase();
                
                // Integrated projects (most common)
                if (lowerDesc.includes('sistema') || lowerDesc.includes('completo') || lowerDesc.includes('integrado')) {
                    return 'integrated';
                }
                
                // Precision parts that use all tools
                if (lowerDesc.includes('precision') || lowerDesc.includes('tolerancia') || lowerDesc.includes('calibracion')) {
                    return 'precision';
                }
                
                // Automation projects
                if (lowerDesc.includes('automatizacion') || lowerDesc.includes('robot') || lowerDesc.includes('cnc') || 
                    lowerDesc.includes('programacion') || lowerDesc.includes('control')) {
                    return 'automation';
                }
                
                // Prototype development
                if (lowerDesc.includes('prototipo') || lowerDesc.includes('desarrollo') || lowerDesc.includes('prueba')) {
                    return 'prototype';
                }
                
                // Maintenance and repair
                if (lowerDesc.includes('mantenimiento') || lowerDesc.includes('reparacion') || lowerDesc.includes('revision')) {
                    return 'maintenance';
                }
                
                // Default to integrated workflow
                return 'integrated';
            }

            identifyMaterial(description) {
                const materials = this.workshopKnowledge.materials;
                for (const material of materials) {
                    if (description.includes(material.replace('_', ' '))) {
                        return material;
                    }
                }
                return 'unknown';
            }

            assessComplexity(description, projectType) {
                let complexity = 'medium';
                
                // Check for complexity indicators
                if (description.includes('precision') || description.includes('tolerancia') || description.includes('±0.001')) {
                    complexity = 'high';
                } else if (description.includes('simple') || description.includes('basico')) {
                    complexity = 'low';
                }
                
                // Adjust based on project type
                if (projectType === 'automation') complexity = 'high';
                if (projectType === 'lathe' && description.includes('cnc')) complexity = 'high';
                
                return complexity;
            }

            estimateDurationWithWorkshopKnowledge(description, projectType, material, complexity) {
                let baseDays = 5; // Base duration for integrated projects
                
                // Adjust based on integrated project type
                switch (projectType) {
                    case 'integrated':
                        baseDays = 5; // Standard integrated project (torno + fresado + automatización)
                        break;
                    case 'precision':
                        baseDays = 7; // Precision work requires more time
                        break;
                    case 'automation':
                        baseDays = 8; // Complex automation integration
                        break;
                    case 'prototype':
                        baseDays = 6; // Prototype development
                        break;
                    case 'maintenance':
                        baseDays = 3; // Maintenance is usually faster
                        break;
                }
                
                // Adjust based on material (affects all processes)
                if (material === 'titanio') baseDays += 3; // Titanium is harder to work with
                if (material === 'acero_inoxidable') baseDays += 2;
                if (material === 'aluminio') baseDays += 0; // Aluminum is easier
                
                // Adjust based on complexity
                if (complexity === 'high') baseDays += 4; // High complexity affects all stages
                if (complexity === 'low') baseDays = Math.max(2, baseDays - 2);
                
                // Check for specific keywords that affect integrated workflow
                if (description.includes('urgente')) baseDays = Math.max(2, baseDays - 1);
                if (description.includes('prototipo')) baseDays += 2; // Prototypes need more testing
                if (description.includes('serie') || description.includes('lote')) baseDays += 3; // Series require setup time
                if (description.includes('calibracion') || description.includes('pruebas')) baseDays += 2; // Testing phase
                if (description.includes('programacion')) baseDays += 1; // CNC programming time
                
                return baseDays;
            }

            extractKeywords(description) {
                const commonWords = ['for', 'and', 'the', 'with', 'from', 'to', 'of', 'in', 'on', 'at', 'by'];
                return description
                    .split(/\s+/)
                    .filter(word => word.length > 3 && !commonWords.includes(word))
                    .slice(0, 5); // Top 5 keywords
            }

            estimateDuration(description) {
                // Simple duration estimation based on keywords
                let baseDays = 7;
                if (description.includes('flange')) baseDays += 3;
                if (description.includes('complex')) baseDays += 5;
                if (description.includes('urgent')) baseDays -= 2;
                if (description.includes('simple')) baseDays -= 2;
                return baseDays;
            }

            updateLearningProgress() {
                this.learningProgress = Math.min(100, this.patterns.size * 10);
                document.getElementById('ai-learning-progress').style.width = `${this.learningProgress}%`;
                document.getElementById('learning-percentage').textContent = `${this.learningProgress}%`;
            }

            generateInsights() {
                this.insights = [];
                
                // Generate insights based on patterns
                for (const [keyword, data] of this.patterns) {
                    if (data.count > 2) {
                        if (data.avgDuration > 10) {
                            this.insights.push({
                                type: 'warning',
                                message: `Los proyectos con "${keyword}" tienden a tomar ${Math.round(data.avgDuration)} días en promedio. Considera agregar tiempo de buffer.`
                            });
                        }
                        
                        if (data.completionRate > 0.9) {
                            this.insights.push({
                                type: 'success',
                                message: `¡Excelente! Los proyectos con "${keyword}" tienen una tasa de finalización del ${Math.round(data.completionRate * 100)}%.`
                            });
                        }
                    }
                }

                // Update UI with insights
                this.updateInsightsUI();
            }

            generatePredictions() {
                this.predictions = [];
                
                // Predict project success based on patterns
                const upcomingProjects = allProjects.filter(p => {
                    const dueDate = p.dueDate.toDate();
                    const today = new Date();
                    return dueDate > today;
                });

                if (upcomingProjects.length > 0) {
                    const riskProjects = upcomingProjects.filter(p => {
                        const keywords = this.extractKeywords(p.description.toLowerCase());
                        return keywords.some(k => {
                            const pattern = this.patterns.get(k);
                            return pattern && pattern.avgDuration > 10;
                        });
                    });

                    if (riskProjects.length > 0) {
                        this.predictions.push({
                            type: 'warning',
                            message: `${riskProjects.length} proyectos pueden estar en riesgo de retraso basándose en patrones históricos.`
                        });
                    }
                }

                this.updatePredictionsUI();
            }

            updateInsightsUI() {
                const insightElement = document.getElementById('ai-insight-text');
                if (this.insights.length > 0) {
                    insightElement.textContent = this.insights[0].message;
                }
            }

            updatePredictionsUI() {
                const predictionElement = document.getElementById('ai-prediction-text');
                if (this.predictions.length > 0) {
                    predictionElement.textContent = this.predictions[0].message;
                }
            }

            getAIResponse(userMessage) {
                const message = userMessage.toLowerCase();
                
                if (message.includes('proyecto') && (message.includes('estado') || message.includes('status'))) {
                    return `Actualmente tienes ${allProjects.length} proyectos activos. ${allProjects.filter(p => {
                        const dueDate = p.dueDate.toDate();
                        const today = new Date();
                        return dueDate < today;
                    }).length} están atrasados.`;
                }
                
                if (message.includes('taller') || message.includes('capacidades') || message.includes('equipos')) {
                    return `Tu taller cuenta con un flujo de trabajo integrado que combina: Torno CNC de 3 ejes (500mm diámetro), Fresadora vertical (1000x500mm), y Sistema de automatización KUKA. Los proyectos utilizan todas estas herramientas en conjunto para crear sistemas mecánicos completos con precisiones de ±0.01mm.`;
                }
                
                if (message.includes('proyecto') || message.includes('trabajo') || message.includes('orden')) {
                    return `Los proyectos en tu taller siguen un flujo integrado: 1) Planificación, 2) Torneado CNC, 3) Fresado, 4) Integración de automatización, 5) Pruebas y calibración. Cada proyecto utiliza todas las herramientas disponibles para crear sistemas completos y funcionales.`;
                }
                
                if (message.includes('tiempo') || message.includes('duracion') || message.includes('estimacion')) {
                    return `Para proyectos integrados (torno + fresado + automatización): proyectos estándar toman 5-7 días, de precisión 7-9 días, automatización compleja 8-10 días. Los materiales como titanio añaden 3 días, y la complejidad alta +4 días. El tiempo incluye todas las etapas del flujo integrado.`;
                }
                
                if (message.includes('material') || message.includes('aleacion')) {
                    return `Trabajamos con: acero inoxidable, aluminio, titanio, y aceros especiales. El titanio requiere más tiempo de mecanizado (+2 días), mientras que el aluminio es más rápido de procesar.`;
                }
                
                if (message.includes('tiempo') || message.includes('duracion') || message.includes('estimacion')) {
                    return `Basándome en las capacidades de tu taller: proyectos de torno toman 2-3 días, fresado 4-6 días, automatización 7+ días. Los materiales como titanio añaden 2 días, y la complejidad alta +3 días.`;
                }
                
                if (message.includes('insight') || message.includes('análisis') || message.includes('analisis')) {
                    return `Basándome en tus patrones de proyectos y conocimiento del taller, he identificado ${this.patterns.size} patrones clave. Los tipos de proyectos más comunes son: ${Array.from(this.patterns.keys()).slice(0, 3).join(', ')}.`;
                }
                
                if (message.includes('predicción') || message.includes('prediccion') || message.includes('forecast')) {
                    return `Predigo que completarás aproximadamente ${Math.round(allProjects.length * 0.85)} proyectos a tiempo este mes basándome en la carga de trabajo actual, capacidades del taller y datos históricos.`;
                }
                
                if (message.includes('whatsapp') || message.includes('recordatorio') || message.includes('notificacion')) {
                    return `El sistema de WhatsApp está configurado para enviar recordatorios automáticos a tu equipo. Puedes configurar: recordatorios tempranos (7 días antes), urgentes (1 día antes), y para proyectos atrasados. Los mensajes se envían solo en horario laboral (8:00-18:00).`;
                }
                
                if (message.includes('compra') || message.includes('material') || message.includes('proveedor') || message.includes('orden de compra')) {
                    const activeProjects = allProjects.filter(project => 
                        project.dueDate && new Date(project.dueDate) >= new Date()
                    );
                    
                    if (activeProjects.length === 0) {
                        return `No hay proyectos activos para analizar materiales. Una vez que agregues proyectos, podré recomendarte materiales y herramientas necesarias basándome en las descripciones de los proyectos.`;
                    }
                    
                    const materialNeeds = analyzeProjectMaterials(activeProjects);
                    if (materialNeeds.length === 0) {
                        return `He analizado ${activeProjects.length} proyecto(s) activo(s) pero no he identificado materiales específicos en las descripciones. Para mejores recomendaciones, incluye palabras como "acero inoxidable", "aluminio", "titanio", "fresas", o "brocas" en las descripciones de proyectos.`;
                    }
                    
                    const urgentNeeds = materialNeeds.filter(need => need.priority === 'high');
                    const mediumNeeds = materialNeeds.filter(need => need.priority === 'medium');
                    
                    let response = `Basándome en ${activeProjects.length} proyecto(s) activo(s), he identificado ${materialNeeds.length} necesidades de materiales/herramientas:\n\n`;
                    
                    if (urgentNeeds.length > 0) {
                        response += `🚨 *URGENTE* (${urgentNeeds.length}):\n`;
                        urgentNeeds.forEach(need => {
                            response += `• ${need.name} - para ${need.relatedProjects.join(', ')}\n`;
                        });
                        response += '\n';
                    }
                    
                    if (mediumNeeds.length > 0) {
                        response += `⚠️ *MEDIO* (${mediumNeeds.length}):\n`;
                        mediumNeeds.forEach(need => {
                            response += `• ${need.name} - para ${need.relatedProjects.join(', ')}\n`;
                        });
                    }
                    
                    response += `\nVe a la pestaña "Compras" para ver recomendaciones detalladas y crear órdenes de compra.`;
                    return response;
                }
                
                if (message.includes('proveedor') || message.includes('supplier')) {
                    return `Para gestionar proveedores, ve a la pestaña "Compras" → "Gestión de Proveedores". Puedes agregar nuevos proveedores con sus especialidades (metales, herramientas, consumibles) y contactos. El sistema te ayudará a mantener un registro organizado de tus proveedores frecuentes.`;
                }
                
                if (message.includes('ayuda') || message.includes('help') || message.includes('qué puedes hacer') || message.includes('que puedes hacer')) {
                    return `Puedo ayudarte con: análisis de proyectos específicos de tu taller (torno, fresado, automatización), predicciones de tiempos basadas en equipos CNC, identificación de materiales y complejidad, optimización de recursos, insights sobre patrones de trabajo industrial, gestión de recordatorios por WhatsApp para tu equipo, y análisis de compras y materiales necesarios. ¿Qué te gustaría saber?`;
                }
                
                return `Entiendo que estás preguntando sobre "${userMessage}". Basándome en el conocimiento de tu taller de torno con fresadora y automatización, puedo proporcionar insights específicos sobre proyectos CNC, tiempos de producción, materiales, capacidades, y gestión de compras. ¿Podrías ser más específico?`;
            }
        }

        const aiSystem = new AILearningSystem();

        // --- WhatsApp Manager System ---
        class WhatsAppManager {
            constructor() {
                this.apiToken = '';
                this.phoneId = '';
                this.verifyToken = '';
                this.teamMembers = [
                    { name: 'Juan Pérez', phone: '+525551234567', notifications: true },
                    { name: 'María García', phone: '+525559876543', notifications: true }
                ];
                this.templates = {
                    due: {
                        title: 'Recordatorio de Vencimiento',
                        message: '🚨 *Recordatorio de Proyecto*\nPO #{{PO_NUMBER}} vence {{DUE_DATE}}\n{{PROJECT_DESCRIPTION}}\n_Taller de Torno CNC_'
                    },
                    overdue: {
                        title: 'Proyecto Atrasado',
                        message: '⚠️ *PROYECTO ATRASADO*\nPO #{{PO_NUMBER}} - {{DAYS_OVERDUE}} días atrasado\n{{PROJECT_DESCRIPTION}}\n_Acción requerida inmediatamente_'
                    },
                    completed: {
                        title: 'Proyecto Completado',
                        message: '✅ *Proyecto Completado*\nPO #{{PO_NUMBER}} finalizado exitosamente\n{{PROJECT_DESCRIPTION}}\n_¡Excelente trabajo!_'
                    }
                };
                this.reminderSettings = {
                    early: { enabled: true, days: 7 },
                    urgent: { enabled: true, days: 1 },
                    overdue: { enabled: true, days: 0 },
                    startTime: '08:00',
                    endTime: '18:00'
                };
                this.notificationHistory = [];
            }

            setCredentials(token, phoneId, verifyToken) {
                this.apiToken = token;
                this.phoneId = phoneId;
                this.verifyToken = verifyToken;
            }

            async sendMessage(phoneNumber, message) {
                if (!this.apiToken || !this.phoneId) {
                    throw new Error('WhatsApp API no configurada');
                }

                const url = `https://graph.facebook.com/v18.0/${this.phoneId}/messages`;
                const payload = {
                    messaging_product: 'whatsapp',
                    to: phoneNumber,
                    type: 'text',
                    text: { body: message }
                };

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error.message);
                    }

                    return result;
                } catch (error) {
                    console.error('Error enviando mensaje WhatsApp:', error);
                    throw error;
                }
            }

            formatMessage(template, project) {
                let message = template.message;
                const dueDate = project.dueDate.toDate();
                const today = new Date();
                const diffDays = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                
                message = message.replace('{{PO_NUMBER}}', project.poNumber);
                message = message.replace('{{PROJECT_DESCRIPTION}}', project.description);
                message = message.replace('{{DUE_DATE}}', dueDate.toLocaleDateString('es-ES'));
                message = message.replace('{{DAYS_OVERDUE}}', Math.abs(diffDays));
                
                return message;
            }

            async sendProjectReminder(project, reminderType) {
                const template = this.templates[reminderType];
                if (!template) return;

                const message = this.formatMessage(template, project);
                const results = [];

                for (const member of this.teamMembers) {
                    if (member.notifications) {
                        try {
                            const result = await this.sendMessage(member.phone, message);
                            results.push({
                                member: member.name,
                                phone: member.phone,
                                status: 'sent',
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        } catch (error) {
                            results.push({
                                member: member.name,
                                phone: member.phone,
                                status: 'error',
                                error: error.message,
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        }
                    }
                }

                this.notificationHistory.unshift(...results);
                return results;
            }

            checkReminders(projects) {
                const now = new Date();
                const currentHour = now.getHours();
                const startHour = parseInt(this.reminderSettings.startTime.split(':')[0]);
                const endHour = parseInt(this.reminderSettings.endTime.split(':')[0]);

                // Solo enviar recordatorios en horario laboral
                if (currentHour < startHour || currentHour > endHour) {
                    return;
                }

                projects.forEach(project => {
                    const dueDate = project.dueDate.toDate();
                    const diffDays = Math.ceil((dueDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

                    // Recordatorio temprano (7 días antes)
                    if (this.reminderSettings.early.enabled && diffDays === 7) {
                        this.sendProjectReminder(project, 'due');
                    }

                    // Recordatorio urgente (1 día antes)
                    if (this.reminderSettings.urgent.enabled && diffDays === 1) {
                        this.sendProjectReminder(project, 'due');
                    }

                    // Proyecto atrasado
                    if (this.reminderSettings.overdue.enabled && diffDays < 0) {
                        this.sendProjectReminder(project, 'overdue');
                    }
                });
            }

            async testConnection() {
                if (!this.apiToken || !this.phoneId) {
                    throw new Error('Configuración de API incompleta');
                }

                // Test con el primer miembro del equipo
                const testMember = this.teamMembers[0];
                const testMessage = '🧪 *Prueba de Conexión*\nSistema de recordatorios WhatsApp funcionando correctamente.\n_Taller de Torno CNC_';

                return await this.sendMessage(testMember.phone, testMessage);
            }

            addTeamMember(name, phone) {
                this.teamMembers.push({
                    name: name,
                    phone: phone,
                    notifications: true
                });
            }

            updateReminderSettings(settings) {
                this.reminderSettings = { ...this.reminderSettings, ...settings };
            }

            getNotificationHistory() {
                return this.notificationHistory;
            }
        }

        const whatsappManager = new WhatsAppManager();

        // --- Multi-Channel Notification System ---
        class MultiChannelNotificationManager {
            constructor() {
                this.selectedMethod = 'browser'; // Default to browser notifications
                this.emailConfig = {
                    smtpServer: '',
                    smtpPort: 587,
                    email: '',
                    password: '',
                    subject: 'Recordatorio de Proyecto - PO #{{PO_NUMBER}}',
                    template: 'Estimado equipo,\n\nEl proyecto PO #{{PO_NUMBER}} vence el {{DUE_DATE}}.\nDescripción: {{PROJECT_DESCRIPTION}}\n\nSaludos,\nSistema de Recordatorios'
                };
                this.whatsappWebConfig = {
                    mainNumber: '',
                    introMessage: 'Hola! Soy el sistema de recordatorios del taller...'
                };
                this.browserConfig = {
                    sound: true,
                    vibrate: true,
                    persistent: false
                };
            }

            setNotificationMethod(method) {
                this.selectedMethod = method;
            }

            async sendNotification(project, reminderType, teamMembers) {
                const message = this.formatMessage(reminderType, project);
                
                switch (this.selectedMethod) {
                    case 'whatsapp-business':
                        return await whatsappManager.sendProjectReminder(project, reminderType);
                    
                    case 'whatsapp-web':
                        return await this.sendWhatsAppWebNotification(project, message, teamMembers);
                    
                    case 'email':
                        return await this.sendEmailNotification(project, message, teamMembers);
                    
                    case 'browser':
                        return await this.sendBrowserNotification(project, message);
                    
                    default:
                        throw new Error('Método de notificación no válido');
                }
            }

            formatMessage(reminderType, project) {
                const templates = {
                    due: '🚨 *Recordatorio de Proyecto*\nPO #{{PO_NUMBER}} vence {{DUE_DATE}}\n{{PROJECT_DESCRIPTION}}\n_Taller de Torno CNC_',
                    overdue: '⚠️ *PROYECTO ATRASADO*\nPO #{{PO_NUMBER}} - {{DAYS_OVERDUE}} días atrasado\n{{PROJECT_DESCRIPTION}}\n_Acción requerida inmediatamente_',
                    completed: '✅ *Proyecto Completado*\nPO #{{PO_NUMBER}} finalizado exitosamente\n{{PROJECT_DESCRIPTION}}\n_¡Excelente trabajo!_'
                };

                let message = templates[reminderType] || templates.due;
                const dueDate = project.dueDate.toDate();
                const today = new Date();
                const diffDays = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                
                message = message.replace('{{PO_NUMBER}}', project.poNumber);
                message = message.replace('{{PROJECT_DESCRIPTION}}', project.description);
                message = message.replace('{{DUE_DATE}}', dueDate.toLocaleDateString('es-ES'));
                message = message.replace('{{DAYS_OVERDUE}}', Math.abs(diffDays));
                
                return message;
            }

            async sendWhatsAppWebNotification(project, message, teamMembers) {
                const results = [];
                const encodedMessage = encodeURIComponent(message);
                
                for (const member of teamMembers) {
                    if (member.notifications) {
                        const whatsappUrl = `https://wa.me/${member.phone.replace(/\D/g, '')}?text=${encodedMessage}`;
                        
                        // Open WhatsApp Web in new tab
                        window.open(whatsappUrl, '_blank');
                        
                        results.push({
                            member: member.name,
                            phone: member.phone,
                            status: 'opened',
                            timestamp: new Date(),
                            project: project.poNumber,
                            url: whatsappUrl
                        });
                    }
                }
                
                return results;
            }

            async sendEmailNotification(project, message, teamMembers) {
                const results = [];
                
                // This would typically use a backend service to send emails
                // For now, we'll simulate the email sending
                for (const member of teamMembers) {
                    if (member.notifications && member.email) {
                        try {
                            // Simulate email sending
                            console.log(`Sending email to ${member.email}: ${message}`);
                            
                            results.push({
                                member: member.name,
                                email: member.email,
                                status: 'sent',
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        } catch (error) {
                            results.push({
                                member: member.name,
                                email: member.email,
                                status: 'error',
                                error: error.message,
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        }
                    }
                }
                
                return results;
            }

            async sendBrowserNotification(project, message) {
                if (!('Notification' in window)) {
                    throw new Error('Este navegador no soporta notificaciones');
                }

                if (Notification.permission === 'denied') {
                    throw new Error('Permisos de notificación denegados');
                }

                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('Permisos de notificación denegados');
                    }
                }

                const notification = new Notification('Recordatorio de Proyecto', {
                    body: message,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico',
                    tag: `project-${project.poNumber}`,
                    requireInteraction: this.browserConfig.persistent,
                    silent: !this.browserConfig.sound,
                    vibrate: this.browserConfig.vibrate ? [200, 100, 200] : undefined
                });

                // Auto-close after 10 seconds unless persistent
                if (!this.browserConfig.persistent) {
                    setTimeout(() => notification.close(), 10000);
                }

                return [{
                    member: 'Usuario actual',
                    status: 'sent',
                    timestamp: new Date(),
                    project: project.poNumber
                }];
            }

            updateEmailConfig(config) {
                this.emailConfig = { ...this.emailConfig, ...config };
            }

            updateWhatsAppWebConfig(config) {
                this.whatsappWebConfig = { ...this.whatsappWebConfig, ...config };
            }

            updateBrowserConfig(config) {
                this.browserConfig = { ...this.browserConfig, ...config };
            }
        }

        const multiChannelManager = new MultiChannelNotificationManager();

        // --- Settings Management System ---
        class SettingsManager {
            constructor() {
                this.settings = {
                    workshop: {
                        name: 'Taller de Torno CNC Emilio',
                        address: '',
                        phone: '',
                        email: '',
                        specialties: ['integrated', 'prototyping', 'maintenance', 'custom'],
                        productionCapacity: 'medium',
                        timezone: 'America/Mexico_City'
                    },
                    projects: {
                        poPrefix: 'PO',
                        poFormat: 'sequential',
                        customFormat: 'PO-{YYYY}-{MM}-{###}',
                        warningDays: {
                            early: 7,
                            urgent: 1,
                            critical: 0
                        },
                        categories: ['Sistema Mecánico Completo', 'Piezas de Precisión', 'Automatización Industrial', 'Prototipo Integrado'],
                        statuses: ['planning', 'turning', 'milling', 'automation', 'testing', 'completed']
                    },
                    notifications: {
                        workHours: {
                            start: '08:00',
                            end: '18:00',
                            workdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
                        },
                        checkFrequency: 30, // minutes
                        types: {
                            email: true,
                            whatsapp: true,
                            browser: true
                        },
                        sound: {
                            enabled: true,
                            vibrate: true
                        }
                    },
                    ai: {
                        learningLevel: 'intermediate',
                        analysisFrequency: 'immediate',
                        precision: 80,
                        features: {
                            patternRecognition: true,
                            durationPrediction: true,
                            riskAnalysis: true,
                            optimization: true
                        },
                        language: 'es'
                    }
                };
                this.loadSettings();
            }

            loadSettings() {
                const saved = localStorage.getItem('workshop-settings');
                if (saved) {
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                }
                this.applySettings();
            }

            saveSettings() {
                localStorage.setItem('workshop-settings', JSON.stringify(this.settings));
                this.applySettings();
                showNotification('Configuraciones guardadas exitosamente', 'success');
            }

            applySettings() {
                // Apply workshop settings
                document.getElementById('workshop-name').value = this.settings.workshop.name;
                document.getElementById('workshop-address').value = this.settings.workshop.address;
                document.getElementById('workshop-phone').value = this.settings.workshop.phone;
                document.getElementById('workshop-email').value = this.settings.workshop.email;
                
                // Apply specialties
                this.settings.workshop.specialties.forEach(specialty => {
                    const checkbox = document.getElementById(`specialty-${specialty}`);
                    if (checkbox) checkbox.checked = true;
                });
                
                document.getElementById('production-capacity').value = this.settings.workshop.productionCapacity;
                document.getElementById('timezone').value = this.settings.workshop.timezone;
                
                // Apply project settings
                document.getElementById('po-prefix').value = this.settings.projects.poPrefix;
                document.getElementById('po-format').value = this.settings.projects.poFormat;
                document.getElementById('custom-po-format').value = this.settings.projects.customFormat;
                
                if (this.settings.projects.poFormat === 'custom') {
                    document.getElementById('custom-format-container').classList.remove('hidden');
                }
                
                document.getElementById('early-warning-days').value = this.settings.projects.warningDays.early;
                document.getElementById('urgent-warning-days').value = this.settings.projects.warningDays.urgent;
                document.getElementById('critical-warning-days').value = this.settings.projects.warningDays.critical;
                
                // Apply notification settings
                document.getElementById('work-start-time').value = this.settings.notifications.workHours.start;
                document.getElementById('work-end-time').value = this.settings.notifications.workHours.end;
                
                this.settings.notifications.workHours.workdays.forEach(day => {
                    const checkbox = document.getElementById(`workday-${day}`);
                    if (checkbox) checkbox.checked = true;
                });
                
                document.getElementById('check-frequency').value = this.settings.notifications.checkFrequency;
                
                // Apply AI settings
                document.getElementById('ai-learning-level').value = this.settings.ai.learningLevel;
                document.getElementById('ai-analysis-frequency').value = this.settings.ai.analysisFrequency;
                document.getElementById('ai-precision').value = this.settings.ai.precision;
                document.getElementById('precision-value').textContent = this.settings.ai.precision + '%';
                
                Object.keys(this.settings.ai.features).forEach(feature => {
                    const checkbox = document.getElementById(`ai-${feature.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
                    if (checkbox) checkbox.checked = this.settings.ai.features[feature];
                });
                
                document.getElementById('ai-language').value = this.settings.ai.language;
            }

            updateSetting(path, value) {
                const keys = path.split('.');
                let current = this.settings;
                
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) current[keys[i]] = {};
                    current = current[keys[i]];
                }
                
                current[keys[keys.length - 1]] = value;
                this.saveSettings();
            }

            getSetting(path) {
                const keys = path.split('.');
                let current = this.settings;
                
                for (const key of keys) {
                    if (current[key] === undefined) return null;
                    current = current[key];
                }
                
                return current;
            }

            exportSettings() {
                const dataStr = JSON.stringify(this.settings, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `workshop-settings-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            importSettings(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        this.settings = { ...this.settings, ...imported };
                        this.saveSettings();
                        this.applySettings();
                        showNotification('Configuraciones importadas exitosamente', 'success');
                    } catch (error) {
                        showNotification('Error importando configuraciones: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            }

            resetToDefaults() {
                if (confirm('¿Estás seguro de que quieres restablecer todas las configuraciones a los valores por defecto?')) {
                    localStorage.removeItem('workshop-settings');
                    this.settings = new SettingsManager().settings;
                    this.applySettings();
                    showNotification('Configuraciones restablecidas', 'success');
                }
            }
        }

        const settingsManager = new SettingsManager();

        // --- Knowledge Upload System ---
        function setupKnowledgeUpload() {
            const uploadTextBtn = document.getElementById('upload-text-knowledge');
            const knowledgeText = document.getElementById('knowledge-text');
            const fileInput = document.getElementById('knowledge-files');
            const fileList = document.getElementById('file-list');
            const enableWebSearchBtn = document.getElementById('enable-web-search');

            // Text upload
            uploadTextBtn.addEventListener('click', () => {
                const text = knowledgeText.value.trim();
                if (text) {
                    aiSystem.addKnowledgeFromText(text);
                    knowledgeText.value = '';
                    showNotification('Conocimiento agregado exitosamente! La IA ha aprendido nueva información.', 'success');
                    updateKnowledgeStatus();
                }
            });

            // File upload
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type === 'text/plain' || file.type === 'application/pdf' || 
                        file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        displayFile(file);
                        processFile(file);
                    } else {
                        showNotification('Tipo de archivo no soportado: ' + file.name, 'warning');
                    }
                });
            });

            // Web search toggle
            enableWebSearchBtn.addEventListener('click', () => {
                aiSystem.toggleWebSearch();
                enableWebSearchBtn.textContent = aiSystem.webSearchEnabled ? 
                    'Desactivar Búsqueda Web' : 'Activar Búsqueda Web';
                showNotification(aiSystem.webSearchEnabled ? 
                    'Búsqueda web activada' : 'Búsqueda web desactivada', 'success');
            });

            function displayFile(file) {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-file text-slate-500 mr-3"></i>
                        <span class="text-sm font-medium">${file.name}</span>
                        <span class="text-xs text-slate-500 ml-2">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin mr-2"></div>
                        <span class="text-xs text-green-600">Procesando...</span>
                    </div>
                `;
                fileList.appendChild(fileItem);
            }

            function processFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    aiSystem.addKnowledgeFromText(content);
                    updateKnowledgeStatus();
                    
                    // Update file display
                    const fileItems = fileList.querySelectorAll('.flex.items-center.justify-between');
                    const lastItem = fileItems[fileItems.length - 1];
                    if (lastItem) {
                        lastItem.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-file text-slate-500 mr-3"></i>
                                <span class="text-sm font-medium">${file.name}</span>
                                <span class="text-xs text-slate-500 ml-2">(${(file.size / 1024).toFixed(1)} KB)</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="text-xs text-green-600">Completado</span>
                            </div>
                        `;
                    }
                };
                reader.readAsText(file);
            }
        }

        // Add methods to AI system
        AILearningSystem.prototype.addKnowledgeFromText = function(text) {
            // Extract key information from text
            const lines = text.split('\n').filter(line => line.trim());
            
            lines.forEach(line => {
                const lowerLine = line.toLowerCase();
                
                // Extract equipment specifications
                if (lowerLine.includes('torno') && lowerLine.includes('cnc')) {
                    this.updateEquipmentKnowledge('cnc_lathe', line);
                }
                if (lowerLine.includes('fresadora') || lowerLine.includes('fresado')) {
                    this.updateEquipmentKnowledge('milling_machine', line);
                }
                if (lowerLine.includes('robot') || lowerLine.includes('automatizacion')) {
                    this.updateEquipmentKnowledge('automation', line);
                }
                
                // Extract material information
                if (lowerLine.includes('material') || lowerLine.includes('aleacion')) {
                    this.updateMaterialKnowledge(line);
                }
                
                // Extract project types
                if (lowerLine.includes('proyecto') || lowerLine.includes('pieza')) {
                    this.updateProjectTypeKnowledge(line);
                }
            });
            
            this.updateLearningProgress();
        };

        AILearningSystem.prototype.updateEquipmentKnowledge = function(equipment, line) {
            // Update equipment knowledge based on new information
            if (!this.workshopKnowledge.capabilities[equipment]) {
                this.workshopKnowledge.capabilities[equipment] = {};
            }
            
            // Extract specifications from line
            const specs = this.extractSpecifications(line);
            Object.assign(this.workshopKnowledge.capabilities[equipment], specs);
        };

        AILearningSystem.prototype.updateMaterialKnowledge = function(line) {
            // Extract materials from line
            const materials = line.match(/\b(acero|aluminio|titanio|inoxidable|bronce|cobre)\b/g);
            if (materials) {
                materials.forEach(material => {
                    if (!this.workshopKnowledge.materials.includes(material)) {
                        this.workshopKnowledge.materials.push(material);
                    }
                });
            }
        };

        AILearningSystem.prototype.updateProjectTypeKnowledge = function(line) {
            // Extract project types from line
            if (line.includes('torno') || line.includes('cilindrico')) {
                this.addProjectType('lathe', line);
            }
            if (line.includes('fresado') || line.includes('mecanizado')) {
                this.addProjectType('milling', line);
            }
        };

        AILearningSystem.prototype.addProjectType = function(type, line) {
            if (!this.workshopKnowledge.projectTypes[type]) {
                this.workshopKnowledge.projectTypes[type] = [];
            }
            
            // Extract project description
            const description = line.replace(/[^\w\s]/g, '').trim();
            if (description && !this.workshopKnowledge.projectTypes[type].includes(description)) {
                this.workshopKnowledge.projectTypes[type].push(description);
            }
        };

        AILearningSystem.prototype.extractSpecifications = function(line) {
            const specs = {};
            
            // Extract dimensions
            const dimensions = line.match(/(\d+)\s*mm/g);
            if (dimensions) {
                specs.dimensions = dimensions;
            }
            
            // Extract precision
            const precision = line.match(/±?(\d+\.?\d*)\s*mm/g);
            if (precision) {
                specs.precision = precision;
            }
            
            // Extract axes
            const axes = line.match(/(\d+)\s*eje/g);
            if (axes) {
                specs.axes = parseInt(axes[0]);
            }
            
            return specs;
        };

        AILearningSystem.prototype.toggleWebSearch = function() {
            this.webSearchEnabled = !this.webSearchEnabled;
        };

        function updateKnowledgeStatus() {
            // Update knowledge status indicators
            const workshopKnowledge = document.getElementById('workshop-knowledge');
            const projectTypesKnowledge = document.getElementById('project-types-knowledge');
            const timingKnowledge = document.getElementById('timing-knowledge');
            
            if (workshopKnowledge) {
                const workshopScore = Math.min(100, Object.keys(aiSystem.workshopKnowledge.capabilities).length * 25);
                workshopKnowledge.textContent = workshopScore + '%';
                workshopKnowledge.parentElement.querySelector('.bg-green-500').style.width = workshopScore + '%';
            }
            
            if (projectTypesKnowledge) {
                const projectTypesScore = Math.min(100, Object.values(aiSystem.workshopKnowledge.projectTypes).flat().length * 10);
                projectTypesKnowledge.textContent = projectTypesScore + '%';
                projectTypesKnowledge.parentElement.querySelector('.bg-blue-500').style.width = projectTypesScore + '%';
            }
            
            if (timingKnowledge) {
                const timingScore = Math.min(100, aiSystem.patterns.size * 15);
                timingKnowledge.textContent = timingScore + '%';
                timingKnowledge.parentElement.querySelector('.bg-purple-500').style.width = timingScore + '%';
            }
        }

        // --- Tab Navigation ---
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                // Update active tab
                navTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show target content
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${targetTab}-tab`).classList.remove('hidden');
                
                // Initialize charts if analytics tab is selected
                if (targetTab === 'analytics') {
                    initializeCharts();
                }
                
                // Initialize purchasing functionality if purchasing tab is selected
                if (targetTab === 'purchasing') {
                    initializePurchasingSystem();
                }
            });
        });

        // --- AI Chat System ---
        aiChatToggle.addEventListener('click', () => {
            aiChat.classList.toggle('open');
        });

        closeAiChat.addEventListener('click', () => {
            aiChat.classList.remove('open');
        });

        aiInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && aiInput.value.trim()) {
                const userMessage = aiInput.value.trim();
                addMessageToChat('user', userMessage);
                aiInput.value = '';
                
                // Simulate AI thinking
                setTimeout(() => {
                    const aiResponse = aiSystem.getAIResponse(userMessage);
                    addMessageToChat('bot', aiResponse);
                }, 1000);
            }
        });

        function addMessageToChat(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            messageDiv.innerHTML = `
                <div class="ai-message-content">
                    <p>${message}</p>
                </div>
            `;
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // --- Smart Entry Parser (Enhanced) ---
        smartEntryTextarea.addEventListener('input', () => {
            const text = smartEntryTextarea.value;
            const poRegex = /(?:PO|Order|Job)\s*(?:#|:)?\s*([\w-]+)/i;
            const poMatch = text.match(poRegex);
            if (poMatch && poMatch[1]) {
                poNumberInput.value = poMatch[1];
            }
            const dateRegex = /(\d{4}-\d{2}-\d{2})|(\d{1,2}\/\d{1,2}\/\d{4})/;
            const dateMatch = text.match(dateRegex);
            if (dateMatch) {
                const dateStr = dateMatch[2] ? new Date(dateMatch[2]).toISOString().split('T')[0] : dateMatch[1];
                dueDateInput.value = dateStr;
            }
             const descRegex = /(?:Job|Description|Title|Desc)\s*:\s*(.*)/i;
             const descMatch = text.match(descRegex);
             if (descMatch && descMatch[1]) {
                 projectDescriptionInput.value = descMatch[1].trim();
             } else {
                const lines = text.split('\n');
                const nonPoDateLine = lines.find(line => !poRegex.test(line) && !dateRegex.test(line) && line.trim() !== '');
                if(nonPoDateLine) {
                    projectDescriptionInput.value = nonPoDateLine.trim().replace(/^:\s*/, '');
                }
             }
        });

        // --- Helper Functions ---
        const getRelativeDateInfo = (date) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(date);
            dueDate.setHours(0, 0, 0, 0);
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { text: `Atrasado por ${Math.abs(diffDays)} día(s)`, class: 'overdue' };
            if (diffDays === 0) return { text: 'Vence hoy', class: 'due-today' };
            if (diffDays === 1) return { text: 'Vence mañana', class: 'due-soon' };
            if (diffDays <= 3) return { text: `Vence en ${diffDays} días`, class: 'due-soon' };
            return { text: `Vence en ${diffDays} días`, class: '' };
        };
        
        const renderProject = (project) => {
            const dueDate = project.dueDate.toDate();
            const formattedDate = dueDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const relativeDateInfo = getRelativeDateInfo(dueDate);
            
            // Determine status badge class
            let statusClass = 'status-normal';
            if (relativeDateInfo.class === 'due-soon') statusClass = 'status-due-soon';
            else if (relativeDateInfo.class === 'due-today') statusClass = 'status-due-today';
            else if (relativeDateInfo.class === 'overdue') statusClass = 'status-overdue';
            
            return `
                <div class="project-card fade-in ${relativeDateInfo.class}">
                    <div class="flex justify-between items-start">
                    <div class="flex-grow">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-file-alt text-white text-sm"></i>
                    </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-slate-800">PO #${project.poNumber}</h3>
                                    <p class="text-slate-600 text-sm">${formattedDate}</p>
                                </div>
                            </div>
                            <p class="text-slate-700 mb-3 leading-relaxed">${project.description}</p>
                            <span class="status-badge ${statusClass}">
                                <i class="fas fa-clock mr-1"></i>
                                ${relativeDateInfo.text}
                            </span>
                    </div>
                        <button data-id="${project.id}" class="delete-btn ml-4">
                            <i class="fas fa-trash-alt"></i>
                    </button>
                    </div>
                </div>
            `;
        };

        const updateProjectList = (projects) => {
            loadingSpinner.classList.remove('show');
            noProjectsMessage.classList.toggle('hidden', projects.length > 0);
            projectList.innerHTML = projects.map(renderProject).join('');
            allProjects = projects;
            updateDashboardMetrics(projects);
            
            // Update purchasing recommendations if purchasing tab is active
            const purchasingTab = document.getElementById('purchasing-tab');
            if (purchasingTab && !purchasingTab.classList.contains('hidden')) {
                updateProjectMaterialRecommendations();
                updatePurchasingInsights();
            }
            
            // Check for multi-channel reminders
            checkMultiChannelReminders(projects);
        };

        async function checkMultiChannelReminders(projects) {
            const now = new Date();
            const currentHour = now.getHours();
            const startHour = 8; // 8:00 AM
            const endHour = 18; // 6:00 PM

            // Only send reminders during business hours
            if (currentHour < startHour || currentHour > endHour) {
                return;
            }

            for (const project of projects) {
                const dueDate = project.dueDate.toDate();
                const diffDays = Math.ceil((dueDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

                let reminderType = null;
                
                // Early reminder (7 days before)
                if (diffDays === 7) {
                    reminderType = 'due';
                }
                // Urgent reminder (1 day before)
                else if (diffDays === 1) {
                    reminderType = 'due';
                }
                // Overdue project
                else if (diffDays < 0) {
                    reminderType = 'overdue';
                }

                if (reminderType) {
                    try {
                        await multiChannelManager.sendNotification(project, reminderType, whatsappManager.teamMembers);
                    } catch (error) {
                        console.error('Error sending notification:', error);
                    }
                }
            }
        }

        const updateDashboardMetrics = (projects) => {
            document.getElementById('total-projects').textContent = projects.length;
            
            const completedThisMonth = projects.filter(p => {
                const created = p.createdAt.toDate();
                const now = new Date();
                return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
            }).length;
            document.getElementById('completed-projects').textContent = completedThisMonth;
            
            const overdue = projects.filter(p => {
                const dueDate = p.dueDate.toDate();
                const today = new Date();
                return dueDate < today;
            }).length;
            document.getElementById('overdue-projects').textContent = overdue;
            
            const efficiencyScore = Math.max(0, Math.min(100, 100 - (overdue * 10) + (completedThisMonth * 5)));
            document.getElementById('efficiency-score').textContent = `${efficiencyScore}%`;
        };

        // --- Chart Initialization ---
        function initializeCharts() {
            // Timeline Chart
            const timelineCtx = document.getElementById('timelineChart');
            if (timelineCtx) {
                new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
                        datasets: [{
                            label: 'Proyectos Completados',
                            data: [2, 4, 3, 5],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Completion Chart
            const completionCtx = document.getElementById('completionChart');
            if (completionCtx) {
                new Chart(completionCtx, {
                    type: 'bar',
                    data: {
                        labels: ['A Tiempo', 'Tardío', 'Temprano'],
                        datasets: [{
                            data: [12, 3, 2],
                            backgroundColor: ['#22c55e', '#ef4444', '#3b82f6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Distribution Chart
            const distributionCtx = document.getElementById('distributionChart');
            if (distributionCtx) {
                new Chart(distributionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Bridas', 'Tuberías', 'Válvulas', 'Otros'],
                        datasets: [{
                            data: [35, 25, 20, 20],
                            backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // --- Purchasing System ---
        function initializePurchasingSystem() {
            updateProjectMaterialRecommendations();
            updatePurchasingInsights();
            // Suscribirse a proveedores y órdenes si hay permisos
            const isAllowed = (currentUserRole === 'admin' || currentUserRole === 'compras');
            if (isAllowed) {
                subscribeSuppliersList();
                subscribePurchaseOrdersList();
            }
        }

        function updateProjectMaterialRecommendations() {
            const recommendationsContainer = document.getElementById('project-material-recommendations');
            if (!recommendationsContainer) return;

            // Clear existing recommendations
            recommendationsContainer.innerHTML = '';

            // Analyze active projects for material needs
            const activeProjects = allProjects.filter(project => 
                project.dueDate && new Date(project.dueDate) >= new Date()
            );

            if (activeProjects.length === 0) {
                recommendationsContainer.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-yellow-800 mb-2">Sin Proyectos Activos</h4>
                                <p class="text-sm text-yellow-700">No hay proyectos activos para analizar. Agrega proyectos para obtener recomendaciones de materiales.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Analyze materials needed
            const materialNeeds = analyzeProjectMaterials(activeProjects);
            
            // Display recommendations
            materialNeeds.forEach(need => {
                const recommendationCard = document.createElement('div');
                recommendationCard.className = 'bg-white border border-gray-200 rounded-lg p-4';
                recommendationCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-${need.priority === 'high' ? 'red' : need.priority === 'medium' ? 'yellow' : 'green'}-500 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-${need.type === 'material' ? 'cube' : 'tools'} text-white text-sm"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800">${need.name}</h4>
                                <p class="text-sm text-slate-600">${need.description}</p>
                            </div>
                        </div>
                        <span class="text-xs bg-${need.priority === 'high' ? 'red' : need.priority === 'medium' ? 'yellow' : 'green'}-100 text-${need.priority === 'high' ? 'red' : need.priority === 'medium' ? 'yellow' : 'green'}-700 px-2 py-1 rounded-full">
                            ${need.priority === 'high' ? 'Urgente' : need.priority === 'medium' ? 'Medio' : 'Bajo'}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-slate-600">
                            <span class="font-medium">Proyectos relacionados:</span> ${need.relatedProjects.join(', ')}
                        </div>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white text-xs py-1 px-3 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-1"></i>Crear PO
                        </button>
                    </div>
                `;
                recommendationsContainer.appendChild(recommendationCard);
            });

            // Add info card at the end
            const infoCard = document.createElement('div');
            infoCard.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4';
            infoCard.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-blue-800 mb-2">Análisis Automático</h4>
                        <p class="text-sm text-blue-700">Las recomendaciones se basan en el análisis de ${activeProjects.length} proyecto(s) activo(s). El sistema identifica materiales y herramientas necesarias según las descripciones de proyectos.</p>
                    </div>
                </div>
            `;
            recommendationsContainer.appendChild(infoCard);
        }

        function analyzeProjectMaterials(projects) {
            const materialNeeds = [];
            const materialMap = new Map();

            projects.forEach(project => {
                const description = project.description.toLowerCase();
                
                // Identify materials
                const materials = [
                    { name: 'Acero Inoxidable 316L', keywords: ['inoxidable', '316l', 'acero inox'], priority: 'high' },
                    { name: 'Aluminio 6061-T6', keywords: ['aluminio', '6061'], priority: 'medium' },
                    { name: 'Titanio Grado 5', keywords: ['titanio', 'ti6al4v'], priority: 'high' },
                    { name: 'Acero al Carbono', keywords: ['acero', 'carbono', 'steel'], priority: 'low' }
                ];

                // Identify tools
                const tools = [
                    { name: 'Fresas HSS', keywords: ['fresa', 'fresado', 'milling'], priority: 'medium' },
                    { name: 'Brocas de Carburo', keywords: ['broca', 'taladro', 'drill'], priority: 'medium' },
                    { name: 'Inserts de Carburo', keywords: ['insert', 'carburo', 'turning'], priority: 'high' },
                    { name: 'Herramientas de Acabado', keywords: ['acabado', 'pulido', 'finish'], priority: 'low' }
                ];

                // Check for materials
                materials.forEach(material => {
                    if (material.keywords.some(keyword => description.includes(keyword))) {
                        if (!materialMap.has(material.name)) {
                            materialMap.set(material.name, {
                                name: material.name,
                                type: 'material',
                                priority: material.priority,
                                description: `Material identificado para proyecto de ${project.description.substring(0, 50)}...`,
                                relatedProjects: []
                            });
                        }
                        materialMap.get(material.name).relatedProjects.push(project.poNumber || `Proyecto ${project.id}`);
                    }
                });

                // Check for tools
                tools.forEach(tool => {
                    if (tool.keywords.some(keyword => description.includes(keyword))) {
                        if (!materialMap.has(tool.name)) {
                            materialMap.set(tool.name, {
                                name: tool.name,
                                type: 'tool',
                                priority: tool.priority,
                                description: `Herramienta identificada para proyecto de ${project.description.substring(0, 50)}...`,
                                relatedProjects: []
                            });
                        }
                        materialMap.get(tool.name).relatedProjects.push(project.poNumber || `Proyecto ${project.id}`);
                    }
                });
            });

            // Convert map to array and sort by priority
            materialMap.forEach(need => materialNeeds.push(need));
            
            return materialNeeds.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
        }

        function updatePurchasingInsights() {
            // Update insights based on current project data
            const activeProjects = allProjects.filter(project => 
                project.dueDate && new Date(project.dueDate) >= new Date()
            );

            // Calculate material usage trends
            const materialUsage = {};
            activeProjects.forEach(project => {
                const description = project.description.toLowerCase();
                if (description.includes('inoxidable')) materialUsage.inoxidable = (materialUsage.inoxidable || 0) + 1;
                if (description.includes('aluminio')) materialUsage.aluminio = (materialUsage.aluminio || 0) + 1;
                if (description.includes('titanio')) materialUsage.titanio = (materialUsage.titanio || 0) + 1;
            });

            // Update trend insights
            const trendElement = document.querySelector('.bg-gradient-to-br.from-blue-50.to-blue-100 .text-sm');
            if (trendElement && materialUsage.inoxidable > 0) {
                trendElement.textContent = `El acero inoxidable se usa en ${materialUsage.inoxidable} proyecto(s) activo(s) - Considera compra a granel`;
            }

            // Update cost optimization
            const costElement = document.querySelector('.bg-gradient-to-br.from-green-50.to-green-100 .text-sm');
            if (costElement) {
                const totalProjects = activeProjects.length;
                if (totalProjects > 5) {
                    costElement.textContent = `Con ${totalProjects} proyectos activos, comprando en lotes puedes ahorrar hasta 20%`;
                }
            }

            // Update predictions
            const predictionElement = document.querySelector('.bg-gradient-to-br.from-purple-50.to-purple-100 .text-sm');
            if (predictionElement) {
                if (materialUsage.aluminio > 0) {
                    predictionElement.textContent = `Se necesitarán aproximadamente ${materialUsage.aluminio * 10}kg de aluminio para proyectos activos`;
                }
            }
        }

        // Firestore live lists for Compras
        function subscribeSuppliersList() {
            const list = document.getElementById('suppliers-list');
            if (!list) return;
            const supCol = collection(db, 'artifacts', appId, 'secure', 'purchasing', 'suppliers');
            const qSup = query(supCol, orderBy('createdAt', 'desc'));
            onSnapshot(qSup, (snap) => {
                list.innerHTML = '';
                snap.forEach((d) => {
                    const s = d.data();
                    const el = document.createElement('div');
                    el.className = 'bg-slate-50 border border-slate-200 rounded-lg p-4';
                    el.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-slate-800">${s.name}</h5>
                            <div class="flex gap-2 items-center">
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Activo</span>
                                ${(currentUserRole === 'admin' || currentUserRole === 'compras') ? `<button data-id="${d.id}" class="text-xs text-blue-600 hover:underline edit-supplier">Editar</button>` : ''}
                                ${(currentUserRole === 'admin') ? `<button data-id="${d.id}" class="text-xs text-red-600 hover:underline delete-supplier">Eliminar</button>` : ''}
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-2">Especialista en ${String(s.specialty || '').toLowerCase()}</p>
                        <div class="flex items-center space-x-4 text-xs text-slate-500">
                            ${s.contact ? `<span><i class="fas fa-user mr-1"></i>${s.contact}</span>` : ''}
                            ${s.phone ? `<span><i class="fas fa-phone mr-1"></i>${s.phone}</span>` : ''}
                            ${s.email ? `<span><i class="fas fa-envelope mr-1"></i>${s.email}</span>` : ''}
                        </div>
                    `;
                    list.appendChild(el);
                });

                // edit handlers
                list.querySelectorAll('.edit-supplier').forEach(btn => {
                    btn.addEventListener('click', async (ev) => {
                        const id = ev.currentTarget.getAttribute('data-id');
                        const newPhone = prompt('Nuevo teléfono (opcional):');
                        const newEmail = prompt('Nuevo email (opcional):');
                        try {
                            await updateDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'suppliers', id), {
                                ...(newPhone ? { phone: newPhone } : {}),
                                ...(newEmail ? { email: newEmail } : {})
                            });
                            showNotification('Proveedor actualizado', 'success');
                        } catch (e) {
                            showNotification('No se pudo actualizar', 'error');
                        }
                    });
                });

                // delete handlers
                if (currentUserRole === 'admin') {
                    list.querySelectorAll('.delete-supplier').forEach(btn => {
                        btn.addEventListener('click', async (ev) => {
                            const id = ev.currentTarget.getAttribute('data-id');
                            try {
                                await deleteDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'suppliers', id));
                                showNotification('Proveedor eliminado', 'success');
                            } catch (e) {
                                showNotification('No se pudo eliminar', 'error');
                            }
                        });
                    });
                }
            });
        }

        function subscribePurchaseOrdersList() {
            const list = document.getElementById('purchase-orders-list');
            if (!list) return;
            const poCol = collection(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders');
            const qPO = query(poCol, orderBy('createdAt', 'desc'));
            const statusFilter = document.getElementById('po-filter-status');
            const supplierFilter = document.getElementById('po-filter-supplier');

            const render = (docs) => {
                list.innerHTML = '';
                const statusVal = statusFilter && 'value' in statusFilter ? statusFilter.value : '';
                const supplierVal = supplierFilter && 'value' in supplierFilter ? (supplierFilter.value || '').toLowerCase() : '';

                docs.forEach((d) => {
                    const p = d.data();
                    if (statusVal && (p.status || 'pendiente') !== statusVal) return;
                    if (supplierVal && !(p.supplier || '').toLowerCase().includes(supplierVal)) return;

                    const el = document.createElement('div');
                    el.className = 'bg-slate-50 border border-slate-200 rounded-lg p-4';
                    el.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-slate-800">${d.id}</h5>
                            <div class="flex items-center gap-2">
                                <span class="text-xs ${p.status === 'pendiente' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'} px-2 py-1 rounded-full">${p.status || 'pendiente'}</span>
                                ${(currentUserRole === 'admin' || currentUserRole === 'compras') ? `<button data-id="${d.id}" class="text-xs text-blue-600 hover:underline edit-po">Editar</button>` : ''}
                                ${(currentUserRole === 'admin' || currentUserRole === 'compras') ? `<button data-id="${d.id}" class="text-xs text-green-700 hover:underline deliver-po">Marcar Entregado</button>` : ''}
                                ${(currentUserRole === 'admin') ? `<button data-id="${d.id}" class="text-xs text-red-600 hover:underline delete-po">Eliminar</button>` : ''}
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-2">${p.item} - ${p.quantity} ${p.unit}</p>
                        <div class="flex items-center justify-between text-xs text-slate-500">
                            <span>Proveedor: ${p.supplier || '-'}</span>
                            <span>${p.createdAt?.toDate ? p.createdAt.toDate().toLocaleDateString() : ''}</span>
                        </div>
                    `;
                    list.appendChild(el);
                });

                // handlers
                list.querySelectorAll('.edit-po').forEach(btn => {
                    btn.addEventListener('click', async (ev) => {
                        const id = ev.currentTarget.getAttribute('data-id');
                        const newQty = prompt('Nueva cantidad:');
                        if (!newQty) return;
                        try {
                            await updateDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders', id), { quantity: parseFloat(newQty) });
                            showNotification('Orden actualizada', 'success');
                        } catch (e) {
                            showNotification('No se pudo actualizar', 'error');
                        }
                    });
                });
                list.querySelectorAll('.deliver-po').forEach(btn => {
                    btn.addEventListener('click', async (ev) => {
                        const id = ev.currentTarget.getAttribute('data-id');
                        try {
                            await updateDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders', id), { status: 'entregado' });
                            showNotification('Orden marcada como entregada', 'success');
                        } catch (e) {
                            showNotification('No se pudo actualizar', 'error');
                        }
                    });
                });
                if (currentUserRole === 'admin') {
                    list.querySelectorAll('.delete-po').forEach(btn => {
                        btn.addEventListener('click', async (ev) => {
                            const id = ev.currentTarget.getAttribute('data-id');
                            try {
                                await deleteDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders', id));
                                showNotification('Orden eliminada', 'success');
                            } catch (e) {
                                showNotification('No se pudo eliminar', 'error');
                            }
                        });
                    });
                }
            };

            onSnapshot(qPO, (snap) => render(snap.docs));
            statusFilter?.addEventListener('change', () => onSnapshot(qPO, (snap) => render(snap.docs)));
            supplierFilter?.addEventListener('input', () => onSnapshot(qPO, (snap) => render(snap.docs)));
        }

        // --- Notification System ---
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('notification-container').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // --- Event Handlers ---
        addProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!poNumberInput.value || !dueDateInput.value || !projectDescriptionInput.value) return;
            
            const [year, month, day] = dueDateInput.value.split('-');
            const dueDate = new Date(year, month - 1, day, 12, 0, 0);
            
            try {
                const projectData = {
                    poNumber: poNumberInput.value,
                    description: projectDescriptionInput.value,
                    dueDate: Timestamp.fromDate(dueDate),
                    createdAt: Timestamp.now()
                };
                
                await addDoc(projectsCollection, projectData);
                
                // AI Learning
                aiSystem.analyzeProject(projectData);
                
                addProjectForm.reset();
                smartEntryTextarea.value = '';
                showNotification('¡Proyecto agregado exitosamente! La IA está aprendiendo de estos datos.', 'success');
            } catch (error) {
                console.error("Error adding document: ", error);
                showNotification('Error al agregar proyecto. Por favor intenta de nuevo.', 'error');
            }
        });

        projectList.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-btn')) {
                const id = e.target.closest('.delete-btn').dataset.id;
                try {
                    await deleteDoc(doc(db, projectsCollection.path, id));
                    showNotification('¡Proyecto eliminado exitosamente!', 'success');
                } catch (error) {
                    console.error("Error removing document: ", error);
                    showNotification('Error al eliminar proyecto.', 'error');
                }
            }
        });

        // --- Multi-Channel Setup System ---
        function setupMultiChannelNotifications() {
            // Method selection
            const methodCards = document.querySelectorAll('.notification-method-card');
            const methodRadios = document.querySelectorAll('input[name="notification-method"]');
            
            methodCards.forEach(card => {
                card.addEventListener('click', () => {
                    const method = card.dataset.method;
                    const radio = card.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Update visual selection
                    methodCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    
                    // Show/hide configuration sections
                    showConfigurationSection(method);
                    
                    // Update notification manager
                    multiChannelManager.setNotificationMethod(method);
                });
            });

            // Initialize with browser notifications
            showConfigurationSection('browser');
            multiChannelManager.setNotificationMethod('browser');
        }

        function showConfigurationSection(method) {
            // Hide all configuration sections
            document.getElementById('whatsapp-business-config').classList.add('hidden');
            document.getElementById('whatsapp-web-config').classList.add('hidden');
            document.getElementById('email-config').classList.add('hidden');
            document.getElementById('browser-config').classList.add('hidden');
            
            // Show selected section
            switch (method) {
                case 'whatsapp-business':
                    document.getElementById('whatsapp-business-config').classList.remove('hidden');
                    break;
                case 'whatsapp-web':
                    document.getElementById('whatsapp-web-config').classList.remove('hidden');
                    break;
                case 'email':
                    document.getElementById('email-config').classList.remove('hidden');
                    break;
                case 'browser':
                    document.getElementById('browser-config').classList.remove('hidden');
                    checkNotificationPermission();
                    break;
            }
        }

        function checkNotificationPermission() {
            const statusElement = document.getElementById('notification-permission-status');
            
            if (!('Notification' in window)) {
                statusElement.textContent = 'No soportado';
                statusElement.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-600';
                return;
            }
            
            switch (Notification.permission) {
                case 'granted':
                    statusElement.textContent = 'Permitido';
                    statusElement.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-600';
                    break;
                case 'denied':
                    statusElement.textContent = 'Denegado';
                    statusElement.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-600';
                    break;
                default:
                    statusElement.textContent = 'Pendiente';
                    statusElement.className = 'text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-600';
            }
        }

        // --- WhatsApp Setup System ---
        function setupWhatsApp() {
            const testConnectionBtn = document.getElementById('test-whatsapp-connection');
            const addMemberBtn = document.getElementById('add-team-member');
            const testAllBtn = document.getElementById('test-all-notifications');
            const testSpecificBtn = document.getElementById('test-specific-member');

            // Test WhatsApp connection
            testConnectionBtn.addEventListener('click', async () => {
                const token = document.getElementById('whatsapp-token').value;
                const phoneId = document.getElementById('whatsapp-phone-id').value;
                const verifyToken = document.getElementById('whatsapp-verify-token').value;

                if (!token || !phoneId) {
                    showNotification('Por favor completa el token y Phone ID', 'warning');
                    return;
                }

                whatsappManager.setCredentials(token, phoneId, verifyToken);

                try {
                    await whatsappManager.testConnection();
                    showNotification('¡Conexión WhatsApp exitosa!', 'success');
                } catch (error) {
                    showNotification('Error de conexión: ' + error.message, 'error');
                }
            });

            // Add team member
            addMemberBtn.addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.remove('hidden');
                // Clear form
                document.getElementById('add-member-name').value = '';
                document.getElementById('add-member-phone').value = '';
                document.getElementById('add-member-notifications').checked = true;
            });

            // Test all notifications
            testAllBtn.addEventListener('click', async () => {
                if (!whatsappManager.apiToken) {
                    showNotification('Configura primero la API de WhatsApp', 'warning');
                    return;
                }

                try {
                    const testMessage = '🧪 *Prueba de Sistema*\nRecordatorios automáticos de proyectos activados.\n_Taller de Torno CNC_';
                    
                    for (const member of whatsappManager.teamMembers) {
                        if (member.notifications) {
                            await whatsappManager.sendMessage(member.phone, testMessage);
                        }
                    }
                    
                    showNotification('Mensajes de prueba enviados a todos los miembros', 'success');
                } catch (error) {
                    showNotification('Error enviando mensajes: ' + error.message, 'error');
                }
            });

            // Update reminder settings
            document.getElementById('early-reminder').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ early: { enabled: e.target.checked, days: 7 } });
            });

            document.getElementById('urgent-reminder').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ urgent: { enabled: e.target.checked, days: 1 } });
            });

            document.getElementById('overdue-reminder').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ overdue: { enabled: e.target.checked, days: 0 } });
            });

            document.getElementById('start-time').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ startTime: e.target.value });
            });

            document.getElementById('end-time').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ endTime: e.target.value });
            });

            // Browser notification permission request
            document.getElementById('request-notification-permission').addEventListener('click', async () => {
                try {
                    const permission = await Notification.requestPermission();
                    checkNotificationPermission();
                    
                    if (permission === 'granted') {
                        showNotification('Permisos de notificación concedidos', 'success');
                    } else {
                        showNotification('Permisos de notificación denegados', 'warning');
                    }
                } catch (error) {
                    showNotification('Error solicitando permisos: ' + error.message, 'error');
                }
            });

            // Browser notification settings
            document.getElementById('notification-sound').addEventListener('change', (e) => {
                multiChannelManager.updateBrowserConfig({ sound: e.target.checked });
            });

            document.getElementById('notification-vibrate').addEventListener('change', (e) => {
                multiChannelManager.updateBrowserConfig({ vibrate: e.target.checked });
            });

            document.getElementById('notification-persistent').addEventListener('change', (e) => {
                multiChannelManager.updateBrowserConfig({ persistent: e.target.checked });
            });

            // Email configuration
            document.getElementById('test-email').addEventListener('click', async () => {
                const smtpServer = document.getElementById('smtp-server').value;
                const smtpPort = document.getElementById('smtp-port').value;
                const email = document.getElementById('smtp-email').value;
                const password = document.getElementById('smtp-password').value;
                
                if (!smtpServer || !email) {
                    showNotification('Completa la configuración SMTP', 'warning');
                    return;
                }

                multiChannelManager.updateEmailConfig({
                    smtpServer,
                    smtpPort: parseInt(smtpPort),
                    email,
                    password
                });

                try {
                    // Simulate email test
                    showNotification('Email de prueba enviado (simulado)', 'success');
                } catch (error) {
                    showNotification('Error enviando email: ' + error.message, 'error');
                }
            });

            document.getElementById('save-email-config').addEventListener('click', () => {
                const subject = document.getElementById('email-subject').value;
                const template = document.getElementById('email-template').value;
                
                multiChannelManager.updateEmailConfig({
                    subject,
                    template
                });
                
                showNotification('Configuración de email guardada', 'success');
            });

            // WhatsApp Web configuration
            document.getElementById('whatsapp-web-number').addEventListener('change', (e) => {
                multiChannelManager.updateWhatsAppWebConfig({ mainNumber: e.target.value });
            });

            document.getElementById('whatsapp-web-intro').addEventListener('change', (e) => {
                multiChannelManager.updateWhatsAppWebConfig({ introMessage: e.target.value });
            });
        }

        function updateTeamMembersDisplay() {
            const container = document.getElementById('team-members-whatsapp');
            container.innerHTML = '';

            whatsappManager.teamMembers.forEach((member, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'flex items-center justify-between p-4 bg-slate-50 rounded-lg';
                memberDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-green-600"></i>
                        </div>
                        <div>
                            <h5 class="font-medium text-slate-800">${member.name}</h5>
                            <p class="text-sm text-slate-600">${member.phone}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="whatsapp-notifications" ${member.notifications ? 'checked' : ''}>
                            <span class="ml-2 text-sm text-slate-600">Notificaciones</span>
                        </label>
                        <button onclick="editTeamMember(${index})" class="ml-3 p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors" title="Editar miembro">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removeTeamMember(${index})" class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors" title="Eliminar miembro">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(memberDiv);
            });
        }

        // --- Team Member Management Functions ---
        function removeTeamMember(index) {
            if (confirm('¿Estás seguro de que quieres eliminar este miembro del equipo?')) {
                whatsappManager.teamMembers.splice(index, 1);
                updateTeamMembersDisplay();
                showNotification('Miembro del equipo eliminado exitosamente', 'success');
            }
        }

        let currentEditingIndex = -1;

        function editTeamMember(index) {
            currentEditingIndex = index;
            const member = whatsappManager.teamMembers[index];
            
            // Populate modal with current member data
            document.getElementById('edit-member-name').value = member.name;
            document.getElementById('edit-member-phone').value = member.phone;
            
            // Show modal
            document.getElementById('edit-member-modal').classList.remove('hidden');
        }

        // --- Template Editor Functions ---
        function editTemplate(templateType) {
            const template = whatsappManager.templates[templateType];
            const newMessage = prompt(`Editar plantilla "${template.title}":`, template.message);
            
            if (newMessage && newMessage !== template.message) {
                whatsappManager.templates[templateType].message = newMessage;
                showNotification('Plantilla actualizada exitosamente', 'success');
                updateTemplateDisplay(templateType);
            }
        }

        function updateTemplateDisplay(templateType) {
            // Update the template display in the UI
            const template = whatsappManager.templates[templateType];
            const templateElements = document.querySelectorAll(`[onclick="editTemplate('${templateType}')"]`);
            
            templateElements.forEach(element => {
                const messageContainer = element.parentElement.querySelector('.bg-white p');
                if (messageContainer) {
                    messageContainer.innerHTML = template.message.replace(/\n/g, '<br>');
                }
            });
        }

        // --- Periodic Reminder Check ---
        function startReminderScheduler() {
            // Check for reminders every hour
            setInterval(() => {
                if (allProjects.length > 0) {
                    whatsappManager.checkReminders(allProjects);
                }
            }, 60 * 60 * 1000); // Every hour

            // Also check immediately on load
            if (allProjects.length > 0) {
                whatsappManager.checkReminders(allProjects);
            }
        }

        // --- Settings Setup System ---
        function setupSettings() {
            // Workshop information
            document.getElementById('workshop-name').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.name', e.target.value);
            });
            
            document.getElementById('workshop-address').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.address', e.target.value);
            });
            
            document.getElementById('workshop-phone').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.phone', e.target.value);
            });
            
            document.getElementById('workshop-email').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.email', e.target.value);
            });
            
            // Specialties
            document.querySelectorAll('input[id^="specialty-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const specialty = e.target.id.replace('specialty-', '');
                    let specialties = settingsManager.getSetting('workshop.specialties') || [];
                    
                    if (e.target.checked) {
                        if (!specialties.includes(specialty)) {
                            specialties.push(specialty);
                        }
                    } else {
                        specialties = specialties.filter(s => s !== specialty);
                    }
                    
                    settingsManager.updateSetting('workshop.specialties', specialties);
                });
            });
            
            document.getElementById('production-capacity').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.productionCapacity', e.target.value);
            });
            
            document.getElementById('timezone').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.timezone', e.target.value);
            });
            
            // Project settings
            document.getElementById('po-prefix').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.poPrefix', e.target.value);
            });
            
            document.getElementById('po-format').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.poFormat', e.target.value);
                
                if (e.target.value === 'custom') {
                    document.getElementById('custom-format-container').classList.remove('hidden');
                } else {
                    document.getElementById('custom-format-container').classList.add('hidden');
                }
            });
            
            document.getElementById('custom-po-format').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.customFormat', e.target.value);
            });
            
            // Warning days
            document.getElementById('early-warning-days').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.warningDays.early', parseInt(e.target.value));
            });
            
            document.getElementById('urgent-warning-days').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.warningDays.urgent', parseInt(e.target.value));
            });
            
            document.getElementById('critical-warning-days').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.warningDays.critical', parseInt(e.target.value));
            });
            
            // Categories management
            document.getElementById('add-category').addEventListener('click', () => {
                const input = document.getElementById('new-category');
                const category = input.value.trim();
                
                if (category) {
                    let categories = settingsManager.getSetting('projects.categories') || [];
                    if (!categories.includes(category)) {
                        categories.push(category);
                        settingsManager.updateSetting('projects.categories', categories);
                        updateCategoriesList();
                        input.value = '';
                    }
                }
            });
            
            // Notification settings
            document.getElementById('work-start-time').addEventListener('change', (e) => {
                settingsManager.updateSetting('notifications.workHours.start', e.target.value);
            });
            
            document.getElementById('work-end-time').addEventListener('change', (e) => {
                settingsManager.updateSetting('notifications.workHours.end', e.target.value);
            });
            
            // Workdays
            document.querySelectorAll('input[id^="workday-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const day = e.target.id.replace('workday-', '');
                    let workdays = settingsManager.getSetting('notifications.workHours.workdays') || [];
                    
                    if (e.target.checked) {
                        if (!workdays.includes(day)) {
                            workdays.push(day);
                        }
                    } else {
                        workdays = workdays.filter(d => d !== day);
                    }
                    
                    settingsManager.updateSetting('notifications.workHours.workdays', workdays);
                });
            });
            
            document.getElementById('check-frequency').addEventListener('change', (e) => {
                settingsManager.updateSetting('notifications.checkFrequency', parseInt(e.target.value));
            });
            
            // AI settings
            document.getElementById('ai-learning-level').addEventListener('change', (e) => {
                settingsManager.updateSetting('ai.learningLevel', e.target.value);
            });
            
            document.getElementById('ai-analysis-frequency').addEventListener('change', (e) => {
                settingsManager.updateSetting('ai.analysisFrequency', e.target.value);
            });
            
            document.getElementById('ai-precision').addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                settingsManager.updateSetting('ai.precision', value);
                document.getElementById('precision-value').textContent = value + '%';
            });
            
            // AI features
            document.querySelectorAll('input[id^="ai-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const feature = e.target.id.replace('ai-', '').replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                    settingsManager.updateSetting(`ai.features.${feature}`, e.target.checked);
                });
            });
            
            document.getElementById('ai-language').addEventListener('change', (e) => {
                settingsManager.updateSetting('ai.language', e.target.value);
            });
            
            // Export/Import
            document.getElementById('export-settings').addEventListener('click', () => {
                settingsManager.exportSettings();
            });
            
            document.getElementById('import-data').addEventListener('click', () => {
                document.getElementById('import-file').click();
            });
            
            document.getElementById('import-file').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    settingsManager.importSettings(e.target.files[0]);
                }
            });
            
            document.getElementById('reset-settings').addEventListener('click', () => {
                settingsManager.resetToDefaults();
            });
            
            document.getElementById('save-all-settings').addEventListener('click', () => {
                settingsManager.saveSettings();
            });
            
            document.getElementById('reset-to-defaults').addEventListener('click', () => {
                settingsManager.resetToDefaults();
            });

            // Admin roles UI visibility and events
            const rolesCard = document.getElementById('admin-roles-card');
            if (rolesCard) {
                if (currentUserRole === 'admin') rolesCard.classList.remove('hidden');
                else rolesCard.classList.add('hidden');
            }

            const saveRoleBtn = document.getElementById('save-role');
            const loadRoleBtn = document.getElementById('load-role');
            const roleMsg = document.getElementById('role-message');

            loadRoleBtn?.addEventListener('click', async () => {
                if (currentUserRole !== 'admin') {
                    showNotification('Solo admin puede cargar roles', 'warning');
                    return;
                }
                const uidInput = document.getElementById('role-user-uid');
                const uid = uidInput && 'value' in uidInput ? (uidInput.value || '').trim() : '';
                if (!uid) return;
                try {
                    const userDoc = doc(db, 'users', uid);
                    const snap = await getDoc(userDoc);
                    if (snap.exists()) {
                        const data = snap.data();
                        const roleSelectEl = document.getElementById('role-select');
                        if (roleSelectEl && 'value' in roleSelectEl) {
                            roleSelectEl.value = data.role || 'viewer';
                        }
                        roleMsg.textContent = `Rol actual: ${data.role || 'viewer'}`;
                    } else {
                        roleMsg.textContent = 'Usuario no encontrado';
                    }
                } catch (e) {
                    roleMsg.textContent = 'Error al cargar rol';
                }
            });

            saveRoleBtn?.addEventListener('click', async () => {
                if (currentUserRole !== 'admin') {
                    showNotification('Solo admin puede guardar roles', 'warning');
                    return;
                }
                const uidInput2 = document.getElementById('role-user-uid');
                const roleSelectEl2 = document.getElementById('role-select');
                const uid = uidInput2 && 'value' in uidInput2 ? (uidInput2.value || '').trim() : '';
                const role = roleSelectEl2 && 'value' in roleSelectEl2 ? (roleSelectEl2.value || '') : '';
                if (!uid || !role) return;
                try {
                    const userDoc = doc(db, 'users', uid);
                    await setDoc(userDoc, { role }, { merge: true });
                    roleMsg.textContent = 'Rol actualizado';
                    showNotification('Rol actualizado', 'success');
                    if (uid === currentUser?.uid) {
                        applyRoleUI(role);
                    }
                } catch (e) {
                    roleMsg.textContent = 'Error al guardar rol';
                }
            });
        }

        // Simple notification functions - Global scope
        window.saveWhatsAppConfig = function() {
            console.log('🔧 Iniciando guardado de configuración WhatsApp...');
            
            const phone = document.getElementById('team-leader-phone');
            const startTime = document.getElementById('notification-start-time');
            const endTime = document.getElementById('notification-end-time');
            const deadlines = document.getElementById('notify-deadlines');
            const completions = document.getElementById('notify-completions');
            const issues = document.getElementById('notify-issues');
            
            console.log('📱 Elementos encontrados:', {
                phone: phone ? phone.value : 'NO ENCONTRADO',
                startTime: startTime ? startTime.value : 'NO ENCONTRADO',
                endTime: endTime ? endTime.value : 'NO ENCONTRADO',
                deadlines: deadlines ? deadlines.checked : 'NO ENCONTRADO',
                completions: completions ? completions.checked : 'NO ENCONTRADO',
                issues: issues ? issues.checked : 'NO ENCONTRADO'
            });
            
            if (!phone || !phone.value.trim()) {
                console.error('❌ No se encontró el campo de teléfono o está vacío');
                showNotification('Por favor ingresa el número del líder del equipo', 'warning');
                return;
            }
            
            const config = {
                phone: phone.value,
                startTime: startTime ? startTime.value : '08:00',
                endTime: endTime ? endTime.value : '18:00',
                deadlines: deadlines ? deadlines.checked : true,
                completions: completions ? completions.checked : true,
                issues: issues ? issues.checked : true
            };
            
            console.log('💾 Guardando configuración:', config);
            
            try {
                localStorage.setItem('whatsapp-config', JSON.stringify(config));
                console.log('✅ Configuración guardada en localStorage');
                
                // Verificar que se guardó
                const saved = localStorage.getItem('whatsapp-config');
                console.log('🔍 Configuración recuperada:', saved);
                
                showNotification('¡Configuración de WhatsApp guardada exitosamente!', 'success');
            } catch (error) {
                console.error('❌ Error al guardar en localStorage:', error);
                showNotification('Error al guardar la configuración: ' + error.message, 'error');
            }
        }
        
        window.saveBrowserConfig = function() {
            console.log('🔧 Iniciando guardado de configuración del navegador...');
            
            const frequency = document.getElementById('notification-frequency');
            const sound = document.getElementById('notification-sound');
            
            console.log('🔔 Elementos encontrados:', {
                frequency: frequency ? frequency.value : 'NO ENCONTRADO',
                sound: sound ? sound.value : 'NO ENCONTRADO'
            });
            
            const config = {
                frequency: frequency ? frequency.value : 'immediate',
                sound: sound ? sound.value : 'default'
            };
            
            console.log('💾 Guardando configuración del navegador:', config);
            
            try {
                localStorage.setItem('browser-config', JSON.stringify(config));
                console.log('✅ Configuración del navegador guardada en localStorage');
                
                // Verificar que se guardó
                const saved = localStorage.getItem('browser-config');
                console.log('🔍 Configuración del navegador recuperada:', saved);
                
                // Request notification permission
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        console.log('🔔 Permiso de notificación:', permission);
                        if (permission === 'granted') {
                            showNotification('¡Notificaciones del navegador activadas!', 'success');
                        } else {
                            showNotification('Permisos de notificación denegados', 'warning');
                        }
                    });
                } else {
                    console.log('❌ Navegador no soporta notificaciones');
                    showNotification('Tu navegador no soporta notificaciones', 'error');
                }
            } catch (error) {
                console.error('❌ Error al guardar configuración del navegador:', error);
                showNotification('Error al guardar la configuración: ' + error.message, 'error');
            }
        }
        
        window.testWhatsAppNotification = function() {
            const config = JSON.parse(localStorage.getItem('whatsapp-config') || '{}');
            if (!config.phone) {
                showNotification('Primero configura WhatsApp', 'warning');
                return;
            }
            
            const message = '🧪 Mensaje de prueba del Cerebro de Proyectos IA - ¡Las notificaciones funcionan correctamente!';
            const url = `https://wa.me/${config.phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showNotification('¡Mensaje de prueba enviado! Se abrió WhatsApp Web', 'success');
        }
        
        window.testBrowserNotification = function() {
            const config = JSON.parse(localStorage.getItem('browser-config') || '{}');
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🧪 Prueba de Notificación', {
                    body: '¡El sistema de notificaciones del Cerebro de Proyectos IA funciona correctamente!',
                    icon: '/favicon.ico'
                });
                showNotification('¡Notificación de prueba enviada!', 'success');
            } else if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification('🧪 Prueba de Notificación', {
                            body: '¡El sistema de notificaciones funciona correctamente!',
                            icon: '/favicon.ico'
                        });
                        showNotification('¡Notificación de prueba enviada!', 'success');
                    } else {
                        showNotification('Permisos de notificación denegados', 'warning');
                    }
                });
            } else {
                showNotification('Tu navegador no soporta notificaciones', 'error');
            }
        }
        
        // Function to load saved configuration
        window.loadNotificationConfig = function() {
            console.log('🔧 Cargando configuración guardada...');
            
            // Load WhatsApp config
            const whatsappConfig = JSON.parse(localStorage.getItem('whatsapp-config') || '{}');
            console.log('📱 Configuración WhatsApp encontrada:', whatsappConfig);
            
            if (whatsappConfig.phone) {
                const phoneField = document.getElementById('team-leader-phone');
                if (phoneField) {
                    phoneField.value = whatsappConfig.phone;
                    console.log('✅ Campo de teléfono llenado');
                }
            }
            
            if (whatsappConfig.startTime) {
                const startTimeField = document.getElementById('notification-start-time');
                if (startTimeField) {
                    startTimeField.value = whatsappConfig.startTime;
                    console.log('✅ Campo de hora inicio llenado');
                }
            }
            
            if (whatsappConfig.endTime) {
                const endTimeField = document.getElementById('notification-end-time');
                if (endTimeField) {
                    endTimeField.value = whatsappConfig.endTime;
                    console.log('✅ Campo de hora fin llenado');
                }
            }
            
            if (typeof whatsappConfig.deadlines !== 'undefined') {
                const deadlinesField = document.getElementById('notify-deadlines');
                if (deadlinesField) {
                    deadlinesField.checked = whatsappConfig.deadlines;
                    console.log('✅ Checkbox deadlines configurado');
                }
            }
            
            if (typeof whatsappConfig.completions !== 'undefined') {
                const completionsField = document.getElementById('notify-completions');
                if (completionsField) {
                    completionsField.checked = whatsappConfig.completions;
                    console.log('✅ Checkbox completions configurado');
                }
            }
            
            if (typeof whatsappConfig.issues !== 'undefined') {
                const issuesField = document.getElementById('notify-issues');
                if (issuesField) {
                    issuesField.checked = whatsappConfig.issues;
                    console.log('✅ Checkbox issues configurado');
                }
            }
            
            // Load browser config
            const browserConfig = JSON.parse(localStorage.getItem('browser-config') || '{}');
            console.log('🔔 Configuración del navegador encontrada:', browserConfig);
            
            if (browserConfig.frequency) {
                const frequencyField = document.getElementById('notification-frequency');
                if (frequencyField) {
                    frequencyField.value = browserConfig.frequency;
                    console.log('✅ Campo de frecuencia llenado');
                }
            }
            
            if (browserConfig.sound) {
                const soundField = document.getElementById('notification-sound');
                if (soundField) {
                    soundField.value = browserConfig.sound;
                    console.log('✅ Campo de sonido llenado');
                }
            }
            
            console.log('✅ Configuración cargada completamente');
        }
        
        // Function to show current configuration status
        window.showConfigStatus = function() {
            const whatsappConfig = JSON.parse(localStorage.getItem('whatsapp-config') || '{}');
            const browserConfig = JSON.parse(localStorage.getItem('browser-config') || '{}');
            
            console.log('📊 Estado actual de la configuración:');
            console.log('WhatsApp:', whatsappConfig);
            console.log('Navegador:', browserConfig);
            
            if (whatsappConfig.phone) {
                showNotification(`Configuración WhatsApp cargada: ${whatsappConfig.phone}`, 'info');
            }
            
            if (browserConfig.frequency) {
                showNotification(`Configuración del navegador cargada: ${browserConfig.frequency}`, 'info');
            }
        }
        
        // Verify functions are available
        console.log('🔍 Verificando funciones disponibles:', {
            saveWhatsAppConfig: typeof window.saveWhatsAppConfig,
            saveBrowserConfig: typeof window.saveBrowserConfig,
            testWhatsAppNotification: typeof window.testWhatsAppNotification,
            testBrowserNotification: typeof window.testBrowserNotification,
            showConfigStatus: typeof window.showConfigStatus,
            loadNotificationConfig: typeof window.loadNotificationConfig
        });

        // Direct function for onclick
        function handleTeamSetupClickDirect() {
            console.log('🔧 Botón clickeado directamente via onclick');
            
            // Hide the initial setup card (more specific selector)
            const initialCard = document.querySelector('#whatsapp-tab .glass-card:first-child');
            if (initialCard) {
                initialCard.classList.add('hidden');
                console.log('✅ Card inicial ocultada (direct)');
                console.log('🔍 Card inicial classes:', initialCard.className);
            } else {
                console.error('❌ No se encontró card inicial (direct)');
                // Try alternative selectors
                const altCard = document.querySelector('.glass-card');
                if (altCard) {
                    altCard.classList.add('hidden');
                    console.log('✅ Card alternativa ocultada (direct)');
                }
            }
            
            // Show the method selection
            const methodSelection = document.getElementById('custom-method-selection');
            if (methodSelection) {
                methodSelection.classList.remove('hidden');
                methodSelection.style.display = 'block';
                methodSelection.style.visibility = 'visible';
                console.log('✅ Selección de métodos mostrada (direct)');
                console.log('🔍 Method selection classes:', methodSelection.className);
            } else {
                console.error('❌ No se encontró custom-method-selection (direct)');
            }
        }

        // --- Simple Notification Setup ---
        function setupSimpleNotifications() {
            console.log('🔧 Inicializando sistema de notificaciones simples...');
            
            // Try multiple approaches to find and setup the button
            let teamSetupBtn = document.getElementById('start-team-setup');
            
            if (!teamSetupBtn) {
                console.error('❌ Botón start-team-setup no encontrado');
                console.log('🔍 Buscando elementos con clase glass-card:', document.querySelectorAll('.glass-card'));
                console.log('🔍 Todos los botones:', document.querySelectorAll('button'));
                
                // Try to find by text content
                const buttons = document.querySelectorAll('button');
                for (let btn of buttons) {
                    if (btn.textContent.includes('Configurar Notificaciones para el Equipo')) {
                        teamSetupBtn = btn;
                        console.log('✅ Botón encontrado por texto:', teamSetupBtn);
                        break;
                    }
                }
                
                if (!teamSetupBtn) {
                    console.error('❌ Botón no encontrado por ningún método');
                    return;
                }
            }
            
            console.log('✅ Botón start-team-setup encontrado:', teamSetupBtn);
            
            // Remove any existing event listeners
            const newBtn = teamSetupBtn.cloneNode(true);
            teamSetupBtn.parentNode.replaceChild(newBtn, teamSetupBtn);
            teamSetupBtn = newBtn;
            
            // Add the event listener
            teamSetupBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('✅ Botón de configurar equipo clickeado (addEventListener)', e);
                handleTeamSetupClick();
            });
            
            // Also add onclick as backup
            teamSetupBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('✅ Botón de configurar equipo clickeado (onclick)', e);
                handleTeamSetupClick();
                return false;
            };
            
            // Function to handle the click
            function handleTeamSetupClick() {
                console.log('🔧 Manejando click del botón de equipo...');
                
                // Hide the initial setup card (more specific selector)
                const initialCard = document.querySelector('#whatsapp-tab .glass-card:first-child');
                if (initialCard) {
                    initialCard.classList.add('hidden');
                    console.log('✅ Card inicial ocultada');
                    console.log('🔍 Card inicial classes:', initialCard.className);
                } else {
                    console.error('❌ No se encontró card inicial');
                    // Try alternative selectors
                    const altCard = document.querySelector('.glass-card');
                    if (altCard) {
                        altCard.classList.add('hidden');
                        console.log('✅ Card alternativa ocultada');
                    }
                }
                
                // Show the method selection
                const methodSelection = document.getElementById('custom-method-selection');
                if (methodSelection) {
                    methodSelection.classList.remove('hidden');
                    console.log('✅ Selección de métodos mostrada');
                    console.log('🔍 Method selection classes:', methodSelection.className);
                    console.log('🔍 Method selection style:', methodSelection.style.display);
                } else {
                    console.error('❌ No se encontró custom-method-selection');
                }
                
                // Force show the method selection
                if (methodSelection) {
                    methodSelection.style.display = 'block';
                    methodSelection.style.visibility = 'visible';
                    console.log('🔧 Forzando visibilidad del método de selección');
                }
                
                // Initialize with default selection
                const defaultRadio = document.querySelector('input[name="notification-method"][checked]');
                if (defaultRadio) {
                    defaultRadio.checked = true;
                    const method = defaultRadio.value;
                    hideAllConfigSections();
                    
                    if (method === 'whatsapp-web-simple') {
                        showWhatsAppWebSimpleConfig();
                    } else if (method === 'browser-notifications') {
                        showBrowserNotificationsConfig();
                    }
                }
            }

            // Handle method selection
            document.querySelectorAll('input[name="notification-method"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const method = e.target.value;
                    hideAllConfigSections();
                    
                    if (method === 'whatsapp-web-simple') {
                        showWhatsAppWebSimpleConfig();
                    } else if (method === 'browser-notifications') {
                        showBrowserNotificationsConfig();
                    }
                });
            });

            // Handle config save buttons
            document.addEventListener('click', (e) => {
                if (e.target.id === 'save-whatsapp-web-config') {
                    saveWhatsAppWebSimpleConfig();
                } else if (e.target.id === 'save-browser-config') {
                    saveBrowserNotificationsConfig();
                }
            });

            // Handle WhatsApp simple config save
            document.addEventListener('click', (e) => {
                if (e.target.id === 'save-whatsapp-config') {
                    saveSimpleWhatsAppConfig();
                } else if (e.target.id === 'save-email-config') {
                    saveSimpleEmailConfig();
                }
            });
            
            // Handle test notification
            document.getElementById('send-test-notification').addEventListener('click', sendTestNotification);
            
            // Handle config edit
            document.getElementById('edit-config').addEventListener('click', editNotificationConfig);
            
            // Handle view projects
            document.getElementById('view-projects').addEventListener('click', () => {
                // Switch to projects tab
                document.querySelector('[data-tab="projects"]').click();
            });

            // Handle team member edit modal
            document.getElementById('close-edit-modal').addEventListener('click', () => {
                document.getElementById('edit-member-modal').classList.add('hidden');
            });

            document.getElementById('cancel-edit').addEventListener('click', () => {
                document.getElementById('edit-member-modal').classList.add('hidden');
            });

            document.getElementById('edit-member-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = document.getElementById('edit-member-name').value.trim();
                const newPhone = document.getElementById('edit-member-phone').value.trim();
                
                if (newName && newPhone && currentEditingIndex >= 0) {
                    whatsappManager.teamMembers[currentEditingIndex].name = newName;
                    whatsappManager.teamMembers[currentEditingIndex].phone = newPhone;
                    updateTeamMembersDisplay();
                    document.getElementById('edit-member-modal').classList.add('hidden');
                    showNotification('Miembro del equipo actualizado exitosamente', 'success');
                }
            });

            // Close modal when clicking outside
            document.getElementById('edit-member-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-member-modal') {
                    document.getElementById('edit-member-modal').classList.add('hidden');
                }
            });

            // Handle add team member modal
            document.getElementById('close-add-modal').addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.add('hidden');
            });

            document.getElementById('cancel-add').addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.add('hidden');
            });

            document.getElementById('add-member-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('add-member-name').value.trim();
                const phone = document.getElementById('add-member-phone').value.trim();
                const notifications = document.getElementById('add-member-notifications').checked;
                
                if (name && phone) {
                    // Add member with notification preference
                    whatsappManager.teamMembers.push({
                        name: name,
                        phone: phone,
                        notifications: notifications
                    });
                    updateTeamMembersDisplay();
                    document.getElementById('add-member-modal').classList.add('hidden');
                    showNotification('Miembro agregado exitosamente', 'success');
                }
            });

            // Close add modal when clicking outside
            document.getElementById('add-member-modal').addEventListener('click', (e) => {
                if (e.target.id === 'add-member-modal') {
                    document.getElementById('add-member-modal').classList.add('hidden');
                }
            });
        }

        function hideAllConfigSections() {
            const sections = ['whatsapp-web-simple-config', 'browser-notifications-config', 'test-config', 'config-complete'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
        }

        function showWhatsAppWebSimpleConfig() {
            try {
                const element = document.getElementById('whatsapp-web-simple-config');
                if (element) {
                    element.classList.remove('hidden');
                    updateStepIndicator(2);
                } else {
                    console.log('WhatsApp Web config element not found');
                }
            } catch (error) {
                console.log('Error showing WhatsApp Web config:', error);
            }
        }


        function showBrowserNotificationsConfig() {
            try {
                const element = document.getElementById('browser-notifications-config');
                if (element) {
                    element.classList.remove('hidden');
                    updateStepIndicator(2);
                } else {
                    console.log('Browser notifications config element not found');
                }
            } catch (error) {
                console.log('Error showing browser notifications config:', error);
            }
        }

        function showWhatsAppSimpleConfig() {
            const element = document.getElementById('whatsapp-simple-config');
            if (element) element.classList.remove('hidden');
            updateStepIndicator(2);
        }

        function showEmailSimpleConfig() {
            const element = document.getElementById('email-simple-config');
            if (element) element.classList.remove('hidden');
            updateStepIndicator(2);
        }

        function showTestConfig() {
            hideAllConfigSections();
            const element = document.getElementById('test-config');
            if (element) element.classList.remove('hidden');
            updateStepIndicator(3);
        }

        function showConfigComplete() {
            hideAllConfigSections();
            const element = document.getElementById('config-complete');
            if (element) element.classList.remove('hidden');
            updateStepIndicator(3, true);
        }

        function updateStepIndicator(currentStep, isComplete = false) {
            try {
                const steps = document.querySelectorAll('.flex.items-center.space-x-4 > div');
                if (steps.length === 0) {
                    console.log('Step indicator not found, skipping update');
                    return;
                }
                
                steps.forEach((step, index) => {
                    const circle = step.querySelector('div');
                    const text = step.querySelector('span');
                    
                    // Skip this iteration if elements don't exist
                    if (!circle || !text) {
                        console.log(`Step ${index + 1} elements not found, skipping`);
                        return; // This exits only this iteration, not the entire function
                    }
                    
                    const isCurrentStep = index + 1 === currentStep;
                    
                    try {
                        if (isComplete) {
                            circle.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-semibold';
                            circle.innerHTML = '<i class="fas fa-check text-xs"></i>';
                            text.className = 'ml-2 text-sm font-medium text-green-600';
                        } else if (isCurrentStep) {
                            circle.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-semibold';
                            text.className = 'ml-2 text-sm font-medium text-green-600';
                        } else if (index + 1 < currentStep) {
                            circle.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-semibold';
                            text.className = 'ml-2 text-sm font-medium text-green-600';
                        } else {
                            circle.className = 'w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold';
                            text.className = 'ml-2 text-sm font-medium text-gray-600';
                        }
                    } catch (stepError) {
                        console.log(`Error updating step ${index + 1}:`, stepError);
                    }
                });
            } catch (error) {
                console.log('Error updating step indicator:', error);
            }
        }

        function saveSimpleWhatsAppConfig() {
            const phoneNumber = document.getElementById('simple-whatsapp-number').value;
            const startTime = document.getElementById('notification-start-time').value;
            const endTime = document.getElementById('notification-end-time').value;
            const earlyReminder = document.getElementById('early-reminder').checked;
            const urgentReminder = document.getElementById('urgent-reminder').checked;
            const overdueReminder = document.getElementById('overdue-reminder').checked;

            if (!phoneNumber) {
                showNotification('Por favor ingresa tu número de teléfono', 'warning');
                return;
            }

            // Save configuration (in a real app, this would be saved to localStorage or server)
            const config = {
                method: 'whatsapp-simple',
                phoneNumber,
                startTime,
                endTime,
                earlyReminder,
                urgentReminder,
                overdueReminder
            };

            localStorage.setItem('notificationConfig', JSON.stringify(config));
            showNotification('Configuración de WhatsApp guardada exitosamente', 'success');
            
            setTimeout(() => {
                showTestConfig();
            }, 1000);
        }

        function saveSimpleEmailConfig() {
            const email = document.getElementById('simple-email-address').value;
            const password = document.getElementById('simple-email-password').value;
            const destination = document.getElementById('simple-email-destination').value;

            if (!email || !password || !destination) {
                showNotification('Por favor completa todos los campos', 'warning');
                return;
            }

            // Save configuration
            const config = {
                method: 'email-simple',
                email,
                password,
                destination
            };

            localStorage.setItem('notificationConfig', JSON.stringify(config));
            showNotification('Configuración de Email guardada exitosamente', 'success');
            
            setTimeout(() => {
                showTestConfig();
            }, 1000);
        }

        function sendTestNotification() {
            const config = JSON.parse(localStorage.getItem('notificationConfig') || '{}');
            
            if (!config.method) {
                showNotification('Primero configura las notificaciones', 'warning');
                return;
            }

            showNotification('Enviando mensaje de prueba...', 'info');
            
            // Create a test project for the notification
            const testProject = {
                poNumber: 'TEST-001',
                description: 'Proyecto de prueba - Configuración de notificaciones',
                dueDate: { toDate: () => new Date(Date.now() + 24 * 60 * 60 * 1000) } // Tomorrow
            };
            
            // Send actual test notification based on configured method
            if (config.method === 'whatsapp-web-simple') {
                sendWhatsAppWebTestNotification(config, testProject);
            } else if (config.method === 'browser-notifications') {
                sendBrowserTestNotification(testProject);
            } else {
                // Fallback to simulation
                setTimeout(() => {
                    showNotification('¡Mensaje de prueba enviado! Revisa tu dispositivo', 'success');
                    setTimeout(() => {
                        showConfigComplete();
                    }, 1500);
                }, 2000);
            }
        }
        
        function sendWhatsAppWebTestNotification(config, testProject) {
            const message = `🧪 *MENSAJE DE PRUEBA*\n\nPO #${testProject.poNumber}\n${testProject.description}\n\n¡Configuración de notificaciones exitosa!\n_Taller de Torno CNC_`;
            
            if (config.teamLeader) {
                const phone = config.teamLeader.replace(/\D/g, '');
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
                
                // Open WhatsApp Web with test message
                window.open(whatsappUrl, '_blank');
                
                showNotification('¡Mensaje de prueba enviado! Se abrió WhatsApp Web con el mensaje', 'success');
                setTimeout(() => {
                    showConfigComplete();
                }, 1500);
            } else {
                showNotification('Error: No se encontró el número del líder del equipo', 'error');
            }
        }
        
        function sendBrowserTestNotification(testProject) {
            if (Notification.permission === 'granted') {
                const message = `🧪 MENSAJE DE PRUEBA\n\nPO #${testProject.poNumber}\n${testProject.description}\n\n¡Configuración de notificaciones exitosa!`;
                
                new Notification('Taller de Torno CNC - Prueba', {
                    body: message,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiMxMEE5ODUiLz4KPHBhdGggZD0iTTQ0IDI0SDIwQzE4Ljg5NTQgMjQgMTggMjQuODk1NCAxOCAyNlY0MkMxOCA0My4xMDQ2IDE4Ljg5NTQgNDQgMjAgNDRINDRDNDUuMTA0NiA0NCA0NiA0My4xMDQ2IDQ2IDQyVjI2QzQ2IDI0Ljg5NTQgNDUuMTA0NiAyNCA0NCAyNFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yOCAzMkgzNlYzNkgyOFYzMloiIGZpbGw9IiMxMEE5ODUiLz4KPC9zdmc+'
                });
                
                showNotification('¡Mensaje de prueba enviado! Revisa la notificación del navegador', 'success');
                setTimeout(() => {
                    showConfigComplete();
                }, 1500);
            } else {
                showNotification('Error: Permisos de notificación no otorgados', 'error');
            }
        }

        function editNotificationConfig() {
            hideAllConfigSections();
            updateStepIndicator(1);
            
            // Show team setup again
            document.querySelector('.glass-card').classList.remove('hidden');
            
            // Reset radio buttons
            document.querySelectorAll('input[name="notification-method"]').forEach(radio => {
                radio.checked = false;
            });
        }


        function saveWhatsAppWebSimpleConfig() {
            const teamLeader = document.getElementById('team-leader-whatsapp').value;
            const teamGroup = document.getElementById('team-whatsapp-group').value;

            if (!teamLeader) {
                showNotification('Por favor ingresa el número del líder del equipo', 'warning');
                return;
            }

            const config = {
                method: 'whatsapp-web-simple',
                teamLeader,
                teamGroup,
                type: 'team'
            };

            localStorage.setItem('notificationConfig', JSON.stringify(config));
            showNotification('¡Configuración de WhatsApp Web guardada!', 'success');
            
            setTimeout(() => {
                showTestConfig();
            }, 1000);
        }


        function saveBrowserNotificationsConfig() {
            const teamMembers = document.getElementById('team-members').value;

            // Request notification permission
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        completeBrowserConfig(teamMembers);
                    } else {
                        showNotification('Se necesitan permisos de notificación para esta función', 'warning');
                    }
                });
            } else if (Notification.permission === 'granted') {
                completeBrowserConfig(teamMembers);
            } else {
                showNotification('Las notificaciones del navegador están bloqueadas. Por favor habilítalas en la configuración del navegador.', 'warning');
            }
        }

        function completeBrowserConfig(teamMembers) {
            const config = {
                method: 'browser-notifications',
                teamMembers: teamMembers ? teamMembers.split(',').map(member => member.trim()) : [],
                type: 'team',
                permission: 'granted'
            };

            localStorage.setItem('notificationConfig', JSON.stringify(config));
            showNotification('¡Notificaciones del navegador activadas!', 'success');
            
            setTimeout(() => {
                showTestConfig();
            }, 1000);
        }

        // --- Purchasing Event Listeners ---
        function setupPurchasingEvents() {
            // Create PO button from recommendations
            document.addEventListener('click', (e) => {
                if (e.target.closest('.bg-blue-600') && e.target.textContent.includes('Crear PO')) {
                    const recommendationCard = e.target.closest('.bg-white');
                    const materialName = recommendationCard.querySelector('h4').textContent;
                    createPurchaseOrderFromRecommendation(materialName);
                }
            });

            // Add material buttons
            document.addEventListener('click', (e) => {
                if (e.target.textContent.includes('Agregar Material') || 
                    e.target.textContent.includes('Agregar Herramienta') ||
                    e.target.textContent.includes('Agregar Consumible')) {
                    showAddMaterialModal(e.target.textContent);
                }
            });

            // Restrict actions to allowed roles only
            const isAllowed = (currentUserRole === 'admin' || currentUserRole === 'compras');

            // Create new purchase order
            const createPOBtn = document.getElementById('create-purchase-order');
            if (createPOBtn) {
                createPOBtn.addEventListener('click', (ev) => {
                    if (!isAllowed) {
                        showNotification('Acceso denegado: no puedes crear órdenes', 'warning');
                        return;
                    }
                    ev.preventDefault();
                    createNewPurchaseOrder();
                });
            }

            // Add supplier
            const saveSupplierBtn = document.getElementById('save-supplier');
            if (saveSupplierBtn) {
                saveSupplierBtn.addEventListener('click', (ev) => {
                    if (!isAllowed) {
                        showNotification('Acceso denegado: no puedes agregar proveedores', 'warning');
                        return;
                    }
                    ev.preventDefault();
                    addNewSupplier();
                });
            }
        }

        function createPurchaseOrderFromRecommendation(materialName) {
            showNotification(`Creando orden de compra para: ${materialName}`, 'success');
            
            // In a real implementation, this would open a modal or redirect to create PO
            // For now, we'll just show a notification and simulate the action
            setTimeout(() => {
                showNotification(`Orden de compra creada exitosamente para ${materialName}`, 'success');
            }, 1000);
        }

        function showAddMaterialModal(type) {
            const materialType = type.replace('Agregar ', '').toLowerCase();
            showNotification(`Abriendo formulario para agregar ${materialType}`, 'info');
            
            // In a real implementation, this would open a modal
            // For now, we'll just show a notification
        }

        async function createNewPurchaseOrder() {
            const supplier = document.getElementById('po-supplier')?.value || '';
            const material = document.getElementById('po-item')?.value || '';
            const quantity = parseFloat(document.getElementById('po-quantity')?.value || '0');
            const unit = document.getElementById('po-unit')?.value || 'piezas';
            const project = document.getElementById('po-project')?.value || '';
            const notes = document.getElementById('po-notes')?.value || '';

            if (!supplier || !material || !quantity) {
                showNotification('Por favor completa todos los campos obligatorios', 'warning');
                return;
            }

            try {
                const poCol = collection(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders');
                await addDoc(poCol, {
                    supplier,
                    item: material,
                    quantity,
                    unit,
                    project,
                    notes,
                    status: 'pendiente',
                    createdBy: currentUser?.uid || null,
                    createdAt: Timestamp.now()
                });
                showNotification(`Orden de compra creada: ${quantity} ${unit} de ${material} para ${supplier}`, 'success');
            } catch (e) {
                console.error(e);
                showNotification('No se pudo crear la orden de compra', 'error');
            }
        }

        async function addNewSupplier() {
            const name = document.getElementById('supplier-name')?.value?.trim();
            const specialty = document.getElementById('supplier-specialty')?.value;
            const contact = document.getElementById('supplier-contact')?.value?.trim();
            const phone = document.getElementById('supplier-phone')?.value?.trim();
            const email = document.getElementById('supplier-email')?.value?.trim();

            if (!name || !specialty) {
                showNotification('Por favor completa nombre y especialidad', 'warning');
                return;
            }

            try {
                const supCol = collection(db, 'artifacts', appId, 'secure', 'purchasing', 'suppliers');
                await addDoc(supCol, {
                    name,
                    specialty,
                    contact,
                    phone,
                    email,
                    createdBy: currentUser?.uid || null,
                    createdAt: Timestamp.now()
                });
                showNotification(`Proveedor "${name}" agregado`, 'success');
            } catch (e) {
                console.error(e);
                showNotification('No se pudo guardar el proveedor', 'error');
            }
        }

        function updateCategoriesList() {
            const container = document.getElementById('categories-list');
            const categories = settingsManager.getSetting('projects.categories') || [];
            
            container.innerHTML = categories.map(category => `
                <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                    <span class="text-sm text-slate-700">${category}</span>
                    <button class="text-red-500 hover:text-red-700" onclick="removeCategory('${category}')">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCategory(category) {
            let categories = settingsManager.getSetting('projects.categories') || [];
            categories = categories.filter(c => c !== category);
            settingsManager.updateSetting('projects.categories', categories);
            updateCategoriesList();
        }

        // --- Main Initialization ---
        // Tab Navigation System
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Show target tab content
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                    }
                    
            // Initialize specific tab functionality
            initializeTabContent(targetTab);
            // Enforce role on purchasing tab navigation
            if (targetTab === 'purchasing' && !(currentUserRole === 'admin' || currentUserRole === 'compras')) {
                showNotification('Acceso denegado: sección confidencial de Compras', 'warning');
                document.querySelector('[data-tab="dashboard"]').click();
                return;
            }
                });
            });
            
            // Initialize default tab (dashboard)
            const defaultTab = document.querySelector('.nav-tab.active');
            if (defaultTab) {
                const defaultTabName = defaultTab.getAttribute('data-tab');
                const defaultContent = document.getElementById(`${defaultTabName}-tab`);
                if (defaultContent) {
                    defaultContent.style.display = 'block';
                }
                initializeTabContent(defaultTabName);
            }
        }
        
        function updateAnalyticsCharts() {
            // Initialize analytics charts if they exist
            console.log('📊 Updating analytics charts...');
            // This function will be called when analytics tab is activated
            // Charts will be initialized if the elements exist
        }

        function updateAIInsights() {
            // Initialize AI insights if they exist
            console.log('🧠 Updating AI insights...');
            // This function will be called when AI insights tab is activated
            // AI insights will be initialized if the elements exist
        }

        function initializeTabContent(tabName) {
            switch(tabName) {
                case 'dashboard':
                    if (typeof updateDashboardMetrics === 'function') {
                        updateDashboardMetrics(projects || []);
                    }
                    break;
                case 'projects':
                    if (typeof updateProjectList === 'function') {
                        updateProjectList();
                    }
                    break;
                case 'analytics':
                    updateAnalyticsCharts();
                    break;
                case 'team':
                    // Initialize team management
                    break;
                case 'ai-insights':
                    if (typeof updateAIInsights === 'function') {
                        updateAIInsights();
                    }
                    break;
                case 'knowledge':
                    if (typeof setupKnowledgeUpload === 'function') {
                        setupKnowledgeUpload();
                    }
                    break;
                case 'whatsapp':
                    if (typeof setupWhatsApp === 'function') {
                        setupWhatsApp();
                    }
                    // Load saved notification configuration
                    setTimeout(() => {
                        loadNotificationConfig();
                    }, 100);
                    break;
                case 'purchasing':
                    if (!(currentUserRole === 'admin' || currentUserRole === 'compras')) {
                        showNotification('Acceso denegado: sección confidencial de Compras', 'warning');
                        document.querySelector('[data-tab="dashboard"]').click();
                        return;
                    }
                    if (typeof initializePurchasingSystem === 'function') {
                        initializePurchasingSystem();
                    }
                    break;
                case 'settings':
                    if (typeof setupSettings === 'function') {
                        setupSettings();
                    }
                    break;
            }
        }

        async function main() {
            console.log('🚀 Iniciando aplicación principal...');
            
            // Initialize tab navigation first
            setupTabNavigation();
            
            // Initialize knowledge upload system
            setupKnowledgeUpload();
            
            // Initialize multi-channel notification system
            setupMultiChannelNotifications();
            
            // Initialize WhatsApp system
            setupWhatsApp();
            
            // Initialize settings system
            setupSettings();
            
            // Initialize purchasing system
            setupPurchasingEvents();
            
            // Initialize simple notifications with a small delay to ensure DOM is ready
            setTimeout(() => {
                setupSimpleNotifications();
            }, 100);
            
            // Also add event delegation as backup
            setTimeout(() => {
                document.addEventListener('click', function(e) {
                    if (e.target && e.target.id === 'start-team-setup') {
                        console.log('✅ Botón clickeado via event delegation');
                        e.preventDefault();
                        e.stopPropagation();
                        handleTeamSetupClick();
                    }
                });
            }, 200);
            
            // Start reminder scheduler
            startReminderScheduler();
            
             if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing!");
                loadingSpinner.classList.remove('show');
                projectList.innerHTML = `<p class="text-red-500 text-center">No se pudo conectar a la base de datos. Por favor verifica la configuración.</p>`;
                return;
            }
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    projectsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
                    const q = query(projectsCollection, orderBy("dueDate", "asc"));
                    onSnapshot(q, (snapshot) => {
                        const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        updateProjectList(projects);
                        
                        // AI Learning from existing projects
                        projects.forEach(project => {
                            aiSystem.analyzeProject(project);
                        });
                    });
                }
            });

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                 console.error("Authentication failed:", error);
                 loadingSpinner.classList.remove('show');
                projectList.innerHTML = `<p class="text-red-500 text-center">Error de autenticación. No se pudieron cargar los proyectos.</p>`;
            }
        }

        // Register Service Worker for PWA
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('✅ Service Worker registrado correctamente:', registration.scope);
                            
                            // Request notification permission
                            if ('Notification' in window && Notification.permission === 'default') {
                                Notification.requestPermission().then(permission => {
                                    console.log('🔔 Permisos de notificación:', permission);
                                });
                            }
                        })
                        .catch(error => {
                            console.log('❌ Error al registrar Service Worker:', error);
                        });
                });
            }
        }

        // Install prompt for PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after a delay
            setTimeout(showInstallPrompt, 3000);
        });

        function showInstallPrompt() {
            // Create install button
            const installBtn = document.createElement('button');
            installBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Instalar App Móvil';
            installBtn.className = 'fixed bottom-4 right-4 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-colors text-sm font-medium';
            installBtn.onclick = installApp;
            
            document.body.appendChild(installBtn);
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
                if (installBtn.parentNode) {
                    installBtn.remove();
                }
            }, 15000);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('✅ Usuario aceptó instalar la app');
                        showNotification('¡App instalada correctamente! Ahora puedes acceder desde tu pantalla de inicio.', 'success');
                    } else {
                        console.log('❌ Usuario rechazó instalar la app');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Register service worker when app loads (disabled for file:// protocol)
        if (window.location.protocol !== 'file:') {
            registerServiceWorker();
        }

        // Ensure DOM is fully loaded before initializing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', main);
        } else {
        main();
        }
        */
    </script>

    <!-- Add Team Member Modal -->
    <div id="add-member-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-800">Agregar Nuevo Miembro</h3>
                <button id="close-add-modal" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-member-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Nombre completo</label>
                    <input type="text" id="add-member-name" class="modern-input w-full" placeholder="Ej: Juan Pérez" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                    <input type="tel" id="add-member-phone" class="modern-input w-full" placeholder="Ej: +52 555 123 4567" required>
                    <p class="text-xs text-slate-500 mt-1">Incluye el código de país (+52 para México)</p>
                </div>
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="add-member-notifications" class="mr-2 rounded" checked>
                        <span class="text-sm text-slate-700">Activar notificaciones para este miembro</span>
                    </label>
                </div>
                <div class="flex space-x-4">
                    <button type="button" id="cancel-add" class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>Agregar Miembro
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Member Edit Modal -->
    <div id="edit-member-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-800">Editar Miembro del Equipo</h3>
                <button id="close-edit-modal" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-member-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Nombre</label>
                    <input type="text" id="edit-member-name" class="modern-input w-full" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                    <input type="tel" id="edit-member-phone" class="modern-input w-full" required>
                </div>
                <div class="flex space-x-4">
                    <button type="button" id="cancel-edit" class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cerebro de Proyectos IA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10a985">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CNC Reminders">
    <meta name="description" content="Sistema de recordatorios y notificaciones para proyectos de taller CNC">
    <meta name="keywords" content="taller, cnc, recordatorios, proyectos, notificaciones">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMxMEE5ODUiLz4KPHBhdGggZD0iTTQ4IDY0SDQ0QzQwLjY4NjMgNjQgMzggNjYuNjg2MyAzOCA3MFY4NkMzOCA4OS4zMTM3IDQwLjY4NjMgOTIgNDQgOTJINDRDNDcuMzEzNyA5MiA1MCA4OS4zMTM3IDUwIDg2VjcwQzUwIDY2LjY4NjMgNDcuMzEzNyA2NCA0NCA2NFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik04NCA2NEg4MEM3Ni42ODYzIDY0IDc0IDY2LjY4NjMgNzQgNzBWODZDNzQgODkuMzEzNyA3Ni42ODYzIDkyIDgwIDkySDEwNEMxMDcuMzE0IDkyIDExMCA4OS4zMTM3IDExMCA4NlY3MEMxMTAgNjYuNjg2MyAxMDcuMzE0IDY0IDEwNCA2NEg4NFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xMjAgNjRIMTE2QzExMi42ODYgNjQgMTEwIDY2LjY4NjMgMTEwIDcwVjg2QzExMCA4OS4zMTM3IDExMi42ODYgOTIgMTE2IDkySDE1MkMxNTUuMzE0IDkyIDE1OCA4OS4zMTM3IDE1OCA4NlY3MEMxNTggNjYuNjg2MyAxNTUuMzE0IDY0IDE1MiA2NEgxMjBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNNDggMTEwSDQ0QzQwLjY4NjMgMTEwIDM4IDExMi42ODYgMzggMTE2VjEzMkMzOCAxMzUuMzE0IDQwLjY4NjMgMTM4IDQ0IDEzOEg0NEM0Ny4zMTM3IDEzOCA1MCAxMzUuMzE0IDUwIDEzMlYxMTZDNTAgMTEyLjY4NiA0Ny4zMTM3IDExMCA0NCAxMTBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNODQgMTEwSDgwQzc2LjY4NjMgMTEwIDc0IDExMi42ODYgNzQgMTE2VjEzMkM3NCAxMzUuMzE0IDc2LjY4NjMgMTM4IDgwIDEzOEgxMDRDMTA3LjMxNCAxMzggMTEwIDEzNS4zMTQgMTEwIDEzMlYxMTZDMTEwIDExMi42ODYgMTA3LjMxNCAxMTAgMTA0IDExMEg4NFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xMjAgMTEwSDExNkMxMTIuNjg2IDExMCAxMTAgMTEyLjY4NiAxMTAgMTE2VjEzMkMxMTAgMTM1LjMxNCAxMTIuNjg2IDEzOCAxMTYgMTM4SDE1MkMxNTUuMzE0IDEzOCAxNTggMTM1LjMxNCAxNTggMTMyVjExNkMxNTggMTEyLjY4NiAxNTUuMzE0IDExMCAxNTIgMTEwSDEyMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xNjggNjRIMTY0QzE2MC42ODYgNjQgMTU4IDY2LjY4NjMgMTU4IDcwVjg2QzE1OCA4OS4zMTM3IDE2MC42ODYgOTIgMTY0IDkySDE2NEMxNjcuMzE0IDkyIDE3MCA4OS4zMTM3IDE3MCA4NlY3MEMxNzAgNjYuNjg2MyAxNjcuMzE0IDY0IDE2NCA2NEgxNjhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTY4IDExMEgxNjRDMTYwLjY4NiAxMTAgMTU4IDExMi42ODYgMTU4IDExNlYxMzJDMTU4IDEzNS4zMTQgMTYwLjY4NiAxMzggMTY0IDEzOEgxNjRDMTY3LjMxNCAxMzggMTcwIDEzNS4zMTQgMTcwIDEzMlYxMTZDMTcwIDExMi42ODYgMTY3LjMxNCAxMTAgMTY0IDExMEgxNjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiMxMEE5ODUiLz4KPHBhdGggZD0iTTEyIDEySDIwVjIwSDEyVjEyWiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #1e293b;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .hidden {
            display: none !important;
        }
        
        .glass-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border-radius: 16px;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .glass-card {
                margin: 0.5rem;
                padding: 1rem;
                border-radius: 1rem;
            }
            
            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            .modern-button {
                padding: 0.75rem 1.5rem;
                font-size: 0.875rem;
            }
            
            .notification-card {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            .project-card {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            /* Mobile-specific touch targets */
            button, .nav-tab, .clickable {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Better mobile scrolling */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Mobile-friendly forms */
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.75rem;
            }
            
            /* Mobile navigation improvements */
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .nav-tabs::-webkit-scrollbar {
                display: none;
            }
        }

        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .glass-card {
                margin: 0.5rem;
            }
        }

        /* Force light theme - no dark mode */
        @media (prefers-color-scheme: dark) {
            body {
                background: #ffffff !important;
                color: #1e293b !important;
            }
            
            .glass-card {
                background: #ffffff !important;
                border: 1px solid #e2e8f0 !important;
                color: #1e293b !important;
            }
            
            .modern-input {
                background: #ffffff !important;
                color: #1e293b !important;
                border: 1px solid #d1d5db !important;
            }
            
            h1, h2, h3, h4, h5, h6 {
                color: #1e293b !important;
            }
            
            p, span, div {
                color: #374151 !important;
            }
        }
        
        .due-soon {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        .due-today {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }
        
        .overdue {
            border-left: 4px solid #dc2626;
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        #loading-spinner {
            display: none;
        }
        
        #loading-spinner.show {
            display: flex;
        }
        
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .parsed-field {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .parsed-field:focus {
            border-color: #3b82f6;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .modern-input {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 20px;
            font-size: 15px;
            font-weight: 400;
            color: #1e293b;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .modern-input:focus {
            outline: none;
            border-color: #10a985;
            box-shadow: 0 0 0 3px rgba(16, 169, 133, 0.1);
            transform: translateY(-1px);
            background: #ffffff;
        }
        
        .modern-input::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }
        
        .modern-input:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        /* File upload area styling */
        .border-dashed {
            background: #ffffff !important;
            border-color: #d1d5db !important;
            color: #374151 !important;
        }
        
        .border-dashed:hover {
            border-color: #10a985 !important;
            background: #f8fafc !important;
        }
        
        .border-dashed i {
            color: #6b7280 !important;
        }
        
        .border-dashed p {
            color: #6b7280 !important;
        }
        
        /* Text areas and content areas */
        textarea {
            background: #ffffff !important;
            color: #1e293b !important;
            border: 1px solid #d1d5db !important;
        }
        
        /* Headers and titles */
        h1, h2, h3, h4, h5, h6 {
            color: #1e293b !important;
        }
        
        /* Text content */
        p, span, div {
            color: #374151 !important;
        }
        
        /* Icons - More visible colors */
        .fas, .far, .fab {
            color: #10a985 !important;  /* Green for primary icons */
        }
        
        /* Icon categories with different colors */
        .fas.fa-home, .fas.fa-dashboard, .fas.fa-tachometer-alt {
            color: #10a985 !important;  /* Green for dashboard icons */
        }
        
        .fas.fa-project-diagram, .fas.fa-tasks, .fas.fa-clipboard-list {
            color: #3b82f6 !important;  /* Blue for project icons */
        }
        
        .fas.fa-chart-line, .fas.fa-analytics, .fas.fa-chart-bar {
            color: #8b5cf6 !important;  /* Purple for analytics icons */
        }
        
        .fas.fa-users, .fas.fa-user-friends, .fas.fa-team {
            color: #f59e0b !important;  /* Orange for team icons */
        }
        
        .fas.fa-brain, .fas.fa-robot, .fas.fa-magic {
            color: #ef4444 !important;  /* Red for AI icons */
        }
        
        .fas.fa-book, .fas.fa-graduation-cap, .fas.fa-lightbulb {
            color: #06b6d4 !important;  /* Cyan for knowledge icons */
        }
        
        .fas.fa-whatsapp, .fas.fa-comments, .fas.fa-message {
            color: #25d366 !important;  /* WhatsApp green for notifications */
        }
        
        .fas.fa-cog, .fas.fa-settings, .fas.fa-wrench {
            color: #6b7280 !important;  /* Gray for settings icons */
        }
        
        .fas.fa-shopping-cart, .fas.fa-box, .fas.fa-truck {
            color: #f97316 !important;  /* Orange for purchasing icons */
        }
        
        .fas.fa-upload, .fas.fa-download, .fas.fa-file-upload {
            color: #059669 !important;  /* Dark green for upload icons */
        }
        
        .fas.fa-plus, .fas.fa-add, .fas.fa-create {
            color: #10a985 !important;  /* Green for add/create icons */
        }
        
        .fas.fa-edit, .fas.fa-pencil, .fas.fa-edit-alt {
            color: #3b82f6 !important;  /* Blue for edit icons */
        }
        
        .fas.fa-trash, .fas.fa-delete, .fas.fa-remove {
            color: #ef4444 !important;  /* Red for delete icons */
        }
        
        .fas.fa-save, .fas.fa-check, .fas.fa-check-circle {
            color: #10a985 !important;  /* Green for save/success icons */
        }
        
        .fas.fa-clock, .fas.fa-time, .fas.fa-calendar {
            color: #f59e0b !important;  /* Orange for time icons */
        }
        
        .fas.fa-bell, .fas.fa-notification, .fas.fa-alert {
            color: #ef4444 !important;  /* Red for notification icons */
        }
        
        /* Enhanced icon visibility with effects */
        .fas, .far, .fab {
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .fas:hover, .far:hover, .fab:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* Icon containers for better visibility */
        .icon-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .icon-container:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        
        /* Navigation tab icons */
        .nav-tab .fas, .nav-tab .far, .nav-tab .fab {
            font-size: 1.1em;
            margin-right: 8px;
        }
        
        /* Status icons with specific colors */
        .status-icon.success {
            color: #10a985 !important;
        }
        
        .status-icon.warning {
            color: #f59e0b !important;
        }
        
        .status-icon.error {
            color: #ef4444 !important;
        }
        
        .status-icon.info {
            color: #3b82f6 !important;
        }
        
        /* Action icons with backgrounds */
        .action-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .action-icon.primary {
            background: linear-gradient(135deg, #10a985 0%, #059669 100%);
        }
        
        .action-icon.secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .action-icon.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .action-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Force all dark elements to be white/light */
        .bg-slate-800, .bg-slate-900, .bg-gray-800, .bg-gray-900 {
            background-color: #ffffff !important;
            color: #1e293b !important;
        }
        
        .text-slate-800, .text-slate-900, .text-gray-800, .text-gray-900 {
            color: #1e293b !important;
        }
        
        .border-slate-800, .border-slate-900, .border-gray-800, .border-gray-900 {
            border-color: #d1d5db !important;
        }
        
        /* Specific dark elements that should be light */
        .bg-dark, .dark-bg, .dark-background {
            background-color: #ffffff !important;
            color: #1e293b !important;
        }
        
        /* Knowledge upload section */
        .knowledge-section {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
        }
        
        .knowledge-section textarea {
            background: #ffffff !important;
            color: #1e293b !important;
            border: 1px solid #d1d5db !important;
        }
        
        .modern-button {
            background: linear-gradient(135deg, #10a985 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(16, 169, 133, 0.3);
        }
        
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 169, 133, 0.4);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .modern-button:active {
            transform: translateY(0);
        }
        
        .project-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #e2e8f0;
        }
        
        .delete-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            color: #64748b;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #fee2e2;
            border-color: #fecaca;
            color: #dc2626;
            transform: scale(1.05);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .status-due-soon {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-due-today {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .status-overdue {
            background: #fef2f2;
            color: #b91c1c;
        }
        
        .status-normal {
            background: #f0f9ff;
            color: #0369a1;
        }
        
        /* Date picker styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.4);
            cursor: pointer;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* AI Assistant Styles */
        .ai-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .ai-chat.open {
            transform: translateY(0);
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .ai-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .ai-message.user {
            justify-content: flex-end;
        }

        .ai-message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .ai-message.bot .ai-message-content {
            background: white;
            border: 1px solid #e2e8f0;
            margin-right: 10px;
        }

        .ai-message.user .ai-message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 10px;
        }

        .ai-input-container {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
            border-radius: 0 0 20px 20px;
        }

        .ai-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .ai-input:focus {
            border-color: #667eea;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .metric-change {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .metric-change.positive {
            color: #059669;
        }

        .metric-change.negative {
            color: #dc2626;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 32px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #64748b;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #334155;
        }

        /* Team Management */
        .team-member {
            display: flex;
            align-items: center;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .team-member:hover {
            transform: translateY(-2px);
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 16px;
        }

        /* AI Learning Indicators */
        .ai-learning {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .ai-insight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .ai-prediction {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #22c55e;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .ai-chat {
                width: calc(100vw - 40px);
                height: calc(100vh - 40px);
                bottom: 20px;
                right: 20px;
                left: 20px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                margin-bottom: 4px;
            }
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #22c55e;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification-method-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .notification-method-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .notification-method-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .notification-method-card input[type="radio"]:checked + span {
            color: #3b82f6;
            font-weight: 600;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification.error {
            border-left-color: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-16">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-purple-500 via-blue-500 to-cyan-500 rounded-3xl mb-6 shadow-xl">
                <i class="fas fa-brain text-white text-3xl"></i>
            </div>
            <h1 class="text-5xl md:text-6xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-cyan-600 bg-clip-text text-transparent mb-4 tracking-tight">Cerebro de Proyectos IA</h1>
            <p class="text-xl text-slate-600 max-w-3xl mx-auto leading-relaxed">Tu asistente inteligente de gestión de proyectos que aprende, predice y optimiza tu flujo de trabajo automáticamente.</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-chart-line mr-2"></i>Panel
            </div>
            <div class="nav-tab" data-tab="projects">
                <i class="fas fa-tasks mr-2"></i>Proyectos
            </div>
            <div class="nav-tab" data-tab="analytics">
                <i class="fas fa-analytics mr-2"></i>Análisis
            </div>
            <div class="nav-tab" data-tab="team">
                <i class="fas fa-users mr-2"></i>Equipo
            </div>
            <div class="nav-tab" data-tab="ai-insights">
                <i class="fas fa-robot mr-2"></i>Insights IA
            </div>
            <div class="nav-tab" data-tab="knowledge">
                <i class="fas fa-database mr-2"></i>Base de Conocimiento
            </div>
            <div class="nav-tab" data-tab="whatsapp">
                <i class="fab fa-whatsapp mr-2"></i>WhatsApp
            </div>
            <div class="nav-tab" data-tab="purchasing">
                <i class="fas fa-shopping-cart mr-2"></i>Compras
            </div>
            <div class="nav-tab" data-tab="settings">
                <i class="fas fa-cog mr-2"></i>Configuraciones
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <!-- AI Learning Status -->
            <div class="ai-learning">
                <div class="flex items-center mb-3">
                    <i class="fas fa-brain text-blue-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-blue-800">Estado de Aprendizaje IA</h3>
                </div>
                <p class="text-blue-700 mb-2">La IA está analizando tus patrones de proyectos y aprendiendo tu flujo de trabajo empresarial...</p>
                <div class="w-full bg-blue-200 rounded-full h-2">
                    <div id="ai-learning-progress" class="bg-blue-500 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p class="text-sm text-blue-600 mt-2">Progreso de Aprendizaje: <span id="learning-percentage">0%</span></p>
            </div>

            <!-- Key Metrics Dashboard -->
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-tasks text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">+12%</span>
                    </div>
                    <div class="metric-value" id="total-projects">0</div>
                    <div class="metric-label">Total Proyectos</div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">+8%</span>
                    </div>
                    <div class="metric-value" id="completed-projects">0</div>
                    <div class="metric-label">Completados Este Mes</div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <span class="text-sm text-red-600 font-semibold">-5%</span>
                    </div>
                    <div class="metric-value" id="overdue-projects">0</div>
                    <div class="metric-label">Proyectos Atrasados</div>
                </div>

                <div class="metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">+15%</span>
                    </div>
                    <div class="metric-value" id="efficiency-score">0%</div>
                    <div class="metric-label">Puntuación Eficiencia IA</div>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="ai-insight">
                <div class="flex items-center mb-3">
                    <i class="fas fa-lightbulb text-yellow-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-yellow-800">Insight IA</h3>
                </div>
                <p id="ai-insight-text" class="text-yellow-700">Basándome en tus patrones de proyectos, he notado que los proyectos con "brida" en la descripción tienden a tomar 15% más tiempo del estimado. Considera agregar tiempo de buffer para proyectos similares.</p>
            </div>

            <!-- AI Predictions -->
            <div class="ai-prediction">
                <div class="flex items-center mb-3">
                    <i class="fas fa-crystal-ball text-green-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-green-800">Predicción IA</h3>
                </div>
                <p id="ai-prediction-text" class="text-green-700">Basándome en la carga de trabajo actual y datos históricos, es probable que completes 85% de los proyectos a tiempo este mes. Considera priorizar los 3 proyectos que vencen la próxima semana.</p>
            </div>

            <!-- Project Timeline Chart -->
            <div class="glass-card p-8 rounded-2xl">
                <h3 class="text-xl font-semibold text-slate-800 mb-6">Cronograma de Proyectos</h3>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects-tab" class="tab-content hidden">
        <!-- Form to Add New Project -->
            <div class="glass-card p-8 rounded-2xl mb-12">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-plus text-white text-sm"></i>
                </div>
                <div>
                        <h2 class="text-2xl font-semibold text-slate-800">Agregar Nuevo Proyecto</h2>
                        <p class="text-slate-600">Copia los detalles del proyecto de tu otro sistema y pégalos abajo.</p>
                    </div>
                </div>
                
                <div class="mb-8">
                    <label for="smart-entry" class="block text-sm font-semibold text-slate-700 mb-3">Entrada Inteligente</label>
                    <textarea id="smart-entry" rows="4" class="modern-input w-full resize-none" placeholder="ej.,&#10;Número PO: 11-2345&#10;Trabajo: Bridas para Cliente XYZ&#10;Fecha Vencimiento: 2025-12-25"></textarea>
                    <p class="text-xs text-slate-500 mt-2">Pega la información del proyecto y extraeremos automáticamente los detalles abajo.</p>
            </div>

                <form id="add-project-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div>
                            <label for="po-number" class="block text-sm font-semibold text-slate-700 mb-3">PO / Número de Orden</label>
                            <input type="text" id="po-number" name="po-number" required class="modern-input w-full parsed-field" placeholder="Auto-completado desde pegar">
                </div>
                <div>
                            <label for="due-date" class="block text-sm font-semibold text-slate-700 mb-3">Fecha de Vencimiento</label>
                            <input type="date" id="due-date" name="due-date" required class="modern-input w-full parsed-field">
                </div>
                </div>
                    
                    <div>
                        <label for="project-description" class="block text-sm font-semibold text-slate-700 mb-3">Descripción del Proyecto</label>
                        <input type="text" id="project-description" name="project-description" required class="modern-input w-full parsed-field" placeholder="Auto-completado desde pegar">
                </div>
                    
                    <div class="flex justify-end pt-4">
                        <button type="submit" class="modern-button flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Agregar Proyecto
                </button>
                    </div>
            </form>
        </div>

        <!-- Loading Spinner -->
            <div id="loading-spinner" class="flex justify-center items-center py-16 show">
                <div class="flex flex-col items-center">
                    <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-slate-600 font-medium">Cargando proyectos...</p>
                </div>
        </div>

        <!-- Project List -->
        <div id="project-list-container">
                <div class="flex items-center mb-8">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-list-check text-white text-sm"></i>
            </div>
                    <div>
                        <h2 class="text-2xl font-semibold text-slate-800">Proyectos Activos</h2>
                        <p class="text-slate-600">Gestiona y rastrea las fechas límite de tus proyectos</p>
        </div>
    </div>
                
                <div id="project-list" class="space-y-4">
                    <div id="no-projects-message" class="text-center py-16 hidden">
                        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-inbox text-slate-400 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-700 mb-2">No hay proyectos activos</h3>
                        <p class="text-slate-500">¡Agrega tu primer proyecto arriba para comenzar!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Tendencias de Finalización de Proyectos</h3>
                    <div class="chart-container">
                        <canvas id="completionChart"></canvas>
                    </div>
                </div>
                
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Distribución de Tipos de Proyectos</h3>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Tab -->
        <div id="team-tab" class="tab-content hidden">
            <div class="glass-card p-8 rounded-2xl mb-8">
                <h3 class="text-xl font-semibold text-slate-800 mb-6">Miembros del Equipo</h3>
                <div id="team-members">
                    <div class="team-member">
                        <div class="member-avatar">JD</div>
                        <div class="flex-grow">
                            <h4 class="font-semibold text-slate-800">Juan Pérez</h4>
                            <p class="text-sm text-slate-600">Gerente de Proyectos</p>
                            <div class="flex items-center mt-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span class="text-xs text-slate-500">3 proyectos activos</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-semibold text-slate-800">85%</div>
                            <div class="text-xs text-slate-500">Eficiencia</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights Tab -->
        <div id="ai-insights-tab" class="tab-content hidden">
            <div class="space-y-6">
                <div class="ai-learning">
                    <h3 class="text-xl font-semibold text-blue-800 mb-4">Progreso de Aprendizaje IA</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Reconocimiento de Patrones de Proyectos</span>
                                <span>92%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 92%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Precisión de Predicción de Fechas Límite</span>
                                <span>87%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 87%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Optimización de Recursos</span>
                                <span>78%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 78%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Recomendaciones IA</h3>
                    <div class="space-y-4">
                        <div class="flex items-start p-4 bg-slate-50 rounded-lg">
                            <i class="fas fa-lightbulb text-yellow-500 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-slate-800">Optimizar Programación de Proyectos</h4>
                                <p class="text-sm text-slate-600">Considera programar proyectos complejos los martes y miércoles cuando la eficiencia del equipo es más alta.</p>
                            </div>
                        </div>
                        <div class="flex items-start p-4 bg-slate-50 rounded-lg">
                            <i class="fas fa-chart-line text-green-500 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-slate-800">Asignación de Recursos</h4>
                                <p class="text-sm text-slate-600">Reasigna 2 miembros del equipo de proyectos de baja prioridad para cumplir con los plazos de la próxima semana.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Base Tab -->
        <div id="knowledge-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Knowledge Upload Section -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-upload text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Cargar Conocimiento al IA</h3>
                            <p class="text-slate-600">Sube información sobre tu taller para que la IA aprenda sobre tus capacidades</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Text Upload -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Información de Texto</h4>
                            <textarea id="knowledge-text" rows="8" class="modern-input w-full resize-none" placeholder="Ejemplo:&#10;Nuestro taller cuenta con:&#10;- Torno CNC de 3 ejes con capacidad de 500mm de diámetro&#10;- Fresadora vertical con mesa de 1000x500mm&#10;- Sistema de automatización con robots KUKA&#10;- Software CAD/CAM Mastercam&#10;- Materiales: acero inoxidable, aluminio, titanio&#10;- Tolerancias: ±0.01mm para piezas de precisión"></textarea>
                            <button id="upload-text-knowledge" class="modern-button mt-4 w-full">
                                <i class="fas fa-upload mr-2"></i>
                                Cargar Texto
                            </button>
                        </div>
                        
                        <!-- File Upload -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Archivos (PDF, DOC, TXT)</h4>
                            <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-indigo-400 transition-colors">
                                <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-4"></i>
                                <p class="text-slate-600 mb-4">Arrastra archivos aquí o haz clic para seleccionar</p>
                                <input type="file" id="knowledge-files" multiple accept=".pdf,.doc,.docx,.txt" class="hidden">
                                <button onclick="document.getElementById('knowledge-files').click()" class="modern-button">
                                    <i class="fas fa-folder-open mr-2"></i>
                                    Seleccionar Archivos
                                </button>
                            </div>
                            <div id="file-list" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Workshop Capabilities -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Flujo de Trabajo Integrado</h3>
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-indigo-600 text-2xl mr-4 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-indigo-800 mb-2">Proceso Integrado</h4>
                                <p class="text-sm text-indigo-700">Cada proyecto utiliza <strong>torno CNC, fresadora y automatización</strong> en secuencia para crear sistemas mecánicos completos y funcionales.</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-cog text-blue-600 text-2xl mr-3"></i>
                                <h4 class="font-semibold text-blue-800">Torno CNC</h4>
                            </div>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>• 3 ejes de control</li>
                                <li>• Capacidad: 500mm diámetro</li>
                                <li>• Precisión: ±0.01mm</li>
                                <li>• Materiales: Acero, Aluminio, Titanio</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-tools text-green-600 text-2xl mr-3"></i>
                                <h4 class="font-semibold text-green-800">Fresadora</h4>
                            </div>
                            <ul class="text-sm text-green-700 space-y-1">
                                <li>• Mesa: 1000x500mm</li>
                                <li>• 4 ejes de control</li>
                                <li>• Precisión: ±0.005mm</li>
                                <li>• Fresado 3D complejo</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-robot text-purple-600 text-2xl mr-3"></i>
                                <h4 class="font-semibold text-purple-800">Automatización</h4>
                            </div>
                            <ul class="text-sm text-purple-700 space-y-1">
                                <li>• Robots KUKA</li>
                                <li>• Carga automática</li>
                                <li>• Inspección por visión</li>
                                <li>• 24/7 operación</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Project Types Knowledge -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Tipos de Proyectos Integrados</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Sistemas Mecánicos Completos</h4>
                            <div class="space-y-3">
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Ejes torneados + bases fresadas + automatización</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Sistemas de transmisión completos</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Mecanismos de precisión integrados</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-blue-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Sistemas de control automatizado</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Piezas de Precisión</h4>
                            <div class="space-y-3">
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Componentes con tolerancias ±0.001mm</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Piezas críticas para automatización</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Elementos de calibración y medición</span>
                                </div>
                                <div class="flex items-center p-3 bg-slate-50 rounded-lg">
                                    <i class="fas fa-circle text-green-500 mr-3 text-xs"></i>
                                    <span class="text-sm">Componentes para prototipos</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Status -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Estado del Conocimiento IA</h3>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-700">Conocimiento del Taller</h4>
                                <p class="text-sm text-slate-500">Información sobre capacidades y equipos</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-green-600" id="workshop-knowledge">85%</div>
                                <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-700">Tipos de Proyectos</h4>
                                <p class="text-sm text-slate-500">Patrones y categorías de trabajo</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-600" id="project-types-knowledge">72%</div>
                                <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 72%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-700">Tiempos de Producción</h4>
                                <p class="text-sm text-slate-500">Estimaciones basadas en experiencia</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-purple-600" id="timing-knowledge">68%</div>
                                <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-purple-500 h-2 rounded-full" style="width: 68%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Web Search Integration -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Búsqueda Web Inteligente</h3>
                    <div class="space-y-4">
                        <p class="text-slate-600">La IA puede buscar información adicional en internet para complementar su conocimiento sobre:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Nuevas tecnologías CNC</span>
                            </div>
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Tendencias de automatización</span>
                            </div>
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Materiales y aleaciones</span>
                            </div>
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg">
                                <i class="fas fa-search text-indigo-500 mr-3"></i>
                                <span class="text-sm">Mejores prácticas industriales</span>
                            </div>
                        </div>
                        <button id="enable-web-search" class="modern-button">
                            <i class="fas fa-globe mr-2"></i>
                            Activar Búsqueda Web
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Tab -->
        <div id="whatsapp-tab" class="tab-content hidden">
            <!-- Configuración Simple de Notificaciones -->
            <div class="glass-card p-8">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-blue-600 mb-4">
                        <i class="fas fa-bell mr-3"></i>
                        Configurar Notificaciones del Equipo
                    </h2>
                    <p class="text-gray-600 text-lg">Configura notificaciones simples para tu equipo de 5-7 personas</p>
                </div>

                <!-- Método 1: WhatsApp Web -->
                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fab fa-whatsapp text-green-500 text-2xl mr-3"></i>
                        <h3 class="text-xl font-semibold text-green-800">WhatsApp Web (Recomendado)</h3>
                    </div>
                    <p class="text-green-700 mb-4">El líder del equipo recibe notificaciones y las comparte con el grupo</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Número del líder del equipo:</label>
                            <input type="tel" id="team-leader-phone" placeholder="+52 555 123 4567" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Horarios de notificación:</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">Desde:</label>
                                    <input type="time" id="notification-start-time" value="08:00" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">Hasta:</label>
                                    <input type="time" id="notification-end-time" value="18:00" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipos de notificación:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="notify-deadlines" checked class="mr-2">
                                    <span class="text-sm text-gray-700">Fechas límite de proyectos</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="notify-completions" checked class="mr-2">
                                    <span class="text-sm text-gray-700">Proyectos completados</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="notify-issues" checked class="mr-2">
                                    <span class="text-sm text-gray-700">Problemas o retrasos</span>
                                </label>
                            </div>
                        </div>
                        
                        <button onclick="saveWhatsAppConfig()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fas fa-save mr-2"></i>
                            Guardar Configuración WhatsApp
                        </button>
                    </div>
                </div>

                <!-- Método 2: Notificaciones del Navegador -->
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-bell text-blue-500 text-2xl mr-3"></i>
                        <h3 class="text-xl font-semibold text-blue-800">Notificaciones del Navegador</h3>
                    </div>
                    <p class="text-blue-700 mb-4">Notificaciones nativas que aparecen en tu dispositivo</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Frecuencia de recordatorios:</label>
                            <select id="notification-frequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="immediate">Inmediato</option>
                                <option value="daily">Diario</option>
                                <option value="weekly">Semanal</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sonido de notificación:</label>
                            <select id="notification-sound" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="default">Sonido por defecto</option>
                                <option value="none">Sin sonido</option>
                            </select>
                        </div>
                        
                        <button onclick="saveBrowserConfig()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fas fa-bell mr-2"></i>
                            Activar Notificaciones del Navegador
                        </button>
                    </div>
                </div>

                <!-- Probar Configuración -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-flask mr-2"></i>
                        Probar Configuración
                    </h3>
                    <p class="text-gray-600 mb-4">Envía un mensaje de prueba para verificar que todo funciona</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <button onclick="testWhatsAppNotification()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Probar WhatsApp
                        </button>
                        <button onclick="testBrowserNotification()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fas fa-bell mr-2"></i>
                            Probar Navegador
                        </button>
                        <button onclick="showConfigStatus()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg">
                            <i class="fas fa-info-circle mr-2"></i>
                            Ver Estado
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-500 text-center">
                        <p><i class="fas fa-lightbulb mr-1"></i> Abre la consola del navegador (F12) para ver logs detallados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Settings Header -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-cog text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Configuraciones Generales</h3>
                            <p class="text-slate-600">Personaliza tu Cerebro de Proyectos IA para tu taller</p>
                        </div>
                    </div>
                </div>

                <!-- Workshop Information -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Información del Taller</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Nombre del Taller</label>
                                <input type="text" id="workshop-name" class="modern-input w-full" placeholder="Taller de Torno CNC Emilio" value="Taller de Torno CNC Emilio">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Descripción del Taller</label>
                                <textarea id="workshop-description" class="modern-input w-full h-24" placeholder="Describe tu taller y especialidades...">Taller especializado en mecanizado CNC con más de 10 años de experiencia</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Dirección</label>
                                <input type="text" id="workshop-address" class="modern-input w-full" placeholder="Calle, Ciudad, Estado">
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono de Contacto</label>
                                <input type="tel" id="workshop-phone" class="modern-input w-full" placeholder="+52 555 123 4567">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Email de Contacto</label>
                                <input type="email" id="workshop-email" class="modern-input w-full" placeholder="contacto@taller.com">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Horarios de Trabajo</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="time" id="work-start" class="modern-input" value="08:00">
                                    <input type="time" id="work-end" class="modern-input" value="17:00">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="saveWorkshopInfo()" class="modern-button bg-indigo-600 hover:bg-indigo-700">
                        <i class="fas fa-save mr-2"></i>
                        Guardar Información del Taller
                    </button>
                </div>

                <!-- Admin: Gestión de Roles -->
                <div id="admin-roles-card" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-users-cog text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Administración de Roles</h3>
                            <p class="text-slate-600">Solo administradores pueden cambiar roles</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">UID del Usuario</label>
                            <input id="role-user-uid" type="text" class="modern-input w-full" placeholder="UID del usuario">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Rol</label>
                            <select id="role-select" class="modern-input w-full">
                                <option value="viewer">viewer</option>
                                <option value="compras">compras</option>
                                <option value="admin">admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex gap-4">
                        <button id="save-role" class="modern-button">
                            <i class="fas fa-save mr-2"></i>Guardar Rol
                        </button>
                        <button id="load-role" class="modern-button bg-slate-600 hover:bg-slate-700">
                            <i class="fas fa-search mr-2"></i>Cargar Rol
                        </button>
                    </div>
                    <p id="role-message" class="text-sm text-slate-600 mt-3"></p>
                </div>

                <!-- Project Categories -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Categorías de Proyectos</h3>
                    <div class="space-y-4">
                        <div id="categories-list" class="space-y-3">
                            <!-- Categories will be populated here -->
                        </div>
                        
                        <div class="flex space-x-4">
                            <input type="text" id="new-category" class="modern-input flex-1" placeholder="Nueva categoría (ej: Piezas Automotrices)">
                            <button onclick="addCategory()" class="modern-button bg-green-600 hover:bg-green-700">
                                <i class="fas fa-plus mr-2"></i>
                                Agregar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Import/Export Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Respaldo y Configuración</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Exportar Configuración</h4>
                            <p class="text-sm text-slate-600">Descarga un archivo con todas tus configuraciones</p>
                            <button onclick="exportSettings()" class="modern-button bg-blue-600 hover:bg-blue-700 w-full">
                                <i class="fas fa-download mr-2"></i>
                                Exportar
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Importar Configuración</h4>
                            <p class="text-sm text-slate-600">Carga un archivo de configuración</p>
                            <input type="file" id="import-file" accept=".json" class="hidden">
                            <button onclick="document.getElementById('import-file').click()" class="modern-button bg-purple-600 hover:bg-purple-700 w-full">
                                <i class="fas fa-upload mr-2"></i>
                                Importar
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <button id="reset-to-defaults" class="modern-button bg-red-600 hover:bg-red-700">
                            <i class="fas fa-undo mr-2"></i>
                            Restablecer a Configuración por Defecto
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchasing Tab (legacy/incomplete duplicate) -->
        <div id="purchasing-tab-legacy" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Purchasing Header -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-shopping-cart text-white text-xl"></i>
                            </div>
                            </div>

                <!-- Step 1: Team Notification Methods -->
                <div id="custom-method-selection" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-1 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 1: Elige cómo tu equipo recibirá notificaciones</h3>
                            <p class="text-slate-600">Opciones simples y efectivas para equipos de 5-7 personas</p>
                    </div>
                </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- WhatsApp Web Simple -->
                        <div class="notification-method-card border-2 border-green-200 bg-green-50" data-method="whatsapp-web-simple">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mr-4">
                                    <i class="fab fa-whatsapp text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-slate-800">WhatsApp Web (Recomendado)</h4>
                                    <p class="text-sm text-slate-600">Perfecto para equipos</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center text-sm text-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Líder del equipo recibe notificaciones</span>
                                </div>
                                <div class="flex items-center text-sm text-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Reenvía mensajes al grupo automáticamente</span>
                                </div>
                                <div class="flex items-center text-sm text-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Sin APIs complicadas</span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <input type="radio" name="notification-method" value="whatsapp-web-simple" class="mr-2" checked>
                                <span class="text-sm font-medium text-green-700">Usar WhatsApp Web</span>
                            </div>
                        </div>
                        
                        <!-- Browser Notifications -->
                        <div class="notification-method-card border-2 border-purple-200 bg-purple-50" data-method="browser-notifications">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-bell text-white text-xl"></i>
                        </div>
                        <div>
                                    <h4 class="font-semibold text-slate-800">Notificaciones del Navegador</h4>
                                    <p class="text-sm text-slate-600">Para equipos en oficina</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center text-sm text-purple-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Cada miembro recibe notificaciones directas</span>
                                </div>
                                <div class="flex items-center text-sm text-purple-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Aparecen en la pantalla automáticamente</span>
                                </div>
                                <div class="flex items-center text-sm text-purple-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Sin configuración adicional</span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <input type="radio" name="notification-method" value="browser-notifications" class="mr-2">
                                <span class="text-sm font-medium text-purple-700">Usar Navegador</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-blue-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-blue-800 mb-1">Recomendación para tu equipo</h4>
                                <p class="text-sm text-blue-700">Te recomendamos <strong>WhatsApp Web</strong> porque es la forma más fácil de que todos en tu equipo reciban las notificaciones sin configuración compleja.</p>
                            </div>
                        </div>
                            </div>
                        </div>
                        
                <!-- Step 2: WhatsApp Web Ultra Simple -->
                <div id="whatsapp-web-simple-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-2 text-white text-lg font-bold"></i>
                            </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 2: Configura WhatsApp Web para tu Equipo</h3>
                            <p class="text-slate-600">Solo necesitas el número del líder del equipo</p>
                            </div>
                        </div>
                        
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-green-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-green-800 mb-2">¡Perfecto para Equipos!</h4>
                                <p class="text-sm text-green-700 mb-2">Cómo funciona:</p>
                                <ul class="text-sm text-green-700 space-y-1">
                                    <li>• El líder del equipo recibe las notificaciones</li>
                                    <li>• Se abren automáticamente en WhatsApp Web</li>
                                    <li>• El líder reenvía el mensaje al grupo del equipo</li>
                                    <li>• ¡Todos reciben la notificación!</li>
                                </ul>
                            </div>
                            </div>
                        </div>
                        
                    <div class="space-y-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-semibold text-slate-800 mb-4">Para tu equipo de 5-7 personas:</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Número de WhatsApp del líder del equipo</label>
                                    <input type="tel" id="team-leader-whatsapp" class="modern-input w-full" placeholder="+52 555 123 4567">
                                    <p class="text-xs text-slate-500 mt-1">Esta persona recibirá notificaciones y las reenviará al equipo</p>
                            </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Grupo de WhatsApp del equipo (opcional)</label>
                                    <input type="text" id="team-whatsapp-group" class="modern-input w-full" placeholder="Nombre del grupo o enlace">
                                    <p class="text-xs text-slate-500 mt-1">Si tienes un grupo, las notificaciones irán ahí también</p>
                            </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-1">¿Cómo funciona?</h4>
                                    <p class="text-sm text-blue-700">El sistema creará un enlace de WhatsApp que se abrirá automáticamente cuando haya una notificación. El líder del equipo puede reenviar el mensaje al grupo o a miembros específicos.</p>
                        </div>
                    </div>
                </div>

                        <button id="save-whatsapp-web-config" class="modern-button w-full">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Configurar WhatsApp Web
                        </button>
                    </div>
                </div>

                <!-- Step 2: Email Ultra Simple -->
                <div id="email-ultra-simple-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-2 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 2: Configura Email</h3>
                            <p class="text-slate-600">Solo necesitas tu email</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-blue-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-blue-800 mb-2">¡Súper Fácil!</h4>
                                <p class="text-sm text-blue-700">Solo necesitas tu email. El sistema generará un enlace que puedes copiar y pegar en tu cliente de email favorito.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-semibold text-slate-800 mb-4">Para tu equipo de 5-7 personas:</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Emails del equipo (separados por comas)</label>
                                    <textarea id="team-emails" rows="3" class="modern-input w-full" placeholder="juan@taller.com, maria@taller.com, carlos@taller.com"></textarea>
                                    <p class="text-xs text-slate-500 mt-1">Lista todos los emails de tu equipo</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Tu email principal</label>
                                    <input type="email" id="main-email" class="modern-input w-full" placeholder="taller@empresa.com">
                                    <p class="text-xs text-slate-500 mt-1">Email donde recibirás las notificaciones principales</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-green-800 mb-1">¿Cómo funciona?</h4>
                                    <p class="text-sm text-green-700">El sistema generará un enlace de email pre-rellenado que puedes usar con Gmail, Outlook, o cualquier cliente de email. Solo copia y pega cuando necesites enviar notificaciones.</p>
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-email-ultra-config" class="modern-button w-full">
                            <i class="fas fa-envelope mr-2"></i>
                            Configurar Email Simple
                        </button>
                    </div>
                </div>

                <!-- Step 2: Browser Notifications -->
                <div id="browser-notifications-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-2 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 2: Notificaciones del Navegador</h3>
                            <p class="text-slate-600">Sin configuración, funciona inmediatamente</p>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-magic text-purple-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-purple-800 mb-2">¡Perfecto para Equipos!</h4>
                                <p class="text-sm text-purple-700">Cada miembro del equipo solo necesita tener esta página abierta en su navegador. Recibirán notificaciones automáticamente sin configurar nada más.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-semibold text-slate-800 mb-4">Para tu equipo de 5-7 personas:</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Nombres de los miembros del equipo</label>
                                    <textarea id="team-members" rows="3" class="modern-input w-full" placeholder="Juan, María, Carlos, Ana, Luis, Roberto, Emilio"></textarea>
                                    <p class="text-xs text-slate-500 mt-1">Solo para referencia, no es obligatorio</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-green-800 mb-1">¿Cómo funciona?</h4>
                                    <p class="text-sm text-green-700">Cada miembro del equipo debe tener esta página abierta en su navegador. Cuando haya una notificación, aparecerá como una notificación del sistema en la esquina de la pantalla.</p>
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-browser-config" class="modern-button w-full">
                            <i class="fas fa-bell mr-2"></i>
                            Activar Notificaciones del Navegador
                        </button>
                    </div>
                </div>

                <!-- Step 2: Email Simple Configuration -->
                <div id="email-simple-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-2 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 2: Configura Email</h3>
                            <p class="text-slate-600">Configuración simple con Gmail</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-blue-800 mb-2">Configuración con Gmail</h4>
                                <p class="text-sm text-blue-700">Usa tu cuenta de Gmail para enviar notificaciones automáticas. Solo necesitas activar la "Verificación en 2 pasos" y generar una "Contraseña de aplicación".</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Tu email de Gmail</label>
                                <input type="email" id="simple-email-address" class="modern-input w-full" placeholder="tu@email.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Contraseña de aplicación</label>
                                <input type="password" id="simple-email-password" class="modern-input w-full" placeholder="Contraseña de 16 caracteres">
                                <p class="text-xs text-slate-500 mt-1">Genera una contraseña de aplicación en tu cuenta de Google</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Email de destino</label>
                            <input type="email" id="simple-email-destination" class="modern-input w-full" placeholder="donde@recibir.com">
                            <p class="text-xs text-slate-500 mt-1">Email donde recibirás las notificaciones</p>
                        </div>
                        
                        <button id="save-email-config" class="modern-button w-full">
                            <i class="fas fa-envelope mr-2"></i>
                            Guardar Configuración de Email
                        </button>
                    </div>
                </div>

                <!-- Step 3: Test Configuration -->
                <div id="test-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-3 text-white text-lg font-bold"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Paso 3: Prueba tu configuración</h3>
                            <p class="text-slate-600">Envía un mensaje de prueba para verificar que todo funciona</p>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-purple-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-purple-800 mb-2">¡Casi listo!</h4>
                                <p class="text-sm text-purple-700">Envía un mensaje de prueba para asegurarte de que recibirás las notificaciones correctamente.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="send-test-notification" class="modern-button bg-purple-600 hover:bg-purple-700">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Enviar Mensaje de Prueba
                        </button>
                        <p class="text-sm text-slate-500 mt-3">Verifica que recibas el mensaje en tu dispositivo</p>
                    </div>
                </div>

                <!-- Configuration Complete -->
                <div id="config-complete" class="glass-card p-8 rounded-2xl hidden">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-check text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-semibold text-slate-800 mb-4">¡Configuración Completada!</h3>
                        <p class="text-slate-600 mb-6">Ahora recibirás notificaciones automáticas sobre tus proyectos</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <i class="fas fa-bell text-green-600 text-xl mb-2"></i>
                                <h4 class="font-semibold text-green-800">Recordatorios</h4>
                                <p class="text-sm text-green-700">Recibe alertas antes de que los proyectos venzan</p>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <i class="fas fa-clock text-blue-600 text-xl mb-2"></i>
                                <h4 class="font-semibold text-blue-800">Horario</h4>
                                <p class="text-sm text-blue-700">Solo durante tu horario laboral</p>
                            </div>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <i class="fas fa-robot text-purple-600 text-xl mb-2"></i>
                                <h4 class="font-semibold text-purple-800">Automático</h4>
                                <p class="text-sm text-purple-700">Sin intervención manual necesaria</p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 justify-center">
                            <button id="edit-config" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-edit mr-2"></i>
                                Editar Configuración
                            </button>
                            <button id="view-projects" class="modern-button">
                                <i class="fas fa-tasks mr-2"></i>
                                Ver Proyectos
                            </button>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Business Configuration (Advanced) -->
                <div id="whatsapp-business-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fab fa-whatsapp text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">WhatsApp Business API (Avanzado)</h3>
                            <p class="text-slate-600">Configuración para empresas con API oficial</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- WhatsApp Business API Setup -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración de API</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Token de Acceso</label>
                                    <input type="password" id="whatsapp-token" class="modern-input w-full" placeholder="Ingresa tu token de WhatsApp Business API">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Número de Teléfono ID</label>
                                    <input type="text" id="whatsapp-phone-id" class="modern-input w-full" placeholder="ID del número de teléfono">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Número de Verificación</label>
                                    <input type="text" id="whatsapp-verify-token" class="modern-input w-full" placeholder="Token de verificación">
                                </div>
                                <button id="test-whatsapp-connection" class="modern-button w-full">
                                    <i class="fab fa-whatsapp mr-2"></i>
                                    Probar Conexión
                                </button>
                            </div>
                        </div>
                        
                        <!-- Team Members Configuration -->
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Miembros del Equipo</h4>
                            <div class="space-y-4">
                                <div id="team-members-whatsapp" class="space-y-3">
                                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-green-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-slate-800">Juan Pérez</h5>
                                                <p class="text-sm text-slate-600">+52 555 123 4567</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" class="whatsapp-notifications" checked>
                                                <span class="ml-2 text-sm text-slate-600">Notificaciones</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-green-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-slate-800">María García</h5>
                                                <p class="text-sm text-slate-600">+52 555 987 6543</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" class="whatsapp-notifications" checked>
                                                <span class="ml-2 text-sm text-slate-600">Notificaciones</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <button id="add-team-member" class="modern-button w-full">
                                    <i class="fas fa-plus mr-2"></i>
                                    Agregar Miembro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Web Configuration -->
                <div id="whatsapp-web-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fab fa-whatsapp text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">WhatsApp Web</h3>
                            <p class="text-slate-600">Para usuarios sin WhatsApp Business - Envía enlaces directos</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-yellow-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-yellow-800 mb-2">¿Cómo funciona?</h4>
                                    <p class="text-sm text-yellow-700">El sistema generará enlaces de WhatsApp Web que se abrirán automáticamente con el mensaje pre-escrito. Los miembros del equipo solo necesitan hacer clic en el enlace.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Número de WhatsApp Principal</label>
                                        <input type="text" id="whatsapp-web-number" class="modern-input w-full" placeholder="+52 555 123 4567">
                                        <p class="text-xs text-slate-500 mt-1">Número que aparecerá como remitente</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Mensaje de Presentación</label>
                                        <textarea id="whatsapp-web-intro" rows="3" class="modern-input w-full" placeholder="Hola! Soy el sistema de recordatorios del taller..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Vista Previa</h4>
                                <div class="bg-slate-50 p-4 rounded-lg">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                            <i class="fab fa-whatsapp text-white text-sm"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                                <p class="text-sm text-slate-800">
                                                    <strong>Enlace generado:</strong><br>
                                                    <a href="#" class="text-green-600 underline">Abrir WhatsApp Web</a><br>
                                                    <em>Mensaje: "PO #12345 vence mañana..."</em>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Configuration -->
                <div id="email-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-envelope text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Notificaciones por Email</h3>
                            <p class="text-slate-600">Configura el envío de recordatorios por correo electrónico</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración SMTP</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Servidor SMTP</label>
                                        <input type="text" id="smtp-server" class="modern-input w-full" placeholder="smtp.gmail.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Puerto</label>
                                        <input type="number" id="smtp-port" class="modern-input w-full" placeholder="587" value="587">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Email de Envío</label>
                                        <input type="email" id="smtp-email" class="modern-input w-full" placeholder="taller@empresa.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Contraseña</label>
                                        <input type="password" id="smtp-password" class="modern-input w-full" placeholder="Contraseña de aplicación">
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Plantilla de Email</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Asunto</label>
                                        <input type="text" id="email-subject" class="modern-input w-full" placeholder="Recordatorio de Proyecto - PO #{{PO_NUMBER}}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Mensaje</label>
                                        <textarea id="email-template" rows="6" class="modern-input w-full" placeholder="Estimado equipo,&#10;&#10;El proyecto PO #{{PO_NUMBER}} vence el {{DUE_DATE}}.&#10;Descripción: {{PROJECT_DESCRIPTION}}&#10;&#10;Saludos,&#10;Sistema de Recordatorios"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button id="test-email" class="modern-button">
                                <i class="fas fa-envelope mr-2"></i>
                                Probar Email
                            </button>
                            <button id="save-email-config" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-save mr-2"></i>
                                Guardar Configuración
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Browser Notifications Configuration -->
                <div id="browser-config" class="glass-card p-8 rounded-2xl hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-bell text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Notificaciones del Navegador</h3>
                            <p class="text-slate-600">Notificaciones push nativas del navegador</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Ventajas de las Notificaciones del Navegador</h4>
                                    <ul class="text-sm text-blue-700 space-y-1">
                                        <li>• No requiere configuración adicional</li>
                                        <li>• Funciona en todos los dispositivos</li>
                                        <li>• Notificaciones nativas del sistema</li>
                                        <li>• Gratuito y fácil de usar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Estado de Permisos</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div class="flex items-center">
                                            <i class="fas fa-bell text-purple-600 mr-3"></i>
                                            <span class="text-sm font-medium text-slate-800">Notificaciones</span>
                                        </div>
                                        <span id="notification-permission-status" class="text-xs px-2 py-1 rounded">Verificando...</span>
                                    </div>
                                    
                                    <button id="request-notification-permission" class="modern-button w-full">
                                        <i class="fas fa-key mr-2"></i>
                                        Solicitar Permisos
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Configuración</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-700">Sonido de notificación</span>
                                        <input type="checkbox" id="notification-sound" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-700">Vibrar en móvil</span>
                                        <input type="checkbox" id="notification-vibrate" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-700">Mostrar siempre</span>
                                        <input type="checkbox" id="notification-persistent" class="rounded">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-2">Vista Previa</h4>
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-bell text-white text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-800">Recordatorio de Proyecto</p>
                                    <p class="text-xs text-slate-600">PO #12345 vence mañana - Taller de Torno CNC</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reminder Templates -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Plantillas de Recordatorios</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Recordatorio de Vencimiento</h4>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fab fa-whatsapp text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <p class="text-sm text-slate-800">
                                                🚨 <strong>Recordatorio de Proyecto</strong><br>
                                                PO #{{PO_NUMBER}} vence {{DUE_DATE}}<br>
                                                {{PROJECT_DESCRIPTION}}<br>
                                                <em>Taller de Torno CNC</em>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="modern-button w-full" onclick="editTemplate('due')">
                                <i class="fas fa-edit mr-2"></i>
                                Editar Plantilla
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700">Proyecto Atrasado</h4>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fab fa-whatsapp text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <p class="text-sm text-slate-800">
                                                ⚠️ <strong>PROYECTO ATRASADO</strong><br>
                                                PO #{{PO_NUMBER}} - {{DAYS_OVERDUE}} días atrasado<br>
                                                {{PROJECT_DESCRIPTION}}<br>
                                                <em>Acción requerida inmediatamente</em>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="modern-button w-full" onclick="editTemplate('overdue')">
                                <i class="fas fa-edit mr-2"></i>
                                Editar Plantilla
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reminder Schedule -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Programación de Recordatorios</h3>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-clock text-blue-600 text-xl mr-3"></i>
                                    <h4 class="font-semibold text-blue-800">Recordatorio Temprano</h4>
                                </div>
                                <p class="text-sm text-blue-700 mb-4">7 días antes del vencimiento</p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="early-reminder" checked class="mr-2">
                                    <label for="early-reminder" class="text-sm text-blue-700">Activar</label>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-200">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3"></i>
                                    <h4 class="font-semibold text-yellow-800">Recordatorio Urgente</h4>
                                </div>
                                <p class="text-sm text-yellow-700 mb-4">1 día antes del vencimiento</p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="urgent-reminder" checked class="mr-2">
                                    <label for="urgent-reminder" class="text-sm text-yellow-700">Activar</label>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-times-circle text-red-600 text-xl mr-3"></i>
                                    <h4 class="font-semibold text-red-800">Proyecto Atrasado</h4>
                                </div>
                                <p class="text-sm text-red-700 mb-4">Inmediatamente al vencerse</p>
                                <div class="flex items-center">
                                    <input type="checkbox" id="overdue-reminder" checked class="mr-2">
                                    <label for="overdue-reminder" class="text-sm text-red-700">Activar</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-6 rounded-xl">
                            <h4 class="font-semibold text-slate-800 mb-4">Horarios de Envío</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Hora de Inicio</label>
                                    <input type="time" id="start-time" value="08:00" class="modern-input w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Hora de Fin</label>
                                    <input type="time" id="end-time" value="18:00" class="modern-input w-full">
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Los recordatorios solo se enviarán durante estas horas</p>
                        </div>
                    </div>
                </div>

                <!-- Test Notifications -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Probar Notificaciones</h3>
                    <div class="space-y-4">
                        <p class="text-slate-600">Envía un mensaje de prueba a todos los miembros del equipo</p>
                        <div class="flex space-x-4">
                            <button id="test-all-notifications" class="modern-button">
                                <i class="fab fa-whatsapp mr-2"></i>
                                Probar a Todos
                            </button>
                            <button id="test-specific-member" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-user mr-2"></i>
                                Probar Miembro Específico
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notification History -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Historial de Notificaciones</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-800">Recordatorio enviado</p>
                                    <p class="text-sm text-slate-600">PO #12345 - Juan Pérez - Hace 2 horas</p>
                                </div>
                            </div>
                            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded">Enviado</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-clock text-yellow-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-800">Recordatorio programado</p>
                                    <p class="text-sm text-slate-600">PO #12346 - María García - Mañana 8:00 AM</p>
                                </div>
                            </div>
                            <span class="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded">Programado</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-times-circle text-red-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-800">Error de envío</p>
                                    <p class="text-sm text-slate-600">PO #12347 - Carlos López - Hace 1 hora</p>
                                </div>
                            </div>
                            <span class="text-xs text-red-600 bg-red-100 px-2 py-1 rounded">Error</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- General Settings Header -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-cog text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Configuraciones Generales</h3>
                            <p class="text-slate-600">Personaliza tu Cerebro de Proyectos IA para tu taller</p>
                        </div>
                    </div>
                </div>

                <!-- Workshop Information -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Información del Taller</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Nombre del Taller</label>
                                <input type="text" id="workshop-name" class="modern-input w-full" placeholder="Taller de Torno CNC Emilio" value="Taller de Torno CNC Emilio">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Dirección</label>
                                <textarea id="workshop-address" rows="3" class="modern-input w-full" placeholder="Calle, Colonia, Ciudad, Estado, CP"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                                <input type="tel" id="workshop-phone" class="modern-input w-full" placeholder="+52 555 123 4567">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                <input type="email" id="workshop-email" class="modern-input w-full" placeholder="taller@empresa.com">
                            </div>
                        </div>
                        
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Capacidades del Taller</label>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Flujo de Trabajo Integrado</h4>
                                    <p class="text-sm text-blue-700">Los proyectos utilizan <strong>torno CNC, fresadora y automatización</strong> en conjunto para crear piezas completas y sistemas integrados.</p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-integrated" checked class="mr-2 rounded" disabled>
                                <span class="text-sm text-slate-700 font-medium">Proyectos Integrados (Torno + Fresado + Automatización)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-prototyping" class="mr-2 rounded">
                                <span class="text-sm text-slate-700">Prototipado Rápido</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-maintenance" class="mr-2 rounded">
                                <span class="text-sm text-slate-700">Mantenimiento Especializado</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="specialty-custom" class="mr-2 rounded">
                                <span class="text-sm text-slate-700">Desarrollo a Medida</span>
                            </label>
                        </div>
                    </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Capacidad de Producción</label>
                                <select id="production-capacity" class="modern-input w-full">
                                    <option value="small">Pequeña (1-10 proyectos/mes)</option>
                                    <option value="medium" selected>Mediana (10-50 proyectos/mes)</option>
                                    <option value="large">Grande (50+ proyectos/mes)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Zona Horaria</label>
                                <select id="timezone" class="modern-input w-full">
                                    <option value="America/Mexico_City" selected>México Central (GMT-6)</option>
                                    <option value="America/Mexico_City">México Pacífico (GMT-7)</option>
                                    <option value="America/New_York">Este (GMT-5)</option>
                                    <option value="America/Los_Angeles">Oeste (GMT-8)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Project Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Configuraciones de Proyectos</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Prefijo de PO</label>
                                <input type="text" id="po-prefix" class="modern-input w-full" placeholder="PO" value="PO">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Formato de Numeración</label>
                                <select id="po-format" class="modern-input w-full">
                                    <option value="sequential" selected>Secuencial (PO-001, PO-002...)</option>
                                    <option value="year-month">Año-Mes (PO-2024-01-001)</option>
                                    <option value="year-only">Solo Año (PO-2024-001)</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            <div id="custom-format-container" class="hidden">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Formato Personalizado</label>
                                <input type="text" id="custom-po-format" class="modern-input w-full" placeholder="PO-{YYYY}-{MM}-{###}">
                                <p class="text-xs text-slate-500 mt-1">Usa {YYYY} para año, {MM} para mes, {###} para número secuencial</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Días de Aviso por Defecto</label>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Temprano</label>
                                        <input type="number" id="early-warning-days" class="modern-input w-full" value="7" min="1" max="30">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Urgente</label>
                                        <input type="number" id="urgent-warning-days" class="modern-input w-full" value="1" min="0" max="7">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Crítico</label>
                                        <input type="number" id="critical-warning-days" class="modern-input w-full" value="0" min="0" max="3">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Tipos de Proyectos Integrados</label>
                                <div class="space-y-2" id="project-categories">
                                    <div class="flex items-center space-x-2">
                                        <input type="text" class="modern-input flex-1" placeholder="Nuevo tipo de proyecto" id="new-category">
                                        <button id="add-category" class="modern-button px-4 py-2">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="space-y-1" id="categories-list">
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Sistema Mecánico Completo</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Piezas de Precisión</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Automatización Industrial</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                            <span class="text-sm text-slate-700">Prototipo Integrado</span>
                                            <button class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Etapas del Proyecto Integrado</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-planning" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Planificación</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-turning" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Torneado CNC</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-milling" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Fresado</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-automation" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Integración Automatización</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-testing" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Pruebas y Calibración</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-completed" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Completado</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="status-cancelled" class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Cancelado</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Configuraciones de Notificaciones</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Horario de Trabajo</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Inicio</label>
                                        <input type="time" id="work-start-time" class="modern-input w-full" value="08:00">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Fin</label>
                                        <input type="time" id="work-end-time" class="modern-input w-full" value="18:00">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Días de Trabajo</label>
                                <div class="grid grid-cols-7 gap-2">
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-monday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">L</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-tuesday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">M</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-wednesday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">X</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-thursday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">J</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-friday" checked class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">V</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-saturday" class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">S</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="workday-sunday" class="mb-1 rounded">
                                        <span class="text-xs text-slate-600">D</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Frecuencia de Verificación</label>
                                <select id="check-frequency" class="modern-input w-full">
                                    <option value="15">Cada 15 minutos</option>
                                    <option value="30" selected>Cada 30 minutos</option>
                                    <option value="60">Cada hora</option>
                                    <option value="120">Cada 2 horas</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Tipos de Recordatorios</label>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <h4 class="font-medium text-slate-800">Email</h4>
                                            <p class="text-sm text-slate-600">Notificaciones por correo</p>
                                        </div>
                                        <input type="checkbox" id="reminder-email" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <h4 class="font-medium text-slate-800">WhatsApp</h4>
                                            <p class="text-sm text-slate-600">Mensajes de WhatsApp</p>
                                        </div>
                                        <input type="checkbox" id="reminder-whatsapp" checked class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <h4 class="font-medium text-slate-800">Navegador</h4>
                                            <p class="text-sm text-slate-600">Notificaciones push</p>
                                        </div>
                                        <input type="checkbox" id="reminder-browser" checked class="rounded">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Configuración de Sonido</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="sound-enabled" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Activar sonidos</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="sound-vibrate" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Vibrar en móvil</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Configuraciones de IA</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Nivel de Aprendizaje</label>
                                <select id="ai-learning-level" class="modern-input w-full">
                                    <option value="basic">Básico</option>
                                    <option value="intermediate" selected>Intermedio</option>
                                    <option value="advanced">Avanzado</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Frecuencia de Análisis</label>
                                <select id="ai-analysis-frequency" class="modern-input w-full">
                                    <option value="immediate" selected>Inmediato</option>
                                    <option value="hourly">Cada hora</option>
                                    <option value="daily">Diario</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Precisión de Predicciones</label>
                                <div class="space-y-2">
                                    <input type="range" id="ai-precision" min="50" max="95" value="80" class="w-full">
                                    <div class="flex justify-between text-xs text-slate-600">
                                        <span>50% (Rápido)</span>
                                        <span id="precision-value">80%</span>
                                        <span>95% (Preciso)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Características de IA</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-pattern-recognition" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Reconocimiento de patrones</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-duration-prediction" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Predicción de duración</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-risk-analysis" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Análisis de riesgos</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ai-optimization" checked class="mr-2 rounded">
                                        <span class="text-sm text-slate-700">Optimización de recursos</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Idioma de Respuestas</label>
                                <select id="ai-language" class="modern-input w-full">
                                    <option value="es" selected>Español</option>
                                    <option value="en">English</option>
                                    <option value="auto">Automático</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup and Export -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">Respaldo y Exportación</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-4">Exportar Datos</h4>
                                <div class="space-y-3">
                                    <button id="export-projects" class="modern-button w-full">
                                        <i class="fas fa-download mr-2"></i>
                                        Exportar Proyectos (CSV)
                                    </button>
                                    <button id="export-settings" class="modern-button w-full">
                                        <i class="fas fa-cog mr-2"></i>
                                        Exportar Configuraciones (JSON)
                                    </button>
                                    <button id="export-knowledge" class="modern-button w-full">
                                        <i class="fas fa-database mr-2"></i>
                                        Exportar Base de Conocimiento
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-4">Importar Datos</h4>
                                <div class="space-y-3">
                                    <input type="file" id="import-file" accept=".json,.csv" class="hidden">
                                    <button id="import-data" class="modern-button w-full">
                                        <i class="fas fa-upload mr-2"></i>
                                        Importar Datos
                                    </button>
                                    <button id="reset-settings" class="modern-button w-full bg-red-600 hover:bg-red-700">
                                        <i class="fas fa-undo mr-2"></i>
                                        Restablecer Configuraciones
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Settings -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-slate-800">Guardar Configuraciones</h3>
                            <p class="text-slate-600">Tus configuraciones se guardan automáticamente</p>
                        </div>
                        <div class="flex space-x-4">
                            <button id="save-all-settings" class="modern-button">
                                <i class="fas fa-save mr-2"></i>
                                Guardar Todo
                            </button>
                            <button id="reset-to-defaults" class="modern-button bg-slate-600 hover:bg-slate-700">
                                <i class="fas fa-undo mr-2"></i>
                                Restablecer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchasing Tab -->
        <div id="purchasing-tab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Purchasing Header -->
                <div class="glass-card p-8 rounded-2xl">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-shopping-cart text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-800">Gestión de Compras Inteligente</h3>
                            <p class="text-slate-600">Sistema de ayuda para el equipo de compras basado en proyectos activos</p>
                        </div>
                    </div>
                </div>

                <!-- Project-Based Material Recommendations -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-lightbulb text-yellow-500 mr-3"></i>
                        Recomendaciones Basadas en Proyectos
                    </h3>
                    <div id="project-material-recommendations" class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Análisis Automático</h4>
                                    <p class="text-sm text-blue-700">El sistema analiza automáticamente los proyectos activos para identificar materiales y componentes necesarios.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Material Categories -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-cubes text-purple-500 mr-3"></i>
                        Categorías de Materiales
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Metals -->
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 border border-gray-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-hammer text-white"></i>
                                </div>
                                <h4 class="font-semibold text-gray-800">Metales</h4>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Acero Inoxidable</span>
                                    <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Aluminio</span>
                                    <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Titanio</span>
                                    <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <button class="w-full mt-3 bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Agregar Material
                                </button>
                            </div>
                        </div>

                        <!-- Cutting Tools -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-cut text-white"></i>
                                </div>
                                <h4 class="font-semibold text-blue-800">Herramientas de Corte</h4>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-blue-600">Fresas</span>
                                    <span class="text-xs bg-blue-200 text-blue-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-blue-600">Brocas</span>
                                    <span class="text-xs bg-blue-200 text-blue-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-blue-600">Inserts</span>
                                    <span class="text-xs bg-blue-200 text-blue-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <button class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Agregar Herramienta
                                </button>
                            </div>
                        </div>

                        <!-- Consumables -->
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-tint text-white"></i>
                                </div>
                                <h4 class="font-semibold text-green-800">Consumibles</h4>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-600">Aceite de Corte</span>
                                    <span class="text-xs bg-green-200 text-green-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-600">Refrigerante</span>
                                    <span class="text-xs bg-green-200 text-green-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-600">Abrasivos</span>
                                    <span class="text-xs bg-green-200 text-green-700 px-2 py-1 rounded-full">Stock: --</span>
                                </div>
                                <button class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Agregar Consumible
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Supplier Management -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-handshake text-orange-500 mr-3"></i>
                        Gestión de Proveedores
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Proveedores Frecuentes</h4>
                            <div class="space-y-3" id="suppliers-list">
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="font-medium text-slate-800">Proveedor de Metales ABC</h5>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Activo</span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-2">Especialista en acero inoxidable y aluminio</p>
                                    <div class="flex items-center space-x-4 text-xs text-slate-500">
                                        <span><i class="fas fa-phone mr-1"></i>555-1234</span>
                                        <span><i class="fas fa-envelope mr-1"></i>ventas@abc.com</span>
                                    </div>
                                </div>
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="font-medium text-slate-800">Herramientas CNC Pro</h5>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Activo</span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-2">Fresas, brocas y herramientas especializadas</p>
                                    <div class="flex items-center space-x-4 text-xs text-slate-500">
                                        <span><i class="fas fa-phone mr-1"></i>555-5678</span>
                                        <span><i class="fas fa-envelope mr-1"></i>info@cncpro.com</span>
                                    </div>
                                </div>
                            </div>
                            <button id="add-supplier" class="w-full mt-4 bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Agregar Proveedor
                            </button>
                        </div>

                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Nuevo Proveedor</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Nombre del Proveedor</label>
                                    <input id="supplier-name" type="text" class="modern-input w-full" placeholder="Ej: Metales del Norte SA">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Especialidad</label>
                                    <select id="supplier-specialty" class="modern-input w-full">
                                        <option value="">Seleccionar especialidad</option>
                                        <option value="metales">Metales y Aleaciones</option>
                                        <option value="herramientas">Herramientas de Corte</option>
                                        <option value="consumibles">Consumibles</option>
                                        <option value="equipos">Equipos y Maquinaria</option>
                                        <option value="servicios">Servicios Especializados</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Contacto Principal</label>
                                    <input id="supplier-contact" type="text" class="modern-input w-full" placeholder="Nombre del contacto">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                                        <input id="supplier-phone" type="tel" class="modern-input w-full" placeholder="555-1234">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                        <input id="supplier-email" type="email" class="modern-input w-full" placeholder="contacto@empresa.com">
                                    </div>
                                </div>
                                <button id="save-supplier" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-save mr-2"></i>Guardar Proveedor
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purchase Orders -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-file-invoice text-indigo-500 mr-3"></i>
                        Órdenes de Compra
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Órdenes Recientes</h4>
                            <div class="flex items-center gap-3 mb-3">
                                <select id="po-filter-status" class="modern-input">
                                    <option value="">Estado: Todos</option>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="entregado">Entregado</option>
                                </select>
                                <input id="po-filter-supplier" class="modern-input" placeholder="Filtrar por proveedor" />
                            </div>
                            <div class="space-y-3" id="purchase-orders-list">
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="font-medium text-slate-800">PO-2024-001</h5>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">Pendiente</span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-2">Acero inoxidable 316L - 50kg</p>
                                    <div class="flex items-center justify-between text-xs text-slate-500">
                                        <span>Proveedor: ABC Metales</span>
                                        <span>Fecha: 15/01/2024</span>
                                    </div>
                                </div>
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="font-medium text-slate-800">PO-2024-002</h5>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Entregado</span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-2">Fresas HSS - Set completo</p>
                                    <div class="flex items-center justify-between text-xs text-slate-500">
                                        <span>Proveedor: CNC Pro</span>
                                        <span>Fecha: 10/01/2024</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Nueva Orden de Compra</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Proveedor</label>
                                    <select id="po-supplier" class="modern-input w-full">
                                        <option value="">Seleccionar proveedor</option>
                                        <option value="abc">Proveedor de Metales ABC</option>
                                        <option value="cnc">Herramientas CNC Pro</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Material/Producto</label>
                                    <input id="po-item" type="text" class="modern-input w-full" placeholder="Ej: Acero inoxidable 316L">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Cantidad</label>
                                        <input id="po-quantity" type="number" class="modern-input w-full" placeholder="50">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Unidad</label>
                                        <select id="po-unit" class="modern-input w-full">
                                            <option value="kg">Kilogramos</option>
                                            <option value="piezas">Piezas</option>
                                            <option value="metros">Metros</option>
                                            <option value="litros">Litros</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Proyecto Relacionado</label>
                                    <select id="po-project" class="modern-input w-full">
                                        <option value="">Seleccionar proyecto (opcional)</option>
                                        <option value="proj1">PO-2024-001 - Ejes para motor</option>
                                        <option value="proj2">PO-2024-002 - Bridas de conexión</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Notas</label>
                                    <textarea id="po-notes" rows="3" class="modern-input w-full" placeholder="Especificaciones adicionales..."></textarea>
                                </div>
                                <button id="create-purchase-order" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Crear Orden de Compra
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Purchase Insights -->
                <div class="glass-card p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6">
                        <i class="fas fa-chart-line text-cyan-500 mr-3"></i>
                        Insights de Compras IA
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-trending-up text-white"></i>
                                </div>
                                <h4 class="font-semibold text-blue-800">Tendencias de Uso</h4>
                            </div>
                            <p class="text-sm text-blue-700 mb-2">El acero inoxidable ha aumentado un 25% en los últimos 3 meses</p>
                            <div class="text-xs text-blue-600">Recomendación: Considerar compra a granel</div>
                        </div>

                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-dollar-sign text-white"></i>
                                </div>
                                <h4 class="font-semibold text-green-800">Optimización de Costos</h4>
                            </div>
                            <p class="text-sm text-green-700 mb-2">Comprando en lotes de 100kg puedes ahorrar 15%</p>
                            <div class="text-xs text-green-600">Ahorro estimado: $2,400/mes</div>
                        </div>

                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-clock text-white"></i>
                                </div>
                                <h4 class="font-semibold text-purple-800">Predicción de Necesidades</h4>
                            </div>
                            <p class="text-sm text-purple-700 mb-2">Se necesitarán 80kg de aluminio en 2 semanas</p>
                            <div class="text-xs text-purple-600">Basado en proyectos programados</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Interface -->
    <div id="ai-chat" class="ai-chat">
        <div class="ai-chat-header">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h3 class="font-semibold">Asistente IA</h3>
                    <p class="text-sm opacity-90">Tu cerebro de gestión de proyectos</p>
                </div>
            </div>
            <button id="close-ai-chat" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ai-messages" id="ai-messages">
            <div class="ai-message bot">
                <div class="ai-message-content">
                    <p>¡Hola! Soy tu asistente de proyectos IA. Puedo ayudarte con:</p>
                    <ul class="mt-2 text-sm">
                        <li>• Análisis de proyectos e insights</li>
                        <li>• Predicciones de fechas límite</li>
                        <li>• Optimización de recursos</li>
                        <li>• Evaluación de riesgos</li>
                    </ul>
                    <p class="mt-2">¿Qué te gustaría saber sobre tus proyectos?</p>
                </div>
            </div>
        </div>
        <div class="ai-input-container">
            <input type="text" id="ai-input" class="ai-input" placeholder="Pregúntame cualquier cosa sobre tus proyectos...">
        </div>
    </div>

    <!-- AI Chat Toggle Button -->
    <button id="ai-chat-toggle" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-purple-500 to-blue-500 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center z-50">
        <i class="fas fa-robot text-xl"></i>
    </button>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 bg-slate-900 bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-user-lock text-white text-xl"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-semibold text-slate-800">Iniciar sesión</h3>
                    <p class="text-slate-600 text-sm">Accede con tu usuario para continuar</p>
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                    <input id="auth-email" type="email" class="modern-input w-full" placeholder="tu@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Contraseña</label>
                    <input id="auth-password" type="password" class="modern-input w-full" placeholder="********">
                </div>
                <div class="flex items-center justify-between">
                    <button id="auth-login" class="modern-button">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                    <button id="auth-register" class="modern-button bg-slate-600 hover:bg-slate-700">
                        <i class="fas fa-user-plus mr-2"></i>Crear cuenta
                    </button>
                </div>
                <p id="auth-error" class="text-sm text-red-600 hidden"></p>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy, Timestamp, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-workshop-bot';
        const firebaseConfig = {
            apiKey: "AIzaSyD6aTV9nIYz4_QdZRs-Bx5pLScI8lmY_ag",
            authDomain: "cerebro-proyecto-smv.firebaseapp.com",
            projectId: "cerebro-proyecto-smv",
            storageBucket: "cerebro-proyecto-smv.firebasestorage.app",
            messagingSenderId: "899383982708",
            appId: "1:899383982708:web:247457d9c08436b6b3ef21",
            measurementId: "G-MD27C2HZ79"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let currentUser = null;
        let currentUserRole = 'viewer';
        let projectsCollection;
        let allProjects = [];
        let aiLearningData = {
            projectPatterns: {},
            completionTimes: {},
            efficiencyScore: 0,
            insights: [],
            predictions: []
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // --- DOM Elements ---
        const addProjectForm = document.getElementById('add-project-form');
        const smartEntryTextarea = document.getElementById('smart-entry');
        const poNumberInput = document.getElementById('po-number');
        const projectDescriptionInput = document.getElementById('project-description');
        const dueDateInput = document.getElementById('due-date');
        const projectList = document.getElementById('project-list');
        const noProjectsMessage = document.getElementById('no-projects-message');
        const loadingSpinner = document.getElementById('loading-spinner');

        // New DOM elements
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const aiChat = document.getElementById('ai-chat');
        const aiChatToggle = document.getElementById('ai-chat-toggle');
        const closeAiChat = document.getElementById('close-ai-chat');
        const aiInput = document.getElementById('ai-input');
        const aiMessages = document.getElementById('ai-messages');
        const authScreen = document.getElementById('auth-screen');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authLoginBtn = document.getElementById('auth-login');
        const authRegisterBtn = document.getElementById('auth-register');
        const authError = document.getElementById('auth-error');

        // --- Auth lifecycle ---
        setupAuthHandlers();
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (!user) {
                showApp(false);
                return;
            }
            showApp(true);
            const role = await loadUserRole(user.uid);
            applyRoleUI(role);
        });

        // --- Auth + Roles ---
        async function loadUserRole(userId) {
            try {
                const userDocRef = doc(getFirestore(), 'users', userId);
                const snap = await (await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js')).getDoc(userDocRef);
                if (snap.exists()) {
                    const data = snap.data();
                    return data.role || 'viewer';
                }
            } catch (e) {
                console.warn('No se pudo cargar rol:', e);
            }
            return 'viewer';
        }

        function applyRoleUI(role) {
            currentUserRole = role;
            const purchasingTabBtn = document.querySelector('.nav-tab[data-tab="purchasing"]');
            const purchasingTabContent = document.getElementById('purchasing-tab');
            const isAllowed = role === 'admin' || role === 'compras';
            if (purchasingTabBtn) {
                if (!isAllowed) {
                    purchasingTabBtn.classList.add('hidden');
                } else {
                    purchasingTabBtn.classList.remove('hidden');
                }
            }
            if (purchasingTabContent) {
                if (!isAllowed && !purchasingTabContent.classList.contains('hidden')) {
                    document.querySelector('[data-tab="dashboard"]').click();
                }
            }
        }

        function showApp(show) {
            const appRoot = document.querySelector('.container.mx-auto');
            if (!appRoot) return;
            if (show) {
                authScreen.classList.add('hidden');
                appRoot.classList.remove('opacity-0');
            } else {
                authScreen.classList.remove('hidden');
                appRoot.classList.add('opacity-0');
            }
        }

        function setupAuthHandlers() {
            authLoginBtn?.addEventListener('click', async () => {
                authError.classList.add('hidden');
                try {
                    const cred = await signInWithEmailAndPassword(auth, authEmail.value.trim(), authPassword.value.trim());
                    currentUser = cred.user;
                } catch (e) {
                    authError.textContent = e.message || 'Error al iniciar sesión';
                    authError.classList.remove('hidden');
                }
            });
            authRegisterBtn?.addEventListener('click', async () => {
                authError.classList.add('hidden');
                try {
                    const cred = await createUserWithEmailAndPassword(auth, authEmail.value.trim(), authPassword.value.trim());
                    currentUser = cred.user;
                    // Default role viewer document using uid as doc id
                    const userDoc = doc(db, 'users', currentUser.uid);
                    await setDoc(userDoc, { uid: currentUser.uid, role: 'viewer', email: currentUser.email, createdAt: Timestamp.now() }, { merge: true });
                } catch (e) {
                    authError.textContent = e.message || 'Error al registrar';
                    authError.classList.remove('hidden');
                }
            });
        }
        class AILearningSystem {
            constructor() {
                this.patterns = new Map();
                this.insights = [];
                this.predictions = [];
                this.learningProgress = 0;
                this.workshopKnowledge = {
                    capabilities: {
                        cnc_lathe: {
                            axes: 3,
                            max_diameter: 500,
                            precision: 0.01,
                            materials: ['acero', 'aluminio', 'titanio']
                        },
                        milling_machine: {
                            table_size: '1000x500',
                            axes: 4,
                            precision: 0.005,
                            capabilities: ['fresado_3d', 'geometrias_complejas']
                        },
                        automation: {
                            robots: 'KUKA',
                            features: ['carga_automatica', 'vision_inspection', '24_7_operation']
                        }
                    },
                    projectTypes: {
                        lathe: ['ejes_husillos', 'bridas_conexiones', 'tornillos_tuercas', 'piezas_cilindricas'],
                        milling: ['bases_soportes', 'moldes_matrices', 'geometrias_complejas', 'prototipos']
                    },
                    materials: ['acero_inoxidable', 'aluminio', 'titanio', 'aceros_especiales'],
                    tolerances: {
                        standard: 0.01,
                        precision: 0.005,
                        high_precision: 0.001
                    }
                };
                this.webSearchEnabled = false;
            }

            analyzeProject(project) {
                // Analyze project description for patterns
                const description = project.description.toLowerCase();
                const keywords = this.extractKeywords(description);
                
                // Enhanced analysis with workshop knowledge
                const projectType = this.classifyProjectType(description);
                const material = this.identifyMaterial(description);
                const complexity = this.assessComplexity(description, projectType);
                
                keywords.forEach(keyword => {
                    if (!this.patterns.has(keyword)) {
                        this.patterns.set(keyword, {
                            count: 0,
                            avgDuration: 0,
                            completionRate: 0,
                            difficulty: 'medium',
                            projectType: projectType,
                            material: material,
                            complexity: complexity
                        });
                    }
                    
                    const pattern = this.patterns.get(keyword);
                    pattern.count++;
                    
                    // Calculate average duration based on project type and workshop capabilities
                    const estimatedDuration = this.estimateDurationWithWorkshopKnowledge(description, projectType, material, complexity);
                    pattern.avgDuration = (pattern.avgDuration * (pattern.count - 1) + estimatedDuration) / pattern.count;
                });

                this.updateLearningProgress();
                this.generateInsights();
                this.generatePredictions();
            }

            classifyProjectType(description) {
                // Classify based on integrated workflow
                const lowerDesc = description.toLowerCase();
                
                // Integrated projects (most common)
                if (lowerDesc.includes('sistema') || lowerDesc.includes('completo') || lowerDesc.includes('integrado')) {
                    return 'integrated';
                }
                
                // Precision parts that use all tools
                if (lowerDesc.includes('precision') || lowerDesc.includes('tolerancia') || lowerDesc.includes('calibracion')) {
                    return 'precision';
                }
                
                // Automation projects
                if (lowerDesc.includes('automatizacion') || lowerDesc.includes('robot') || lowerDesc.includes('cnc') || 
                    lowerDesc.includes('programacion') || lowerDesc.includes('control')) {
                    return 'automation';
                }
                
                // Prototype development
                if (lowerDesc.includes('prototipo') || lowerDesc.includes('desarrollo') || lowerDesc.includes('prueba')) {
                    return 'prototype';
                }
                
                // Maintenance and repair
                if (lowerDesc.includes('mantenimiento') || lowerDesc.includes('reparacion') || lowerDesc.includes('revision')) {
                    return 'maintenance';
                }
                
                // Default to integrated workflow
                return 'integrated';
            }

            identifyMaterial(description) {
                const materials = this.workshopKnowledge.materials;
                for (const material of materials) {
                    if (description.includes(material.replace('_', ' '))) {
                        return material;
                    }
                }
                return 'unknown';
            }

            assessComplexity(description, projectType) {
                let complexity = 'medium';
                
                // Check for complexity indicators
                if (description.includes('precision') || description.includes('tolerancia') || description.includes('±0.001')) {
                    complexity = 'high';
                } else if (description.includes('simple') || description.includes('basico')) {
                    complexity = 'low';
                }
                
                // Adjust based on project type
                if (projectType === 'automation') complexity = 'high';
                if (projectType === 'lathe' && description.includes('cnc')) complexity = 'high';
                
                return complexity;
            }

            estimateDurationWithWorkshopKnowledge(description, projectType, material, complexity) {
                let baseDays = 5; // Base duration for integrated projects
                
                // Adjust based on integrated project type
                switch (projectType) {
                    case 'integrated':
                        baseDays = 5; // Standard integrated project (torno + fresado + automatización)
                        break;
                    case 'precision':
                        baseDays = 7; // Precision work requires more time
                        break;
                    case 'automation':
                        baseDays = 8; // Complex automation integration
                        break;
                    case 'prototype':
                        baseDays = 6; // Prototype development
                        break;
                    case 'maintenance':
                        baseDays = 3; // Maintenance is usually faster
                        break;
                }
                
                // Adjust based on material (affects all processes)
                if (material === 'titanio') baseDays += 3; // Titanium is harder to work with
                if (material === 'acero_inoxidable') baseDays += 2;
                if (material === 'aluminio') baseDays += 0; // Aluminum is easier
                
                // Adjust based on complexity
                if (complexity === 'high') baseDays += 4; // High complexity affects all stages
                if (complexity === 'low') baseDays = Math.max(2, baseDays - 2);
                
                // Check for specific keywords that affect integrated workflow
                if (description.includes('urgente')) baseDays = Math.max(2, baseDays - 1);
                if (description.includes('prototipo')) baseDays += 2; // Prototypes need more testing
                if (description.includes('serie') || description.includes('lote')) baseDays += 3; // Series require setup time
                if (description.includes('calibracion') || description.includes('pruebas')) baseDays += 2; // Testing phase
                if (description.includes('programacion')) baseDays += 1; // CNC programming time
                
                return baseDays;
            }

            extractKeywords(description) {
                const commonWords = ['for', 'and', 'the', 'with', 'from', 'to', 'of', 'in', 'on', 'at', 'by'];
                return description
                    .split(/\s+/)
                    .filter(word => word.length > 3 && !commonWords.includes(word))
                    .slice(0, 5); // Top 5 keywords
            }

            estimateDuration(description) {
                // Simple duration estimation based on keywords
                let baseDays = 7;
                if (description.includes('flange')) baseDays += 3;
                if (description.includes('complex')) baseDays += 5;
                if (description.includes('urgent')) baseDays -= 2;
                if (description.includes('simple')) baseDays -= 2;
                return baseDays;
            }

            updateLearningProgress() {
                this.learningProgress = Math.min(100, this.patterns.size * 10);
                document.getElementById('ai-learning-progress').style.width = `${this.learningProgress}%`;
                document.getElementById('learning-percentage').textContent = `${this.learningProgress}%`;
            }

            generateInsights() {
                this.insights = [];
                
                // Generate insights based on patterns
                for (const [keyword, data] of this.patterns) {
                    if (data.count > 2) {
                        if (data.avgDuration > 10) {
                            this.insights.push({
                                type: 'warning',
                                message: `Los proyectos con "${keyword}" tienden a tomar ${Math.round(data.avgDuration)} días en promedio. Considera agregar tiempo de buffer.`
                            });
                        }
                        
                        if (data.completionRate > 0.9) {
                            this.insights.push({
                                type: 'success',
                                message: `¡Excelente! Los proyectos con "${keyword}" tienen una tasa de finalización del ${Math.round(data.completionRate * 100)}%.`
                            });
                        }
                    }
                }

                // Update UI with insights
                this.updateInsightsUI();
            }

            generatePredictions() {
                this.predictions = [];
                
                // Predict project success based on patterns
                const upcomingProjects = allProjects.filter(p => {
                    const dueDate = p.dueDate.toDate();
                    const today = new Date();
                    return dueDate > today;
                });

                if (upcomingProjects.length > 0) {
                    const riskProjects = upcomingProjects.filter(p => {
                        const keywords = this.extractKeywords(p.description.toLowerCase());
                        return keywords.some(k => {
                            const pattern = this.patterns.get(k);
                            return pattern && pattern.avgDuration > 10;
                        });
                    });

                    if (riskProjects.length > 0) {
                        this.predictions.push({
                            type: 'warning',
                            message: `${riskProjects.length} proyectos pueden estar en riesgo de retraso basándose en patrones históricos.`
                        });
                    }
                }

                this.updatePredictionsUI();
            }

            updateInsightsUI() {
                const insightElement = document.getElementById('ai-insight-text');
                if (this.insights.length > 0) {
                    insightElement.textContent = this.insights[0].message;
                }
            }

            updatePredictionsUI() {
                const predictionElement = document.getElementById('ai-prediction-text');
                if (this.predictions.length > 0) {
                    predictionElement.textContent = this.predictions[0].message;
                }
            }

            getAIResponse(userMessage) {
                const message = userMessage.toLowerCase();
                
                if (message.includes('proyecto') && (message.includes('estado') || message.includes('status'))) {
                    return `Actualmente tienes ${allProjects.length} proyectos activos. ${allProjects.filter(p => {
                        const dueDate = p.dueDate.toDate();
                        const today = new Date();
                        return dueDate < today;
                    }).length} están atrasados.`;
                }
                
                if (message.includes('taller') || message.includes('capacidades') || message.includes('equipos')) {
                    return `Tu taller cuenta con un flujo de trabajo integrado que combina: Torno CNC de 3 ejes (500mm diámetro), Fresadora vertical (1000x500mm), y Sistema de automatización KUKA. Los proyectos utilizan todas estas herramientas en conjunto para crear sistemas mecánicos completos con precisiones de ±0.01mm.`;
                }
                
                if (message.includes('proyecto') || message.includes('trabajo') || message.includes('orden')) {
                    return `Los proyectos en tu taller siguen un flujo integrado: 1) Planificación, 2) Torneado CNC, 3) Fresado, 4) Integración de automatización, 5) Pruebas y calibración. Cada proyecto utiliza todas las herramientas disponibles para crear sistemas completos y funcionales.`;
                }
                
                if (message.includes('tiempo') || message.includes('duracion') || message.includes('estimacion')) {
                    return `Para proyectos integrados (torno + fresado + automatización): proyectos estándar toman 5-7 días, de precisión 7-9 días, automatización compleja 8-10 días. Los materiales como titanio añaden 3 días, y la complejidad alta +4 días. El tiempo incluye todas las etapas del flujo integrado.`;
                }
                
                if (message.includes('material') || message.includes('aleacion')) {
                    return `Trabajamos con: acero inoxidable, aluminio, titanio, y aceros especiales. El titanio requiere más tiempo de mecanizado (+2 días), mientras que el aluminio es más rápido de procesar.`;
                }
                
                if (message.includes('tiempo') || message.includes('duracion') || message.includes('estimacion')) {
                    return `Basándome en las capacidades de tu taller: proyectos de torno toman 2-3 días, fresado 4-6 días, automatización 7+ días. Los materiales como titanio añaden 2 días, y la complejidad alta +3 días.`;
                }
                
                if (message.includes('insight') || message.includes('análisis') || message.includes('analisis')) {
                    return `Basándome en tus patrones de proyectos y conocimiento del taller, he identificado ${this.patterns.size} patrones clave. Los tipos de proyectos más comunes son: ${Array.from(this.patterns.keys()).slice(0, 3).join(', ')}.`;
                }
                
                if (message.includes('predicción') || message.includes('prediccion') || message.includes('forecast')) {
                    return `Predigo que completarás aproximadamente ${Math.round(allProjects.length * 0.85)} proyectos a tiempo este mes basándome en la carga de trabajo actual, capacidades del taller y datos históricos.`;
                }
                
                if (message.includes('whatsapp') || message.includes('recordatorio') || message.includes('notificacion')) {
                    return `El sistema de WhatsApp está configurado para enviar recordatorios automáticos a tu equipo. Puedes configurar: recordatorios tempranos (7 días antes), urgentes (1 día antes), y para proyectos atrasados. Los mensajes se envían solo en horario laboral (8:00-18:00).`;
                }
                
                if (message.includes('compra') || message.includes('material') || message.includes('proveedor') || message.includes('orden de compra')) {
                    const activeProjects = allProjects.filter(project => 
                        project.dueDate && new Date(project.dueDate) >= new Date()
                    );
                    
                    if (activeProjects.length === 0) {
                        return `No hay proyectos activos para analizar materiales. Una vez que agregues proyectos, podré recomendarte materiales y herramientas necesarias basándome en las descripciones de los proyectos.`;
                    }
                    
                    const materialNeeds = analyzeProjectMaterials(activeProjects);
                    if (materialNeeds.length === 0) {
                        return `He analizado ${activeProjects.length} proyecto(s) activo(s) pero no he identificado materiales específicos en las descripciones. Para mejores recomendaciones, incluye palabras como "acero inoxidable", "aluminio", "titanio", "fresas", o "brocas" en las descripciones de proyectos.`;
                    }
                    
                    const urgentNeeds = materialNeeds.filter(need => need.priority === 'high');
                    const mediumNeeds = materialNeeds.filter(need => need.priority === 'medium');
                    
                    let response = `Basándome en ${activeProjects.length} proyecto(s) activo(s), he identificado ${materialNeeds.length} necesidades de materiales/herramientas:\n\n`;
                    
                    if (urgentNeeds.length > 0) {
                        response += `🚨 *URGENTE* (${urgentNeeds.length}):\n`;
                        urgentNeeds.forEach(need => {
                            response += `• ${need.name} - para ${need.relatedProjects.join(', ')}\n`;
                        });
                        response += '\n';
                    }
                    
                    if (mediumNeeds.length > 0) {
                        response += `⚠️ *MEDIO* (${mediumNeeds.length}):\n`;
                        mediumNeeds.forEach(need => {
                            response += `• ${need.name} - para ${need.relatedProjects.join(', ')}\n`;
                        });
                    }
                    
                    response += `\nVe a la pestaña "Compras" para ver recomendaciones detalladas y crear órdenes de compra.`;
                    return response;
                }
                
                if (message.includes('proveedor') || message.includes('supplier')) {
                    return `Para gestionar proveedores, ve a la pestaña "Compras" → "Gestión de Proveedores". Puedes agregar nuevos proveedores con sus especialidades (metales, herramientas, consumibles) y contactos. El sistema te ayudará a mantener un registro organizado de tus proveedores frecuentes.`;
                }
                
                if (message.includes('ayuda') || message.includes('help') || message.includes('qué puedes hacer') || message.includes('que puedes hacer')) {
                    return `Puedo ayudarte con: análisis de proyectos específicos de tu taller (torno, fresado, automatización), predicciones de tiempos basadas en equipos CNC, identificación de materiales y complejidad, optimización de recursos, insights sobre patrones de trabajo industrial, gestión de recordatorios por WhatsApp para tu equipo, y análisis de compras y materiales necesarios. ¿Qué te gustaría saber?`;
                }
                
                return `Entiendo que estás preguntando sobre "${userMessage}". Basándome en el conocimiento de tu taller de torno con fresadora y automatización, puedo proporcionar insights específicos sobre proyectos CNC, tiempos de producción, materiales, capacidades, y gestión de compras. ¿Podrías ser más específico?`;
            }
        }

        const aiSystem = new AILearningSystem();

        // --- WhatsApp Manager System ---
        class WhatsAppManager {
            constructor() {
                this.apiToken = '';
                this.phoneId = '';
                this.verifyToken = '';
                this.teamMembers = [
                    { name: 'Juan Pérez', phone: '+525551234567', notifications: true },
                    { name: 'María García', phone: '+525559876543', notifications: true }
                ];
                this.templates = {
                    due: {
                        title: 'Recordatorio de Vencimiento',
                        message: '🚨 *Recordatorio de Proyecto*\nPO #{{PO_NUMBER}} vence {{DUE_DATE}}\n{{PROJECT_DESCRIPTION}}\n_Taller de Torno CNC_'
                    },
                    overdue: {
                        title: 'Proyecto Atrasado',
                        message: '⚠️ *PROYECTO ATRASADO*\nPO #{{PO_NUMBER}} - {{DAYS_OVERDUE}} días atrasado\n{{PROJECT_DESCRIPTION}}\n_Acción requerida inmediatamente_'
                    },
                    completed: {
                        title: 'Proyecto Completado',
                        message: '✅ *Proyecto Completado*\nPO #{{PO_NUMBER}} finalizado exitosamente\n{{PROJECT_DESCRIPTION}}\n_¡Excelente trabajo!_'
                    }
                };
                this.reminderSettings = {
                    early: { enabled: true, days: 7 },
                    urgent: { enabled: true, days: 1 },
                    overdue: { enabled: true, days: 0 },
                    startTime: '08:00',
                    endTime: '18:00'
                };
                this.notificationHistory = [];
            }

            setCredentials(token, phoneId, verifyToken) {
                this.apiToken = token;
                this.phoneId = phoneId;
                this.verifyToken = verifyToken;
            }

            async sendMessage(phoneNumber, message) {
                if (!this.apiToken || !this.phoneId) {
                    throw new Error('WhatsApp API no configurada');
                }

                const url = `https://graph.facebook.com/v18.0/${this.phoneId}/messages`;
                const payload = {
                    messaging_product: 'whatsapp',
                    to: phoneNumber,
                    type: 'text',
                    text: { body: message }
                };

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error.message);
                    }

                    return result;
                } catch (error) {
                    console.error('Error enviando mensaje WhatsApp:', error);
                    throw error;
                }
            }

            formatMessage(template, project) {
                let message = template.message;
                const dueDate = project.dueDate.toDate();
                const today = new Date();
                const diffDays = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                
                message = message.replace('{{PO_NUMBER}}', project.poNumber);
                message = message.replace('{{PROJECT_DESCRIPTION}}', project.description);
                message = message.replace('{{DUE_DATE}}', dueDate.toLocaleDateString('es-ES'));
                message = message.replace('{{DAYS_OVERDUE}}', Math.abs(diffDays));
                
                return message;
            }

            async sendProjectReminder(project, reminderType) {
                const template = this.templates[reminderType];
                if (!template) return;

                const message = this.formatMessage(template, project);
                const results = [];

                for (const member of this.teamMembers) {
                    if (member.notifications) {
                        try {
                            const result = await this.sendMessage(member.phone, message);
                            results.push({
                                member: member.name,
                                phone: member.phone,
                                status: 'sent',
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        } catch (error) {
                            results.push({
                                member: member.name,
                                phone: member.phone,
                                status: 'error',
                                error: error.message,
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        }
                    }
                }

                this.notificationHistory.unshift(...results);
                return results;
            }

            checkReminders(projects) {
                const now = new Date();
                const currentHour = now.getHours();
                const startHour = parseInt(this.reminderSettings.startTime.split(':')[0]);
                const endHour = parseInt(this.reminderSettings.endTime.split(':')[0]);

                // Solo enviar recordatorios en horario laboral
                if (currentHour < startHour || currentHour > endHour) {
                    return;
                }

                projects.forEach(project => {
                    const dueDate = project.dueDate.toDate();
                    const diffDays = Math.ceil((dueDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

                    // Recordatorio temprano (7 días antes)
                    if (this.reminderSettings.early.enabled && diffDays === 7) {
                        this.sendProjectReminder(project, 'due');
                    }

                    // Recordatorio urgente (1 día antes)
                    if (this.reminderSettings.urgent.enabled && diffDays === 1) {
                        this.sendProjectReminder(project, 'due');
                    }

                    // Proyecto atrasado
                    if (this.reminderSettings.overdue.enabled && diffDays < 0) {
                        this.sendProjectReminder(project, 'overdue');
                    }
                });
            }

            async testConnection() {
                if (!this.apiToken || !this.phoneId) {
                    throw new Error('Configuración de API incompleta');
                }

                // Test con el primer miembro del equipo
                const testMember = this.teamMembers[0];
                const testMessage = '🧪 *Prueba de Conexión*\nSistema de recordatorios WhatsApp funcionando correctamente.\n_Taller de Torno CNC_';

                return await this.sendMessage(testMember.phone, testMessage);
            }

            addTeamMember(name, phone) {
                this.teamMembers.push({
                    name: name,
                    phone: phone,
                    notifications: true
                });
            }

            updateReminderSettings(settings) {
                this.reminderSettings = { ...this.reminderSettings, ...settings };
            }

            getNotificationHistory() {
                return this.notificationHistory;
            }
        }

        const whatsappManager = new WhatsAppManager();

        // --- Multi-Channel Notification System ---
        class MultiChannelNotificationManager {
            constructor() {
                this.selectedMethod = 'browser'; // Default to browser notifications
                this.emailConfig = {
                    smtpServer: '',
                    smtpPort: 587,
                    email: '',
                    password: '',
                    subject: 'Recordatorio de Proyecto - PO #{{PO_NUMBER}}',
                    template: 'Estimado equipo,\n\nEl proyecto PO #{{PO_NUMBER}} vence el {{DUE_DATE}}.\nDescripción: {{PROJECT_DESCRIPTION}}\n\nSaludos,\nSistema de Recordatorios'
                };
                this.whatsappWebConfig = {
                    mainNumber: '',
                    introMessage: 'Hola! Soy el sistema de recordatorios del taller...'
                };
                this.browserConfig = {
                    sound: true,
                    vibrate: true,
                    persistent: false
                };
            }

            setNotificationMethod(method) {
                this.selectedMethod = method;
            }

            async sendNotification(project, reminderType, teamMembers) {
                const message = this.formatMessage(reminderType, project);
                
                switch (this.selectedMethod) {
                    case 'whatsapp-business':
                        return await whatsappManager.sendProjectReminder(project, reminderType);
                    
                    case 'whatsapp-web':
                        return await this.sendWhatsAppWebNotification(project, message, teamMembers);
                    
                    case 'email':
                        return await this.sendEmailNotification(project, message, teamMembers);
                    
                    case 'browser':
                        return await this.sendBrowserNotification(project, message);
                    
                    default:
                        throw new Error('Método de notificación no válido');
                }
            }

            formatMessage(reminderType, project) {
                const templates = {
                    due: '🚨 *Recordatorio de Proyecto*\nPO #{{PO_NUMBER}} vence {{DUE_DATE}}\n{{PROJECT_DESCRIPTION}}\n_Taller de Torno CNC_',
                    overdue: '⚠️ *PROYECTO ATRASADO*\nPO #{{PO_NUMBER}} - {{DAYS_OVERDUE}} días atrasado\n{{PROJECT_DESCRIPTION}}\n_Acción requerida inmediatamente_',
                    completed: '✅ *Proyecto Completado*\nPO #{{PO_NUMBER}} finalizado exitosamente\n{{PROJECT_DESCRIPTION}}\n_¡Excelente trabajo!_'
                };

                let message = templates[reminderType] || templates.due;
                const dueDate = project.dueDate.toDate();
                const today = new Date();
                const diffDays = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                
                message = message.replace('{{PO_NUMBER}}', project.poNumber);
                message = message.replace('{{PROJECT_DESCRIPTION}}', project.description);
                message = message.replace('{{DUE_DATE}}', dueDate.toLocaleDateString('es-ES'));
                message = message.replace('{{DAYS_OVERDUE}}', Math.abs(diffDays));
                
                return message;
            }

            async sendWhatsAppWebNotification(project, message, teamMembers) {
                const results = [];
                const encodedMessage = encodeURIComponent(message);
                
                for (const member of teamMembers) {
                    if (member.notifications) {
                        const whatsappUrl = `https://wa.me/${member.phone.replace(/\D/g, '')}?text=${encodedMessage}`;
                        
                        // Open WhatsApp Web in new tab
                        window.open(whatsappUrl, '_blank');
                        
                        results.push({
                            member: member.name,
                            phone: member.phone,
                            status: 'opened',
                            timestamp: new Date(),
                            project: project.poNumber,
                            url: whatsappUrl
                        });
                    }
                }
                
                return results;
            }

            async sendEmailNotification(project, message, teamMembers) {
                const results = [];
                
                // This would typically use a backend service to send emails
                // For now, we'll simulate the email sending
                for (const member of teamMembers) {
                    if (member.notifications && member.email) {
                        try {
                            // Simulate email sending
                            console.log(`Sending email to ${member.email}: ${message}`);
                            
                            results.push({
                                member: member.name,
                                email: member.email,
                                status: 'sent',
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        } catch (error) {
                            results.push({
                                member: member.name,
                                email: member.email,
                                status: 'error',
                                error: error.message,
                                timestamp: new Date(),
                                project: project.poNumber
                            });
                        }
                    }
                }
                
                return results;
            }

            async sendBrowserNotification(project, message) {
                if (!('Notification' in window)) {
                    throw new Error('Este navegador no soporta notificaciones');
                }

                if (Notification.permission === 'denied') {
                    throw new Error('Permisos de notificación denegados');
                }

                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('Permisos de notificación denegados');
                    }
                }

                const notification = new Notification('Recordatorio de Proyecto', {
                    body: message,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico',
                    tag: `project-${project.poNumber}`,
                    requireInteraction: this.browserConfig.persistent,
                    silent: !this.browserConfig.sound,
                    vibrate: this.browserConfig.vibrate ? [200, 100, 200] : undefined
                });

                // Auto-close after 10 seconds unless persistent
                if (!this.browserConfig.persistent) {
                    setTimeout(() => notification.close(), 10000);
                }

                return [{
                    member: 'Usuario actual',
                    status: 'sent',
                    timestamp: new Date(),
                    project: project.poNumber
                }];
            }

            updateEmailConfig(config) {
                this.emailConfig = { ...this.emailConfig, ...config };
            }

            updateWhatsAppWebConfig(config) {
                this.whatsappWebConfig = { ...this.whatsappWebConfig, ...config };
            }

            updateBrowserConfig(config) {
                this.browserConfig = { ...this.browserConfig, ...config };
            }
        }

        const multiChannelManager = new MultiChannelNotificationManager();

        // --- Settings Management System ---
        class SettingsManager {
            constructor() {
                this.settings = {
                    workshop: {
                        name: 'Taller de Torno CNC Emilio',
                        address: '',
                        phone: '',
                        email: '',
                        specialties: ['integrated', 'prototyping', 'maintenance', 'custom'],
                        productionCapacity: 'medium',
                        timezone: 'America/Mexico_City'
                    },
                    projects: {
                        poPrefix: 'PO',
                        poFormat: 'sequential',
                        customFormat: 'PO-{YYYY}-{MM}-{###}',
                        warningDays: {
                            early: 7,
                            urgent: 1,
                            critical: 0
                        },
                        categories: ['Sistema Mecánico Completo', 'Piezas de Precisión', 'Automatización Industrial', 'Prototipo Integrado'],
                        statuses: ['planning', 'turning', 'milling', 'automation', 'testing', 'completed']
                    },
                    notifications: {
                        workHours: {
                            start: '08:00',
                            end: '18:00',
                            workdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
                        },
                        checkFrequency: 30, // minutes
                        types: {
                            email: true,
                            whatsapp: true,
                            browser: true
                        },
                        sound: {
                            enabled: true,
                            vibrate: true
                        }
                    },
                    ai: {
                        learningLevel: 'intermediate',
                        analysisFrequency: 'immediate',
                        precision: 80,
                        features: {
                            patternRecognition: true,
                            durationPrediction: true,
                            riskAnalysis: true,
                            optimization: true
                        },
                        language: 'es'
                    }
                };
                this.loadSettings();
            }

            loadSettings() {
                const saved = localStorage.getItem('workshop-settings');
                if (saved) {
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                }
                this.applySettings();
            }

            saveSettings() {
                localStorage.setItem('workshop-settings', JSON.stringify(this.settings));
                this.applySettings();
                showNotification('Configuraciones guardadas exitosamente', 'success');
            }

            applySettings() {
                // Apply workshop settings
                document.getElementById('workshop-name').value = this.settings.workshop.name;
                document.getElementById('workshop-address').value = this.settings.workshop.address;
                document.getElementById('workshop-phone').value = this.settings.workshop.phone;
                document.getElementById('workshop-email').value = this.settings.workshop.email;
                
                // Apply specialties
                this.settings.workshop.specialties.forEach(specialty => {
                    const checkbox = document.getElementById(`specialty-${specialty}`);
                    if (checkbox) checkbox.checked = true;
                });
                
                document.getElementById('production-capacity').value = this.settings.workshop.productionCapacity;
                document.getElementById('timezone').value = this.settings.workshop.timezone;
                
                // Apply project settings
                document.getElementById('po-prefix').value = this.settings.projects.poPrefix;
                document.getElementById('po-format').value = this.settings.projects.poFormat;
                document.getElementById('custom-po-format').value = this.settings.projects.customFormat;
                
                if (this.settings.projects.poFormat === 'custom') {
                    document.getElementById('custom-format-container').classList.remove('hidden');
                }
                
                document.getElementById('early-warning-days').value = this.settings.projects.warningDays.early;
                document.getElementById('urgent-warning-days').value = this.settings.projects.warningDays.urgent;
                document.getElementById('critical-warning-days').value = this.settings.projects.warningDays.critical;
                
                // Apply notification settings
                document.getElementById('work-start-time').value = this.settings.notifications.workHours.start;
                document.getElementById('work-end-time').value = this.settings.notifications.workHours.end;
                
                this.settings.notifications.workHours.workdays.forEach(day => {
                    const checkbox = document.getElementById(`workday-${day}`);
                    if (checkbox) checkbox.checked = true;
                });
                
                document.getElementById('check-frequency').value = this.settings.notifications.checkFrequency;
                
                // Apply AI settings
                document.getElementById('ai-learning-level').value = this.settings.ai.learningLevel;
                document.getElementById('ai-analysis-frequency').value = this.settings.ai.analysisFrequency;
                document.getElementById('ai-precision').value = this.settings.ai.precision;
                document.getElementById('precision-value').textContent = this.settings.ai.precision + '%';
                
                Object.keys(this.settings.ai.features).forEach(feature => {
                    const checkbox = document.getElementById(`ai-${feature.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
                    if (checkbox) checkbox.checked = this.settings.ai.features[feature];
                });
                
                document.getElementById('ai-language').value = this.settings.ai.language;
            }

            updateSetting(path, value) {
                const keys = path.split('.');
                let current = this.settings;
                
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) current[keys[i]] = {};
                    current = current[keys[i]];
                }
                
                current[keys[keys.length - 1]] = value;
                this.saveSettings();
            }

            getSetting(path) {
                const keys = path.split('.');
                let current = this.settings;
                
                for (const key of keys) {
                    if (current[key] === undefined) return null;
                    current = current[key];
                }
                
                return current;
            }

            exportSettings() {
                const dataStr = JSON.stringify(this.settings, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `workshop-settings-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            importSettings(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        this.settings = { ...this.settings, ...imported };
                        this.saveSettings();
                        this.applySettings();
                        showNotification('Configuraciones importadas exitosamente', 'success');
                    } catch (error) {
                        showNotification('Error importando configuraciones: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            }

            resetToDefaults() {
                if (confirm('¿Estás seguro de que quieres restablecer todas las configuraciones a los valores por defecto?')) {
                    localStorage.removeItem('workshop-settings');
                    this.settings = new SettingsManager().settings;
                    this.applySettings();
                    showNotification('Configuraciones restablecidas', 'success');
                }
            }
        }

        const settingsManager = new SettingsManager();

        // --- Knowledge Upload System ---
        function setupKnowledgeUpload() {
            const uploadTextBtn = document.getElementById('upload-text-knowledge');
            const knowledgeText = document.getElementById('knowledge-text');
            const fileInput = document.getElementById('knowledge-files');
            const fileList = document.getElementById('file-list');
            const enableWebSearchBtn = document.getElementById('enable-web-search');

            // Text upload
            uploadTextBtn.addEventListener('click', () => {
                const text = knowledgeText.value.trim();
                if (text) {
                    aiSystem.addKnowledgeFromText(text);
                    knowledgeText.value = '';
                    showNotification('Conocimiento agregado exitosamente! La IA ha aprendido nueva información.', 'success');
                    updateKnowledgeStatus();
                }
            });

            // File upload
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type === 'text/plain' || file.type === 'application/pdf' || 
                        file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        displayFile(file);
                        processFile(file);
                    } else {
                        showNotification('Tipo de archivo no soportado: ' + file.name, 'warning');
                    }
                });
            });

            // Web search toggle
            enableWebSearchBtn.addEventListener('click', () => {
                aiSystem.toggleWebSearch();
                enableWebSearchBtn.textContent = aiSystem.webSearchEnabled ? 
                    'Desactivar Búsqueda Web' : 'Activar Búsqueda Web';
                showNotification(aiSystem.webSearchEnabled ? 
                    'Búsqueda web activada' : 'Búsqueda web desactivada', 'success');
            });

            function displayFile(file) {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-file text-slate-500 mr-3"></i>
                        <span class="text-sm font-medium">${file.name}</span>
                        <span class="text-xs text-slate-500 ml-2">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin mr-2"></div>
                        <span class="text-xs text-green-600">Procesando...</span>
                    </div>
                `;
                fileList.appendChild(fileItem);
            }

            function processFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    aiSystem.addKnowledgeFromText(content);
                    updateKnowledgeStatus();
                    
                    // Update file display
                    const fileItems = fileList.querySelectorAll('.flex.items-center.justify-between');
                    const lastItem = fileItems[fileItems.length - 1];
                    if (lastItem) {
                        lastItem.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-file text-slate-500 mr-3"></i>
                                <span class="text-sm font-medium">${file.name}</span>
                                <span class="text-xs text-slate-500 ml-2">(${(file.size / 1024).toFixed(1)} KB)</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="text-xs text-green-600">Completado</span>
                            </div>
                        `;
                    }
                };
                reader.readAsText(file);
            }
        }

        // Add methods to AI system
        AILearningSystem.prototype.addKnowledgeFromText = function(text) {
            // Extract key information from text
            const lines = text.split('\n').filter(line => line.trim());
            
            lines.forEach(line => {
                const lowerLine = line.toLowerCase();
                
                // Extract equipment specifications
                if (lowerLine.includes('torno') && lowerLine.includes('cnc')) {
                    this.updateEquipmentKnowledge('cnc_lathe', line);
                }
                if (lowerLine.includes('fresadora') || lowerLine.includes('fresado')) {
                    this.updateEquipmentKnowledge('milling_machine', line);
                }
                if (lowerLine.includes('robot') || lowerLine.includes('automatizacion')) {
                    this.updateEquipmentKnowledge('automation', line);
                }
                
                // Extract material information
                if (lowerLine.includes('material') || lowerLine.includes('aleacion')) {
                    this.updateMaterialKnowledge(line);
                }
                
                // Extract project types
                if (lowerLine.includes('proyecto') || lowerLine.includes('pieza')) {
                    this.updateProjectTypeKnowledge(line);
                }
            });
            
            this.updateLearningProgress();
        };

        AILearningSystem.prototype.updateEquipmentKnowledge = function(equipment, line) {
            // Update equipment knowledge based on new information
            if (!this.workshopKnowledge.capabilities[equipment]) {
                this.workshopKnowledge.capabilities[equipment] = {};
            }
            
            // Extract specifications from line
            const specs = this.extractSpecifications(line);
            Object.assign(this.workshopKnowledge.capabilities[equipment], specs);
        };

        AILearningSystem.prototype.updateMaterialKnowledge = function(line) {
            // Extract materials from line
            const materials = line.match(/\b(acero|aluminio|titanio|inoxidable|bronce|cobre)\b/g);
            if (materials) {
                materials.forEach(material => {
                    if (!this.workshopKnowledge.materials.includes(material)) {
                        this.workshopKnowledge.materials.push(material);
                    }
                });
            }
        };

        AILearningSystem.prototype.updateProjectTypeKnowledge = function(line) {
            // Extract project types from line
            if (line.includes('torno') || line.includes('cilindrico')) {
                this.addProjectType('lathe', line);
            }
            if (line.includes('fresado') || line.includes('mecanizado')) {
                this.addProjectType('milling', line);
            }
        };

        AILearningSystem.prototype.addProjectType = function(type, line) {
            if (!this.workshopKnowledge.projectTypes[type]) {
                this.workshopKnowledge.projectTypes[type] = [];
            }
            
            // Extract project description
            const description = line.replace(/[^\w\s]/g, '').trim();
            if (description && !this.workshopKnowledge.projectTypes[type].includes(description)) {
                this.workshopKnowledge.projectTypes[type].push(description);
            }
        };

        AILearningSystem.prototype.extractSpecifications = function(line) {
            const specs = {};
            
            // Extract dimensions
            const dimensions = line.match(/(\d+)\s*mm/g);
            if (dimensions) {
                specs.dimensions = dimensions;
            }
            
            // Extract precision
            const precision = line.match(/±?(\d+\.?\d*)\s*mm/g);
            if (precision) {
                specs.precision = precision;
            }
            
            // Extract axes
            const axes = line.match(/(\d+)\s*eje/g);
            if (axes) {
                specs.axes = parseInt(axes[0]);
            }
            
            return specs;
        };

        AILearningSystem.prototype.toggleWebSearch = function() {
            this.webSearchEnabled = !this.webSearchEnabled;
        };

        function updateKnowledgeStatus() {
            // Update knowledge status indicators
            const workshopKnowledge = document.getElementById('workshop-knowledge');
            const projectTypesKnowledge = document.getElementById('project-types-knowledge');
            const timingKnowledge = document.getElementById('timing-knowledge');
            
            if (workshopKnowledge) {
                const workshopScore = Math.min(100, Object.keys(aiSystem.workshopKnowledge.capabilities).length * 25);
                workshopKnowledge.textContent = workshopScore + '%';
                workshopKnowledge.parentElement.querySelector('.bg-green-500').style.width = workshopScore + '%';
            }
            
            if (projectTypesKnowledge) {
                const projectTypesScore = Math.min(100, Object.values(aiSystem.workshopKnowledge.projectTypes).flat().length * 10);
                projectTypesKnowledge.textContent = projectTypesScore + '%';
                projectTypesKnowledge.parentElement.querySelector('.bg-blue-500').style.width = projectTypesScore + '%';
            }
            
            if (timingKnowledge) {
                const timingScore = Math.min(100, aiSystem.patterns.size * 15);
                timingKnowledge.textContent = timingScore + '%';
                timingKnowledge.parentElement.querySelector('.bg-purple-500').style.width = timingScore + '%';
            }
        }

        // --- Tab Navigation ---
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                // Update active tab
                navTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show target content
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${targetTab}-tab`).classList.remove('hidden');
                
                // Initialize charts if analytics tab is selected
                if (targetTab === 'analytics') {
                    initializeCharts();
                }
                
                // Initialize purchasing functionality if purchasing tab is selected
                if (targetTab === 'purchasing') {
                    initializePurchasingSystem();
                }
            });
        });

        // --- AI Chat System ---
        aiChatToggle.addEventListener('click', () => {
            aiChat.classList.toggle('open');
        });

        closeAiChat.addEventListener('click', () => {
            aiChat.classList.remove('open');
        });

        aiInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && aiInput.value.trim()) {
                const userMessage = aiInput.value.trim();
                addMessageToChat('user', userMessage);
                aiInput.value = '';
                
                // Simulate AI thinking
                setTimeout(() => {
                    const aiResponse = aiSystem.getAIResponse(userMessage);
                    addMessageToChat('bot', aiResponse);
                }, 1000);
            }
        });

        function addMessageToChat(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            messageDiv.innerHTML = `
                <div class="ai-message-content">
                    <p>${message}</p>
                </div>
            `;
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // --- Smart Entry Parser (Enhanced) ---
        smartEntryTextarea.addEventListener('input', () => {
            const text = smartEntryTextarea.value;
            const poRegex = /(?:PO|Order|Job)\s*(?:#|:)?\s*([\w-]+)/i;
            const poMatch = text.match(poRegex);
            if (poMatch && poMatch[1]) {
                poNumberInput.value = poMatch[1];
            }
            const dateRegex = /(\d{4}-\d{2}-\d{2})|(\d{1,2}\/\d{1,2}\/\d{4})/;
            const dateMatch = text.match(dateRegex);
            if (dateMatch) {
                const dateStr = dateMatch[2] ? new Date(dateMatch[2]).toISOString().split('T')[0] : dateMatch[1];
                dueDateInput.value = dateStr;
            }
             const descRegex = /(?:Job|Description|Title|Desc)\s*:\s*(.*)/i;
             const descMatch = text.match(descRegex);
             if (descMatch && descMatch[1]) {
                 projectDescriptionInput.value = descMatch[1].trim();
             } else {
                const lines = text.split('\n');
                const nonPoDateLine = lines.find(line => !poRegex.test(line) && !dateRegex.test(line) && line.trim() !== '');
                if(nonPoDateLine) {
                    projectDescriptionInput.value = nonPoDateLine.trim().replace(/^:\s*/, '');
                }
             }
        });

        // --- Helper Functions ---
        const getRelativeDateInfo = (date) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(date);
            dueDate.setHours(0, 0, 0, 0);
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { text: `Atrasado por ${Math.abs(diffDays)} día(s)`, class: 'overdue' };
            if (diffDays === 0) return { text: 'Vence hoy', class: 'due-today' };
            if (diffDays === 1) return { text: 'Vence mañana', class: 'due-soon' };
            if (diffDays <= 3) return { text: `Vence en ${diffDays} días`, class: 'due-soon' };
            return { text: `Vence en ${diffDays} días`, class: '' };
        };
        
        const renderProject = (project) => {
            const dueDate = project.dueDate.toDate();
            const formattedDate = dueDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const relativeDateInfo = getRelativeDateInfo(dueDate);
            
            // Determine status badge class
            let statusClass = 'status-normal';
            if (relativeDateInfo.class === 'due-soon') statusClass = 'status-due-soon';
            else if (relativeDateInfo.class === 'due-today') statusClass = 'status-due-today';
            else if (relativeDateInfo.class === 'overdue') statusClass = 'status-overdue';
            
            return `
                <div class="project-card fade-in ${relativeDateInfo.class}">
                    <div class="flex justify-between items-start">
                    <div class="flex-grow">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-file-alt text-white text-sm"></i>
                    </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-slate-800">PO #${project.poNumber}</h3>
                                    <p class="text-slate-600 text-sm">${formattedDate}</p>
                                </div>
                            </div>
                            <p class="text-slate-700 mb-3 leading-relaxed">${project.description}</p>
                            <span class="status-badge ${statusClass}">
                                <i class="fas fa-clock mr-1"></i>
                                ${relativeDateInfo.text}
                            </span>
                    </div>
                        <button data-id="${project.id}" class="delete-btn ml-4">
                            <i class="fas fa-trash-alt"></i>
                    </button>
                    </div>
                </div>
            `;
        };

        const updateProjectList = (projects) => {
            loadingSpinner.classList.remove('show');
            noProjectsMessage.classList.toggle('hidden', projects.length > 0);
            projectList.innerHTML = projects.map(renderProject).join('');
            allProjects = projects;
            updateDashboardMetrics(projects);
            
            // Update purchasing recommendations if purchasing tab is active
            const purchasingTab = document.getElementById('purchasing-tab');
            if (purchasingTab && !purchasingTab.classList.contains('hidden')) {
                updateProjectMaterialRecommendations();
                updatePurchasingInsights();
            }
            
            // Check for multi-channel reminders
            checkMultiChannelReminders(projects);
        };

        async function checkMultiChannelReminders(projects) {
            const now = new Date();
            const currentHour = now.getHours();
            const startHour = 8; // 8:00 AM
            const endHour = 18; // 6:00 PM

            // Only send reminders during business hours
            if (currentHour < startHour || currentHour > endHour) {
                return;
            }

            for (const project of projects) {
                const dueDate = project.dueDate.toDate();
                const diffDays = Math.ceil((dueDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

                let reminderType = null;
                
                // Early reminder (7 days before)
                if (diffDays === 7) {
                    reminderType = 'due';
                }
                // Urgent reminder (1 day before)
                else if (diffDays === 1) {
                    reminderType = 'due';
                }
                // Overdue project
                else if (diffDays < 0) {
                    reminderType = 'overdue';
                }

                if (reminderType) {
                    try {
                        await multiChannelManager.sendNotification(project, reminderType, whatsappManager.teamMembers);
                    } catch (error) {
                        console.error('Error sending notification:', error);
                    }
                }
            }
        }

        const updateDashboardMetrics = (projects) => {
            document.getElementById('total-projects').textContent = projects.length;
            
            const completedThisMonth = projects.filter(p => {
                const created = p.createdAt.toDate();
                const now = new Date();
                return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
            }).length;
            document.getElementById('completed-projects').textContent = completedThisMonth;
            
            const overdue = projects.filter(p => {
                const dueDate = p.dueDate.toDate();
                const today = new Date();
                return dueDate < today;
            }).length;
            document.getElementById('overdue-projects').textContent = overdue;
            
            const efficiencyScore = Math.max(0, Math.min(100, 100 - (overdue * 10) + (completedThisMonth * 5)));
            document.getElementById('efficiency-score').textContent = `${efficiencyScore}%`;
        };

        // --- Chart Initialization ---
        function initializeCharts() {
            // Timeline Chart
            const timelineCtx = document.getElementById('timelineChart');
            if (timelineCtx) {
                new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
                        datasets: [{
                            label: 'Proyectos Completados',
                            data: [2, 4, 3, 5],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Completion Chart
            const completionCtx = document.getElementById('completionChart');
            if (completionCtx) {
                new Chart(completionCtx, {
                    type: 'bar',
                    data: {
                        labels: ['A Tiempo', 'Tardío', 'Temprano'],
                        datasets: [{
                            data: [12, 3, 2],
                            backgroundColor: ['#22c55e', '#ef4444', '#3b82f6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Distribution Chart
            const distributionCtx = document.getElementById('distributionChart');
            if (distributionCtx) {
                new Chart(distributionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Bridas', 'Tuberías', 'Válvulas', 'Otros'],
                        datasets: [{
                            data: [35, 25, 20, 20],
                            backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // --- Purchasing System ---
        function initializePurchasingSystem() {
            updateProjectMaterialRecommendations();
            updatePurchasingInsights();
            // Suscribirse a proveedores y órdenes si hay permisos
            const isAllowed = (currentUserRole === 'admin' || currentUserRole === 'compras');
            if (isAllowed) {
                subscribeSuppliersList();
                subscribePurchaseOrdersList();
            }
        }

        function updateProjectMaterialRecommendations() {
            const recommendationsContainer = document.getElementById('project-material-recommendations');
            if (!recommendationsContainer) return;

            // Clear existing recommendations
            recommendationsContainer.innerHTML = '';

            // Analyze active projects for material needs
            const activeProjects = allProjects.filter(project => 
                project.dueDate && new Date(project.dueDate) >= new Date()
            );

            if (activeProjects.length === 0) {
                recommendationsContainer.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-yellow-800 mb-2">Sin Proyectos Activos</h4>
                                <p class="text-sm text-yellow-700">No hay proyectos activos para analizar. Agrega proyectos para obtener recomendaciones de materiales.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Analyze materials needed
            const materialNeeds = analyzeProjectMaterials(activeProjects);
            
            // Display recommendations
            materialNeeds.forEach(need => {
                const recommendationCard = document.createElement('div');
                recommendationCard.className = 'bg-white border border-gray-200 rounded-lg p-4';
                recommendationCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-${need.priority === 'high' ? 'red' : need.priority === 'medium' ? 'yellow' : 'green'}-500 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-${need.type === 'material' ? 'cube' : 'tools'} text-white text-sm"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800">${need.name}</h4>
                                <p class="text-sm text-slate-600">${need.description}</p>
                            </div>
                        </div>
                        <span class="text-xs bg-${need.priority === 'high' ? 'red' : need.priority === 'medium' ? 'yellow' : 'green'}-100 text-${need.priority === 'high' ? 'red' : need.priority === 'medium' ? 'yellow' : 'green'}-700 px-2 py-1 rounded-full">
                            ${need.priority === 'high' ? 'Urgente' : need.priority === 'medium' ? 'Medio' : 'Bajo'}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-slate-600">
                            <span class="font-medium">Proyectos relacionados:</span> ${need.relatedProjects.join(', ')}
                        </div>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white text-xs py-1 px-3 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-1"></i>Crear PO
                        </button>
                    </div>
                `;
                recommendationsContainer.appendChild(recommendationCard);
            });

            // Add info card at the end
            const infoCard = document.createElement('div');
            infoCard.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4';
            infoCard.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-blue-800 mb-2">Análisis Automático</h4>
                        <p class="text-sm text-blue-700">Las recomendaciones se basan en el análisis de ${activeProjects.length} proyecto(s) activo(s). El sistema identifica materiales y herramientas necesarias según las descripciones de proyectos.</p>
                    </div>
                </div>
            `;
            recommendationsContainer.appendChild(infoCard);
        }

        function analyzeProjectMaterials(projects) {
            const materialNeeds = [];
            const materialMap = new Map();

            projects.forEach(project => {
                const description = project.description.toLowerCase();
                
                // Identify materials
                const materials = [
                    { name: 'Acero Inoxidable 316L', keywords: ['inoxidable', '316l', 'acero inox'], priority: 'high' },
                    { name: 'Aluminio 6061-T6', keywords: ['aluminio', '6061'], priority: 'medium' },
                    { name: 'Titanio Grado 5', keywords: ['titanio', 'ti6al4v'], priority: 'high' },
                    { name: 'Acero al Carbono', keywords: ['acero', 'carbono', 'steel'], priority: 'low' }
                ];

                // Identify tools
                const tools = [
                    { name: 'Fresas HSS', keywords: ['fresa', 'fresado', 'milling'], priority: 'medium' },
                    { name: 'Brocas de Carburo', keywords: ['broca', 'taladro', 'drill'], priority: 'medium' },
                    { name: 'Inserts de Carburo', keywords: ['insert', 'carburo', 'turning'], priority: 'high' },
                    { name: 'Herramientas de Acabado', keywords: ['acabado', 'pulido', 'finish'], priority: 'low' }
                ];

                // Check for materials
                materials.forEach(material => {
                    if (material.keywords.some(keyword => description.includes(keyword))) {
                        if (!materialMap.has(material.name)) {
                            materialMap.set(material.name, {
                                name: material.name,
                                type: 'material',
                                priority: material.priority,
                                description: `Material identificado para proyecto de ${project.description.substring(0, 50)}...`,
                                relatedProjects: []
                            });
                        }
                        materialMap.get(material.name).relatedProjects.push(project.poNumber || `Proyecto ${project.id}`);
                    }
                });

                // Check for tools
                tools.forEach(tool => {
                    if (tool.keywords.some(keyword => description.includes(keyword))) {
                        if (!materialMap.has(tool.name)) {
                            materialMap.set(tool.name, {
                                name: tool.name,
                                type: 'tool',
                                priority: tool.priority,
                                description: `Herramienta identificada para proyecto de ${project.description.substring(0, 50)}...`,
                                relatedProjects: []
                            });
                        }
                        materialMap.get(tool.name).relatedProjects.push(project.poNumber || `Proyecto ${project.id}`);
                    }
                });
            });

            // Convert map to array and sort by priority
            materialMap.forEach(need => materialNeeds.push(need));
            
            return materialNeeds.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
        }

        function updatePurchasingInsights() {
            // Update insights based on current project data
            const activeProjects = allProjects.filter(project => 
                project.dueDate && new Date(project.dueDate) >= new Date()
            );

            // Calculate material usage trends
            const materialUsage = {};
            activeProjects.forEach(project => {
                const description = project.description.toLowerCase();
                if (description.includes('inoxidable')) materialUsage.inoxidable = (materialUsage.inoxidable || 0) + 1;
                if (description.includes('aluminio')) materialUsage.aluminio = (materialUsage.aluminio || 0) + 1;
                if (description.includes('titanio')) materialUsage.titanio = (materialUsage.titanio || 0) + 1;
            });

            // Update trend insights
            const trendElement = document.querySelector('.bg-gradient-to-br.from-blue-50.to-blue-100 .text-sm');
            if (trendElement && materialUsage.inoxidable > 0) {
                trendElement.textContent = `El acero inoxidable se usa en ${materialUsage.inoxidable} proyecto(s) activo(s) - Considera compra a granel`;
            }

            // Update cost optimization
            const costElement = document.querySelector('.bg-gradient-to-br.from-green-50.to-green-100 .text-sm');
            if (costElement) {
                const totalProjects = activeProjects.length;
                if (totalProjects > 5) {
                    costElement.textContent = `Con ${totalProjects} proyectos activos, comprando en lotes puedes ahorrar hasta 20%`;
                }
            }

            // Update predictions
            const predictionElement = document.querySelector('.bg-gradient-to-br.from-purple-50.to-purple-100 .text-sm');
            if (predictionElement) {
                if (materialUsage.aluminio > 0) {
                    predictionElement.textContent = `Se necesitarán aproximadamente ${materialUsage.aluminio * 10}kg de aluminio para proyectos activos`;
                }
            }
        }

        // Firestore live lists for Compras
        function subscribeSuppliersList() {
            const list = document.getElementById('suppliers-list');
            if (!list) return;
            const supCol = collection(db, 'artifacts', appId, 'secure', 'purchasing', 'suppliers');
            const qSup = query(supCol, orderBy('createdAt', 'desc'));
            onSnapshot(qSup, (snap) => {
                list.innerHTML = '';
                snap.forEach((d) => {
                    const s = d.data();
                    const el = document.createElement('div');
                    el.className = 'bg-slate-50 border border-slate-200 rounded-lg p-4';
                    el.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-slate-800">${s.name}</h5>
                            <div class="flex gap-2 items-center">
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Activo</span>
                                ${(currentUserRole === 'admin' || currentUserRole === 'compras') ? `<button data-id="${d.id}" class="text-xs text-blue-600 hover:underline edit-supplier">Editar</button>` : ''}
                                ${(currentUserRole === 'admin') ? `<button data-id="${d.id}" class="text-xs text-red-600 hover:underline delete-supplier">Eliminar</button>` : ''}
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-2">Especialista en ${String(s.specialty || '').toLowerCase()}</p>
                        <div class="flex items-center space-x-4 text-xs text-slate-500">
                            ${s.contact ? `<span><i class="fas fa-user mr-1"></i>${s.contact}</span>` : ''}
                            ${s.phone ? `<span><i class="fas fa-phone mr-1"></i>${s.phone}</span>` : ''}
                            ${s.email ? `<span><i class="fas fa-envelope mr-1"></i>${s.email}</span>` : ''}
                        </div>
                    `;
                    list.appendChild(el);
                });

                // edit handlers
                list.querySelectorAll('.edit-supplier').forEach(btn => {
                    btn.addEventListener('click', async (ev) => {
                        const id = ev.currentTarget.getAttribute('data-id');
                        const newPhone = prompt('Nuevo teléfono (opcional):');
                        const newEmail = prompt('Nuevo email (opcional):');
                        try {
                            await updateDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'suppliers', id), {
                                ...(newPhone ? { phone: newPhone } : {}),
                                ...(newEmail ? { email: newEmail } : {})
                            });
                            showNotification('Proveedor actualizado', 'success');
                        } catch (e) {
                            showNotification('No se pudo actualizar', 'error');
                        }
                    });
                });

                // delete handlers
                if (currentUserRole === 'admin') {
                    list.querySelectorAll('.delete-supplier').forEach(btn => {
                        btn.addEventListener('click', async (ev) => {
                            const id = ev.currentTarget.getAttribute('data-id');
                            try {
                                await deleteDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'suppliers', id));
                                showNotification('Proveedor eliminado', 'success');
                            } catch (e) {
                                showNotification('No se pudo eliminar', 'error');
                            }
                        });
                    });
                }
            });
        }

        function subscribePurchaseOrdersList() {
            const list = document.getElementById('purchase-orders-list');
            if (!list) return;
            const poCol = collection(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders');
            const qPO = query(poCol, orderBy('createdAt', 'desc'));
            const statusFilter = document.getElementById('po-filter-status');
            const supplierFilter = document.getElementById('po-filter-supplier');

            const render = (docs) => {
                list.innerHTML = '';
                const statusVal = statusFilter && 'value' in statusFilter ? statusFilter.value : '';
                const supplierVal = supplierFilter && 'value' in supplierFilter ? (supplierFilter.value || '').toLowerCase() : '';

                docs.forEach((d) => {
                    const p = d.data();
                    if (statusVal && (p.status || 'pendiente') !== statusVal) return;
                    if (supplierVal && !(p.supplier || '').toLowerCase().includes(supplierVal)) return;

                    const el = document.createElement('div');
                    el.className = 'bg-slate-50 border border-slate-200 rounded-lg p-4';
                    el.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-slate-800">${d.id}</h5>
                            <div class="flex items-center gap-2">
                                <span class="text-xs ${p.status === 'pendiente' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'} px-2 py-1 rounded-full">${p.status || 'pendiente'}</span>
                                ${(currentUserRole === 'admin' || currentUserRole === 'compras') ? `<button data-id="${d.id}" class="text-xs text-blue-600 hover:underline edit-po">Editar</button>` : ''}
                                ${(currentUserRole === 'admin' || currentUserRole === 'compras') ? `<button data-id="${d.id}" class="text-xs text-green-700 hover:underline deliver-po">Marcar Entregado</button>` : ''}
                                ${(currentUserRole === 'admin') ? `<button data-id="${d.id}" class="text-xs text-red-600 hover:underline delete-po">Eliminar</button>` : ''}
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-2">${p.item} - ${p.quantity} ${p.unit}</p>
                        <div class="flex items-center justify-between text-xs text-slate-500">
                            <span>Proveedor: ${p.supplier || '-'}</span>
                            <span>${p.createdAt?.toDate ? p.createdAt.toDate().toLocaleDateString() : ''}</span>
                        </div>
                    `;
                    list.appendChild(el);
                });

                // handlers
                list.querySelectorAll('.edit-po').forEach(btn => {
                    btn.addEventListener('click', async (ev) => {
                        const id = ev.currentTarget.getAttribute('data-id');
                        const newQty = prompt('Nueva cantidad:');
                        if (!newQty) return;
                        try {
                            await updateDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders', id), { quantity: parseFloat(newQty) });
                            showNotification('Orden actualizada', 'success');
                        } catch (e) {
                            showNotification('No se pudo actualizar', 'error');
                        }
                    });
                });
                list.querySelectorAll('.deliver-po').forEach(btn => {
                    btn.addEventListener('click', async (ev) => {
                        const id = ev.currentTarget.getAttribute('data-id');
                        try {
                            await updateDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders', id), { status: 'entregado' });
                            showNotification('Orden marcada como entregada', 'success');
                        } catch (e) {
                            showNotification('No se pudo actualizar', 'error');
                        }
                    });
                });
                if (currentUserRole === 'admin') {
                    list.querySelectorAll('.delete-po').forEach(btn => {
                        btn.addEventListener('click', async (ev) => {
                            const id = ev.currentTarget.getAttribute('data-id');
                            try {
                                await deleteDoc(doc(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders', id));
                                showNotification('Orden eliminada', 'success');
                            } catch (e) {
                                showNotification('No se pudo eliminar', 'error');
                            }
                        });
                    });
                }
            };

            onSnapshot(qPO, (snap) => render(snap.docs));
            statusFilter?.addEventListener('change', () => onSnapshot(qPO, (snap) => render(snap.docs)));
            supplierFilter?.addEventListener('input', () => onSnapshot(qPO, (snap) => render(snap.docs)));
        }

        // --- Notification System ---
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('notification-container').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // --- Event Handlers ---
        addProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!poNumberInput.value || !dueDateInput.value || !projectDescriptionInput.value) return;
            
            const [year, month, day] = dueDateInput.value.split('-');
            const dueDate = new Date(year, month - 1, day, 12, 0, 0);
            
            try {
                const projectData = {
                    poNumber: poNumberInput.value,
                    description: projectDescriptionInput.value,
                    dueDate: Timestamp.fromDate(dueDate),
                    createdAt: Timestamp.now()
                };
                
                await addDoc(projectsCollection, projectData);
                
                // AI Learning
                aiSystem.analyzeProject(projectData);
                
                addProjectForm.reset();
                smartEntryTextarea.value = '';
                showNotification('¡Proyecto agregado exitosamente! La IA está aprendiendo de estos datos.', 'success');
            } catch (error) {
                console.error("Error adding document: ", error);
                showNotification('Error al agregar proyecto. Por favor intenta de nuevo.', 'error');
            }
        });

        projectList.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-btn')) {
                const id = e.target.closest('.delete-btn').dataset.id;
                try {
                    await deleteDoc(doc(db, projectsCollection.path, id));
                    showNotification('¡Proyecto eliminado exitosamente!', 'success');
                } catch (error) {
                    console.error("Error removing document: ", error);
                    showNotification('Error al eliminar proyecto.', 'error');
                }
            }
        });

        // --- Multi-Channel Setup System ---
        function setupMultiChannelNotifications() {
            // Method selection
            const methodCards = document.querySelectorAll('.notification-method-card');
            const methodRadios = document.querySelectorAll('input[name="notification-method"]');
            
            methodCards.forEach(card => {
                card.addEventListener('click', () => {
                    const method = card.dataset.method;
                    const radio = card.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Update visual selection
                    methodCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    
                    // Show/hide configuration sections
                    showConfigurationSection(method);
                    
                    // Update notification manager
                    multiChannelManager.setNotificationMethod(method);
                });
            });

            // Initialize with browser notifications
            showConfigurationSection('browser');
            multiChannelManager.setNotificationMethod('browser');
        }

        function showConfigurationSection(method) {
            // Hide all configuration sections
            document.getElementById('whatsapp-business-config').classList.add('hidden');
            document.getElementById('whatsapp-web-config').classList.add('hidden');
            document.getElementById('email-config').classList.add('hidden');
            document.getElementById('browser-config').classList.add('hidden');
            
            // Show selected section
            switch (method) {
                case 'whatsapp-business':
                    document.getElementById('whatsapp-business-config').classList.remove('hidden');
                    break;
                case 'whatsapp-web':
                    document.getElementById('whatsapp-web-config').classList.remove('hidden');
                    break;
                case 'email':
                    document.getElementById('email-config').classList.remove('hidden');
                    break;
                case 'browser':
                    document.getElementById('browser-config').classList.remove('hidden');
                    checkNotificationPermission();
                    break;
            }
        }

        function checkNotificationPermission() {
            const statusElement = document.getElementById('notification-permission-status');
            
            if (!('Notification' in window)) {
                statusElement.textContent = 'No soportado';
                statusElement.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-600';
                return;
            }
            
            switch (Notification.permission) {
                case 'granted':
                    statusElement.textContent = 'Permitido';
                    statusElement.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-600';
                    break;
                case 'denied':
                    statusElement.textContent = 'Denegado';
                    statusElement.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-600';
                    break;
                default:
                    statusElement.textContent = 'Pendiente';
                    statusElement.className = 'text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-600';
            }
        }

        // --- WhatsApp Setup System ---
        function setupWhatsApp() {
            const testConnectionBtn = document.getElementById('test-whatsapp-connection');
            const addMemberBtn = document.getElementById('add-team-member');
            const testAllBtn = document.getElementById('test-all-notifications');
            const testSpecificBtn = document.getElementById('test-specific-member');

            // Test WhatsApp connection
            testConnectionBtn.addEventListener('click', async () => {
                const token = document.getElementById('whatsapp-token').value;
                const phoneId = document.getElementById('whatsapp-phone-id').value;
                const verifyToken = document.getElementById('whatsapp-verify-token').value;

                if (!token || !phoneId) {
                    showNotification('Por favor completa el token y Phone ID', 'warning');
                    return;
                }

                whatsappManager.setCredentials(token, phoneId, verifyToken);

                try {
                    await whatsappManager.testConnection();
                    showNotification('¡Conexión WhatsApp exitosa!', 'success');
                } catch (error) {
                    showNotification('Error de conexión: ' + error.message, 'error');
                }
            });

            // Add team member
            addMemberBtn.addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.remove('hidden');
                // Clear form
                document.getElementById('add-member-name').value = '';
                document.getElementById('add-member-phone').value = '';
                document.getElementById('add-member-notifications').checked = true;
            });

            // Test all notifications
            testAllBtn.addEventListener('click', async () => {
                if (!whatsappManager.apiToken) {
                    showNotification('Configura primero la API de WhatsApp', 'warning');
                    return;
                }

                try {
                    const testMessage = '🧪 *Prueba de Sistema*\nRecordatorios automáticos de proyectos activados.\n_Taller de Torno CNC_';
                    
                    for (const member of whatsappManager.teamMembers) {
                        if (member.notifications) {
                            await whatsappManager.sendMessage(member.phone, testMessage);
                        }
                    }
                    
                    showNotification('Mensajes de prueba enviados a todos los miembros', 'success');
                } catch (error) {
                    showNotification('Error enviando mensajes: ' + error.message, 'error');
                }
            });

            // Update reminder settings
            document.getElementById('early-reminder').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ early: { enabled: e.target.checked, days: 7 } });
            });

            document.getElementById('urgent-reminder').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ urgent: { enabled: e.target.checked, days: 1 } });
            });

            document.getElementById('overdue-reminder').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ overdue: { enabled: e.target.checked, days: 0 } });
            });

            document.getElementById('start-time').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ startTime: e.target.value });
            });

            document.getElementById('end-time').addEventListener('change', (e) => {
                whatsappManager.updateReminderSettings({ endTime: e.target.value });
            });

            // Browser notification permission request
            document.getElementById('request-notification-permission').addEventListener('click', async () => {
                try {
                    const permission = await Notification.requestPermission();
                    checkNotificationPermission();
                    
                    if (permission === 'granted') {
                        showNotification('Permisos de notificación concedidos', 'success');
                    } else {
                        showNotification('Permisos de notificación denegados', 'warning');
                    }
                } catch (error) {
                    showNotification('Error solicitando permisos: ' + error.message, 'error');
                }
            });

            // Browser notification settings
            document.getElementById('notification-sound').addEventListener('change', (e) => {
                multiChannelManager.updateBrowserConfig({ sound: e.target.checked });
            });

            document.getElementById('notification-vibrate').addEventListener('change', (e) => {
                multiChannelManager.updateBrowserConfig({ vibrate: e.target.checked });
            });

            document.getElementById('notification-persistent').addEventListener('change', (e) => {
                multiChannelManager.updateBrowserConfig({ persistent: e.target.checked });
            });

            // Email configuration
            document.getElementById('test-email').addEventListener('click', async () => {
                const smtpServer = document.getElementById('smtp-server').value;
                const smtpPort = document.getElementById('smtp-port').value;
                const email = document.getElementById('smtp-email').value;
                const password = document.getElementById('smtp-password').value;
                
                if (!smtpServer || !email) {
                    showNotification('Completa la configuración SMTP', 'warning');
                    return;
                }

                multiChannelManager.updateEmailConfig({
                    smtpServer,
                    smtpPort: parseInt(smtpPort),
                    email,
                    password
                });

                try {
                    // Simulate email test
                    showNotification('Email de prueba enviado (simulado)', 'success');
                } catch (error) {
                    showNotification('Error enviando email: ' + error.message, 'error');
                }
            });

            document.getElementById('save-email-config').addEventListener('click', () => {
                const subject = document.getElementById('email-subject').value;
                const template = document.getElementById('email-template').value;
                
                multiChannelManager.updateEmailConfig({
                    subject,
                    template
                });
                
                showNotification('Configuración de email guardada', 'success');
            });

            // WhatsApp Web configuration
            document.getElementById('whatsapp-web-number').addEventListener('change', (e) => {
                multiChannelManager.updateWhatsAppWebConfig({ mainNumber: e.target.value });
            });

            document.getElementById('whatsapp-web-intro').addEventListener('change', (e) => {
                multiChannelManager.updateWhatsAppWebConfig({ introMessage: e.target.value });
            });
        }

        function updateTeamMembersDisplay() {
            const container = document.getElementById('team-members-whatsapp');
            container.innerHTML = '';

            whatsappManager.teamMembers.forEach((member, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'flex items-center justify-between p-4 bg-slate-50 rounded-lg';
                memberDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-green-600"></i>
                        </div>
                        <div>
                            <h5 class="font-medium text-slate-800">${member.name}</h5>
                            <p class="text-sm text-slate-600">${member.phone}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="whatsapp-notifications" ${member.notifications ? 'checked' : ''}>
                            <span class="ml-2 text-sm text-slate-600">Notificaciones</span>
                        </label>
                        <button onclick="editTeamMember(${index})" class="ml-3 p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors" title="Editar miembro">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removeTeamMember(${index})" class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors" title="Eliminar miembro">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(memberDiv);
            });
        }

        // --- Team Member Management Functions ---
        function removeTeamMember(index) {
            if (confirm('¿Estás seguro de que quieres eliminar este miembro del equipo?')) {
                whatsappManager.teamMembers.splice(index, 1);
                updateTeamMembersDisplay();
                showNotification('Miembro del equipo eliminado exitosamente', 'success');
            }
        }

        let currentEditingIndex = -1;

        function editTeamMember(index) {
            currentEditingIndex = index;
            const member = whatsappManager.teamMembers[index];
            
            // Populate modal with current member data
            document.getElementById('edit-member-name').value = member.name;
            document.getElementById('edit-member-phone').value = member.phone;
            
            // Show modal
            document.getElementById('edit-member-modal').classList.remove('hidden');
        }

        // --- Template Editor Functions ---
        function editTemplate(templateType) {
            const template = whatsappManager.templates[templateType];
            const newMessage = prompt(`Editar plantilla "${template.title}":`, template.message);
            
            if (newMessage && newMessage !== template.message) {
                whatsappManager.templates[templateType].message = newMessage;
                showNotification('Plantilla actualizada exitosamente', 'success');
                updateTemplateDisplay(templateType);
            }
        }

        function updateTemplateDisplay(templateType) {
            // Update the template display in the UI
            const template = whatsappManager.templates[templateType];
            const templateElements = document.querySelectorAll(`[onclick="editTemplate('${templateType}')"]`);
            
            templateElements.forEach(element => {
                const messageContainer = element.parentElement.querySelector('.bg-white p');
                if (messageContainer) {
                    messageContainer.innerHTML = template.message.replace(/\n/g, '<br>');
                }
            });
        }

        // --- Periodic Reminder Check ---
        function startReminderScheduler() {
            // Check for reminders every hour
            setInterval(() => {
                if (allProjects.length > 0) {
                    whatsappManager.checkReminders(allProjects);
                }
            }, 60 * 60 * 1000); // Every hour

            // Also check immediately on load
            if (allProjects.length > 0) {
                whatsappManager.checkReminders(allProjects);
            }
        }

        // --- Settings Setup System ---
        function setupSettings() {
            // Workshop information
            document.getElementById('workshop-name').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.name', e.target.value);
            });
            
            document.getElementById('workshop-address').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.address', e.target.value);
            });
            
            document.getElementById('workshop-phone').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.phone', e.target.value);
            });
            
            document.getElementById('workshop-email').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.email', e.target.value);
            });
            
            // Specialties
            document.querySelectorAll('input[id^="specialty-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const specialty = e.target.id.replace('specialty-', '');
                    let specialties = settingsManager.getSetting('workshop.specialties') || [];
                    
                    if (e.target.checked) {
                        if (!specialties.includes(specialty)) {
                            specialties.push(specialty);
                        }
                    } else {
                        specialties = specialties.filter(s => s !== specialty);
                    }
                    
                    settingsManager.updateSetting('workshop.specialties', specialties);
                });
            });
            
            document.getElementById('production-capacity').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.productionCapacity', e.target.value);
            });
            
            document.getElementById('timezone').addEventListener('change', (e) => {
                settingsManager.updateSetting('workshop.timezone', e.target.value);
            });
            
            // Project settings
            document.getElementById('po-prefix').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.poPrefix', e.target.value);
            });
            
            document.getElementById('po-format').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.poFormat', e.target.value);
                
                if (e.target.value === 'custom') {
                    document.getElementById('custom-format-container').classList.remove('hidden');
                } else {
                    document.getElementById('custom-format-container').classList.add('hidden');
                }
            });
            
            document.getElementById('custom-po-format').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.customFormat', e.target.value);
            });
            
            // Warning days
            document.getElementById('early-warning-days').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.warningDays.early', parseInt(e.target.value));
            });
            
            document.getElementById('urgent-warning-days').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.warningDays.urgent', parseInt(e.target.value));
            });
            
            document.getElementById('critical-warning-days').addEventListener('change', (e) => {
                settingsManager.updateSetting('projects.warningDays.critical', parseInt(e.target.value));
            });
            
            // Categories management
            document.getElementById('add-category').addEventListener('click', () => {
                const input = document.getElementById('new-category');
                const category = input.value.trim();
                
                if (category) {
                    let categories = settingsManager.getSetting('projects.categories') || [];
                    if (!categories.includes(category)) {
                        categories.push(category);
                        settingsManager.updateSetting('projects.categories', categories);
                        updateCategoriesList();
                        input.value = '';
                    }
                }
            });
            
            // Notification settings
            document.getElementById('work-start-time').addEventListener('change', (e) => {
                settingsManager.updateSetting('notifications.workHours.start', e.target.value);
            });
            
            document.getElementById('work-end-time').addEventListener('change', (e) => {
                settingsManager.updateSetting('notifications.workHours.end', e.target.value);
            });
            
            // Workdays
            document.querySelectorAll('input[id^="workday-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const day = e.target.id.replace('workday-', '');
                    let workdays = settingsManager.getSetting('notifications.workHours.workdays') || [];
                    
                    if (e.target.checked) {
                        if (!workdays.includes(day)) {
                            workdays.push(day);
                        }
                    } else {
                        workdays = workdays.filter(d => d !== day);
                    }
                    
                    settingsManager.updateSetting('notifications.workHours.workdays', workdays);
                });
            });
            
            document.getElementById('check-frequency').addEventListener('change', (e) => {
                settingsManager.updateSetting('notifications.checkFrequency', parseInt(e.target.value));
            });
            
            // AI settings
            document.getElementById('ai-learning-level').addEventListener('change', (e) => {
                settingsManager.updateSetting('ai.learningLevel', e.target.value);
            });
            
            document.getElementById('ai-analysis-frequency').addEventListener('change', (e) => {
                settingsManager.updateSetting('ai.analysisFrequency', e.target.value);
            });
            
            document.getElementById('ai-precision').addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                settingsManager.updateSetting('ai.precision', value);
                document.getElementById('precision-value').textContent = value + '%';
            });
            
            // AI features
            document.querySelectorAll('input[id^="ai-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const feature = e.target.id.replace('ai-', '').replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                    settingsManager.updateSetting(`ai.features.${feature}`, e.target.checked);
                });
            });
            
            document.getElementById('ai-language').addEventListener('change', (e) => {
                settingsManager.updateSetting('ai.language', e.target.value);
            });
            
            // Export/Import
            document.getElementById('export-settings').addEventListener('click', () => {
                settingsManager.exportSettings();
            });
            
            document.getElementById('import-data').addEventListener('click', () => {
                document.getElementById('import-file').click();
            });
            
            document.getElementById('import-file').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    settingsManager.importSettings(e.target.files[0]);
                }
            });
            
            document.getElementById('reset-settings').addEventListener('click', () => {
                settingsManager.resetToDefaults();
            });
            
            document.getElementById('save-all-settings').addEventListener('click', () => {
                settingsManager.saveSettings();
            });
            
            document.getElementById('reset-to-defaults').addEventListener('click', () => {
                settingsManager.resetToDefaults();
            });

            // Admin roles UI visibility and events
            const rolesCard = document.getElementById('admin-roles-card');
            if (rolesCard) {
                if (currentUserRole === 'admin') rolesCard.classList.remove('hidden');
                else rolesCard.classList.add('hidden');
            }

            const saveRoleBtn = document.getElementById('save-role');
            const loadRoleBtn = document.getElementById('load-role');
            const roleMsg = document.getElementById('role-message');

            loadRoleBtn?.addEventListener('click', async () => {
                if (currentUserRole !== 'admin') {
                    showNotification('Solo admin puede cargar roles', 'warning');
                    return;
                }
                const uidInput = document.getElementById('role-user-uid');
                const uid = uidInput && 'value' in uidInput ? (uidInput.value || '').trim() : '';
                if (!uid) return;
                try {
                    const userDoc = doc(db, 'users', uid);
                    const snap = await getDoc(userDoc);
                    if (snap.exists()) {
                        const data = snap.data();
                        const roleSelectEl = document.getElementById('role-select');
                        if (roleSelectEl && 'value' in roleSelectEl) {
                            roleSelectEl.value = data.role || 'viewer';
                        }
                        roleMsg.textContent = `Rol actual: ${data.role || 'viewer'}`;
                    } else {
                        roleMsg.textContent = 'Usuario no encontrado';
                    }
                } catch (e) {
                    roleMsg.textContent = 'Error al cargar rol';
                }
            });

            saveRoleBtn?.addEventListener('click', async () => {
                if (currentUserRole !== 'admin') {
                    showNotification('Solo admin puede guardar roles', 'warning');
                    return;
                }
                const uidInput2 = document.getElementById('role-user-uid');
                const roleSelectEl2 = document.getElementById('role-select');
                const uid = uidInput2 && 'value' in uidInput2 ? (uidInput2.value || '').trim() : '';
                const role = roleSelectEl2 && 'value' in roleSelectEl2 ? (roleSelectEl2.value || '') : '';
                if (!uid || !role) return;
                try {
                    const userDoc = doc(db, 'users', uid);
                    await setDoc(userDoc, { role }, { merge: true });
                    roleMsg.textContent = 'Rol actualizado';
                    showNotification('Rol actualizado', 'success');
                    if (uid === currentUser?.uid) {
                        applyRoleUI(role);
                    }
                } catch (e) {
                    roleMsg.textContent = 'Error al guardar rol';
                }
            });
        }

        // Simple notification functions - Global scope
        window.saveWhatsAppConfig = function() {
            console.log('🔧 Iniciando guardado de configuración WhatsApp...');
            
            const phone = document.getElementById('team-leader-phone');
            const startTime = document.getElementById('notification-start-time');
            const endTime = document.getElementById('notification-end-time');
            const deadlines = document.getElementById('notify-deadlines');
            const completions = document.getElementById('notify-completions');
            const issues = document.getElementById('notify-issues');
            
            console.log('📱 Elementos encontrados:', {
                phone: phone ? phone.value : 'NO ENCONTRADO',
                startTime: startTime ? startTime.value : 'NO ENCONTRADO',
                endTime: endTime ? endTime.value : 'NO ENCONTRADO',
                deadlines: deadlines ? deadlines.checked : 'NO ENCONTRADO',
                completions: completions ? completions.checked : 'NO ENCONTRADO',
                issues: issues ? issues.checked : 'NO ENCONTRADO'
            });
            
            if (!phone || !phone.value.trim()) {
                console.error('❌ No se encontró el campo de teléfono o está vacío');
                showNotification('Por favor ingresa el número del líder del equipo', 'warning');
                return;
            }
            
            const config = {
                phone: phone.value,
                startTime: startTime ? startTime.value : '08:00',
                endTime: endTime ? endTime.value : '18:00',
                deadlines: deadlines ? deadlines.checked : true,
                completions: completions ? completions.checked : true,
                issues: issues ? issues.checked : true
            };
            
            console.log('💾 Guardando configuración:', config);
            
            try {
                localStorage.setItem('whatsapp-config', JSON.stringify(config));
                console.log('✅ Configuración guardada en localStorage');
                
                // Verificar que se guardó
                const saved = localStorage.getItem('whatsapp-config');
                console.log('🔍 Configuración recuperada:', saved);
                
                showNotification('¡Configuración de WhatsApp guardada exitosamente!', 'success');
            } catch (error) {
                console.error('❌ Error al guardar en localStorage:', error);
                showNotification('Error al guardar la configuración: ' + error.message, 'error');
            }
        }
        
        window.saveBrowserConfig = function() {
            console.log('🔧 Iniciando guardado de configuración del navegador...');
            
            const frequency = document.getElementById('notification-frequency');
            const sound = document.getElementById('notification-sound');
            
            console.log('🔔 Elementos encontrados:', {
                frequency: frequency ? frequency.value : 'NO ENCONTRADO',
                sound: sound ? sound.value : 'NO ENCONTRADO'
            });
            
            const config = {
                frequency: frequency ? frequency.value : 'immediate',
                sound: sound ? sound.value : 'default'
            };
            
            console.log('💾 Guardando configuración del navegador:', config);
            
            try {
                localStorage.setItem('browser-config', JSON.stringify(config));
                console.log('✅ Configuración del navegador guardada en localStorage');
                
                // Verificar que se guardó
                const saved = localStorage.getItem('browser-config');
                console.log('🔍 Configuración del navegador recuperada:', saved);
                
                // Request notification permission
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        console.log('🔔 Permiso de notificación:', permission);
                        if (permission === 'granted') {
                            showNotification('¡Notificaciones del navegador activadas!', 'success');
                        } else {
                            showNotification('Permisos de notificación denegados', 'warning');
                        }
                    });
                } else {
                    console.log('❌ Navegador no soporta notificaciones');
                    showNotification('Tu navegador no soporta notificaciones', 'error');
                }
            } catch (error) {
                console.error('❌ Error al guardar configuración del navegador:', error);
                showNotification('Error al guardar la configuración: ' + error.message, 'error');
            }
        }
        
        window.testWhatsAppNotification = function() {
            const config = JSON.parse(localStorage.getItem('whatsapp-config') || '{}');
            if (!config.phone) {
                showNotification('Primero configura WhatsApp', 'warning');
                return;
            }
            
            const message = '🧪 Mensaje de prueba del Cerebro de Proyectos IA - ¡Las notificaciones funcionan correctamente!';
            const url = `https://wa.me/${config.phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showNotification('¡Mensaje de prueba enviado! Se abrió WhatsApp Web', 'success');
        }
        
        window.testBrowserNotification = function() {
            const config = JSON.parse(localStorage.getItem('browser-config') || '{}');
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🧪 Prueba de Notificación', {
                    body: '¡El sistema de notificaciones del Cerebro de Proyectos IA funciona correctamente!',
                    icon: '/favicon.ico'
                });
                showNotification('¡Notificación de prueba enviada!', 'success');
            } else if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification('🧪 Prueba de Notificación', {
                            body: '¡El sistema de notificaciones funciona correctamente!',
                            icon: '/favicon.ico'
                        });
                        showNotification('¡Notificación de prueba enviada!', 'success');
                    } else {
                        showNotification('Permisos de notificación denegados', 'warning');
                    }
                });
            } else {
                showNotification('Tu navegador no soporta notificaciones', 'error');
            }
        }
        
        // Function to load saved configuration
        window.loadNotificationConfig = function() {
            console.log('🔧 Cargando configuración guardada...');
            
            // Load WhatsApp config
            const whatsappConfig = JSON.parse(localStorage.getItem('whatsapp-config') || '{}');
            console.log('📱 Configuración WhatsApp encontrada:', whatsappConfig);
            
            if (whatsappConfig.phone) {
                const phoneField = document.getElementById('team-leader-phone');
                if (phoneField) {
                    phoneField.value = whatsappConfig.phone;
                    console.log('✅ Campo de teléfono llenado');
                }
            }
            
            if (whatsappConfig.startTime) {
                const startTimeField = document.getElementById('notification-start-time');
                if (startTimeField) {
                    startTimeField.value = whatsappConfig.startTime;
                    console.log('✅ Campo de hora inicio llenado');
                }
            }
            
            if (whatsappConfig.endTime) {
                const endTimeField = document.getElementById('notification-end-time');
                if (endTimeField) {
                    endTimeField.value = whatsappConfig.endTime;
                    console.log('✅ Campo de hora fin llenado');
                }
            }
            
            if (typeof whatsappConfig.deadlines !== 'undefined') {
                const deadlinesField = document.getElementById('notify-deadlines');
                if (deadlinesField) {
                    deadlinesField.checked = whatsappConfig.deadlines;
                    console.log('✅ Checkbox deadlines configurado');
                }
            }
            
            if (typeof whatsappConfig.completions !== 'undefined') {
                const completionsField = document.getElementById('notify-completions');
                if (completionsField) {
                    completionsField.checked = whatsappConfig.completions;
                    console.log('✅ Checkbox completions configurado');
                }
            }
            
            if (typeof whatsappConfig.issues !== 'undefined') {
                const issuesField = document.getElementById('notify-issues');
                if (issuesField) {
                    issuesField.checked = whatsappConfig.issues;
                    console.log('✅ Checkbox issues configurado');
                }
            }
            
            // Load browser config
            const browserConfig = JSON.parse(localStorage.getItem('browser-config') || '{}');
            console.log('🔔 Configuración del navegador encontrada:', browserConfig);
            
            if (browserConfig.frequency) {
                const frequencyField = document.getElementById('notification-frequency');
                if (frequencyField) {
                    frequencyField.value = browserConfig.frequency;
                    console.log('✅ Campo de frecuencia llenado');
                }
            }
            
            if (browserConfig.sound) {
                const soundField = document.getElementById('notification-sound');
                if (soundField) {
                    soundField.value = browserConfig.sound;
                    console.log('✅ Campo de sonido llenado');
                }
            }
            
            console.log('✅ Configuración cargada completamente');
        }
        
        // Function to show current configuration status
        window.showConfigStatus = function() {
            const whatsappConfig = JSON.parse(localStorage.getItem('whatsapp-config') || '{}');
            const browserConfig = JSON.parse(localStorage.getItem('browser-config') || '{}');
            
            console.log('📊 Estado actual de la configuración:');
            console.log('WhatsApp:', whatsappConfig);
            console.log('Navegador:', browserConfig);
            
            if (whatsappConfig.phone) {
                showNotification(`Configuración WhatsApp cargada: ${whatsappConfig.phone}`, 'info');
            }
            
            if (browserConfig.frequency) {
                showNotification(`Configuración del navegador cargada: ${browserConfig.frequency}`, 'info');
            }
        }
        
        // Verify functions are available
        console.log('🔍 Verificando funciones disponibles:', {
            saveWhatsAppConfig: typeof window.saveWhatsAppConfig,
            saveBrowserConfig: typeof window.saveBrowserConfig,
            testWhatsAppNotification: typeof window.testWhatsAppNotification,
            testBrowserNotification: typeof window.testBrowserNotification,
            showConfigStatus: typeof window.showConfigStatus,
            loadNotificationConfig: typeof window.loadNotificationConfig
        });

        // Direct function for onclick
        function handleTeamSetupClickDirect() {
            console.log('🔧 Botón clickeado directamente via onclick');
            
            // Hide the initial setup card (more specific selector)
            const initialCard = document.querySelector('#whatsapp-tab .glass-card:first-child');
            if (initialCard) {
                initialCard.classList.add('hidden');
                console.log('✅ Card inicial ocultada (direct)');
                console.log('🔍 Card inicial classes:', initialCard.className);
            } else {
                console.error('❌ No se encontró card inicial (direct)');
                // Try alternative selectors
                const altCard = document.querySelector('.glass-card');
                if (altCard) {
                    altCard.classList.add('hidden');
                    console.log('✅ Card alternativa ocultada (direct)');
                }
            }
            
            // Show the method selection
            const methodSelection = document.getElementById('custom-method-selection');
            if (methodSelection) {
                methodSelection.classList.remove('hidden');
                methodSelection.style.display = 'block';
                methodSelection.style.visibility = 'visible';
                console.log('✅ Selección de métodos mostrada (direct)');
                console.log('🔍 Method selection classes:', methodSelection.className);
            } else {
                console.error('❌ No se encontró custom-method-selection (direct)');
            }
        }

        // --- Simple Notification Setup ---
        function setupSimpleNotifications() {
            console.log('🔧 Inicializando sistema de notificaciones simples...');
            
            // Try multiple approaches to find and setup the button
            let teamSetupBtn = document.getElementById('start-team-setup');
            
            if (!teamSetupBtn) {
                console.error('❌ Botón start-team-setup no encontrado');
                console.log('🔍 Buscando elementos con clase glass-card:', document.querySelectorAll('.glass-card'));
                console.log('🔍 Todos los botones:', document.querySelectorAll('button'));
                
                // Try to find by text content
                const buttons = document.querySelectorAll('button');
                for (let btn of buttons) {
                    if (btn.textContent.includes('Configurar Notificaciones para el Equipo')) {
                        teamSetupBtn = btn;
                        console.log('✅ Botón encontrado por texto:', teamSetupBtn);
                        break;
                    }
                }
                
                if (!teamSetupBtn) {
                    console.error('❌ Botón no encontrado por ningún método');
                    return;
                }
            }
            
            console.log('✅ Botón start-team-setup encontrado:', teamSetupBtn);
            
            // Remove any existing event listeners
            const newBtn = teamSetupBtn.cloneNode(true);
            teamSetupBtn.parentNode.replaceChild(newBtn, teamSetupBtn);
            teamSetupBtn = newBtn;
            
            // Add the event listener
            teamSetupBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('✅ Botón de configurar equipo clickeado (addEventListener)', e);
                handleTeamSetupClick();
            });
            
            // Also add onclick as backup
            teamSetupBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('✅ Botón de configurar equipo clickeado (onclick)', e);
                handleTeamSetupClick();
                return false;
            };
            
            // Function to handle the click
            function handleTeamSetupClick() {
                console.log('🔧 Manejando click del botón de equipo...');
                
                // Hide the initial setup card (more specific selector)
                const initialCard = document.querySelector('#whatsapp-tab .glass-card:first-child');
                if (initialCard) {
                    initialCard.classList.add('hidden');
                    console.log('✅ Card inicial ocultada');
                    console.log('🔍 Card inicial classes:', initialCard.className);
                } else {
                    console.error('❌ No se encontró card inicial');
                    // Try alternative selectors
                    const altCard = document.querySelector('.glass-card');
                    if (altCard) {
                        altCard.classList.add('hidden');
                        console.log('✅ Card alternativa ocultada');
                    }
                }
                
                // Show the method selection
                const methodSelection = document.getElementById('custom-method-selection');
                if (methodSelection) {
                    methodSelection.classList.remove('hidden');
                    console.log('✅ Selección de métodos mostrada');
                    console.log('🔍 Method selection classes:', methodSelection.className);
                    console.log('🔍 Method selection style:', methodSelection.style.display);
                } else {
                    console.error('❌ No se encontró custom-method-selection');
                }
                
                // Force show the method selection
                if (methodSelection) {
                    methodSelection.style.display = 'block';
                    methodSelection.style.visibility = 'visible';
                    console.log('🔧 Forzando visibilidad del método de selección');
                }
                
                // Initialize with default selection
                const defaultRadio = document.querySelector('input[name="notification-method"][checked]');
                if (defaultRadio) {
                    defaultRadio.checked = true;
                    const method = defaultRadio.value;
                    hideAllConfigSections();
                    
                    if (method === 'whatsapp-web-simple') {
                        showWhatsAppWebSimpleConfig();
                    } else if (method === 'browser-notifications') {
                        showBrowserNotificationsConfig();
                    }
                }
            }

            // Handle method selection
            document.querySelectorAll('input[name="notification-method"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const method = e.target.value;
                    hideAllConfigSections();
                    
                    if (method === 'whatsapp-web-simple') {
                        showWhatsAppWebSimpleConfig();
                    } else if (method === 'browser-notifications') {
                        showBrowserNotificationsConfig();
                    }
                });
            });

            // Handle config save buttons
            document.addEventListener('click', (e) => {
                if (e.target.id === 'save-whatsapp-web-config') {
                    saveWhatsAppWebSimpleConfig();
                } else if (e.target.id === 'save-browser-config') {
                    saveBrowserNotificationsConfig();
                }
            });

            // Handle WhatsApp simple config save
            document.addEventListener('click', (e) => {
                if (e.target.id === 'save-whatsapp-config') {
                    saveSimpleWhatsAppConfig();
                } else if (e.target.id === 'save-email-config') {
                    saveSimpleEmailConfig();
                }
            });
            
            // Handle test notification
            document.getElementById('send-test-notification').addEventListener('click', sendTestNotification);
            
            // Handle config edit
            document.getElementById('edit-config').addEventListener('click', editNotificationConfig);
            
            // Handle view projects
            document.getElementById('view-projects').addEventListener('click', () => {
                // Switch to projects tab
                document.querySelector('[data-tab="projects"]').click();
            });

            // Handle team member edit modal
            document.getElementById('close-edit-modal').addEventListener('click', () => {
                document.getElementById('edit-member-modal').classList.add('hidden');
            });

            document.getElementById('cancel-edit').addEventListener('click', () => {
                document.getElementById('edit-member-modal').classList.add('hidden');
            });

            document.getElementById('edit-member-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = document.getElementById('edit-member-name').value.trim();
                const newPhone = document.getElementById('edit-member-phone').value.trim();
                
                if (newName && newPhone && currentEditingIndex >= 0) {
                    whatsappManager.teamMembers[currentEditingIndex].name = newName;
                    whatsappManager.teamMembers[currentEditingIndex].phone = newPhone;
                    updateTeamMembersDisplay();
                    document.getElementById('edit-member-modal').classList.add('hidden');
                    showNotification('Miembro del equipo actualizado exitosamente', 'success');
                }
            });

            // Close modal when clicking outside
            document.getElementById('edit-member-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-member-modal') {
                    document.getElementById('edit-member-modal').classList.add('hidden');
                }
            });

            // Handle add team member modal
            document.getElementById('close-add-modal').addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.add('hidden');
            });

            document.getElementById('cancel-add').addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.add('hidden');
            });

            document.getElementById('add-member-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('add-member-name').value.trim();
                const phone = document.getElementById('add-member-phone').value.trim();
                const notifications = document.getElementById('add-member-notifications').checked;
                
                if (name && phone) {
                    // Add member with notification preference
                    whatsappManager.teamMembers.push({
                        name: name,
                        phone: phone,
                        notifications: notifications
                    });
                    updateTeamMembersDisplay();
                    document.getElementById('add-member-modal').classList.add('hidden');
                    showNotification('Miembro agregado exitosamente', 'success');
                }
            });

            // Close add modal when clicking outside
            document.getElementById('add-member-modal').addEventListener('click', (e) => {
                if (e.target.id === 'add-member-modal') {
                    document.getElementById('add-member-modal').classList.add('hidden');
                }
            });
        }

        function hideAllConfigSections() {
            const sections = ['whatsapp-web-simple-config', 'browser-notifications-config', 'test-config', 'config-complete'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
        }

        function showWhatsAppWebSimpleConfig() {
            try {
                const element = document.getElementById('whatsapp-web-simple-config');
                if (element) {
                    element.classList.remove('hidden');
                    updateStepIndicator(2);
                } else {
                    console.log('WhatsApp Web config element not found');
                }
            } catch (error) {
                console.log('Error showing WhatsApp Web config:', error);
            }
        }


        function showBrowserNotificationsConfig() {
            try {
                const element = document.getElementById('browser-notifications-config');
                if (element) {
                    element.classList.remove('hidden');
                    updateStepIndicator(2);
                } else {
                    console.log('Browser notifications config element not found');
                }
            } catch (error) {
                console.log('Error showing browser notifications config:', error);
            }
        }

        function showWhatsAppSimpleConfig() {
            const element = document.getElementById('whatsapp-simple-config');
            if (element) element.classList.remove('hidden');
            updateStepIndicator(2);
        }

        function showEmailSimpleConfig() {
            const element = document.getElementById('email-simple-config');
            if (element) element.classList.remove('hidden');
            updateStepIndicator(2);
        }

        function showTestConfig() {
            hideAllConfigSections();
            const element = document.getElementById('test-config');
            if (element) element.classList.remove('hidden');
            updateStepIndicator(3);
        }

        function showConfigComplete() {
            hideAllConfigSections();
            const element = document.getElementById('config-complete');
            if (element) element.classList.remove('hidden');
            updateStepIndicator(3, true);
        }

        function updateStepIndicator(currentStep, isComplete = false) {
            try {
                const steps = document.querySelectorAll('.flex.items-center.space-x-4 > div');
                if (steps.length === 0) {
                    console.log('Step indicator not found, skipping update');
                    return;
                }
                
                steps.forEach((step, index) => {
                    const circle = step.querySelector('div');
                    const text = step.querySelector('span');
                    
                    // Skip this iteration if elements don't exist
                    if (!circle || !text) {
                        console.log(`Step ${index + 1} elements not found, skipping`);
                        return; // This exits only this iteration, not the entire function
                    }
                    
                    const isCurrentStep = index + 1 === currentStep;
                    
                    try {
                        if (isComplete) {
                            circle.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-semibold';
                            circle.innerHTML = '<i class="fas fa-check text-xs"></i>';
                            text.className = 'ml-2 text-sm font-medium text-green-600';
                        } else if (isCurrentStep) {
                            circle.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-semibold';
                            text.className = 'ml-2 text-sm font-medium text-green-600';
                        } else if (index + 1 < currentStep) {
                            circle.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-semibold';
                            text.className = 'ml-2 text-sm font-medium text-green-600';
                        } else {
                            circle.className = 'w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold';
                            text.className = 'ml-2 text-sm font-medium text-gray-600';
                        }
                    } catch (stepError) {
                        console.log(`Error updating step ${index + 1}:`, stepError);
                    }
                });
            } catch (error) {
                console.log('Error updating step indicator:', error);
            }
        }

        function saveSimpleWhatsAppConfig() {
            const phoneNumber = document.getElementById('simple-whatsapp-number').value;
            const startTime = document.getElementById('notification-start-time').value;
            const endTime = document.getElementById('notification-end-time').value;
            const earlyReminder = document.getElementById('early-reminder').checked;
            const urgentReminder = document.getElementById('urgent-reminder').checked;
            const overdueReminder = document.getElementById('overdue-reminder').checked;

            if (!phoneNumber) {
                showNotification('Por favor ingresa tu número de teléfono', 'warning');
                return;
            }

            // Save configuration (in a real app, this would be saved to localStorage or server)
            const config = {
                method: 'whatsapp-simple',
                phoneNumber,
                startTime,
                endTime,
                earlyReminder,
                urgentReminder,
                overdueReminder
            };

            localStorage.setItem('notificationConfig', JSON.stringify(config));
            showNotification('Configuración de WhatsApp guardada exitosamente', 'success');
            
            setTimeout(() => {
                showTestConfig();
            }, 1000);
        }

        function saveSimpleEmailConfig() {
            const email = document.getElementById('simple-email-address').value;
            const password = document.getElementById('simple-email-password').value;
            const destination = document.getElementById('simple-email-destination').value;

            if (!email || !password || !destination) {
                showNotification('Por favor completa todos los campos', 'warning');
                return;
            }

            // Save configuration
            const config = {
                method: 'email-simple',
                email,
                password,
                destination
            };

            localStorage.setItem('notificationConfig', JSON.stringify(config));
            showNotification('Configuración de Email guardada exitosamente', 'success');
            
            setTimeout(() => {
                showTestConfig();
            }, 1000);
        }

        function sendTestNotification() {
            const config = JSON.parse(localStorage.getItem('notificationConfig') || '{}');
            
            if (!config.method) {
                showNotification('Primero configura las notificaciones', 'warning');
                return;
            }

            showNotification('Enviando mensaje de prueba...', 'info');
            
            // Create a test project for the notification
            const testProject = {
                poNumber: 'TEST-001',
                description: 'Proyecto de prueba - Configuración de notificaciones',
                dueDate: { toDate: () => new Date(Date.now() + 24 * 60 * 60 * 1000) } // Tomorrow
            };
            
            // Send actual test notification based on configured method
            if (config.method === 'whatsapp-web-simple') {
                sendWhatsAppWebTestNotification(config, testProject);
            } else if (config.method === 'browser-notifications') {
                sendBrowserTestNotification(testProject);
            } else {
                // Fallback to simulation
                setTimeout(() => {
                    showNotification('¡Mensaje de prueba enviado! Revisa tu dispositivo', 'success');
                    setTimeout(() => {
                        showConfigComplete();
                    }, 1500);
                }, 2000);
            }
        }
        
        function sendWhatsAppWebTestNotification(config, testProject) {
            const message = `🧪 *MENSAJE DE PRUEBA*\n\nPO #${testProject.poNumber}\n${testProject.description}\n\n¡Configuración de notificaciones exitosa!\n_Taller de Torno CNC_`;
            
            if (config.teamLeader) {
                const phone = config.teamLeader.replace(/\D/g, '');
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
                
                // Open WhatsApp Web with test message
                window.open(whatsappUrl, '_blank');
                
                showNotification('¡Mensaje de prueba enviado! Se abrió WhatsApp Web con el mensaje', 'success');
                setTimeout(() => {
                    showConfigComplete();
                }, 1500);
            } else {
                showNotification('Error: No se encontró el número del líder del equipo', 'error');
            }
        }
        
        function sendBrowserTestNotification(testProject) {
            if (Notification.permission === 'granted') {
                const message = `🧪 MENSAJE DE PRUEBA\n\nPO #${testProject.poNumber}\n${testProject.description}\n\n¡Configuración de notificaciones exitosa!`;
                
                new Notification('Taller de Torno CNC - Prueba', {
                    body: message,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiMxMEE5ODUiLz4KPHBhdGggZD0iTTQ0IDI0SDIwQzE4Ljg5NTQgMjQgMTggMjQuODk1NCAxOCAyNlY0MkMxOCA0My4xMDQ2IDE4Ljg5NTQgNDQgMjAgNDRINDRDNDUuMTA0NiA0NCA0NiA0My4xMDQ2IDQ2IDQyVjI2QzQ2IDI0Ljg5NTQgNDUuMTA0NiAyNCA0NCAyNFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yOCAzMkgzNlYzNkgyOFYzMloiIGZpbGw9IiMxMEE5ODUiLz4KPC9zdmc+'
                });
                
                showNotification('¡Mensaje de prueba enviado! Revisa la notificación del navegador', 'success');
                setTimeout(() => {
                    showConfigComplete();
                }, 1500);
            } else {
                showNotification('Error: Permisos de notificación no otorgados', 'error');
            }
        }

        function editNotificationConfig() {
            hideAllConfigSections();
            updateStepIndicator(1);
            
            // Show team setup again
            document.querySelector('.glass-card').classList.remove('hidden');
            
            // Reset radio buttons
            document.querySelectorAll('input[name="notification-method"]').forEach(radio => {
                radio.checked = false;
            });
        }


        function saveWhatsAppWebSimpleConfig() {
            const teamLeader = document.getElementById('team-leader-whatsapp').value;
            const teamGroup = document.getElementById('team-whatsapp-group').value;

            if (!teamLeader) {
                showNotification('Por favor ingresa el número del líder del equipo', 'warning');
                return;
            }

            const config = {
                method: 'whatsapp-web-simple',
                teamLeader,
                teamGroup,
                type: 'team'
            };

            localStorage.setItem('notificationConfig', JSON.stringify(config));
            showNotification('¡Configuración de WhatsApp Web guardada!', 'success');
            
            setTimeout(() => {
                showTestConfig();
            }, 1000);
        }


        function saveBrowserNotificationsConfig() {
            const teamMembers = document.getElementById('team-members').value;

            // Request notification permission
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        completeBrowserConfig(teamMembers);
                    } else {
                        showNotification('Se necesitan permisos de notificación para esta función', 'warning');
                    }
                });
            } else if (Notification.permission === 'granted') {
                completeBrowserConfig(teamMembers);
            } else {
                showNotification('Las notificaciones del navegador están bloqueadas. Por favor habilítalas en la configuración del navegador.', 'warning');
            }
        }

        function completeBrowserConfig(teamMembers) {
            const config = {
                method: 'browser-notifications',
                teamMembers: teamMembers ? teamMembers.split(',').map(member => member.trim()) : [],
                type: 'team',
                permission: 'granted'
            };

            localStorage.setItem('notificationConfig', JSON.stringify(config));
            showNotification('¡Notificaciones del navegador activadas!', 'success');
            
            setTimeout(() => {
                showTestConfig();
            }, 1000);
        }

        // --- Purchasing Event Listeners ---
        function setupPurchasingEvents() {
            // Create PO button from recommendations
            document.addEventListener('click', (e) => {
                if (e.target.closest('.bg-blue-600') && e.target.textContent.includes('Crear PO')) {
                    const recommendationCard = e.target.closest('.bg-white');
                    const materialName = recommendationCard.querySelector('h4').textContent;
                    createPurchaseOrderFromRecommendation(materialName);
                }
            });

            // Add material buttons
            document.addEventListener('click', (e) => {
                if (e.target.textContent.includes('Agregar Material') || 
                    e.target.textContent.includes('Agregar Herramienta') ||
                    e.target.textContent.includes('Agregar Consumible')) {
                    showAddMaterialModal(e.target.textContent);
                }
            });

            // Restrict actions to allowed roles only
            const isAllowed = (currentUserRole === 'admin' || currentUserRole === 'compras');

            // Create new purchase order
            const createPOBtn = document.getElementById('create-purchase-order');
            if (createPOBtn) {
                createPOBtn.addEventListener('click', (ev) => {
                    if (!isAllowed) {
                        showNotification('Acceso denegado: no puedes crear órdenes', 'warning');
                        return;
                    }
                    ev.preventDefault();
                    createNewPurchaseOrder();
                });
            }

            // Add supplier
            const saveSupplierBtn = document.getElementById('save-supplier');
            if (saveSupplierBtn) {
                saveSupplierBtn.addEventListener('click', (ev) => {
                    if (!isAllowed) {
                        showNotification('Acceso denegado: no puedes agregar proveedores', 'warning');
                        return;
                    }
                    ev.preventDefault();
                    addNewSupplier();
                });
            }
        }

        function createPurchaseOrderFromRecommendation(materialName) {
            showNotification(`Creando orden de compra para: ${materialName}`, 'success');
            
            // In a real implementation, this would open a modal or redirect to create PO
            // For now, we'll just show a notification and simulate the action
            setTimeout(() => {
                showNotification(`Orden de compra creada exitosamente para ${materialName}`, 'success');
            }, 1000);
        }

        function showAddMaterialModal(type) {
            const materialType = type.replace('Agregar ', '').toLowerCase();
            showNotification(`Abriendo formulario para agregar ${materialType}`, 'info');
            
            // In a real implementation, this would open a modal
            // For now, we'll just show a notification
        }

        async function createNewPurchaseOrder() {
            const supplier = document.getElementById('po-supplier')?.value || '';
            const material = document.getElementById('po-item')?.value || '';
            const quantity = parseFloat(document.getElementById('po-quantity')?.value || '0');
            const unit = document.getElementById('po-unit')?.value || 'piezas';
            const project = document.getElementById('po-project')?.value || '';
            const notes = document.getElementById('po-notes')?.value || '';

            if (!supplier || !material || !quantity) {
                showNotification('Por favor completa todos los campos obligatorios', 'warning');
                return;
            }

            try {
                const poCol = collection(db, 'artifacts', appId, 'secure', 'purchasing', 'purchase_orders');
                await addDoc(poCol, {
                    supplier,
                    item: material,
                    quantity,
                    unit,
                    project,
                    notes,
                    status: 'pendiente',
                    createdBy: currentUser?.uid || null,
                    createdAt: Timestamp.now()
                });
                showNotification(`Orden de compra creada: ${quantity} ${unit} de ${material} para ${supplier}`, 'success');
            } catch (e) {
                console.error(e);
                showNotification('No se pudo crear la orden de compra', 'error');
            }
        }

        async function addNewSupplier() {
            const name = document.getElementById('supplier-name')?.value?.trim();
            const specialty = document.getElementById('supplier-specialty')?.value;
            const contact = document.getElementById('supplier-contact')?.value?.trim();
            const phone = document.getElementById('supplier-phone')?.value?.trim();
            const email = document.getElementById('supplier-email')?.value?.trim();

            if (!name || !specialty) {
                showNotification('Por favor completa nombre y especialidad', 'warning');
                return;
            }

            try {
                const supCol = collection(db, 'artifacts', appId, 'secure', 'purchasing', 'suppliers');
                await addDoc(supCol, {
                    name,
                    specialty,
                    contact,
                    phone,
                    email,
                    createdBy: currentUser?.uid || null,
                    createdAt: Timestamp.now()
                });
                showNotification(`Proveedor "${name}" agregado`, 'success');
            } catch (e) {
                console.error(e);
                showNotification('No se pudo guardar el proveedor', 'error');
            }
        }

        function updateCategoriesList() {
            const container = document.getElementById('categories-list');
            const categories = settingsManager.getSetting('projects.categories') || [];
            
            container.innerHTML = categories.map(category => `
                <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                    <span class="text-sm text-slate-700">${category}</span>
                    <button class="text-red-500 hover:text-red-700" onclick="removeCategory('${category}')">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCategory(category) {
            let categories = settingsManager.getSetting('projects.categories') || [];
            categories = categories.filter(c => c !== category);
            settingsManager.updateSetting('projects.categories', categories);
            updateCategoriesList();
        }

        // --- Main Initialization ---
        // Tab Navigation System
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Show target tab content
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                    }
                    
            // Initialize specific tab functionality
            initializeTabContent(targetTab);
            // Enforce role on purchasing tab navigation
            if (targetTab === 'purchasing' && !(currentUserRole === 'admin' || currentUserRole === 'compras')) {
                showNotification('Acceso denegado: sección confidencial de Compras', 'warning');
                document.querySelector('[data-tab="dashboard"]').click();
                return;
            }
                });
            });
            
            // Initialize default tab (dashboard)
            const defaultTab = document.querySelector('.nav-tab.active');
            if (defaultTab) {
                const defaultTabName = defaultTab.getAttribute('data-tab');
                const defaultContent = document.getElementById(`${defaultTabName}-tab`);
                if (defaultContent) {
                    defaultContent.style.display = 'block';
                }
                initializeTabContent(defaultTabName);
            }
        }
        
        function updateAnalyticsCharts() {
            // Initialize analytics charts if they exist
            console.log('📊 Updating analytics charts...');
            // This function will be called when analytics tab is activated
            // Charts will be initialized if the elements exist
        }

        function updateAIInsights() {
            // Initialize AI insights if they exist
            console.log('🧠 Updating AI insights...');
            // This function will be called when AI insights tab is activated
            // AI insights will be initialized if the elements exist
        }

        function initializeTabContent(tabName) {
            switch(tabName) {
                case 'dashboard':
                    if (typeof updateDashboardMetrics === 'function') {
                        updateDashboardMetrics(projects || []);
                    }
                    break;
                case 'projects':
                    if (typeof updateProjectList === 'function') {
                        updateProjectList();
                    }
                    break;
                case 'analytics':
                    updateAnalyticsCharts();
                    break;
                case 'team':
                    // Initialize team management
                    break;
                case 'ai-insights':
                    if (typeof updateAIInsights === 'function') {
                        updateAIInsights();
                    }
                    break;
                case 'knowledge':
                    if (typeof setupKnowledgeUpload === 'function') {
                        setupKnowledgeUpload();
                    }
                    break;
                case 'whatsapp':
                    if (typeof setupWhatsApp === 'function') {
                        setupWhatsApp();
                    }
                    // Load saved notification configuration
                    setTimeout(() => {
                        loadNotificationConfig();
                    }, 100);
                    break;
                case 'purchasing':
                    if (!(currentUserRole === 'admin' || currentUserRole === 'compras')) {
                        showNotification('Acceso denegado: sección confidencial de Compras', 'warning');
                        document.querySelector('[data-tab="dashboard"]').click();
                        return;
                    }
                    if (typeof initializePurchasingSystem === 'function') {
                        initializePurchasingSystem();
                    }
                    break;
                case 'settings':
                    if (typeof setupSettings === 'function') {
                        setupSettings();
                    }
                    break;
            }
        }

        async function main() {
            console.log('🚀 Iniciando aplicación principal...');
            
            // Initialize tab navigation first
            setupTabNavigation();
            
            // Initialize knowledge upload system
            setupKnowledgeUpload();
            
            // Initialize multi-channel notification system
            setupMultiChannelNotifications();
            
            // Initialize WhatsApp system
            setupWhatsApp();
            
            // Initialize settings system
            setupSettings();
            
            // Initialize purchasing system
            setupPurchasingEvents();
            
            // Initialize simple notifications with a small delay to ensure DOM is ready
            setTimeout(() => {
                setupSimpleNotifications();
            }, 100);
            
            // Also add event delegation as backup
            setTimeout(() => {
                document.addEventListener('click', function(e) {
                    if (e.target && e.target.id === 'start-team-setup') {
                        console.log('✅ Botón clickeado via event delegation');
                        e.preventDefault();
                        e.stopPropagation();
                        handleTeamSetupClick();
                    }
                });
            }, 200);
            
            // Start reminder scheduler
            startReminderScheduler();
            
             if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing!");
                loadingSpinner.classList.remove('show');
                projectList.innerHTML = `<p class="text-red-500 text-center">No se pudo conectar a la base de datos. Por favor verifica la configuración.</p>`;
                return;
            }
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    projectsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
                    const q = query(projectsCollection, orderBy("dueDate", "asc"));
                    onSnapshot(q, (snapshot) => {
                        const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        updateProjectList(projects);
                        
                        // AI Learning from existing projects
                        projects.forEach(project => {
                            aiSystem.analyzeProject(project);
                        });
                    });
                }
            });

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                 console.error("Authentication failed:", error);
                 loadingSpinner.classList.remove('show');
                projectList.innerHTML = `<p class="text-red-500 text-center">Error de autenticación. No se pudieron cargar los proyectos.</p>`;
            }
        }

        // Register Service Worker for PWA
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('✅ Service Worker registrado correctamente:', registration.scope);
                            
                            // Request notification permission
                            if ('Notification' in window && Notification.permission === 'default') {
                                Notification.requestPermission().then(permission => {
                                    console.log('🔔 Permisos de notificación:', permission);
                                });
                            }
                        })
                        .catch(error => {
                            console.log('❌ Error al registrar Service Worker:', error);
                        });
                });
            }
        }

        // Install prompt for PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after a delay
            setTimeout(showInstallPrompt, 3000);
        });

        function showInstallPrompt() {
            // Create install button
            const installBtn = document.createElement('button');
            installBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Instalar App Móvil';
            installBtn.className = 'fixed bottom-4 right-4 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-colors text-sm font-medium';
            installBtn.onclick = installApp;
            
            document.body.appendChild(installBtn);
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
                if (installBtn.parentNode) {
                    installBtn.remove();
                }
            }, 15000);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('✅ Usuario aceptó instalar la app');
                        showNotification('¡App instalada correctamente! Ahora puedes acceder desde tu pantalla de inicio.', 'success');
                    } else {
                        console.log('❌ Usuario rechazó instalar la app');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Register service worker when app loads (disabled for file:// protocol)
        if (window.location.protocol !== 'file:') {
            registerServiceWorker();
        }

        // Ensure DOM is fully loaded before initializing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', main);
        } else {
        main();
        }
    </script>

    <!-- Add Team Member Modal -->
    <div id="add-member-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-800">Agregar Nuevo Miembro</h3>
                <button id="close-add-modal" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-member-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Nombre completo</label>
                    <input type="text" id="add-member-name" class="modern-input w-full" placeholder="Ej: Juan Pérez" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                    <input type="tel" id="add-member-phone" class="modern-input w-full" placeholder="Ej: +52 555 123 4567" required>
                    <p class="text-xs text-slate-500 mt-1">Incluye el código de país (+52 para México)</p>
                </div>
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="add-member-notifications" class="mr-2 rounded" checked>
                        <span class="text-sm text-slate-700">Activar notificaciones para este miembro</span>
                    </label>
                </div>
                <div class="flex space-x-4">
                    <button type="button" id="cancel-add" class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>Agregar Miembro
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Member Edit Modal -->
    <div id="edit-member-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-800">Editar Miembro del Equipo</h3>
                <button id="close-edit-modal" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-member-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Nombre</label>
                    <input type="text" id="edit-member-name" class="modern-input w-full" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Teléfono</label>
                    <input type="tel" id="edit-member-phone" class="modern-input w-full" required>
                </div>
                <div class="flex space-x-4">
                    <button type="button" id="cancel-edit" class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>


